# Backend API

[English](#english) | [中文](#中文)

---

<a name="english"></a>
## English

FastAPI backend service providing chat, summary generation, and code change generation.

### Quick Start

#### 1. Install Dependencies

```bash
# Option 1: Using Makefile (recommended)
make setup-backend

# Option 2: Manual installation
cd backend
pip install -r requirements.txt
```

#### 2. Start the Server

```bash
# Option 1: Using Makefile (recommended, from project root)
make run-backend

# Option 2: Manual
cd backend
uvicorn app.main:app --reload
```

You should see:
```
INFO:     Uvicorn running on http://127.0.0.1:8000
INFO:     Application startup complete.
```

#### 3. Verify the Service

Open in browser:
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

### Manual Testing

> ⚠️ Make sure the server is running first

#### Test 1: Health Check

```bash
curl http://localhost:8000/health
```

✅ Expected:
```json
{"status": "ok"}
```

#### Test 2: Generate Code Changes

```bash
curl -X POST http://localhost:8000/generate-changes \
  -H "Content-Type: application/json" \
  -d '{"file_path": "src/main.py", "instruction": "Add logging"}'
```

✅ Expected:
```json
{
  "success": true,
  "change_set": {
    "changes": [{
      "file_path": "src/main.py",
      "change_type": "replace_range",
      "replace_range": {
        "start_line": 1,
        "end_line": 5,
        "new_content": "# Mock change generated..."
      }
    }],
    "summary": "Mock change for: Add logging"
  },
  "message": "Generated by MockAgent (no LLM calls)"
}
```

#### Test 3: Generate Summary

```bash
curl -X POST http://localhost:8000/summary \
  -H "Content-Type: application/json" \
  -d '{
    "roomId": "room1",
    "messages": [
      {"userId": "alice", "content": "Goal: Build a chat app", "ts": 1000},
      {"userId": "bob", "content": "Decided: We will use FastAPI", "ts": 1001},
      {"userId": "alice", "content": "Should we use PostgreSQL?", "ts": 1002}
    ]
  }'
```

✅ Expected:
```json
{
  "goal": "Build a chat app",
  "decisions": ["We will use FastAPI"],
  "open_questions": ["Should we use PostgreSQL?"]
}
```

### Automated Testing

```bash
# Option 1: Using Makefile (recommended)
make test-backend

# Option 2: Manual
cd backend
pytest tests/ -v
```

#### Test Coverage

| Test File | Count | Description |
|-----------|-------|-------------|
| `test_main.py` | 1 | Health endpoint |
| `test_chat.py` | 4 | WebSocket chat |
| `test_summary.py` | 12 | Summary + schemas |
| `test_style_loader.py` | 14 | Code style loading |
| `test_mock_agent.py` | 14 | MockAgent + changes |
| `test_auto_apply_policy.py` | 28 | Auto-apply policy + API |
| **Total** | **83** | |

#### Test 4: Evaluate Auto-Apply Policy

```bash
curl -X POST http://localhost:8000/policy/evaluate-auto-apply \
  -H "Content-Type: application/json" \
  -d '{
    "change_set": {
      "changes": [{
        "file": "src/main.py",
        "type": "replace_range",
        "range": {"start": 1, "end": 5},
        "content": "# new content"
      }]
    }
  }'
```

✅ Expected (allowed):
```json
{
  "allowed": true,
  "reasons": [],
  "files_count": 1,
  "lines_changed": 5
}
```

❌ Expected (denied - forbidden path):
```json
{
  "allowed": false,
  "reasons": ["Forbidden paths: security/auth.py"],
  "files_count": 1,
  "lines_changed": 5
}
```

### Auto-Apply Policy Rules

| Rule | Limit | Description |
|------|-------|-------------|
| `max_files` | ≤ 2 | Maximum number of files that can be modified |
| `max_lines_changed` | ≤ 50 | Maximum total lines in the change range |
| `forbidden_paths` | `infra/`, `db/`, `security/` | Paths that cannot be auto-applied |

### API Reference

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/health` | GET | Health check |
| `/generate-changes` | POST | Generate code changes (MockAgent) |
| `/summary` | POST | Generate chat summary |
| `/policy/evaluate-auto-apply` | POST | Evaluate if ChangeSet can be auto-applied |
| `/ws/chat/{room_id}` | WebSocket | Real-time chat room |

### FAQ

**Q: Port 8000 is in use?**
```bash
uvicorn app.main:app --reload --port 8001
```

**Q: How to run specific tests?**
```bash
pytest tests/test_mock_agent.py -v
pytest tests/test_mock_agent.py::TestGenerateChangesEndpoint -v
```

---

<a name="中文"></a>
## 中文

FastAPI 后端服务，提供聊天、摘要生成和代码变更生成功能。

### 快速开始

#### 1. 安装依赖

```bash
# 方式一：使用 Makefile（推荐）
make setup-backend

# 方式二：手动安装
cd backend
pip install -r requirements.txt
```

#### 2. 启动服务器

```bash
# 方式一：使用 Makefile（推荐，从项目根目录）
make run-backend

# 方式二：手动启动
cd backend
uvicorn app.main:app --reload
```

启动成功后会看到：
```
INFO:     Uvicorn running on http://127.0.0.1:8000
INFO:     Application startup complete.
```

#### 3. 验证服务

打开浏览器访问：
- **Swagger 文档**: http://localhost:8000/docs
- **ReDoc 文档**: http://localhost:8000/redoc

### 手动测试

> ⚠️ 请先确保服务器已启动

#### 测试 1：健康检查

```bash
curl http://localhost:8000/health
```

✅ 预期返回：
```json
{"status": "ok"}
```

#### 测试 2：生成代码变更

```bash
curl -X POST http://localhost:8000/generate-changes \
  -H "Content-Type: application/json" \
  -d '{"file_path": "src/main.py", "instruction": "Add logging"}'
```

✅ 预期返回：
```json
{
  "success": true,
  "change_set": {
    "changes": [{
      "file_path": "src/main.py",
      "change_type": "replace_range",
      "replace_range": {
        "start_line": 1,
        "end_line": 5,
        "new_content": "# Mock change generated..."
      }
    }],
    "summary": "Mock change for: Add logging"
  },
  "message": "Generated by MockAgent (no LLM calls)"
}
```

#### 测试 3：生成聊天摘要

```bash
curl -X POST http://localhost:8000/summary \
  -H "Content-Type: application/json" \
  -d '{
    "roomId": "room1",
    "messages": [
      {"userId": "alice", "content": "Goal: Build a chat app", "ts": 1000},
      {"userId": "bob", "content": "Decided: We will use FastAPI", "ts": 1001},
      {"userId": "alice", "content": "Should we use PostgreSQL?", "ts": 1002}
    ]
  }'
```

✅ 预期返回：
```json
{
  "goal": "Build a chat app",
  "decisions": ["We will use FastAPI"],
  "open_questions": ["Should we use PostgreSQL?"]
}
```

### 自动化测试

```bash
# 方式一：使用 Makefile（推荐）
make test-backend

# 方式二：手动运行
cd backend
pytest tests/ -v
```

#### 测试覆盖

| 测试文件 | 数量 | 说明 |
|----------|------|------|
| `test_main.py` | 1 | 健康检查端点 |
| `test_chat.py` | 4 | WebSocket 聊天 |
| `test_summary.py` | 12 | 摘要生成 + Schema |
| `test_style_loader.py` | 14 | 代码风格加载 |
| `test_mock_agent.py` | 14 | MockAgent + 变更生成 |
| `test_auto_apply_policy.py` | 28 | 自动应用策略 + API |
| **总计** | **83** | |

#### 测试 4：评估自动应用策略

```bash
curl -X POST http://localhost:8000/policy/evaluate-auto-apply \
  -H "Content-Type: application/json" \
  -d '{
    "change_set": {
      "changes": [{
        "file": "src/main.py",
        "type": "replace_range",
        "range": {"start": 1, "end": 5},
        "content": "# new content"
      }]
    }
  }'
```

✅ 允许时的预期返回：
```json
{
  "allowed": true,
  "reasons": [],
  "files_count": 1,
  "lines_changed": 5
}
```

❌ 拒绝时的预期返回（禁止路径）：
```json
{
  "allowed": false,
  "reasons": ["Forbidden paths: security/auth.py"],
  "files_count": 1,
  "lines_changed": 5
}
```

### 自动应用策略规则

| 规则 | 限制 | 说明 |
|------|------|------|
| `max_files` | ≤ 2 | 最多修改的文件数量 |
| `max_lines_changed` | ≤ 50 | 更改范围内的最大总行数 |
| `forbidden_paths` | `infra/`, `db/`, `security/` | 禁止自动应用的路径 |

### API 参考

| 端点 | 方法 | 说明 |
|------|------|------|
| `/health` | GET | 健康检查 |
| `/generate-changes` | POST | 生成代码变更（MockAgent） |
| `/summary` | POST | 生成聊天摘要 |
| `/policy/evaluate-auto-apply` | POST | 评估 ChangeSet 是否可以自动应用 |
| `/ws/chat/{room_id}` | WebSocket | 实时聊天室 |

### 常见问题

**Q: 端口 8000 被占用？**
```bash
uvicorn app.main:app --reload --port 8001
```

**Q: 如何只运行特定测试？**
```bash
pytest tests/test_mock_agent.py -v
pytest tests/test_mock_agent.py::TestGenerateChangesEndpoint -v
```

---

## Project Structure / 项目结构

```
backend/
├── app/
│   ├── main.py                 # App entry / 应用入口
│   ├── agent/
│   │   ├── mock_agent.py       # MockAgent (no LLM)
│   │   ├── router.py           # /generate-changes
│   │   ├── schemas.py          # ChangeSet models
│   │   └── style_loader.py     # Code style loader
│   ├── chat/
│   │   ├── router.py           # WebSocket chat
│   │   └── manager.py          # Connection manager
│   ├── policy/
│   │   ├── auto_apply.py       # Auto-apply policy rules / 自动应用策略规则
│   │   └── router.py           # /policy/evaluate-auto-apply
│   └── summary/
│       ├── router.py           # /summary
│       └── schemas.py          # Summary models
├── tests/                      # Test files / 测试文件
└── requirements.txt            # Dependencies / 依赖
```
