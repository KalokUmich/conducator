<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link rel="stylesheet" href="tailwind.css">
    <style>
        /* ============================================================
           CONDUCTOR — Premium AI Interface
           ============================================================ */

        /* === Scrollbar === */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: rgba(139,92,246,0.25);
            border-radius: 9999px;
            transition: background 0.2s;
        }
        ::-webkit-scrollbar-thumb:hover { background: rgba(139,92,246,0.45); }

        /* === Layout === */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }

        .message-bubble { word-wrap: break-word; overflow-wrap: break-word; }

        /* === Scroll-to-bottom === */
        #scroll-to-bottom { transition: opacity 0.2s, transform 0.2s; }
        #scroll-to-bottom:hover { transform: scale(1.1); }

        /* === Unread badge pulse === */
        .unread-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* === Code snippets — no syntax colors === */
        .code-snippet-plain, .code-snippet-plain code, .code-snippet-plain * {
            color: #d1d5db !important; background: transparent !important;
        }

        /* === Conductor header action buttons === */
        .conductor-action-btn {
            font-size: 0.7rem; font-weight: 500;
            padding: 0.2rem 0.55rem;
            border-radius: 6px;
            background: rgba(139,92,246,0.08);
            border: 1px solid rgba(139,92,246,0.18);
            transition: background 0.15s, border-color 0.15s;
        }
        .conductor-action-btn:hover {
            background: rgba(139,92,246,0.16);
            border-color: rgba(139,92,246,0.35);
        }
        .conductor-quit-btn {
            font-size: 0.7rem; font-weight: 400;
            padding: 0.2rem 0.45rem;
            border-radius: 6px;
            color: rgba(156,163,175,0.75);
            transition: color 0.15s, background 0.15s;
        }
        .conductor-quit-btn:hover { color: #d1d5db; background: rgba(75,85,99,0.25); }
        .conductor-danger-btn {
            font-size: 0.7rem; font-weight: 400;
            padding: 0.2rem 0.45rem;
            border-radius: 6px;
            color: rgba(248,113,113,0.6);
            transition: color 0.15s, background 0.15s;
        }
        .conductor-danger-btn:hover { color: #f87171; background: rgba(239,68,68,0.1); }

        /* === Explain Code — loading bubble in chat === */
        @keyframes explainPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        #ai-explain-loading { animation: explainPulse 2s ease-in-out infinite; }

        /* === Role-based accent colors === */
        .bubble-host { position: relative; }
        .bubble-host::before { content: ''; position: absolute; top: 8px; left: -8px; width: 5px; height: 5px; border-radius: 50%; background: #f59e0b; }
        .bubble-guest { position: relative; }
        .bubble-guest::before { content: ''; position: absolute; top: 8px; left: -8px; width: 5px; height: 5px; border-radius: 50%; background: #3b82f6; }
        .name-host { color: #fbbf24; }
        .name-guest { color: #60a5fa; }

        .role-pill {
            font-size: 0.6rem; line-height: 1rem; padding: 0 0.375rem;
            border-radius: 9999px; font-weight: 600;
            letter-spacing: 0.05em; text-transform: uppercase;
        }
        .role-pill-host   { background: rgba(245,158,11,0.12); color: #fbbf24; }
        .role-pill-guest   { background: rgba(59,130,246,0.12); color: #60a5fa; }
        .role-pill-sso     { background: rgba(34,197,94,0.12); color: #4ade80; }
        .role-pill-aws     { background: rgba(251,191,36,0.12); color: #fbbf24; }
        .role-pill-google  { background: rgba(96,165,250,0.12); color: #60a5fa; }

        /* ============================================================
           PREMIUM VISUAL SYSTEM
           ============================================================ */

        /* --- Glassmorphism --- */
        .glass {
            backdrop-filter: blur(16px) saturate(1.4);
            -webkit-backdrop-filter: blur(16px) saturate(1.4);
            background: rgba(15,18,30,0.75);
            border: 1px solid rgba(255,255,255,0.06);
        }

        /* --- Glow effects --- */
        .glow-primary { box-shadow: 0 0 24px rgba(139,92,246,0.3), 0 0 6px rgba(139,92,246,0.15); }

        /* --- Animated background for body --- */
        body.bg-conductor {
            background-color: #0a0d14;
            background-image:
                radial-gradient(ellipse 60% 50% at 20% 0%, rgba(124,58,237,0.12) 0%, transparent 60%),
                radial-gradient(ellipse 50% 40% at 80% 10%, rgba(59,130,246,0.08) 0%, transparent 55%),
                radial-gradient(ellipse 40% 50% at 50% 100%, rgba(88,28,135,0.06) 0%, transparent 60%);
        }

        /* --- Animated aurora mesh for landing pages --- */
        @keyframes auroraShift {
            0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.5; }
            33% { transform: translate(10px, -15px) scale(1.05); opacity: 0.7; }
            66% { transform: translate(-8px, 10px) scale(0.97); opacity: 0.4; }
        }
        .aurora-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            pointer-events: none;
            animation: auroraShift 12s ease-in-out infinite;
            will-change: transform, opacity;
        }
        .aurora-orb-1 {
            width: 300px; height: 300px;
            background: rgba(124,58,237,0.25);
            top: -60px; left: -40px;
        }
        .aurora-orb-2 {
            width: 250px; height: 250px;
            background: rgba(59,130,246,0.18);
            bottom: -50px; right: -30px;
            animation-delay: -4s;
        }
        .aurora-orb-3 {
            width: 200px; height: 200px;
            background: rgba(6,182,212,0.1);
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            animation-delay: -8s;
        }

        /* --- Brand wordmark --- */
        .brand-wordmark {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            background: linear-gradient(135deg, #e0c3fc 0%, #a78bfa 30%, #818cf8 55%, #60a5fa 80%, #38bdf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 20px rgba(139,92,246,0.3));
        }

        /* --- Gradient text utility --- */
        .text-gradient {
            background: linear-gradient(135deg, #e0c3fc 0%, #a78bfa 25%, #818cf8 50%, #60a5fa 75%, #38bdf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* --- Border gradient utility --- */
        .border-gradient {
            border-image: linear-gradient(135deg, rgba(139,92,246,0.5), rgba(99,102,241,0.5)) 1;
        }

        /* --- Shimmer animation --- */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .shimmer {
            background: linear-gradient(90deg, transparent 0%, rgba(139,92,246,0.08) 50%, transparent 100%);
            background-size: 200% 100%;
            animation: shimmer 2.5s infinite;
        }

        /* --- Message appear animation --- */
        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-enter { animation: messageSlideIn 0.2s ease-out; }

        /* --- Modal appear animation --- */
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.96) translateY(8px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-enter { animation: modalIn 0.25s ease-out; }

        /* --- AI thinking dots --- */
        @keyframes aiThinking {
            0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
            40% { opacity: 1; transform: scale(1); }
        }
        .ai-thinking-dots { display: inline-flex; align-items: center; gap: 5px; }
        .ai-thinking-dots span {
            width: 7px; height: 7px; border-radius: 50%;
            background: linear-gradient(135deg, #a78bfa, #818cf8);
            animation: aiThinking 1.4s infinite;
        }
        .ai-thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
        .ai-thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

        /* --- Animated gradient border for AI cards --- */
        @keyframes borderGlow {
            0%, 100% { border-color: rgba(139,92,246,0.3); }
            50% { border-color: rgba(99,102,241,0.5); }
        }
        .ai-card-border { animation: borderGlow 3s ease-in-out infinite; }

        /* --- Staggered section entrance for AI summary card --- */
        @keyframes sectionFadeUp {
            from { opacity: 0; transform: translateY(5px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .ai-section-1 { animation: sectionFadeUp 0.25s ease-out 0.05s both; }
        .ai-section-2 { animation: sectionFadeUp 0.25s ease-out 0.13s both; }
        .ai-section-3 { animation: sectionFadeUp 0.25s ease-out 0.21s both; }
        .ai-section-4 { animation: sectionFadeUp 0.25s ease-out 0.29s both; }
        .ai-section-5 { animation: sectionFadeUp 0.25s ease-out 0.37s both; }

        /* --- CGP card animated border --- */
        @keyframes cgpBorderGlow {
            0%, 100% { border-color: rgba(34,211,238,0.18); }
            50%       { border-color: rgba(56,189,248,0.32); }
        }
        .cgp-card-border { animation: cgpBorderGlow 4s ease-in-out infinite; }

        /* --- Modal close button --- */
        .modal-close-btn { transition: transform 0.2s ease, color 0.2s ease; }
        .modal-close-btn:hover { transform: rotate(90deg); }

        /* --- Typing indicator --- */
        .typing-dots { display: inline-flex; gap: 3px; align-items: center; }
        .typing-dots span {
            width: 5px; height: 5px; border-radius: 50%;
            background: #9ca3af; animation: aiThinking 1.4s infinite;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        /* --- Online indicator glow --- */
        .online-glow { box-shadow: 0 0 6px rgba(74,222,128,0.5); }

        /* ============================================================
           PREMIUM BUTTON SYSTEM
           ============================================================ */
        .btn-primary {
            background: linear-gradient(135deg, #7c3aed 0%, #6366f1 50%, #4f46e5 100%);
            color: #fff;
            font-weight: 500;
            border-radius: 0.625rem;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .btn-primary:hover::before { opacity: 1; }
        .btn-primary:hover {
            box-shadow: 0 0 28px rgba(124,58,237,0.35), 0 4px 16px rgba(99,102,241,0.2);
            transform: translateY(-1px);
        }
        .btn-primary:active { transform: translateY(0); }

        .btn-secondary {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            color: #e5e7eb;
            font-weight: 500;
            border-radius: 0.625rem;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.14);
            box-shadow: 0 0 16px rgba(139,92,246,0.1);
        }

        .btn-danger {
            background: linear-gradient(135deg, rgba(239,68,68,0.8) 0%, rgba(185,28,28,0.8) 100%);
            border: 1px solid rgba(239,68,68,0.2);
            color: #fff;
            font-weight: 500;
            border-radius: 0.625rem;
            transition: all 0.2s ease;
        }
        .btn-danger:hover {
            box-shadow: 0 0 20px rgba(239,68,68,0.25);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: #fff;
            font-weight: 500;
            border-radius: 0.625rem;
            transition: all 0.2s ease;
        }
        .btn-success:hover {
            box-shadow: 0 0 20px rgba(16,185,129,0.25);
            transform: translateY(-1px);
        }

        /* ============================================================
           PREMIUM INPUT
           ============================================================ */
        .input-premium {
            background: rgba(15,18,30,0.6);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 0.75rem;
            transition: all 0.25s ease;
            color: #f3f4f6;
        }
        .input-premium:focus {
            outline: none;
            border-color: rgba(139,92,246,0.4);
            box-shadow: 0 0 0 3px rgba(139,92,246,0.1), 0 0 20px rgba(139,92,246,0.08);
        }
        .input-premium::placeholder { color: rgba(156,163,175,0.5); }

        /* ============================================================
           LANDING PAGE EXTRAS
           ============================================================ */
        .landing-subtitle {
            color: #9ca3af;
            font-size: 0.875rem;
            line-height: 1.5;
            max-width: 280px;
            text-align: center;
        }

        /* Subtle horizontal rule with gradient */
        .divider-gradient {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(139,92,246,0.2), transparent);
            border: none;
            width: 100%;
            max-width: 200px;
        }

        /* Status badge for header */
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            display: inline-block;
            animation: statusPulse 2s ease-in-out infinite;
        }
        @keyframes statusPulse {
            0%, 100% { box-shadow: 0 0 0 0 currentColor; }
            50% { box-shadow: 0 0 0 4px transparent; }
        }

        /* Premium sidebar */
        .sidebar-premium {
            background: rgba(10,13,20,0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* === Upload spinner === */
        @keyframes spin { to { transform: rotate(360deg); } }
        .upload-spinner {
            width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.2);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        /* === Drag-drop input glow === */
        @keyframes inputDropPulse {
            0%, 100% { box-shadow: 0 0 12px rgba(139,92,246,0.4), 0 0 0 2px rgba(139,92,246,0.3); }
            50% { box-shadow: 0 0 20px rgba(139,92,246,0.6), 0 0 0 3px rgba(139,92,246,0.5); }
        }
        .input-drop-active {
            border-color: rgba(139,92,246,0.6) !important;
            animation: inputDropPulse 1.2s ease-in-out infinite;
        }

        /* === Toast notification === */
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes toastOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(12px); }
        }
        .toast {
            position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 100;
            padding: 0.75rem 1.25rem; border-radius: 0.75rem;
            font-size: 0.8125rem; font-weight: 500;
            backdrop-filter: blur(12px);
            animation: toastIn 0.25s ease-out;
            max-width: 320px;
        }
        .toast.hiding { animation: toastOut 0.25s ease-in forwards; }
        .toast-error { background: rgba(239,68,68,0.85); color: #fff; border: 1px solid rgba(239,68,68,0.3); }
        .toast-success { background: rgba(34,197,94,0.85); color: #fff; border: 1px solid rgba(34,197,94,0.3); }
        .toast-info { background: rgba(59,130,246,0.85); color: #fff; border: 1px solid rgba(59,130,246,0.3); }
    </style>
</head>
<body class="bg-gray-900 bg-conductor text-gray-100 h-screen overflow-hidden">
    <div class="flex h-full">
        <!-- Main Chat Area -->
        <div class="flex flex-col flex-1">

            <!-- ============================================================ -->
            <!-- STATE PANEL: Idle — Start / Join buttons                     -->
            <!-- ============================================================ -->
            <div id="panel-idle" class="hidden flex-1 flex flex-col items-center justify-center gap-5 px-6 relative overflow-hidden">
                <!-- Aurora orbs -->
                <div class="aurora-orb aurora-orb-1"></div>
                <div class="aurora-orb aurora-orb-2"></div>
                <div class="aurora-orb aurora-orb-3"></div>

                <!-- Brand -->
                <div class="relative z-10 flex flex-col items-center gap-1">
                    <h2 class="brand-wordmark">Conductor</h2>
                    <p class="landing-subtitle">AI-powered collaboration for engineering teams</p>
                </div>

                <hr class="divider-gradient relative z-10" />

                <!-- Start button -->
                <button
                    id="btn-idle-start"
                    class="btn-primary text-sm px-8 py-2.5 flex items-center gap-2.5 relative z-10"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    Start Session
                </button>

                <!-- Join row -->
                <div class="flex items-center gap-2 w-full max-w-xs relative z-10">
                    <input
                        id="invite-url-input"
                        type="text"
                        placeholder="Paste invite link…"
                        class="input-premium flex-1 text-xs px-3 py-2"
                    />
                    <button
                        id="btn-idle-join"
                        class="btn-success text-xs px-4 py-2 flex items-center gap-1"
                    >
                        Join
                    </button>
                </div>

                <!-- SSO Identity Section -->
                <div id="sso-idle" class="w-full max-w-xs mt-1 relative z-10">
                    <div id="sso-idle-signin" class="sso-signin flex gap-2">
                        <button class="sso-login-btn sso-login-aws btn-secondary flex-1 text-xs py-2 px-3 flex items-center justify-center gap-1" data-provider="aws">
                            &#9729; AWS SSO
                        </button>
                        <button class="sso-login-btn sso-login-google btn-secondary flex-1 text-xs py-2 px-3 flex items-center justify-center gap-1" data-provider="google">
                            G Google
                        </button>
                    </div>
                    <div id="sso-idle-pending" class="sso-pending hidden">
                        <div class="flex items-center justify-center gap-2 py-2 px-3 border border-gray-700/50 rounded-xl bg-gray-800/30">
                            <div class="h-3 w-3 border-2 border-violet-400 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-xs text-gray-400">Waiting for SSO...</span>
                            <code class="sso-user-code text-xs text-violet-400 font-mono"></code>
                            <button class="sso-cancel-btn text-gray-500 hover:text-gray-300 text-xs ml-1">Cancel</button>
                        </div>
                    </div>
                    <div id="sso-idle-done" class="sso-done hidden">
                        <div class="flex items-center gap-2 py-2 px-3 bg-gray-800/40 border border-gray-700/50 rounded-xl">
                            <span class="sso-provider-badge text-xs"></span>
                            <span class="sso-email text-xs text-gray-300 truncate"></span>
                            <button class="sso-clear-btn ml-auto text-gray-500 hover:text-gray-300 text-xs flex-shrink-0" title="Clear identity">&#10005;</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- STATE PANEL: BackendDisconnected — join only mode            -->
            <!-- ============================================================ -->
            <div id="panel-disconnected" class="hidden flex-1 flex flex-col items-center justify-center gap-5 px-6 relative overflow-hidden">
                <!-- Aurora orbs (muted) -->
                <div class="aurora-orb aurora-orb-1" style="opacity:0.3;"></div>
                <div class="aurora-orb aurora-orb-2" style="opacity:0.2;"></div>

                <!-- Backend status warning -->
                <div class="relative z-10 flex items-center gap-2 text-amber-400 px-4 py-2 rounded-xl border border-amber-500/15 bg-amber-500/5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-xs font-medium">Local backend not running</span>
                </div>

                <div class="relative z-10 flex flex-col items-center gap-1">
                    <h2 class="text-lg font-semibold text-white">Join Only Mode</h2>
                    <p class="landing-subtitle">
                        Join other sessions directly. Start the backend to host your own.
                    </p>
                </div>

                <!-- Start Session button (disabled) -->
                <div class="relative group w-full max-w-xs z-10">
                    <button
                        id="btn-start-session-disabled"
                        disabled
                        class="w-full text-sm px-6 py-2.5 rounded-xl flex items-center justify-center gap-2 cursor-not-allowed opacity-40 bg-gray-700 text-gray-400 border border-gray-600/30"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        Start Session
                    </button>
                    <!-- Tooltip -->
                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-1.5 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none border border-gray-700/50">
                        Backend required to host a session
                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                    </div>
                </div>

                <!-- Join Session input + button -->
                <div class="flex items-center gap-2 w-full max-w-xs relative z-10">
                    <input
                        id="disconnected-invite-url-input"
                        type="text"
                        placeholder="Paste invite link…"
                        class="input-premium flex-1 text-xs px-3 py-2"
                    />
                    <button
                        id="btn-disconnected-join"
                        class="btn-success text-xs px-4 py-2 flex items-center gap-1"
                    >
                        Join
                    </button>
                </div>

                <!-- Retry connection link -->
                <button
                    id="btn-retry"
                    class="text-violet-400 hover:text-violet-300 text-xs mt-1 transition-colors relative z-10 flex items-center gap-1"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                    </svg>
                    Retry connection
                </button>
                <!-- SSO Identity Section -->
                <div id="sso-disconnected" class="w-full max-w-xs mt-1 relative z-10">
                    <div id="sso-disconnected-signin" class="sso-signin flex gap-2">
                        <button class="sso-login-btn sso-login-aws btn-secondary flex-1 text-xs py-2 px-3 flex items-center justify-center gap-1" data-provider="aws">
                            &#9729; AWS SSO
                        </button>
                        <button class="sso-login-btn sso-login-google btn-secondary flex-1 text-xs py-2 px-3 flex items-center justify-center gap-1" data-provider="google">
                            G Google
                        </button>
                    </div>
                    <div id="sso-disconnected-pending" class="sso-pending hidden">
                        <div class="flex items-center justify-center gap-2 py-2 px-3 border border-gray-700/50 rounded-xl bg-gray-800/30">
                            <div class="h-3 w-3 border-2 border-violet-400 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-xs text-gray-400">Waiting for SSO...</span>
                            <code class="sso-user-code text-xs text-violet-400 font-mono"></code>
                            <button class="sso-cancel-btn text-gray-500 hover:text-gray-300 text-xs ml-1">Cancel</button>
                        </div>
                    </div>
                    <div id="sso-disconnected-done" class="sso-done hidden">
                        <div class="flex items-center gap-2 py-2 px-3 bg-gray-800/40 border border-gray-700/50 rounded-xl">
                            <span class="sso-provider-badge text-xs"></span>
                            <span class="sso-email text-xs text-gray-300 truncate"></span>
                            <button class="sso-clear-btn ml-auto text-gray-500 hover:text-gray-300 text-xs flex-shrink-0" title="Clear identity">&#10005;</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- STATE PANEL: ReadyToHost — start session                     -->
            <!-- ============================================================ -->
            <div id="panel-ready" class="hidden flex-1 flex flex-col items-center justify-center gap-5 px-6 relative overflow-hidden">
                <!-- Aurora orbs -->
                <div class="aurora-orb aurora-orb-1"></div>
                <div class="aurora-orb aurora-orb-2"></div>
                <div class="aurora-orb aurora-orb-3"></div>

                <!-- Ready status -->
                <div class="relative z-10 flex items-center gap-2 text-emerald-400 px-4 py-2 rounded-xl border border-emerald-500/15 bg-emerald-500/5">
                    <span class="status-dot bg-emerald-400" style="color:rgba(52,211,153,0.4);"></span>
                    <span class="text-xs font-medium">Backend connected</span>
                </div>

                <div class="relative z-10 flex flex-col items-center gap-1">
                    <h2 class="brand-wordmark" style="font-size:1.5rem;">Conductor</h2>
                    <p class="landing-subtitle">Ready to start. Create a session or join an existing one.</p>
                </div>

                <hr class="divider-gradient relative z-10" />

                <button
                    id="btn-start-session"
                    class="btn-primary text-sm px-8 py-2.5 flex items-center gap-2.5 relative z-10"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    Start Session
                </button>
                <div class="flex items-center gap-2 w-full max-w-xs relative z-10">
                    <input
                        id="ready-invite-url-input"
                        type="text"
                        placeholder="Paste invite link…"
                        class="input-premium flex-1 text-xs px-3 py-2"
                    />
                    <button
                        id="btn-ready-join"
                        class="btn-success text-xs px-4 py-2 flex items-center gap-1"
                    >
                        Join
                    </button>
                </div>
                <!-- SSO Identity Section -->
                <div id="sso-ready" class="w-full max-w-xs mt-1 relative z-10">
                    <div id="sso-ready-signin" class="sso-signin flex gap-2">
                        <button class="sso-login-btn sso-login-aws btn-secondary flex-1 text-xs py-2 px-3 flex items-center justify-center gap-1" data-provider="aws">
                            &#9729; AWS SSO
                        </button>
                        <button class="sso-login-btn sso-login-google btn-secondary flex-1 text-xs py-2 px-3 flex items-center justify-center gap-1" data-provider="google">
                            G Google
                        </button>
                    </div>
                    <div id="sso-ready-pending" class="sso-pending hidden">
                        <div class="flex items-center justify-center gap-2 py-2 px-3 border border-gray-700/50 rounded-xl bg-gray-800/30">
                            <div class="h-3 w-3 border-2 border-violet-400 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-xs text-gray-400">Waiting for SSO...</span>
                            <code class="sso-user-code text-xs text-violet-400 font-mono"></code>
                            <button class="sso-cancel-btn text-gray-500 hover:text-gray-300 text-xs ml-1">Cancel</button>
                        </div>
                    </div>
                    <div id="sso-ready-done" class="sso-done hidden">
                        <div class="flex items-center gap-2 py-2 px-3 bg-gray-800/40 border border-gray-700/50 rounded-xl">
                            <span class="sso-provider-badge text-xs"></span>
                            <span class="sso-email text-xs text-gray-300 truncate"></span>
                            <button class="sso-clear-btn ml-auto text-gray-500 hover:text-gray-300 text-xs flex-shrink-0" title="Clear identity">&#10005;</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- STATE PANEL: Joining — loading indicator                     -->
            <!-- ============================================================ -->
            <div id="panel-joining" class="hidden flex-1 flex flex-col items-center justify-center gap-4 px-6 relative overflow-hidden">
                <div class="aurora-orb aurora-orb-1" style="opacity:0.4;"></div>
                <div class="aurora-orb aurora-orb-2" style="opacity:0.3;"></div>
                <div class="ai-thinking-dots relative z-10" style="transform: scale(1.8);"><span></span><span></span><span></span></div>
                <p class="text-sm text-gray-400 relative z-10">Joining session…</p>
            </div>

            <!-- ============================================================ -->
            <!-- STATE PANELS: Hosting / Joined — full chat UI                -->
            <!-- ============================================================ -->
            <div id="panel-chat" class="hidden flex flex-1 min-h-0">
            <!-- Chat content column (header + messages + input) -->
            <div class="flex flex-col flex-1 min-h-0 overflow-hidden">

            <!-- Header (only visible in Hosting / Joined) -->
            <header class="flex-shrink-0 px-4 pt-3 pb-2" style="background:rgba(10,13,20,0.85);border-bottom:1px solid rgba(255,255,255,0.055);">

                <!-- Row 1: Brand + Controls -->
                <div class="flex items-center gap-2">
                    <!-- Brand -->
                    <div class="flex items-center gap-2 min-w-0 flex-1">
                        <div class="w-5 h-5 rounded flex items-center justify-center flex-shrink-0" style="background:rgba(139,92,246,0.18);border:1px solid rgba(139,92,246,0.28);">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-violet-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <span class="text-sm font-semibold text-white/90 tracking-tight">Conductor</span>
                        <div class="flex items-center gap-0.5 min-w-0">
                            <span id="room-id-display" class="font-mono text-[0.58rem] text-gray-600 truncate max-w-[72px]">loading…</span>
                            <button id="btn-copy-room-id" class="text-gray-600 hover:text-gray-400 p-0.5 flex-shrink-0 transition-colors" title="Copy Room ID">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- Right: icon controls + role badge -->
                    <div class="flex items-center gap-0.5 flex-shrink-0">
                        <!-- AI Config (visibility controlled via style.display by JS) -->
                        <button id="btn-ai-config"
                            class="p-1.5 rounded-md text-gray-500 hover:text-violet-400 hover:bg-violet-500/10 transition-all duration-150"
                            title="AI Configuration">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        <!-- Room Settings (hidden until lead) -->
                        <button id="btn-room-settings"
                            class="hidden p-1.5 rounded-md text-gray-500 hover:text-gray-300 hover:bg-gray-700/50 transition-all duration-150"
                            title="Room Settings">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        <!-- Auto Apply Toggle -->
                        <div id="auto-apply-toggle-container" class="hidden items-center gap-1.5 pl-1 pr-0.5">
                            <span class="text-[0.6rem] text-gray-600 uppercase tracking-wide font-medium">Auto</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="auto-apply-toggle" class="sr-only peer">
                                <div class="w-8 h-[18px] bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-gray-300 after:border-gray-300 after:border after:rounded-full after:h-3.5 after:w-3.5 after:transition-all peer-checked:bg-violet-600"></div>
                            </label>
                        </div>
                        <!-- SSO identity badge (hidden by default) -->
                        <div id="sso-header-badge" class="hidden text-[0.6rem] px-1.5 py-0.5 rounded-full bg-gray-800 text-gray-500 truncate max-w-[90px] border border-gray-700/50" title=""></div>
                        <!-- Role / user badge -->
                        <div id="role-badge" class="ml-1 text-[0.65rem] px-2.5 py-1 rounded-full font-medium bg-gray-800/80 text-gray-400 border border-gray-700/40 whitespace-nowrap"></div>
                    </div>
                </div>

                <!-- Row 2: Unified session action bar -->
                <div class="mt-2.5 flex items-center gap-1 flex-wrap">
                    <!-- Hosting controls -->
                    <div id="hosting-controls" class="hidden items-center gap-1">
                        <span class="flex items-center gap-1.5 text-[0.65rem] font-medium text-emerald-400 pr-0.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 flex-shrink-0" style="box-shadow:0 0 5px rgba(52,211,153,0.6)"></span>
                            Live
                        </span>
                        <span class="w-px h-3 bg-gray-700/70 mx-0.5"></span>
                        <button id="btn-copy-invite" class="conductor-action-btn text-violet-300 flex items-center gap-1" style="border-color:rgba(139,92,246,0.25);">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
                            </svg>
                            Invite
                        </button>
                        <button id="btn-stop-session" class="conductor-quit-btn" title="Leave session — chat data is preserved">Leave</button>
                    </div>

                    <!-- Joined controls -->
                    <div id="joined-controls" class="hidden items-center gap-1">
                        <span class="flex items-center gap-1.5 text-[0.65rem] font-medium text-blue-400 pr-0.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-blue-400 flex-shrink-0" style="box-shadow:0 0 5px rgba(96,165,250,0.6)"></span>
                            Joined
                        </span>
                        <button id="btn-leave-session" class="conductor-quit-btn" title="Leave session — chat data is preserved">Leave</button>
                    </div>

                    <!-- Lead-only actions -->
                    <div id="lead-actions" class="hidden items-center gap-1">
                        <span class="w-px h-3 bg-gray-700/70 mx-0.5"></span>
                        <button id="btn-create-summary" class="conductor-action-btn text-violet-300 flex items-center gap-1" style="border-color:rgba(139,92,246,0.25);">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z"/>
                            </svg>
                            Distill
                        </button>
                        <button id="btn-end-chat" class="conductor-danger-btn flex items-center gap-1" title="End session for all participants">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                            End
                        </button>
                    </div>
                </div>

            <!-- Pending Changes Card (hidden by default) -->
            <div id="pending-changes-card" class="hidden mt-3 glass border border-violet-500/15 rounded-xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-medium text-white flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                        </svg>
                        <span id="pending-changes-title">Pending Changes</span>
                        <span id="change-progress" class="text-purple-300 text-xs font-normal"></span>
                    </h3>
                    <button id="btn-discard-changes" class="text-gray-400 hover:text-gray-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <!-- Current File Info -->
                <div id="current-file-info" class="text-xs text-blue-300 mb-2 flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                    </svg>
                    <span id="current-file-name"></span>
                </div>

                <!-- Change Stats -->
                <div class="flex items-center gap-4 text-xs text-gray-300 mb-3">
                    <span id="pending-files-count" class="flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                        </svg>
                        <span>1 file</span>
                    </span>
                    <span id="pending-lines-count" class="flex items-center gap-1">
                        <span class="text-green-400">+5</span>
                        <span class="text-red-400">-3</span>
                        <span>lines</span>
                    </span>
                </div>

                <!-- Policy Status -->
                <div id="policy-status" class="flex items-center gap-2 text-xs mb-3">
                    <span id="policy-status-icon" class="inline-block w-2 h-2 rounded-full bg-green-400 online-glow"></span>
                    <span id="policy-status-text" class="text-gray-300">Safe to apply</span>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2">
                    <button
                        id="btn-view-diff"
                        class="flex-1 btn-secondary text-xs px-3 py-2 flex items-center justify-center gap-1"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                        </svg>
                        View Diff
                    </button>
                    <button
                        id="btn-apply-changes"
                        class="flex-1 btn-success text-xs px-3 py-2 flex items-center justify-center gap-1"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Apply
                    </button>
                </div>
            </div>

            <!-- Rebuild workspace index button (shown when session is active) -->
            <div id="rebuild-index-row" class="hidden px-3 pt-1 flex items-center justify-between">
                <span class="text-[0.6rem] text-gray-500">Context index</span>
                <button id="btn-rebuild-index" class="flex items-center gap-1 text-[0.6rem] text-amber-400/80 hover:text-amber-300 transition-colors" title="Delete and rebuild workspace index">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                    </svg>
                    Rebuild Index
                </button>
            </div>

            <!-- Workspace indexing progress bar (hidden by default) -->
            <div id="index-progress-bar" class="hidden px-1 pt-1.5 pb-0.5">
                <div class="flex items-center gap-2">
                    <div class="flex-1 h-1 rounded-full overflow-hidden" style="background:rgba(255,255,255,0.06);">
                        <div id="index-progress-fill" class="h-full rounded-full transition-all duration-300" style="width:0%;background:rgba(139,92,246,0.6);"></div>
                    </div>
                    <span id="index-progress-text" class="text-[0.55rem] text-gray-500 whitespace-nowrap"></span>
                </div>
            </div>
        </header>

        <!-- Chat / Tasks Tab bar — pill segment control -->
        <div class="flex-shrink-0 px-3 py-2" style="background:rgba(10,13,20,0.7);border-bottom:1px solid rgba(255,255,255,0.045);">
            <div class="flex p-0.5 rounded-lg gap-0.5" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);">
                <button id="tab-chat" class="chat-tab active flex-1 text-xs py-1.5 rounded-md font-medium transition-all duration-200 flex items-center justify-center gap-1.5 text-white" style="background:rgba(55,65,81,0.9);box-shadow:0 1px 3px rgba(0,0,0,0.4);">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                    </svg>
                    Chat
                </button>
                <button id="tab-tasks" class="chat-tab flex-1 text-xs py-1.5 rounded-md font-medium transition-all duration-200 flex items-center justify-center gap-1.5 text-gray-500 hover:text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                    </svg>
                    Tasks
                    <span id="todo-count-badge" class="hidden bg-violet-500/80 text-white text-[0.55rem] px-1.5 py-px rounded-full leading-none">0</span>
                </button>
            </div>
        </div>

        <!-- Messages Area - WhatsApp-style scrollable container -->
        <div id="tab-panel-chat" class="relative flex-1 min-h-0">
            <div id="messages-container" class="absolute inset-0 overflow-y-auto overflow-x-hidden px-4 py-3 space-y-2" style="scrollbar-width: thin; scrollbar-color: rgba(139,92,246,0.2) transparent;">
                <!-- Messages will be rendered here by JavaScript -->
                <div id="connection-status" class="flex justify-center">
                    <div class="bg-gray-800/30 text-gray-500 text-xs px-3 py-1.5 rounded-full border border-gray-700/40 shimmer">
                        <span>Connecting to chat...</span>
                    </div>
                </div>
            </div>

            <!-- Workspace scanning overlay (prominent indicator during indexing) -->
            <div id="scanning-overlay" class="hidden absolute inset-0 z-20 flex flex-col items-center justify-center gap-4 px-8" style="background:rgba(8,12,20,0.9);backdrop-filter:blur(6px);">
                <!-- Branch-change banner -->
                <div id="scan-branch-banner" class="hidden w-full max-w-[240px] text-[0.6rem] text-amber-400/80 text-center leading-relaxed rounded-lg px-3 py-2" style="background:rgba(217,119,6,0.06);border:1px solid rgba(217,119,6,0.18);">
                    Branch changed — rebuilding index
                </div>
                <!-- Pulsing ring + spinner -->
                <div class="relative flex items-center justify-center h-16 w-16">
                    <div class="absolute inset-0 rounded-full animate-ping opacity-20" style="background:radial-gradient(circle,rgba(139,92,246,0.5),transparent);animation-duration:2s;"></div>
                    <div class="absolute inset-2 rounded-full" style="border:1px solid rgba(139,92,246,0.25);"></div>
                    <svg id="scan-overlay-spinner" class="h-6 w-6 animate-spin" style="color:rgba(139,92,246,0.8);animation-duration:1.4s;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </div>
                <!-- Phase + detail text -->
                <div class="flex flex-col items-center gap-1.5 text-center">
                    <span id="scan-overlay-phase" class="text-sm font-medium text-gray-200">Building workspace index</span>
                    <span id="scan-overlay-detail" class="text-xs text-gray-500 max-w-[200px] leading-relaxed">Scanning files…</span>
                </div>
                <!-- Progress bar + percentage -->
                <div class="flex flex-col items-center gap-1.5 w-full max-w-[200px]">
                    <div class="w-full h-px rounded-full overflow-hidden" style="background:rgba(255,255,255,0.06);">
                        <div id="scan-overlay-fill" class="h-full rounded-full transition-all duration-300" style="width:0%;background:linear-gradient(90deg,rgba(139,92,246,0.7),rgba(59,130,246,0.5));"></div>
                    </div>
                    <span id="scan-overlay-pct" class="text-[0.55rem] tabular-nums" style="color:rgba(139,92,246,0.5);">0%</span>
                </div>
                <!-- AST-only badge (shown when embedding is disabled) -->
                <div id="scan-mode-badge" class="hidden text-[0.55rem] px-2 py-0.5 rounded-full" style="color:rgba(156,163,175,0.6);background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);">
                    AST only — embedding unavailable
                </div>
            </div>

            <!-- Scroll to bottom button -->
            <button id="scroll-to-bottom" class="hidden absolute bottom-3 right-3 glass text-gray-300 hover:text-white p-2 rounded-full z-10 hover:shadow-[0_0_12px_rgba(139,92,246,0.2)] transition-all" title="Scroll to bottom" style="z-index:10;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                <span id="unread-count" class="hidden absolute -top-1 -right-1 bg-violet-500 text-white text-[0.6rem] rounded-full h-4 w-4 flex items-center justify-center unread-badge">0</span>
            </button>
        </div>

        <!-- TODO / Tasks Tab Panel -->
        <div id="tab-panel-tasks" class="hidden flex-1 min-h-0 flex flex-col overflow-y-auto px-3 py-3 gap-2" style="scrollbar-width:thin; scrollbar-color:rgba(139,92,246,0.2) transparent;">
            <div class="flex items-center justify-between mb-1">
                <div class="flex gap-1">
                    <button data-filter="all" class="todo-filter-btn active text-[0.65rem] px-2 py-1 rounded-full bg-violet-600/20 text-violet-400 border border-violet-600/30">All</button>
                    <button data-filter="open" class="todo-filter-btn text-[0.65rem] px-2 py-1 rounded-full text-gray-500 hover:text-gray-300 border border-gray-700/40">Open</button>
                    <button data-filter="done" class="todo-filter-btn text-[0.65rem] px-2 py-1 rounded-full text-gray-500 hover:text-gray-300 border border-gray-700/40">Done</button>
                </div>
                <button id="btn-add-todo" class="text-xs text-violet-400 hover:text-violet-300 flex items-center gap-1 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Add
                </button>
            </div>
            <!-- Quick add form (hidden by default) -->
            <div id="todo-add-form" class="hidden bg-gray-800/60 rounded-lg p-3 border border-gray-700/40 flex flex-col gap-2">
                <input id="todo-title-input" type="text" placeholder="Task title *" maxlength="200"
                    class="bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-xs text-gray-200 focus:outline-none focus:border-violet-500 w-full" />
                <textarea id="todo-desc-input" rows="2" placeholder="Description (optional) — helps AI understand what to do"
                    class="bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-xs text-gray-400 focus:outline-none focus:border-violet-500 w-full resize-none"></textarea>
                <div class="flex items-center gap-2">
                    <select id="todo-priority-select" class="bg-gray-900 border border-gray-700 rounded-lg px-2 py-1.5 text-xs text-gray-300 focus:outline-none">
                        <option value="high">🔴 High</option>
                        <option value="medium" selected>🟡 Medium</option>
                        <option value="low">🟢 Low</option>
                    </select>
                    <div class="flex gap-1.5 ml-auto">
                        <button id="btn-todo-cancel" class="btn-secondary text-xs px-3 py-1.5">Cancel</button>
                        <button id="btn-todo-save" class="btn-primary text-xs px-3 py-1.5">Add Task</button>
                    </div>
                </div>
            </div>
            <div id="todos-list" class="flex flex-col gap-1.5">
                <div class="text-xs text-gray-600 text-center py-6">No tasks yet. They'll appear here from AI summaries or when you add them manually.</div>
            </div>

            <!-- Workspace TODOs Section -->
            <div class="mt-3 border-t border-gray-700/40 pt-3">
                <div class="flex items-center justify-between mb-2">
                    <button id="btn-toggle-workspace-todos" class="flex items-center gap-1.5 text-xs text-gray-400 hover:text-gray-200 transition-colors">
                        <svg id="workspace-todos-chevron" xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 transition-transform" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-violet-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h7a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <span class="font-medium">Code TODOs</span>
                        <span id="workspace-todo-count" class="hidden text-[0.6rem] bg-violet-600/40 text-violet-300 px-1.5 rounded-full">0</span>
                    </button>
                    <button id="btn-scan-workspace-todos" class="flex items-center gap-1 text-[0.65rem] text-violet-400 hover:text-violet-300 transition-colors" title="Scan workspace for TODO comments">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                        </svg>
                        Scan
                    </button>
                </div>
                <div id="workspace-todos-panel" class="hidden flex flex-col gap-1.5">
                    <div id="workspace-todos-empty" class="text-xs text-gray-600 text-center py-3">
                        Click Scan to find TODO comments in your workspace.<br>
                        <span class="text-gray-700">Format: <code class="text-violet-500">// TODO: title</code> + optional <code class="text-violet-500">// TODO_DESC: description</code></span>
                    </div>
                    <div id="workspace-todos-list" class="flex flex-col gap-1"></div>
                </div>
            </div>

            <!-- Edit Workspace TODO Modal -->
            <div id="workspace-todo-edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 w-[90%] max-w-sm shadow-2xl flex flex-col gap-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-200">Edit Code TODO</span>
                        <button id="btn-close-workspace-todo-modal" class="text-gray-500 hover:text-white p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                    <div id="workspace-todo-edit-location" class="text-[0.65rem] text-gray-500 font-mono truncate"></div>
                    <input id="workspace-todo-edit-title" type="text" maxlength="200"
                        placeholder="Task title *"
                        class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-xs text-gray-200 focus:outline-none focus:border-violet-500 w-full"/>
                    <textarea id="workspace-todo-edit-desc" rows="3"
                        placeholder="Description (optional) — uses // TODO_DESC: comment"
                        class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-xs text-gray-400 focus:outline-none focus:border-violet-500 w-full resize-none"></textarea>
                    <div class="flex gap-2 justify-end">
                        <button id="btn-workspace-todo-cancel" class="btn-secondary text-xs px-3 py-1.5">Cancel</button>
                        <button id="btn-workspace-todo-save" class="btn-primary text-xs px-3 py-1.5">Save to file</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rebuild Index Confirmation Modal -->
        <div id="rebuild-index-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
            <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 w-[90%] max-w-sm shadow-2xl flex flex-col gap-3">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-200">Rebuild Workspace Index?</span>
                    <button id="btn-close-rebuild-modal" class="text-gray-500 hover:text-white p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
                <p class="text-xs text-gray-400 leading-relaxed">
                    This will delete all cached embeddings, LSP data, and file metadata,
                    then re-scan and re-embed the workspace. Embedding API calls will be
                    re-issued. This may take a while depending on workspace size.
                </p>
                <div class="flex gap-2 justify-end">
                    <button id="btn-rebuild-cancel" class="btn-secondary text-xs px-3 py-1.5">Cancel</button>
                    <button id="btn-rebuild-confirm" class="text-xs px-3 py-1.5 rounded-lg font-medium text-white transition-colors" style="background:rgba(217,119,6,0.7);">Rebuild</button>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="hidden flex-shrink-0 px-6 py-2 text-xs text-gray-400">
            <span id="typing-text" class="flex items-center gap-1.5">Someone is typing<span class="typing-dots"><span></span><span></span><span></span></span></span>
        </div>

        <!-- Input Area -->
        <div class="flex-shrink-0 glass px-5 py-3" style="border-top: 1px solid; border-image: linear-gradient(90deg, transparent, rgba(139,92,246,0.12), transparent) 1;">
            <!-- Hidden file input -->
            <input type="file" id="file-input" class="hidden"
                   accept="image/*,.pdf,audio/*,.mp3,.wav,.ogg,.m4a,.flac" />

            <!-- File preview area (shown when file is selected) -->
            <div id="file-preview" class="hidden mb-3 p-3 bg-gray-900/60 rounded-xl border border-gray-700/40">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span id="file-preview-icon" class="text-2xl">📎</span>
                        <div>
                            <div id="file-preview-name" class="text-sm text-gray-200 font-medium"></div>
                            <div id="file-preview-size" class="text-xs text-gray-500"></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="btn-upload-file" class="btn-success text-sm px-3 py-1.5">
                            Upload
                        </button>
                        <button id="btn-remove-file" class="text-gray-400 hover:text-red-400 p-1 transition-colors" title="Cancel">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                <img id="file-preview-img" class="hidden mt-3 max-h-32 rounded-lg" />
                <div class="mt-2">
                    <input type="text" id="file-caption" placeholder="Add a caption (optional)..."
                           class="input-premium w-full text-sm px-3 py-1.5" />
                </div>
            </div>

            <!-- Code Snippet Preview (shown when code is attached) -->
            <div id="code-snippet-preview" class="hidden mb-2 bg-gray-900/60 border border-gray-700/40 rounded-xl overflow-hidden">
                <div class="flex items-center justify-between px-3 py-1.5 bg-gray-800/50 border-b border-gray-700/30">
                    <div class="flex items-center gap-2 min-w-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-violet-400 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        <span id="code-snippet-filename" class="text-xs text-gray-300 font-mono truncate max-w-[140px]"></span>
                        <span id="code-snippet-lines" class="text-xs text-gray-500 flex-shrink-0"></span>
                        <span id="code-snippet-stats" class="text-[0.6rem] text-gray-600 flex-shrink-0"></span>
                    </div>
                    <div class="flex items-center gap-1 flex-shrink-0">
                        <button id="btn-toggle-snippet" class="text-[0.6rem] text-gray-500 hover:text-gray-300 px-1.5 py-0.5 rounded transition-colors" title="Expand/collapse preview">▼</button>
                        <button id="btn-clear-snippet" class="text-gray-400 hover:text-white p-1 transition-colors" title="Remove code snippet">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- Preview body: capped at 5 lines (~80px), collapsible -->
                <div id="code-snippet-body" class="overflow-hidden" style="max-height: 80px;">
                    <pre id="code-snippet-content" class="code-snippet-plain px-3 py-2 text-xs font-mono text-gray-300 overflow-x-auto overflow-y-hidden whitespace-pre"></pre>
                </div>
            </div>

            <div id="input-wrapper" class="flex items-end gap-2">
                <!-- Attachment Button -->
                <button
                    id="btn-attach"
                    class="text-gray-500 hover:text-violet-400 p-2.5 rounded-lg hover:bg-violet-500/10 transition-all duration-200 focus:outline-none"
                    title="Attach file (images, PDF, audio, max 20MB)"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clip-rule="evenodd" />
                    </svg>
                </button>

                <!-- Code Snippet Button -->
                <button
                    id="btn-code-snippet"
                    class="text-gray-500 hover:text-violet-400 p-2.5 rounded-lg hover:bg-violet-500/10 transition-all duration-200 focus:outline-none"
                    title="Share code from editor (select code first)"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>

                <!-- Stack Trace Button -->
                <button
                    id="btn-stack-trace"
                    class="text-gray-500 hover:text-red-400 p-2.5 rounded-lg hover:bg-red-500/10 transition-all duration-200 focus:outline-none"
                    title="Share a stack trace"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </button>

                <!-- Text Input -->
                <div class="flex-1">
                    <textarea
                        id="chat-input"
                        rows="1"
                        placeholder="Type a message..."
                        class="input-premium w-full px-4 py-2.5 resize-none text-sm"
                    ></textarea>
                </div>

                <!-- Send Button -->
                <button
                    id="btn-send"
                    class="btn-primary px-5 py-2.5 flex items-center gap-2 focus:outline-none"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                    <span class="text-sm">Send</span>
                </button>
            </div>

            <!-- Helper Text -->
            <div class="mt-1.5 text-[0.65rem] text-gray-600">
                Enter to send &middot; Shift+Enter for new line &middot; <span class="text-violet-400/60">&lt;/&gt;</span> share code
            </div>
        </div>
        </div> <!-- close chat content column -->

        <!-- Users Sidebar (inside panel-chat) -->
        <aside id="sidebar" class="w-52 sidebar-premium flex-shrink-0 hidden md:flex flex-col" style="border-left: 1px solid; border-image: linear-gradient(180deg, rgba(139,92,246,0.15), rgba(99,102,241,0.04), transparent) 1;">
            <div class="px-4 py-3">
                <div class="flex items-center justify-between">
                    <h2 class="text-[0.6rem] font-semibold text-gray-500 uppercase tracking-widest">Participants</h2>
                    <span id="user-count" class="text-[0.6rem] text-gray-500 bg-gray-800/60 px-1.5 py-0.5 rounded-full font-medium">0</span>
                </div>
            </div>
            <div class="mx-4 mb-2" style="height:1px;background:linear-gradient(90deg,transparent,rgba(139,92,246,0.12),transparent);"></div>
            <div id="users-list" class="flex-1 overflow-y-auto px-2 py-1 space-y-0.5">
                <!-- Users will be rendered here -->
            </div>
        </aside>
        </div> <!-- close panel-chat -->
    </div> <!-- close main area flex-col -->
    </div> <!-- close outer flex h-full -->

    <!-- ============================================================ -->
    <!-- AI Configuration Modal                                        -->
    <!-- ============================================================ -->
    <div id="ai-config-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <!-- Backdrop -->
        <div id="ai-config-backdrop" class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <!-- Modal Content -->
        <div class="relative glass rounded-xl shadow-2xl shadow-black/50 w-full max-w-md mx-4 modal-enter">
            <!-- Header -->
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-700/50 bg-gradient-to-r from-gray-800/80 to-gray-800/40">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                    </svg>
                    AI Configuration
                </h3>
                <button id="btn-close-ai-config" class="text-gray-400 hover:text-white p-1 rounded transition-all modal-close-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <!-- Body -->
            <div class="px-5 py-4 space-y-4">
                <!-- Loading State -->
                <div id="ai-config-loading" class="hidden flex items-center justify-center py-8">
                    <div class="h-6 w-6 border-2 border-purple-400 border-t-transparent rounded-full animate-spin"></div>
                    <span class="ml-3 text-gray-400 text-sm">Loading AI status...</span>
                </div>
                <!-- Error State -->
                <div id="ai-config-error" class="hidden bg-red-900/30 border border-red-700 rounded-lg p-3">
                    <p class="text-red-400 text-sm" id="ai-config-error-text">Failed to fetch AI status</p>
                </div>
                <!-- Content -->
                <div id="ai-config-content" class="hidden space-y-4">
                    <!-- AI Summary Toggle Section -->
                    <div class="bg-gray-900/50 rounded-lg border border-gray-700 p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div id="ai-summary-icon" class="h-10 w-10 rounded-full flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div>
                                    <span class="text-white text-sm font-medium block">AI Distillation</span>
                                    <span id="ai-summary-status-text" class="text-xs text-gray-400">Checking status...</span>
                                </div>
                            </div>
                            <span id="ai-summary-enabled" class="px-3 py-1 rounded-full text-xs font-medium"></span>
                        </div>
                    </div>

                    <!-- Model Selection Dropdown -->
                    <div class="bg-purple-900/20 rounded-lg border border-purple-700/50 p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-purple-300 text-xs font-medium uppercase tracking-wide">Active Model</span>
                        </div>
                        <select id="ai-model-select" class="w-full bg-gray-900 border border-gray-600 text-white text-sm rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            <option value="">No models available</option>
                        </select>
                        <p id="ai-model-select-hint" class="text-xs text-gray-500 mt-2">Select a model to use for AI summarization</p>
                    </div>

                    <!-- Provider Health List -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-300 text-sm font-medium">Provider Health Status</span>
                            <span id="ai-last-updated" class="text-xs text-gray-500"></span>
                        </div>
                        <div id="ai-providers-list" class="bg-gray-900/50 rounded-lg border border-gray-700 divide-y divide-gray-700">
                            <!-- Provider rows will be inserted here -->
                        </div>
                        <p id="ai-no-providers" class="hidden text-gray-500 text-xs italic py-2">No providers configured</p>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div class="px-5 py-4 border-t border-gray-700 flex justify-end gap-2">
                <button
                    id="btn-refresh-ai-status"
                    class="btn-primary text-sm px-4 py-2 flex items-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                    </svg>
                    Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- Room Settings Modal                                           -->
    <!-- ============================================================ -->
    <div id="room-settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <!-- Backdrop -->
        <div id="room-settings-backdrop" class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <!-- Modal Content -->
        <div class="relative glass rounded-xl shadow-2xl shadow-black/50 w-full max-w-md mx-4 modal-enter">
            <!-- Header -->
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-700/50 bg-gradient-to-r from-gray-800/80 to-gray-800/40">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                    </svg>
                    Room Settings
                </h3>
                <button id="btn-close-room-settings" class="text-gray-400 hover:text-white p-1 rounded transition-all modal-close-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <!-- Body -->
            <div class="px-5 py-4 space-y-4">
                <!-- Loading State -->
                <div id="room-settings-loading" class="hidden flex items-center justify-center py-8">
                    <div class="h-6 w-6 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                    <span class="ml-3 text-gray-400 text-sm">Loading settings...</span>
                </div>
                <!-- Error State -->
                <div id="room-settings-error" class="hidden bg-red-900/30 border border-red-700 rounded-lg p-3">
                    <p class="text-red-400 text-sm" id="room-settings-error-text">Failed to fetch settings</p>
                </div>
                <!-- Content -->
                <div id="room-settings-content" class="hidden space-y-4">
                    <!-- Template Picker -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Load from Template</label>
                        <div class="flex gap-2">
                            <select id="style-template-select" class="flex-1 bg-gray-900 border border-gray-600 text-gray-100 text-sm rounded-lg px-3 py-2 focus:ring-2 focus:ring-violet-500 focus:border-violet-500">
                                <option value="">-- Select a template --</option>
                            </select>
                            <button id="btn-load-template" class="btn-primary text-sm px-3 py-2 whitespace-nowrap">
                                Load
                            </button>
                        </div>
                    </div>
                    <!-- Output Mode Dropdown -->
                    <div>
                        <label for="room-output-mode" class="block text-sm font-medium text-gray-300 mb-2">Code Prompt Output Mode</label>
                        <select id="room-output-mode" class="w-full bg-gray-900 border border-gray-600 text-gray-100 text-sm rounded-lg px-3 py-2 focus:ring-2 focus:ring-violet-500 focus:border-violet-500">
                            <option value="">Server Default</option>
                            <option value="unified_diff">Unified Diff — git-apply patches only</option>
                            <option value="direct_repo_edits">Direct Repo Edits — full file contents, run tests</option>
                            <option value="plan_then_diff">Plan then Diff — implementation plan + patches</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Controls the output format in AI-generated code prompts for this room.</p>
                    </div>
                    <!-- Code Style Textarea with header row -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <label for="room-code-style" class="block text-sm font-medium text-gray-300">Code Style Guidelines</label>
                                <span id="style-source-badge" class="hidden text-xs px-2 py-0.5 rounded-full font-medium">Default</span>
                            </div>
                            <button id="btn-toggle-preview" class="text-xs text-violet-400 hover:text-violet-300 transition-colors">Preview</button>
                        </div>
                        <textarea
                            id="room-code-style"
                            rows="8"
                            class="w-full bg-gray-900 border border-gray-600 text-gray-100 text-sm rounded-lg px-3 py-2 focus:ring-2 focus:ring-violet-500 focus:border-violet-500 font-mono resize-y"
                            placeholder="Enter code style guidelines for this room (e.g., indentation rules, naming conventions, patterns to follow)..."
                        ></textarea>
                        <div id="style-preview" class="hidden w-full bg-gray-900 border border-gray-600 text-gray-100 text-sm rounded-lg px-3 py-2 font-mono overflow-y-auto" style="min-height: 12rem; max-height: 20rem;"></div>
                        <p class="text-xs text-gray-500 mt-1">These guidelines will be included in AI-generated code prompts for this room.</p>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div id="room-settings-footer" class="hidden flex items-center justify-end gap-3 px-5 py-4 border-t border-gray-700">
                <button id="btn-cancel-room-settings" class="text-gray-400 hover:text-white text-sm px-4 py-2 rounded-lg transition-colors">
                    Cancel
                </button>
                <button id="btn-save-room-settings" class="btn-primary text-sm px-4 py-2">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- Summarize Options Modal                                       -->
    <!-- ============================================================ -->
    <div id="summarize-options-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <!-- Backdrop -->
        <div id="summarize-options-backdrop" class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <!-- Modal Content -->
        <div class="relative glass rounded-xl shadow-2xl shadow-black/50 w-full max-w-md mx-4 modal-enter">
            <!-- Header -->
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-700/50 bg-gradient-to-r from-gray-800/80 to-gray-800/40">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                    </svg>
                    Distill Conversation
                </h3>
                <button id="btn-close-summarize-options" class="text-gray-400 hover:text-white p-1 rounded transition-all modal-close-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <!-- Body -->
            <div class="px-5 py-4 space-y-4">
                <p class="text-gray-300 text-sm">How would you like to distill the conversation?</p>

                <!-- Option: Summarize All -->
                <button id="btn-summarize-all" class="w-full btn-primary text-sm px-4 py-3 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                    </svg>
                    <div class="text-left">
                        <span class="block font-medium">Distill All Messages</span>
                        <span id="summarize-all-count" class="text-xs text-purple-200">0 messages</span>
                    </div>
                </button>

                <!-- Option: Select Messages -->
                <button id="btn-summarize-select" class="w-full btn-secondary text-sm px-4 py-3 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    <div class="text-left">
                        <span class="block font-medium">Select Messages to Distill</span>
                        <span class="text-xs text-gray-400">Choose specific messages</span>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- Message Selection Modal                                       -->
    <!-- ============================================================ -->
    <div id="message-selection-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <!-- Backdrop -->
        <div id="message-selection-backdrop" class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <!-- Modal Content -->
        <div class="relative glass rounded-xl shadow-2xl shadow-black/50 w-full max-w-lg mx-4 max-h-[80vh] flex flex-col modal-enter">
            <!-- Header -->
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-700 flex-shrink-0">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    Select Messages
                </h3>
                <button id="btn-close-message-selection" class="text-gray-400 hover:text-white p-1 rounded transition-all modal-close-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <!-- Selection controls -->
            <div class="px-5 py-3 border-b border-gray-700 flex items-center justify-between flex-shrink-0">
                <div class="flex items-center gap-3">
                    <button id="btn-select-all-messages" class="text-xs text-purple-400 hover:text-purple-300 transition-colors">Select All</button>
                    <span class="text-gray-600">|</span>
                    <button id="btn-deselect-all-messages" class="text-xs text-gray-400 hover:text-gray-300 transition-colors">Deselect All</button>
                </div>
                <span id="selected-messages-count" class="text-xs text-gray-400">0 selected</span>
            </div>
            <!-- Message list (scrollable) -->
            <div id="message-selection-list" class="px-5 py-3 overflow-y-auto flex-1 space-y-2">
                <!-- Messages will be populated here -->
            </div>
            <!-- Footer -->
            <div class="px-5 py-4 border-t border-gray-700 flex justify-end gap-3 flex-shrink-0">
                <button id="btn-cancel-message-selection" class="px-4 py-2 text-sm text-gray-400 hover:text-white transition-colors">
                    Cancel
                </button>
                <button id="btn-confirm-message-selection" class="px-4 py-2 btn-primary disabled:opacity-40 disabled:cursor-not-allowed text-sm">
                    Distill Selected
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- AI Summary Results Modal                                      -->
    <!-- ============================================================ -->
    <div id="summary-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <!-- Backdrop -->
        <div id="summary-modal-backdrop" class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <!-- Modal Content -->
        <div class="relative glass rounded-xl shadow-2xl shadow-black/50 w-full max-w-lg mx-4 max-h-[90vh] flex flex-col modal-enter">
            <!-- Header -->
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-700 flex-shrink-0">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-violet-400" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z"/>
                    </svg>
                    AI Distillation
                </h3>
                <button id="btn-close-summary" class="text-gray-400 hover:text-white p-1 rounded transition-all modal-close-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <!-- Body (scrollable) -->
            <div class="px-5 py-4 space-y-4 overflow-y-auto flex-1">
                <!-- Loading State -->
                <div id="summary-loading" class="hidden flex flex-col items-center justify-center py-8 gap-3">
                    <div class="ai-thinking-dots"><span></span><span></span><span></span></div>
                    <span class="text-gray-400 text-sm">Distilling conversation...</span>
                </div>
                <!-- Error State -->
                <div id="summary-error" class="hidden bg-red-900/30 border border-red-700 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        <span class="text-red-400 font-medium">Distillation Failed</span>
                    </div>
                    <p class="text-red-300 text-sm" id="summary-error-text">Unable to distill conversation.</p>
                </div>
                <!-- Summary Content -->
                <div id="summary-content" class="hidden space-y-4">
                    <!-- Topic -->
                    <div>
                        <h4 class="text-[0.65rem] font-medium text-gray-400 uppercase tracking-wider mb-1">Topic</h4>
                        <p id="summary-topic" class="text-white text-sm"></p>
                    </div>
                    <!-- Problem Statement -->
                    <div>
                        <h4 class="text-[0.65rem] font-medium text-gray-400 uppercase tracking-wider mb-1">Problem</h4>
                        <p id="summary-problem" class="text-gray-200 text-sm"></p>
                    </div>
                    <!-- Proposed Solution -->
                    <div>
                        <h4 class="text-[0.65rem] font-medium text-gray-400 uppercase tracking-wider mb-1">Proposed Solution</h4>
                        <p id="summary-solution" class="text-gray-200 text-sm"></p>
                    </div>
                    <!-- Risk Level -->
                    <div class="flex items-center gap-3">
                        <h4 class="text-[0.65rem] font-medium text-gray-400 uppercase tracking-wider">Risk Level</h4>
                        <span id="summary-risk" class="px-2 py-0.5 rounded text-xs font-medium"></span>
                    </div>
                    <!-- Affected Components -->
                    <div id="summary-components-section">
                        <h4 class="text-[0.65rem] font-medium text-gray-400 uppercase tracking-wider mb-2">Affected Components</h4>
                        <div id="summary-components" class="flex flex-wrap gap-1"></div>
                    </div>
                    <!-- Next Steps -->
                    <div id="summary-steps-section">
                        <h4 class="text-[0.65rem] font-medium text-gray-400 uppercase tracking-wider mb-2">Next Steps</h4>
                        <ul id="summary-steps" class="text-sm text-gray-200 list-disc list-inside space-y-1"></ul>
                    </div>
                    <!-- Code Change Required Section -->
                    <div id="summary-code-change-section" class="hidden mt-4 p-4 bg-purple-900/30 border border-purple-700 rounded-lg">
                        <div class="flex items-center gap-2 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-purple-300 font-medium text-sm">This decision includes code changes.</span>
                        </div>

                        <!-- Initial state: Generate button -->
                        <div id="code-prompt-initial" class="">
                            <p class="text-gray-300 text-xs mb-3">Generate a coding prompt?</p>
                            <button id="btn-generate-code-prompt" class="w-full btn-primary text-sm px-4 py-2 flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                <span id="btn-generate-code-prompt-text">Generate Coding Prompt</span>
                            </button>
                        </div>

                        <!-- Loading state -->
                        <div id="code-prompt-loading" class="hidden flex items-center justify-center py-4">
                            <div class="h-5 w-5 border-2 border-purple-400 border-t-transparent rounded-full animate-spin"></div>
                            <span class="ml-2 text-gray-400 text-sm">Generating prompt...</span>
                        </div>

                        <!-- Error state -->
                        <div id="code-prompt-error" class="hidden bg-red-900/30 border border-red-700 rounded-lg p-3 mt-2">
                            <p class="text-red-300 text-xs" id="code-prompt-error-text">Failed to generate code prompt.</p>
                        </div>

                        <!-- Result state: Code prompt display -->
                        <div id="code-prompt-result" class="hidden mt-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-medium text-gray-400">Generated Coding Prompt</span>
                                <button id="btn-copy-code-prompt" class="text-xs text-purple-400 hover:text-purple-300 flex items-center gap-1 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                                    </svg>
                                    <span id="btn-copy-code-prompt-text">Copy</span>
                                </button>
                            </div>
                            <textarea id="code-prompt-textarea" readonly class="w-full h-40 bg-gray-900 border border-gray-700 rounded-lg p-3 text-xs text-gray-200 font-mono resize-none focus:outline-none focus:border-purple-500"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div class="px-5 py-4 border-t border-gray-700 flex justify-end flex-shrink-0">
                <button id="btn-dismiss-summary" class="btn-secondary text-sm px-4 py-2">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- Stack Trace Share Modal                                       -->
    <!-- ============================================================ -->
    <div id="stack-trace-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" id="stack-trace-backdrop"></div>
        <div class="relative z-10 w-[90%] max-w-lg bg-gray-900 border border-red-800/40 rounded-xl shadow-2xl flex flex-col max-h-[85vh]">
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-700 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    <h3 class="text-sm font-semibold text-white">Share Stack Trace</h3>
                </div>
                <button id="btn-close-stack-trace-modal" class="text-gray-500 hover:text-gray-300 p-1 rounded transition-colors">✕</button>
            </div>
            <div class="px-5 py-4 flex-1 overflow-y-auto flex flex-col gap-3">
                <p class="text-xs text-gray-400">Paste your stack trace below. Frames will be rendered as clickable links for your team.</p>
                <div id="stack-trace-tabs" class="flex gap-1 bg-gray-800/50 rounded-lg p-1">
                    <button data-tab="paste" class="stack-tab flex-1 text-xs py-1.5 rounded-md text-white bg-gray-700 transition-all">Paste Trace</button>
                    <button data-tab="test" class="stack-tab flex-1 text-xs py-1.5 rounded-md text-gray-400 hover:text-gray-200 transition-all">Test Output</button>
                    <button data-tab="vscode" class="stack-tab flex-1 text-xs py-1.5 rounded-md text-gray-400 hover:text-gray-200 transition-all">VS Code Tests</button>
                </div>
                <!-- Paste tab -->
                <div id="stack-tab-paste" class="flex flex-col gap-2">
                    <textarea id="stack-trace-input" rows="10"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-xs text-gray-200 font-mono resize-none focus:outline-none focus:border-red-500"
                        placeholder="Traceback (most recent call last):&#10;  File &quot;app/service.py&quot;, line 42, in process&#10;    result = data.split(',')&#10;AttributeError: 'NoneType' object has no attribute 'split'">
                    </textarea>
                </div>
                <!-- Test output tab -->
                <div id="stack-tab-test" class="hidden flex-col gap-2">
                    <select id="test-framework-select" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-xs text-gray-300 focus:outline-none focus:border-red-500">
                        <option value="pytest">pytest</option>
                        <option value="jest">Jest</option>
                        <option value="go">Go test</option>
                        <option value="unknown">Other</option>
                    </select>
                    <textarea id="test-output-input" rows="10"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-xs text-gray-200 font-mono resize-none focus:outline-none focus:border-red-500"
                        placeholder="Paste test output here...">
                    </textarea>
                </div>
                <!-- VS Code test panel tab -->
                <div id="stack-tab-vscode" class="hidden flex-col gap-3">
                    <p class="text-xs text-gray-400">Share failing tests from VS Code's Test Explorer panel.</p>
                    <button id="btn-collect-vscode-tests" class="btn-secondary text-xs py-2">Collect Failing Tests from Test Explorer</button>
                    <div id="vscode-tests-preview" class="hidden text-xs text-gray-300 bg-gray-800 rounded-lg p-3 font-mono max-h-40 overflow-y-auto"></div>
                </div>
                <div id="stack-trace-error" class="hidden text-xs text-red-400 bg-red-900/20 border border-red-800/40 rounded-lg px-3 py-2"></div>
            </div>
            <div class="px-5 py-4 border-t border-gray-700 flex gap-2 justify-end flex-shrink-0">
                <button id="btn-cancel-stack-trace" class="btn-secondary text-sm px-4 py-2">Cancel</button>
                <button id="btn-send-stack-trace" class="btn-primary text-sm px-4 py-2 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                    Share
                </button>
            </div>
        </div>
    </div>

    <script>
        // VS Code API for communication with the extension
        const vscode = acquireVsCodeApi();

        // Session state (injected by extension)
        let session = window.initialSession || { roomId: null, hostId: null, userId: null, createdAt: null, backendUrl: 'http://localhost:8000', displayName: 'Host', leadId: null };
        console.log('[WebView] Session initialized:', session.roomId ? `roomId=${session.roomId}, userId=${session.userId}` : 'no session');

        // Conductor FSM state (injected by extension)
        let conductorState = window.initialConductorState || 'Idle';
        console.log('[WebView] Conductor state:', conductorState);

        // Users map: userId -> user info
        const usersMap = new Map();

        // Display roomId in the header (truncated for readability)
        const roomIdDisplay = document.getElementById('room-id-display');
        if (roomIdDisplay && session.roomId) {
            roomIdDisplay.textContent = session.roomId.substring(0, 8) + '...';
            roomIdDisplay.title = session.roomId; // Full ID on hover
        }

        // State
        let pendingChangeSet = null;
        let policyResult = null;
        let autoApplyEnabled = false;
        let currentChange = null;
        let currentChangeIndex = 0;
        let totalChanges = 0;

        // WebSocket state
        let ws = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;
        const BASE_RECONNECT_DELAY_MS = 1000;
        const MAX_RECONNECT_DELAY_MS = 30000;

        // Message recovery & deduplication
        let lastMessageTimestamp = 0;
        const seenMessageIds = new Set();

        // Chat messages storage for summarization
        // Each message: { role: 'host'|'engineer', text: string, timestamp: number }
        const chatMessages = [];

        // DOM elements
        const roleBadge = document.getElementById('role-badge');
        const leadActions = document.getElementById('lead-actions');
        const btnCreateSummary = document.getElementById('btn-create-summary');
        const autoApplyToggleContainer = document.getElementById('auto-apply-toggle-container');
        const autoApplyToggle = document.getElementById('auto-apply-toggle');
        const pendingChangesCard = document.getElementById('pending-changes-card');
        const pendingFilesCount = document.getElementById('pending-files-count');
        const pendingLinesCount = document.getElementById('pending-lines-count');
        const policyStatus = document.getElementById('policy-status');
        const policyStatusIcon = document.getElementById('policy-status-icon');
        const policyStatusText = document.getElementById('policy-status-text');
        const btnViewDiff = document.getElementById('btn-view-diff');
        const btnApplyChanges = document.getElementById('btn-apply-changes');
        const btnDiscardChanges = document.getElementById('btn-discard-changes');
        const changeProgress = document.getElementById('change-progress');
        const currentFileInfo = document.getElementById('current-file-info');
        const currentFileName = document.getElementById('current-file-name');
        const messagesContainer = document.getElementById('messages-container');
        const connectionStatus = document.getElementById('connection-status');
        const chatInput = document.getElementById('chat-input');
        const btnSend = document.getElementById('btn-send');
        const btnCopyRoomId = document.getElementById('btn-copy-room-id');
        const btnEndChat = document.getElementById('btn-end-chat');
        const usersList = document.getElementById('users-list');
        const userCount = document.getElementById('user-count');

        // State panels (render() toggles these)
        const panelIdle = document.getElementById('panel-idle');
        const panelDisconnected = document.getElementById('panel-disconnected');
        const panelReady = document.getElementById('panel-ready');
        const panelJoining = document.getElementById('panel-joining');
        const panelChat = document.getElementById('panel-chat');
        const hostingControls = document.getElementById('hosting-controls');
        const joinedControls = document.getElementById('joined-controls');

        // Buttons inside state panels
        const btnIdleStart = document.getElementById('btn-idle-start');
        const btnIdleJoin = document.getElementById('btn-idle-join');
        const btnRetry = document.getElementById('btn-retry');
        const btnStartSession = document.getElementById('btn-start-session');
        const btnReadyJoin = document.getElementById('btn-ready-join');
        const readyInviteUrlInput = document.getElementById('ready-invite-url-input');
        const btnDisconnectedJoin = document.getElementById('btn-disconnected-join');
        const disconnectedInviteUrlInput = document.getElementById('disconnected-invite-url-input');
        const btnStopSession = document.getElementById('btn-stop-session');
        const btnCopyInvite = document.getElementById('btn-copy-invite');
        const inviteUrlInput = document.getElementById('invite-url-input');
        const btnLeaveSession = document.getElementById('btn-leave-session');

        // File upload elements
        // Note: fileInput, filePreview, btnAttach are stable (never replaced).
        // The others are inside filePreview and get destroyed by showDuplicatePrompt(),
        // so we use let and re-query them after restoreFilePreviewUI().
        const fileInput = document.getElementById('file-input');
        const filePreview = document.getElementById('file-preview');
        let filePreviewIcon = document.getElementById('file-preview-icon');
        let filePreviewName = document.getElementById('file-preview-name');
        let filePreviewSize = document.getElementById('file-preview-size');
        let filePreviewImg = document.getElementById('file-preview-img');
        let fileCaption = document.getElementById('file-caption');
        const btnAttach = document.getElementById('btn-attach');
        let btnRemoveFile = document.getElementById('btn-remove-file');
        let btnUploadFile = document.getElementById('btn-upload-file');

        // Code snippet elements
        const btnCodeSnippet = document.getElementById('btn-code-snippet');
        const codeSnippetPreview = document.getElementById('code-snippet-preview');
        const codeSnippetFilename = document.getElementById('code-snippet-filename');
        const codeSnippetLines = document.getElementById('code-snippet-lines');
        const codeSnippetContent = document.getElementById('code-snippet-content');
        const btnClearSnippet = document.getElementById('btn-clear-snippet');

        // AI Config modal elements
        const aiConfigModal = document.getElementById('ai-config-modal');
        const aiConfigBackdrop = document.getElementById('ai-config-backdrop');
        const btnAiConfig = document.getElementById('btn-ai-config');
        const btnCloseAiConfig = document.getElementById('btn-close-ai-config');
        const btnRefreshAiStatus = document.getElementById('btn-refresh-ai-status');
        const aiConfigLoading = document.getElementById('ai-config-loading');
        const aiConfigError = document.getElementById('ai-config-error');
        const aiConfigErrorText = document.getElementById('ai-config-error-text');
        const aiConfigContent = document.getElementById('ai-config-content');
        const aiSummaryEnabled = document.getElementById('ai-summary-enabled');
        const aiSummaryIcon = document.getElementById('ai-summary-icon');
        const aiSummaryStatusText = document.getElementById('ai-summary-status-text');
        const aiModelSelect = document.getElementById('ai-model-select');
        const aiModelSelectHint = document.getElementById('ai-model-select-hint');
        const aiLastUpdated = document.getElementById('ai-last-updated');
        const aiProvidersList = document.getElementById('ai-providers-list');
        const aiNoProviders = document.getElementById('ai-no-providers');

        // Track models state
        let aiModelsState = [];
        let aiActiveModelState = null;

        // Room Settings modal elements
        const roomSettingsModal = document.getElementById('room-settings-modal');
        const roomSettingsBackdrop = document.getElementById('room-settings-backdrop');
        const btnRoomSettings = document.getElementById('btn-room-settings');
        const btnCloseRoomSettings = document.getElementById('btn-close-room-settings');
        const btnCancelRoomSettings = document.getElementById('btn-cancel-room-settings');
        const btnSaveRoomSettings = document.getElementById('btn-save-room-settings');
        const roomSettingsLoading = document.getElementById('room-settings-loading');
        const roomSettingsError = document.getElementById('room-settings-error');
        const roomSettingsErrorText = document.getElementById('room-settings-error-text');
        const roomSettingsContent = document.getElementById('room-settings-content');
        const roomSettingsFooter = document.getElementById('room-settings-footer');
        const roomCodeStyleTextarea = document.getElementById('room-code-style');
        const roomOutputModeSelect = document.getElementById('room-output-mode');
        const styleTemplateSelect = document.getElementById('style-template-select');
        const btnLoadTemplate = document.getElementById('btn-load-template');
        const btnTogglePreview = document.getElementById('btn-toggle-preview');
        const stylePreview = document.getElementById('style-preview');
        const styleSourceBadge = document.getElementById('style-source-badge');
        let styleTemplatesCache = [];

        // AI Summarize elements

        // Summary modal elements
        const summaryModal = document.getElementById('summary-modal');
        const summaryModalBackdrop = document.getElementById('summary-modal-backdrop');
        const btnCloseSummary = document.getElementById('btn-close-summary');
        const btnDismissSummary = document.getElementById('btn-dismiss-summary');
        const summaryLoading = document.getElementById('summary-loading');
        const summaryError = document.getElementById('summary-error');
        const summaryErrorText = document.getElementById('summary-error-text');
        const summaryContent = document.getElementById('summary-content');
        const summaryTopic = document.getElementById('summary-topic');
        const summaryProblem = document.getElementById('summary-problem');
        const summarySolution = document.getElementById('summary-solution');
        const summaryRisk = document.getElementById('summary-risk');
        const summaryComponents = document.getElementById('summary-components');
        const summaryComponentsSection = document.getElementById('summary-components-section');
        const summarySteps = document.getElementById('summary-steps');
        const summaryStepsSection = document.getElementById('summary-steps-section');
        const summaryCodeChangeSection = document.getElementById('summary-code-change-section');
        const btnGenerateCodePrompt = document.getElementById('btn-generate-code-prompt');
        const btnGenerateCodePromptText = document.getElementById('btn-generate-code-prompt-text');
        const codePromptInitial = document.getElementById('code-prompt-initial');
        const codePromptLoading = document.getElementById('code-prompt-loading');
        const codePromptError = document.getElementById('code-prompt-error');
        const codePromptErrorText = document.getElementById('code-prompt-error-text');
        const codePromptResult = document.getElementById('code-prompt-result');
        const codePromptTextarea = document.getElementById('code-prompt-textarea');
        const btnCopyCodePrompt = document.getElementById('btn-copy-code-prompt');
        const btnCopyCodePromptText = document.getElementById('btn-copy-code-prompt-text');

        // Summarize options modal elements
        const summarizeOptionsModal = document.getElementById('summarize-options-modal');
        const summarizeOptionsBackdrop = document.getElementById('summarize-options-backdrop');
        const btnCloseSummarizeOptions = document.getElementById('btn-close-summarize-options');
        const btnSummarizeAll = document.getElementById('btn-summarize-all');
        const btnSummarizeSelect = document.getElementById('btn-summarize-select');
        const summarizeAllCount = document.getElementById('summarize-all-count');

        // Message selection modal elements
        const messageSelectionModal = document.getElementById('message-selection-modal');
        const messageSelectionBackdrop = document.getElementById('message-selection-backdrop');
        const btnCloseMessageSelection = document.getElementById('btn-close-message-selection');
        const btnSelectAllMessages = document.getElementById('btn-select-all-messages');
        const btnDeselectAllMessages = document.getElementById('btn-deselect-all-messages');
        const selectedMessagesCount = document.getElementById('selected-messages-count');
        const messageSelectionList = document.getElementById('message-selection-list');
        const btnCancelMessageSelection = document.getElementById('btn-cancel-message-selection');
        const btnConfirmMessageSelection = document.getElementById('btn-confirm-message-selection');

        // Track selected message indices for summarization
        let selectedMessageIndices = new Set();

        // Track AI status
        let aiSummaryEnabledState = false;
        let aiActiveProviderState = null;

        // Track current summary for code prompt generation
        let currentSummaryData = null;

        // Track the button ID for the current code prompt generation
        let currentCodePromptButtonId = null;

        // Track generated code prompt
        let generatedCodePrompt = null;

        // SSO state
        let ssoIdentity = window.initialSSOIdentity || null;
        let ssoProvider = window.initialSSOProvider || null;

        function getSSODisplayName(identity) {
            if (!identity) return null;
            if (identity.email) {
                const at = identity.email.indexOf('@');
                return at > 0 ? identity.email.substring(0, at) : identity.email;
            }
            if (identity.name) return identity.name;
            return identity.user_id || null;
        }

        function getIdentitySource() {
            if (ssoIdentity) return 'sso';
            if (session.displayName && session.displayName !== 'Host' && session.displayName !== 'User') return 'named';
            return 'anonymous';
        }

        function getProviderBadge(provider) {
            if (provider === 'aws') return '\u2601 AWS';
            if (provider === 'google') return 'G Google';
            return '\u2713';
        }

        const ssoDisplayName = getSSODisplayName(ssoIdentity);
        if (ssoDisplayName) session.displayName = ssoDisplayName;

        // SSO panel containers (each has .sso-signin, .sso-pending, .sso-done children)
        const ssoPanels = ['sso-idle', 'sso-disconnected', 'sso-ready'].map(id => document.getElementById(id));
        const ssoHeaderBadge = document.getElementById('sso-header-badge');

        /**
         * Show/hide SSO provider buttons based on which providers are enabled.
         * If no providers are enabled, the entire sign-in row is hidden.
         */
        function applySSOProviderVisibility(providers) {
            document.querySelectorAll('.sso-login-aws').forEach(btn => {
                btn.classList.toggle('hidden', !providers.aws);
            });
            document.querySelectorAll('.sso-login-google').forEach(btn => {
                btn.classList.toggle('hidden', !providers.google);
            });
            // If neither provider is enabled, hide the entire signin row
            const noneEnabled = !providers.aws && !providers.google;
            document.querySelectorAll('.sso-signin').forEach(row => {
                row.classList.toggle('hidden', noneEnabled);
            });
        }

        // Apply initial provider visibility from injected config
        let enabledProviders = window.initialEnabledSSOProviders || { aws: false, google: false };
        applySSOProviderVisibility(enabledProviders);

        // Attach SSO button handlers (login + cancel) for all three panels
        document.querySelectorAll('.sso-login-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const provider = btn.dataset.provider || 'aws';
                vscode.postMessage({ command: 'ssoLogin', provider });
            });
        });
        document.querySelectorAll('.sso-cancel-btn').forEach(btn => {
            btn.addEventListener('click', () => vscode.postMessage({ command: 'ssoCancel' }));
        });
        document.querySelectorAll('.sso-clear-btn').forEach(btn => {
            btn.addEventListener('click', () => vscode.postMessage({ command: 'ssoClearCache' }));
        });

        /**
         * Update all SSO UI panels to show the sign-in button (default state).
         */
        function showSSOSignInState() {
            ssoPanels.forEach(panel => {
                if (!panel) return;
                panel.querySelector('.sso-signin')?.classList.remove('hidden');
                panel.querySelector('.sso-pending')?.classList.add('hidden');
                panel.querySelector('.sso-done')?.classList.add('hidden');
            });
            // Re-apply provider visibility (hides row if no providers enabled)
            applySSOProviderVisibility(enabledProviders);
        }

        /**
         * Update all SSO UI panels to show the pending/polling state.
         */
        function showSSOPendingState(userCode) {
            ssoPanels.forEach(panel => {
                if (!panel) return;
                panel.querySelector('.sso-signin')?.classList.add('hidden');
                panel.querySelector('.sso-pending')?.classList.remove('hidden');
                panel.querySelector('.sso-done')?.classList.add('hidden');
                const codeEl = panel.querySelector('.sso-user-code');
                if (codeEl) codeEl.textContent = userCode || '';
            });
        }

        /**
         * Update all SSO UI panels to show the signed-in state with email and provider badge.
         */
        function showSSOSignedInState(identity, provider) {
            const email = identity?.email || identity?.arn || 'Signed in';
            const badge = getProviderBadge(provider || ssoProvider);
            ssoPanels.forEach(panel => {
                if (!panel) return;
                panel.querySelector('.sso-signin')?.classList.add('hidden');
                panel.querySelector('.sso-pending')?.classList.add('hidden');
                panel.querySelector('.sso-done')?.classList.remove('hidden');
                const badgeEl = panel.querySelector('.sso-provider-badge');
                if (badgeEl) {
                    badgeEl.textContent = badge;
                }
                const emailEl = panel.querySelector('.sso-email');
                if (emailEl) {
                    emailEl.textContent = email;
                    emailEl.title = identity?.arn || email;
                }
            });
            // Name is now shown in the role badge, so keep ssoHeaderBadge hidden
        }

        // Restore SSO state on page load
        if (ssoIdentity) {
            showSSOSignedInState(ssoIdentity, ssoProvider);
        }

        // Track session state
        let sessionEnded = false;

        // Track pending code snippet
        let pendingCodeSnippet = null;

        // Track pending file upload
        let pendingFile = null;
        let isUploading = false;  // Prevent double uploads
        const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB

        // Typing indicator state
        const typingIndicator = document.getElementById('typing-indicator');
        const typingText = document.getElementById('typing-text');
        const typingUsers = new Map();  // userId -> displayName
        let typingTimeout = null;
        const TYPING_DEBOUNCE_MS = 500;
        const TYPING_EXPIRE_MS = 3000;
        let isTyping = false;
        let lastTypingTime = 0;

        // Message grouping state
        let lastMessageUserId = null;
        let lastMessageTime = 0;
        let lastMessageDate = null;
        const MESSAGE_GROUP_INTERVAL_MS = 5 * 60 * 1000;  // 5 minutes

        // Scroll to bottom button state
        const scrollToBottomBtn = document.getElementById('scroll-to-bottom');
        const unreadCountBadge = document.getElementById('unread-count');
        let unreadCount = 0;
        let isUserScrolledUp = false;
        const SCROLL_THRESHOLD = 100;  // pixels from bottom to consider "at bottom"

        // Pagination state
        let isLoadingHistory = false;
        let hasMoreHistory = true;
        const PAGINATION_THRESHOLD = 100;  // pixels from top to trigger load

        // Avatar color mapping
        const avatarColors = {
            purple: 'bg-purple-600',
            blue: 'bg-blue-600',
            green: 'bg-green-600',
            orange: 'bg-orange-600',
            pink: 'bg-pink-600',
            cyan: 'bg-cyan-600',
            yellow: 'bg-yellow-600',
            red: 'bg-red-600',
            amber: 'bg-amber-500'
        };

        /**
         * Update UI based on dynamic lead permissions from WebSocket.
         * This replaces the static isEffectiveLead logic with server-tracked lead state.
         */
        function updateLeadPermissions() {
            const isHost = session.sessionRole === 'host';
            const isLead = session.userId === session.leadId;
            const canUseAI = isLead;
            const canConfigure = isHost || isLead;

            // Update role badge to reflect lead status
            const headerName = escapeHtml(session.displayName || 'User');
            if (isHost && isLead) {
                roleBadge.innerHTML = `<span class="font-semibold text-amber-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-amber-400 font-medium">Host + Lead</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-amber-500/10 border border-amber-500/20';
            } else if (isHost) {
                roleBadge.innerHTML = `<span class="font-semibold text-amber-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-amber-400 font-medium">Host</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-amber-500/10 border border-amber-500/20';
            } else if (isLead) {
                roleBadge.innerHTML = `<span class="font-semibold text-purple-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-purple-400 font-medium">Lead</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-purple-500/10 border border-purple-500/20';
            } else {
                roleBadge.innerHTML = `<span class="font-semibold text-gray-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-gray-400 font-medium">Member</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-gray-700/50 border border-gray-600/30';
            }

            // AI buttons: only lead
            btnCreateSummary.style.display = canUseAI ? 'flex' : 'none';

            // Config buttons: host OR lead
            if (btnAiConfig) btnAiConfig.style.display = canConfigure ? 'flex' : 'none';
            if (btnRoomSettings) btnRoomSettings.classList.toggle('hidden', !canConfigure);

            // End session: host only
            btnEndChat.style.display = isHost ? 'flex' : 'none';

            // Auto-apply toggle: lead only
            if (canUseAI) {
                autoApplyToggleContainer.classList.remove('hidden');
                autoApplyToggleContainer.classList.add('flex');
            } else {
                autoApplyToggleContainer.classList.add('hidden');
                autoApplyToggleContainer.classList.remove('flex');
            }

            // AI toolbar section: show if user has any AI-related permissions
            if (canUseAI || canConfigure) {
                leadActions.classList.remove('hidden');
                leadActions.classList.add('flex');
            } else {
                leadActions.classList.add('hidden');
                leadActions.classList.remove('flex');
            }

            // Re-evaluate AI-gated buttons whenever role changes
            updateAiDependentButtons();
        }

        /**
         * Enable or disable buttons that require a healthy AI backend.
         *
         * Called from:
         *   - handleAiStatusResponse()  — when fresh status arrives from backend
         *   - updateLeadPermissions()   — when the user's role changes
         *
         * A button is considered "AI-available" when BOTH are true:
         *   1. summary_enabled = true  (feature flag in conductor.settings.yaml)
         *   2. active_provider is non-null (at least one healthy provider exists)
         */
        function updateAiDependentButtons() {
            const aiOk = aiSummaryEnabledState && !!aiActiveProviderState;

            // Summarize button — also requires AI (already hidden by role, but disable too)
            const summarizeBtn = document.getElementById('btn-create-summary');
            if (summarizeBtn) {
                if (aiOk) {
                    summarizeBtn.removeAttribute('disabled');
                    summarizeBtn.classList.remove('opacity-30', 'cursor-not-allowed');
                } else {
                    summarizeBtn.setAttribute('disabled', 'true');
                    summarizeBtn.classList.add('opacity-30', 'cursor-not-allowed');
                    const reason = !aiSummaryEnabledState ? 'AI disabled' : 'No AI provider';
                    summarizeBtn.title = `Summarize unavailable: ${reason}`;
                }
            }

            // All snippet explain buttons in existing messages
            document.querySelectorAll('.snippet-explain-btn').forEach(btn => {
                if (btn.getAttribute('data-loading') === 'true') return; // skip in-flight
                if (aiOk) {
                    btn.removeAttribute('disabled');
                    btn.classList.remove('text-gray-600', 'opacity-40', 'cursor-not-allowed');
                    btn.classList.add('text-emerald-400/70', 'hover:text-emerald-300', 'hover:bg-emerald-500/10');
                    btn.title = 'Explain with AI';
                } else {
                    btn.setAttribute('disabled', 'true');
                    btn.classList.add('text-gray-600', 'opacity-40', 'cursor-not-allowed');
                    btn.classList.remove('text-emerald-400/70', 'hover:text-emerald-300', 'hover:bg-emerald-500/10');
                    btn.title = 'AI not available';
                }
            });
        }

        /**
         * Update the UI based on permissions from extension host.
         * After setting sessionRole, delegates to updateLeadPermissions() for
         * dynamic lead-based visibility.
         */
        function updateUIForPermissions(permissions) {
            // Store session role for use in messages
            if (permissions.sessionRole) {
                session.sessionRole = permissions.sessionRole;
            }

            // Hide SSO header badge since name is now shown in role badge
            if (ssoHeaderBadge) {
                ssoHeaderBadge.classList.add('hidden');
            }

            // Delegate to dynamic lead permissions if leadId is known
            // (leadId comes from WebSocket, not from extension permissions)
            if (session.leadId) {
                updateLeadPermissions();
                return;
            }

            // Fallback: use old isEffectiveLead logic if WebSocket hasn't sent leadId yet
            const isEffectiveLead = permissions.role === 'lead' || permissions.sessionRole === 'host';

            // Update role badge based on session role (host/guest) or config role (lead/member)
            const headerName = escapeHtml(session.displayName || 'User');
            if (permissions.sessionRole === 'host') {
                roleBadge.innerHTML = `<span class="font-semibold text-amber-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-amber-400 font-medium">Host</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-amber-500/10 border border-amber-500/20';
            } else if (permissions.sessionRole === 'guest') {
                roleBadge.innerHTML = `<span class="font-semibold text-blue-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-blue-400 font-medium">Guest</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-blue-500/10 border border-blue-500/20';
            } else if (permissions.role === 'lead') {
                roleBadge.innerHTML = `<span class="font-semibold text-amber-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-amber-400 font-medium">Lead</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-amber-500/10 border border-amber-500/20';
            } else {
                roleBadge.innerHTML = `<span class="font-semibold text-gray-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-gray-400 font-medium">Member</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-gray-700/50 border border-gray-600/30';
            }

            // Show/hide lead-only actions: host or lead get full access
            if (isEffectiveLead || permissions.canCreateSummary) {
                leadActions.classList.remove('hidden');
                leadActions.classList.add('flex');
            } else {
                leadActions.classList.add('hidden');
                leadActions.classList.remove('flex');
            }

            // Individual button visibility — host gets same access as lead
            btnCreateSummary.style.display = (permissions.canCreateSummary || isEffectiveLead) ? 'flex' : 'none';
            btnEndChat.style.display = isEffectiveLead ? 'flex' : 'none';

            // Show auto-apply toggle for leads/hosts
            if (permissions.canAutoApply || isEffectiveLead) {
                autoApplyToggleContainer.classList.remove('hidden');
                autoApplyToggleContainer.classList.add('flex');
            } else {
                autoApplyToggleContainer.classList.add('hidden');
                autoApplyToggleContainer.classList.remove('flex');
            }

            // Show room settings button for leads/hosts
            if (btnRoomSettings) {
                btnRoomSettings.classList.toggle('hidden', !isEffectiveLead);
            }
        }

        /**
         * Single render function — deterministically updates the entire UI
         * based on the ConductorState. No conditional UI logic exists
         * outside this function.
         */
        function render(state, newSession) {
            const prevState = conductorState;
            conductorState = state;

            // Track if roomId changed (need to reconnect WebSocket)
            const prevRoomId = session.roomId;

            // Update session data if provided (e.g. after startHosting or joinSucceeded)
            if (newSession) {
                session = { ...session, ...newSession };
                if (roomIdDisplay && session.roomId) {
                    roomIdDisplay.textContent = session.roomId.substring(0, 8) + '...';
                    roomIdDisplay.title = session.roomId;
                }
            }

            const roomIdChanged = newSession && newSession.roomId && newSession.roomId !== prevRoomId;

            // --- 1. Hide every panel ----------------------------------------
            panelIdle.classList.add('hidden');
            panelIdle.classList.remove('flex');
            panelDisconnected.classList.add('hidden');
            panelDisconnected.classList.remove('flex');
            panelReady.classList.add('hidden');
            panelReady.classList.remove('flex');
            panelJoining.classList.add('hidden');
            panelJoining.classList.remove('flex');
            panelChat.classList.add('hidden');
            panelChat.classList.remove('flex');
            hostingControls.classList.add('hidden');
            hostingControls.classList.remove('flex');
            joinedControls.classList.add('hidden');
            joinedControls.classList.remove('flex');

            // --- 2. Show the panel for the current state --------------------
            if (state === 'Idle') {
                panelIdle.classList.remove('hidden');
                panelIdle.classList.add('flex');
            } else if (state === 'BackendDisconnected') {
                panelDisconnected.classList.remove('hidden');
                panelDisconnected.classList.add('flex');
            } else if (state === 'ReadyToHost') {
                panelReady.classList.remove('hidden');
                panelReady.classList.add('flex');
            } else if (state === 'Joining') {
                panelJoining.classList.remove('hidden');
                panelJoining.classList.add('flex');
            } else if (state === 'Hosting') {
                panelChat.classList.remove('hidden');
                panelChat.classList.add('flex');
                hostingControls.classList.remove('hidden');
                hostingControls.classList.add('flex');
            } else if (state === 'Joined') {
                panelChat.classList.remove('hidden');
                panelChat.classList.add('flex');
                joinedControls.classList.remove('hidden');
                joinedControls.classList.add('flex');
            }

            // --- 3. WebSocket lifecycle -------------------------------------
            const chatStates = ['Hosting', 'Joined'];
            const wasInChat = chatStates.includes(prevState);
            const nowInChat = chatStates.includes(state);

            if (nowInChat && !wasInChat) {
                // Entering chat state — reset ended flag and re-enable input
                sessionEnded = false;
                chatInput.disabled = false;
                chatInput.placeholder = 'Type a message...';
                btnSend.disabled = false;
                btnSend.classList.remove('opacity-50', 'cursor-not-allowed');
                // Clear stale messages from previous session
                messagesContainer.innerHTML = '';
                if (connectionStatus) {
                    connectionStatus.style.display = '';
                    messagesContainer.appendChild(connectionStatus);
                }
                chatMessages.length = 0;
                lastMessageUserId = null;
                lastMessageTime = 0;
                lastMessageDate = null;
                seenMessageIds.clear();
                lastMessageTimestamp = 0;
                reconnectAttempts = 0;
                // Connect
                connectWebSocket();
            } else if (!nowInChat && wasInChat) {
                // Leaving chat state — disconnect
                disconnectWebSocket();
            } else if (nowInChat && wasInChat && roomIdChanged) {
                // Staying in chat but roomId changed — reconnect to new room
                console.log('[WebView] roomId changed, reconnecting WebSocket');
                disconnectWebSocket();
                connectWebSocket();
            }

            // Re-apply SSO identity state after panel switch
            if (ssoIdentity) {
                showSSOSignedInState(ssoIdentity, ssoProvider);
            }

            console.log('[WebView] render:', prevState, '→', state, roomIdChanged ? '(roomId changed)' : '');
        }

        /**
         * Disconnect the WebSocket if open.
         */
        function disconnectWebSocket() {
            if (ws) {
                console.log('[WebView] Disconnecting WebSocket');
                ws.close();
                ws = null;
            }
        }

        /**
         * Update the pending changes card UI.
         */
        function updatePendingChangesCard(changeSet, policy) {
            if (!changeSet) {
                pendingChangesCard.classList.add('hidden');
                return;
            }

            pendingChangesCard.classList.remove('hidden');

            // Update file count
            const filesCount = changeSet.changes ? changeSet.changes.length : 0;
            pendingFilesCount.querySelector('span').textContent = `${filesCount} file${filesCount !== 1 ? 's' : ''}`;

            // Update lines count
            let linesAdded = 0;
            let linesRemoved = 0;
            if (changeSet.changes) {
                for (const change of changeSet.changes) {
                    if (change.type === 'replace_range' && change.range) {
                        linesRemoved += change.range.end - change.range.start + 1;
                        linesAdded += (change.content || '').split('\n').length;
                    } else if (change.type === 'create_file') {
                        linesAdded += (change.content || '').split('\n').length;
                    }
                }
            }
            pendingLinesCount.innerHTML = `
                <span class="text-green-400">+${linesAdded}</span>
                <span class="text-red-400">-${linesRemoved}</span>
                <span>lines</span>
            `;

            // Update policy status
            if (policy) {
                if (policy.allowed) {
                    policyStatusIcon.textContent = '✓';
                    policyStatusIcon.className = 'text-green-400';
                    policyStatusText.textContent = 'Safe to apply';
                    policyStatusText.className = 'text-gray-300';
                    btnApplyChanges.disabled = false;
                    btnApplyChanges.className = 'flex-1 btn-success text-xs px-3 py-2 flex items-center justify-center gap-1';
                } else {
                    policyStatusIcon.textContent = '⚠';
                    policyStatusIcon.className = 'text-amber-400';
                    policyStatusText.textContent = policy.reasons ? policy.reasons.join('; ') : 'Manual review required';
                    policyStatusText.className = 'text-amber-300';
                    // Still allow manual apply, but show warning
                    btnApplyChanges.disabled = false;
                    btnApplyChanges.className = 'flex-1 text-xs px-3 py-2 flex items-center justify-center gap-1 rounded-xl font-medium text-white transition-all' + ' bg-gradient-to-r from-amber-600 to-amber-700 hover:shadow-[0_0_16px_rgba(217,119,6,0.2)]';
                }
            }
        }

        /**
         * Clear pending changes.
         */
        function clearPendingChanges() {
            pendingChangeSet = null;
            policyResult = null;
            currentChange = null;
            currentChangeIndex = 0;
            totalChanges = 0;
            pendingChangesCard.classList.add('hidden');
        }

        /**
         * Update UI for the current change being reviewed.
         */
        function updateCurrentChangeUI(change, index, total, policy) {
            if (!change) {
                pendingChangesCard.classList.add('hidden');
                return;
            }

            pendingChangesCard.classList.remove('hidden');
            currentChange = change;
            currentChangeIndex = index;
            totalChanges = total;
            policyResult = policy;

            // Update progress indicator (e.g., "1/3")
            changeProgress.textContent = `(${index + 1}/${total})`;

            // Update current file name
            currentFileName.textContent = change.file;
            currentFileInfo.classList.remove('hidden');

            // Update file count to show current/total
            pendingFilesCount.querySelector('span').textContent = `Change ${index + 1} of ${total}`;

            // Calculate lines for this single change
            let linesAdded = 0;
            let linesRemoved = 0;
            if (change.type === 'replace_range' && change.range) {
                linesRemoved = change.range.end - change.range.start + 1;
                linesAdded = (change.content || '').split('\n').length;
            } else if (change.type === 'create_file') {
                linesAdded = (change.content || '').split('\n').length;
            }
            pendingLinesCount.innerHTML = `
                <span class="text-green-400">+${linesAdded}</span>
                <span class="text-red-400">-${linesRemoved}</span>
                <span>lines</span>
            `;

            // Update policy status
            if (policy) {
                if (policy.allowed) {
                    policyStatusIcon.textContent = '✓';
                    policyStatusIcon.className = 'text-green-400';
                    policyStatusText.textContent = 'Safe to apply';
                    policyStatusText.className = 'text-gray-300';
                    btnApplyChanges.className = 'flex-1 btn-success text-xs px-3 py-2 flex items-center justify-center gap-1';
                } else {
                    policyStatusIcon.textContent = '⚠';
                    policyStatusIcon.className = 'text-amber-400';
                    policyStatusText.textContent = policy.reasons ? policy.reasons.join('; ') : 'Manual review required';
                    policyStatusText.className = 'text-amber-300';
                    btnApplyChanges.className = 'flex-1 text-xs px-3 py-2 flex items-center justify-center gap-1 rounded-xl font-medium text-white transition-all' + ' bg-gradient-to-r from-amber-600 to-amber-700 hover:shadow-[0_0_16px_rgba(217,119,6,0.2)]';
                }
            }

            btnApplyChanges.disabled = false;
        }

        // Handle messages from the extension
        window.addEventListener('message', event => {
            const message = event.data;
            console.log('Received message from extension:', message);
            switch (message.command) {
                case 'updatePermissions':
                    console.log('Updating permissions:', message.permissions);
                    updateUIForPermissions(message.permissions);
                    break;
                case 'showCurrentChange':
                    // Sequential review mode: show one change at a time
                    updateCurrentChangeUI(
                        message.currentChange,
                        message.currentIndex,
                        message.totalChanges,
                        message.policyResult
                    );

                    // If auto-apply is enabled and policy allows, apply automatically
                    if (autoApplyEnabled && message.policyResult && message.policyResult.allowed) {
                        vscode.postMessage({ command: 'applyChanges', changeSet: { changes: [message.currentChange] } });
                    }
                    break;
                case 'allChangesComplete':
                    // All changes have been reviewed
                    clearPendingChanges();
                    break;
                case 'indexProgress': {
                    const p = message.payload;
                    // Tiny header bar
                    const bar  = document.getElementById('index-progress-bar');
                    const fill = document.getElementById('index-progress-fill');
                    const text = document.getElementById('index-progress-text');
                    // Prominent overlay
                    const overlay       = document.getElementById('scanning-overlay');
                    const overlayPhase  = document.getElementById('scan-overlay-phase');
                    const overlayDetail = document.getElementById('scan-overlay-detail');
                    const overlayFill   = document.getElementById('scan-overlay-fill');
                    const overlayPct    = document.getElementById('scan-overlay-pct');
                    const modeBadge     = document.getElementById('scan-mode-badge');

                    if (p.phase === 'done') {
                        bar?.classList.add('hidden');
                        overlay?.classList.add('hidden');
                        _scanBranchInfo = null;
                        _clearScanOverlayTimeout();
                        break;
                    }

                    // Show prominent overlay only for significant operations:
                    // branch change, empty DB, or many stale files.
                    // For incremental / small delta: just show the subtle header bar.
                    const showOverlay = !p.isIncremental && (
                        !!_scanBranchInfo ||
                        p.staleFilesCount === undefined ||
                        p.staleFilesCount > 20
                    );

                    bar?.classList.remove('hidden');
                    if (showOverlay) {
                        overlay?.classList.remove('hidden');
                        _resetScanOverlayTimeout();
                    } else {
                        overlay?.classList.add('hidden');
                    }

                    // Show branch-change banner if pending
                    if (_scanBranchInfo) {
                        const banner = document.getElementById('scan-branch-banner');
                        if (banner) {
                            banner.textContent = 'Branch changed: ' + _scanBranchInfo.from + ' \u2192 ' + _scanBranchInfo.to + ' \u2014 rebuilding index';
                            banner.classList.remove('hidden');
                        }
                    }

                    // AST-only badge
                    if (modeBadge) {
                        modeBadge.classList.toggle('hidden', p.embeddingEnabled !== false);
                    }

                    let pct = 0;
                    let phaseLabel = '';
                    let detailLabel = '';

                    if (p.phase === 'scanning') {
                        pct = p.totalFiles > 0 ? Math.round((p.filesScanned / p.totalFiles) * 100) : 5;
                        phaseLabel  = 'Scanning workspace';
                        detailLabel = 'Collecting file metadata\u2026 (' + p.filesScanned + ' files)';
                        if (text) text.textContent = 'Indexing workspace\u2026 (' + p.filesScanned + ' files)';
                    } else if (p.phase === 'extracting') {
                        // Use file-based progress as primary driver so the bar
                        // always moves even when a workspace has 0 extracted symbols.
                        const filePct  = p.totalFiles > 0 ? (p.filesIndexed || 0) / p.totalFiles : 0;
                        const symBonus = p.totalFiles > 0 ? Math.min(0.3, p.symbolsExtracted / (p.totalFiles * 5)) : 0;
                        pct = Math.round((filePct * 0.7 + symBonus) * 80) + 10; // 10–90 %
                        pct = Math.min(90, Math.max(10, pct));
                        phaseLabel  = 'Building AST index';
                        const filesStr = p.filesIndexed ? p.filesIndexed + '/' + p.totalFiles + ' files' : p.symbolsExtracted + ' symbols';
                        detailLabel = 'Extracting symbols\u2026 (' + filesStr + ')';
                        if (text) text.textContent = 'Building code index\u2026 (' + filesStr + ')';
                    } else if (p.phase === 'embedding') {
                        pct = 70 + Math.min(28, Math.round((p.embeddingsEnqueued / Math.max(p.symbolsExtracted, 1)) * 28));
                        phaseLabel  = 'Generating embeddings';
                        detailLabel = 'Embedding symbols\u2026 (' + p.embeddingsEnqueued + ' queued)';
                        if (text) text.textContent = 'Embedding symbols\u2026 (' + p.embeddingsEnqueued + ')';
                    }

                    if (fill) fill.style.width = pct + '%';
                    if (overlayFill) overlayFill.style.width = pct + '%';
                    if (overlayPct) overlayPct.textContent = pct + '%';
                    if (overlayPhase) overlayPhase.textContent = phaseLabel;
                    if (overlayDetail) overlayDetail.textContent = detailLabel;
                    break;
                }
                case 'indexBranchChanged':
                    // Store info so the overlay shows the banner on first indexProgress
                    _scanBranchInfo = { from: message.from || '?', to: message.to || '?' };
                    break;
                case 'indexEmbeddingError': {
                    const badge = document.getElementById('scan-mode-badge');
                    if (badge) badge.classList.remove('hidden');
                    break;
                }
                case 'indexRebuildComplete':
                    handleIndexRebuildComplete(message);
                    // Reset branch banner state after a manual rebuild
                    _scanBranchInfo = null;
                    document.getElementById('scan-branch-banner')?.classList.add('hidden');
                    break;
                case 'explainCodeFromSnippetDone':
                    // Reset all in-flight snippet explain buttons
                    document.querySelectorAll('.snippet-explain-btn[data-loading="true"]').forEach(btn => {
                        btn.removeAttribute('data-loading');
                        // Restore the lightbulb icon
                        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.68.166-1.32.42-1.897A5 5 0 006 10a5 5 0 006 10l-.579 2.894A1 1 0 0012 14z"/></svg>`;
                        if (aiSummaryEnabledState && aiActiveProviderState) {
                            btn.removeAttribute('disabled');
                        }
                    });
                    if (!message.success) showToast('Explain failed: ' + (message.error || 'unknown error'), 'error');
                    break;
                case 'indexFileSynced':
                    // File watcher updated a single file — flash the header bar briefly
                    (function() {
                        const b = document.getElementById('index-progress-bar');
                        const f = document.getElementById('index-progress-fill');
                        const t = document.getElementById('index-progress-text');
                        if (!b || !f || !t) return;
                        f.style.width = '100%';
                        t.textContent = '\u2713 ' + message.file + ' (' + (message.symbols || 0) + ' symbols)';
                        b.classList.remove('hidden');
                        setTimeout(() => b.classList.add('hidden'), 2000);
                    })();
                    break;
                case 'changesGenerated':
                    // Legacy: Store the pending change set (kept for backwards compatibility)
                    pendingChangeSet = message.changeSet;
                    policyResult = message.policyResult;
                    // Don't call updatePendingChangesCard here anymore
                    // The showCurrentChange message will handle the UI update
                    break;
                case 'changesApplied':
                    // Single change applied, waiting for next showCurrentChange or allChangesComplete
                    break;
                case 'autoApplyState':
                    autoApplyEnabled = message.enabled;
                    autoApplyToggle.checked = autoApplyEnabled;
                    break;
                case 'endChatConfirmed':
                    handleEndChatConfirmed();
                    break;
                case 'conductorStateChanged':
                    // Restore SSO identity from extension's globalState if available
                    if (message.ssoIdentity && !ssoIdentity) {
                        ssoIdentity = message.ssoIdentity;
                        ssoProvider = message.ssoProvider || ssoProvider;
                    }
                    render(message.state, message.session);
                    // Show rebuild-index row only when a session is active
                    if (message.state === 'Hosting' || message.state === 'Joined') {
                        document.getElementById('rebuild-index-row')?.classList.remove('hidden');
                    } else {
                        document.getElementById('rebuild-index-row')?.classList.add('hidden');
                        // Hide scanning overlay when session ends
                        document.getElementById('scanning-overlay')?.classList.add('hidden');
                        document.getElementById('index-progress-bar')?.classList.add('hidden');
                    }
                    break;
                case 'uploadFileResult':
                    handleUploadFileResult(message);
                    break;
                case 'checkDuplicateFileResult':
                    handleCheckDuplicateFileResult(message);
                    break;
                case 'codeSnippet':
                    // Received code snippet from extension (user selected code in editor)
                    handleCodeSnippetFromExtension(message);
                    break;
                case 'aiStatus':
                    // Received AI status from extension (proxied from backend)
                    console.log('[WebView] Received aiStatus:', message.data);
                    handleAiStatusResponse(message.data);
                    break;
                case 'setAiModelResult':
                    // Received result of setting AI model
                    console.log('[WebView] Received setAiModelResult:', message.data);
                    handleSetAiModelResult(message.data);
                    break;
                case 'summarizeResult':
                    // Received summarize result from extension
                    handleSummarizeResponse(message.data);
                    break;
                case 'codePromptResult':
                    // Received code prompt result from extension
                    handleCodePromptResponse(message.data);
                    break;
                case 'codePromptPostResult':
                    // Received code prompt post result from extension
                    handleCodePromptPostResponse(message.data);
                    break;
                case 'roomSettings':
                    // Received room settings from extension
                    handleRoomSettingsResponse(message.data);
                    break;
                case 'styleTemplates':
                    // Received style templates from extension
                    handleStyleTemplatesResponse(message.data);
                    break;
                case 'saveRoomSettingsResult':
                    // Received save room settings result from extension
                    handleSaveRoomSettingsResult(message.data);
                    break;
                case 'ssoLoginPending':
                    showSSOPendingState(message.userCode);
                    break;
                case 'ssoLoginResult':
                    if (message.identity) {
                        ssoIdentity = message.identity;
                        ssoProvider = message.provider || ssoProvider;
                        showSSOSignedInState(message.identity, message.provider);
                        const loginName = getSSODisplayName(message.identity);
                        if (loginName) session.displayName = loginName;
                        console.log('[WebView] SSO identity:', message.identity, 'provider:', message.provider);
                    } else {
                        showSSOSignInState();
                        if (message.error) {
                            console.warn('[WebView] SSO error:', message.error);
                        }
                    }
                    break;
                case 'ssoCacheCleared':
                    ssoIdentity = null;
                    ssoProvider = null;
                    session.displayName = 'User';
                    showSSOSignInState();
                    if (ssoHeaderBadge) {
                        ssoHeaderBadge.classList.add('hidden');
                    }
                    break;
                case 'ssoProvidersUpdate':
                    enabledProviders = message.providers;
                    applySSOProviderVisibility(enabledProviders);
                    break;

                // ---- Stack trace ----
                case 'stackTraceResolved':
                    handleStackTraceResolved(message);
                    break;

                // ---- Test failures ----
                case 'testFailuresResolved':
                    handleTestFailuresResolved(message);
                    break;

                // ---- TODO tracking ----
                case 'todosLoaded':
                    renderTodoList(message.todos || []);
                    break;
                case 'todoCreated':
                    if (message.todo) addTodoToList(message.todo);
                    break;
                case 'todoUpdated':
                    if (message.todo) refreshTodoInList(message.todo);
                    break;
                case 'todoDeleted':
                    if (message.todoId) removeTodoFromList(message.todoId);
                    break;
                case 'workspaceTodosScanned':
                    handleWorkspaceTodosScanned(message);
                    break;
                case 'workspaceTodoUpdated':
                    handleWorkspaceTodoUpdated(message);
                    break;
                case 'historyLoaded':
                    handleHistoryLoaded(message);
                    break;
            }
        });

        /**
         * Handle file upload result from extension host
         */
        function handleUploadFileResult(message) {
            console.log('[WebView] Upload result received:', message);

            if (message.success) {
                const result = message.result;
                console.log('[WebView] File uploaded successfully:', result);
                console.log('[WebView] WebSocket state:', ws ? ws.readyState : 'null', '(OPEN=1)');

                // Send file message via WebSocket
                // SECURITY: userId and role are assigned by backend
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const fileMessage = {
                        type: 'file',
                        id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
                        displayName: session.displayName || 'User',
                        fileId: result.id,
                        originalFilename: result.original_filename,
                        fileType: result.file_type,
                        mimeType: result.mime_type,
                        sizeBytes: result.size_bytes,
                        downloadUrl: result.download_url,
                        caption: pendingUploadCaption,
                        ts: Date.now() / 1000
                    };

                    console.log('[WebView] Sending file message via WebSocket:', fileMessage);
                    ws.send(JSON.stringify(fileMessage));
                    console.log('[WebView] File message sent successfully');
                } else {
                    console.error('[WebView] Cannot send file message: WebSocket not open. ws:', ws, 'readyState:', ws?.readyState);
                }

                // Clear preview after successful upload
                clearFilePreview();
                pendingUploadCaption = null;
                console.log('[WebView] File upload complete, preview cleared');
            } else {
                console.error('[WebView] File upload failed:', message.error);
                showToast(`File upload failed: ${message.error}`, 'error');
                // Reset upload state but keep preview so user can retry
                isUploading = false;
                btnUploadFile.disabled = false;
                btnUploadFile.textContent = 'Upload';
            }
        }

        // ----- Conductor session button handlers -----

        // Idle panel: Start (triggers health check → ReadyToHost → startSession)
        btnIdleStart.addEventListener('click', () => {
            vscode.postMessage({ command: 'startSession' });
        });

        // Idle panel: Join (paste invite URL)
        btnIdleJoin.addEventListener('click', () => {
            const url = inviteUrlInput.value.trim();
            if (!url) { return; }
            vscode.postMessage({ command: 'joinSession', inviteUrl: url });
            inviteUrlInput.value = '';
        });

        // BackendDisconnected panel: Retry
        btnRetry.addEventListener('click', () => {
            vscode.postMessage({ command: 'retryConnection' });
        });

        // BackendDisconnected panel: Join (paste invite URL)
        btnDisconnectedJoin.addEventListener('click', () => {
            const url = disconnectedInviteUrlInput.value.trim();
            if (!url) { return; }
            vscode.postMessage({ command: 'joinSession', inviteUrl: url });
            disconnectedInviteUrlInput.value = '';
        });

        // ReadyToHost panel: Start Session
        btnStartSession.addEventListener('click', () => {
            vscode.postMessage({ command: 'startSession' });
        });

        // ReadyToHost panel: Join (paste invite URL)
        btnReadyJoin.addEventListener('click', () => {
            const url = readyInviteUrlInput.value.trim();
            if (!url) { return; }
            vscode.postMessage({ command: 'joinSession', inviteUrl: url });
            readyInviteUrlInput.value = '';
        });

        // Hosting: Stop + Copy Invite
        btnStopSession.addEventListener('click', () => {
            vscode.postMessage({ command: 'stopSession' });
        });

        btnCopyInvite.addEventListener('click', () => {
            vscode.postMessage({ command: 'copyInviteLink' });
        });

        // Joined: Leave
        btnLeaveSession.addEventListener('click', () => {
            vscode.postMessage({ command: 'leaveSession' });
        });

        // Button click handlers
        btnCreateSummary.addEventListener('click', () => {
            // Use the same summary functionality as the sidebar button
            requestSummarize();
        });

        // Auto-apply toggle handler
        autoApplyToggle.addEventListener('change', (e) => {
            autoApplyEnabled = e.target.checked;
            vscode.postMessage({ command: 'setAutoApply', enabled: autoApplyEnabled });
        });

        // Pending changes card button handlers
        btnViewDiff.addEventListener('click', () => {
            // View diff for current change only
            if (currentChange) {
                vscode.postMessage({ command: 'viewDiff', changeSet: { changes: [currentChange], summary: '' } });
            } else if (pendingChangeSet) {
                vscode.postMessage({ command: 'viewDiff', changeSet: pendingChangeSet });
            }
        });

        btnApplyChanges.addEventListener('click', () => {
            // Apply current change only (the extension handles the queue)
            if (currentChange) {
                vscode.postMessage({ command: 'applyChanges', changeSet: { changes: [currentChange], summary: '' } });
            } else if (pendingChangeSet) {
                vscode.postMessage({ command: 'applyChanges', changeSet: pendingChangeSet });
            }
        });

        btnDiscardChanges.addEventListener('click', () => {
            clearPendingChanges();
            vscode.postMessage({ command: 'discardChanges' });
        });

        // Initialize with permissions from the extension
        if (window.initialPermissions) {
            updateUIForPermissions(window.initialPermissions);
        } else {
            // Request permissions if not injected
            vscode.postMessage({ command: 'getPermissions' });
        }

        // Request auto-apply state
        vscode.postMessage({ command: 'getAutoApplyState' });

        // =====================================================
        // WebSocket Chat Implementation
        // =====================================================

        // Intersection Observer for read receipts
        let messageReadObserver = null;
        const readMessageIds = new Set();  // Track which messages we've already sent read receipts for

        /**
         * Initialize Intersection Observer for read receipts.
         * Called once when messages container is available.
         */
        function initReadReceiptObserver() {
            if (messageReadObserver) return;  // Already initialized

            messageReadObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const messageId = entry.target.getAttribute('data-message-id');
                        if (messageId && !readMessageIds.has(messageId)) {
                            readMessageIds.add(messageId);
                            sendReadReceipt(messageId);
                            // Stop observing this message
                            messageReadObserver.unobserve(entry.target);
                        }
                    }
                });
            }, {
                root: messagesContainer,
                threshold: 0.5  // Message is 50% visible
            });
        }

        // Initialize observer when DOM is ready
        initReadReceiptObserver();

        /**
         * Format timestamp for display
         */
        function formatTime(ts) {
            const date = new Date(ts * 1000);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        /**
         * Show a toast notification.
         * @param {string} message - Toast message text.
         * @param {'error'|'success'|'info'} type - Toast type.
         */
        function showToast(message, type = 'error') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 250);
            }, 4000);
        }

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Get initials from a display name
         */
        function getInitials(name) {
            const parts = name.includes('.') && !name.includes(' ')
                ? name.split('.') : name.split(' ');
            return parts.map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function buildNameAndRole(displayName, role, identitySource) {
            const nameColor = role === 'host' ? 'name-host' : 'name-guest';
            const pill = role === 'host'
                ? '<span class="role-pill role-pill-host ml-1.5">host</span>' : '';
            const ssoPill = identitySource === 'sso'
                ? '<span class="role-pill role-pill-sso ml-1">SSO</span>' : '';
            const nameHtml = `<div class="flex items-center gap-1 mb-1 ml-1">
                <span class="text-xs font-semibold ${nameColor}">${escapeHtml(displayName)}</span>${pill}${ssoPill}</div>`;
            const bubbleAccent = role === 'host' ? 'bubble-host' : 'bubble-guest';
            return { nameHtml, bubbleAccent };
        }

        /**
         * Render the users list in the sidebar with enhanced status display
         */
        function renderUsersList(users) {
            usersMap.clear();
            users.forEach(u => usersMap.set(u.userId, u));

            // Update count badge
            userCount.textContent = users.length;

            // Update room ID display if available
            if (session.roomId) {
                const roomIdDisplay = document.getElementById('room-id-display');
                const shortId = session.roomId.slice(0, 8);
                roomIdDisplay.innerHTML = `Room: <span class="text-purple-400 font-mono">${shortId}...</span>`;
                roomIdDisplay.title = session.roomId;
            }

            // Determine if current user can transfer lead (host or current lead)
            const myIsHost = session.sessionRole === 'host';
            const myIsLead = session.userId === session.leadId;
            const canTransferLead = myIsHost || myIsLead;

            usersList.innerHTML = users.map(user => {
                const colorClass = avatarColors[user.avatarColor] || 'bg-purple-600';
                const isHost = user.role === 'host';
                const isMe = user.userId === session.userId;
                const isTyping = typingUsers.has(user.userId);
                const isUserLead = user.userId === session.leadId;

                // Role pill
                const rolePill = isHost
                    ? '<span class="role-pill role-pill-host">host</span>'
                    : '<span class="role-pill role-pill-guest">member</span>';

                // Lead pill
                const leadPill = isUserLead
                    ? '<span class="role-pill" style="background:rgba(168,85,247,0.15);color:#c084fc;">&#9733; lead</span>'
                    : '';

                // SSO pill
                const ssoPill = user.identitySource === 'sso'
                    ? '<span class="role-pill role-pill-sso">SSO</span>'
                    : '';

                // Transfer Lead button (shown to host/lead, not on self, not on current lead)
                const transferBtn = (canTransferLead && !isMe && !isUserLead)
                    ? `<button class="transfer-lead-btn ml-auto text-xs text-purple-400 hover:text-purple-300 hover:bg-purple-500/10 px-1.5 py-0.5 rounded transition-colors" data-target-id="${escapeHtml(user.userId)}" title="Transfer lead to ${escapeHtml(user.displayName)}">Make Lead</button>`
                    : '';

                // Status indicator
                const statusDot = isTyping
                    ? '<span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-blue-500 rounded-full animate-pulse"></span>'
                    : '<span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border border-gray-800 online-glow"></span>';

                // Typing status text
                const typingText = isTyping
                    ? '<span class="text-xs text-blue-400 italic">typing...</span>'
                    : '';

                const nameColor = isHost ? 'text-amber-300' : (isUserLead ? 'text-purple-300' : 'text-gray-200');

                return `
                    <div class="user-item flex items-center gap-2 p-2 rounded-lg transition-colors ${isMe ? 'ring-1 ring-gray-600/50' : 'hover:bg-gray-700/30'}" data-user-id="${escapeHtml(user.userId)}">
                        <div class="relative flex-shrink-0">
                            <div class="w-8 h-8 ${colorClass} rounded-full flex items-center justify-center text-white text-xs font-medium shadow-sm">
                                ${getInitials(user.displayName)}
                            </div>
                            ${statusDot}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center">
                                <span class="text-sm ${nameColor} truncate font-medium">${escapeHtml(user.displayName)}</span>
                                ${isMe ? '<span class="ml-1 text-xs text-gray-500">you</span>' : ''}
                                ${transferBtn}
                            </div>
                            <div class="flex items-center gap-1 mt-0.5">
                                ${rolePill}
                                ${leadPill}
                                ${ssoPill}
                                ${typingText}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Attach click handlers for transfer lead buttons
            usersList.querySelectorAll('.transfer-lead-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const targetId = btn.getAttribute('data-target-id');
                    if (ws && ws.readyState === WebSocket.OPEN && targetId) {
                        ws.send(JSON.stringify({ type: 'transfer_lead', targetUserId: targetId }));
                    }
                });
            });
        }

        /**
         * Format file size for display
         */
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        /**
         * Get file icon based on file type.
         * @param {string} fileType - File type (image, pdf, audio, other).
         * @returns {string} Emoji icon for the file type.
         */
        function getFileIcon(fileType) {
            switch (fileType) {
                case 'image': return '🖼️';
                case 'pdf': return '📄';
                case 'audio': return '🎵';
                default: return '📎';
            }
        }

        /**
         * Format a date for display as a date separator.
         * @param {Date} date - The date to format.
         * @returns {string} Formatted date string (e.g., "Today", "Yesterday", or "Feb 7, 2026").
         */
        function formatDateSeparator(date) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
            }
        }

        /**
         * Render a date separator in the messages container.
         * @param {Date} date - The date for the separator.
         */
        function renderDateSeparator(date) {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-center my-3 gap-3';
            div.innerHTML = `
                <div class="flex-1 h-px" style="background:linear-gradient(90deg,transparent,rgba(139,92,246,0.1),transparent);"></div>
                <span class="text-[0.6rem] text-gray-500 font-medium tracking-wide uppercase">
                    ${formatDateSeparator(date)}
                </span>
                <div class="flex-1 h-px" style="background:linear-gradient(90deg,transparent,rgba(139,92,246,0.1),transparent);"></div>
            `;
            messagesContainer.appendChild(div);
        }

        /**
         * Update the typing indicator display.
         * Shows which users are currently typing.
         */
        function updateTypingIndicator() {
            if (typingUsers.size === 0) {
                typingIndicator.classList.add('hidden');
                return;
            }

            const names = Array.from(typingUsers.values());
            let text;
            if (names.length === 1) {
                text = `${names[0]} is typing`;
            } else if (names.length === 2) {
                text = `${names[0]} and ${names[1]} are typing`;
            } else {
                text = `${names[0]} and ${names.length - 1} others are typing`;
            }

            typingText.innerHTML = `${escapeHtml(text)}<span class="typing-dots"><span></span><span></span><span></span></span>`;
            typingIndicator.classList.remove('hidden');
        }

        /**
         * Handle incoming typing indicator from another user.
         * Updates both the typing indicator and user list to show typing status.
         * @param {Object} data - Typing event data with userId, displayName, isTyping.
         */
        function handleTypingEvent(data) {
            if (data.isTyping) {
                typingUsers.set(data.userId, data.displayName);
                // Auto-expire after TYPING_EXPIRE_MS
                setTimeout(() => {
                    typingUsers.delete(data.userId);
                    updateTypingIndicator();
                    updateUserTypingStatus(data.userId, false);
                }, TYPING_EXPIRE_MS);
            } else {
                typingUsers.delete(data.userId);
            }
            updateTypingIndicator();
            updateUserTypingStatus(data.userId, data.isTyping);
        }

        /**
         * Update a specific user's typing status in the user list
         * without re-rendering the entire list
         */
        function updateUserTypingStatus(userId, isTyping) {
            const userItem = usersList.querySelector(`[data-user-id="${userId}"]`);
            if (!userItem) return;

            // Update status dot
            const statusDot = userItem.querySelector('.absolute');
            if (statusDot) {
                if (isTyping) {
                    statusDot.className = 'absolute bottom-0 right-0 w-2.5 h-2.5 bg-blue-500 rounded-full animate-pulse';
                } else {
                    statusDot.className = 'absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border border-gray-800';
                }
            }

            // Update typing text
            const statusTextContainer = userItem.querySelector('.flex.items-center.gap-1.mt-0\\.5');
            if (statusTextContainer) {
                const existingTyping = statusTextContainer.querySelector('.italic');
                if (isTyping && !existingTyping) {
                    const typingSpan = document.createElement('span');
                    typingSpan.className = 'text-xs text-blue-400 italic';
                    typingSpan.textContent = 'typing...';
                    statusTextContainer.appendChild(typingSpan);
                } else if (!isTyping && existingTyping) {
                    existingTyping.remove();
                }
            }
        }

        /**
         * Send typing indicator to other users (debounced).
         * @param {boolean} isTyping - Whether the user is currently typing.
         */
        function sendTypingIndicator(isTyping) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            // SECURITY: Backend uses assigned userId, we only send displayName
            ws.send(JSON.stringify({
                type: 'typing',
                displayName: session.displayName || 'Host',
                isTyping: isTyping
            }));
        }

        /**
         * Check if user is scrolled near the bottom of messages.
         * @returns {boolean} True if within SCROLL_THRESHOLD of bottom.
         */
        function isNearBottom() {
            const { scrollTop, scrollHeight, clientHeight } = messagesContainer;
            return scrollHeight - scrollTop - clientHeight < SCROLL_THRESHOLD;
        }

        /**
         * Update scroll-to-bottom button visibility and unread count.
         */
        function updateScrollButton() {
            if (isUserScrolledUp) {
                scrollToBottomBtn.classList.remove('hidden');
                if (unreadCount > 0) {
                    unreadCountBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    unreadCountBadge.classList.remove('hidden');
                } else {
                    unreadCountBadge.classList.add('hidden');
                }
            } else {
                scrollToBottomBtn.classList.add('hidden');
                unreadCount = 0;
            }
        }

        /**
         * Scroll to the bottom of messages container.
         * @param {boolean} force - Force scroll even if user scrolled up.
         */
        function scrollToBottom(force = true) {
            if (force || !isUserScrolledUp) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                isUserScrolledUp = false;
                unreadCount = 0;
                updateScrollButton();
            }
        }

        /**
         * Smart scroll: scroll to bottom if user is near bottom, otherwise increment unread.
         * @param {boolean} isOwnMessage - True if this is the current user's message.
         */
        function smartScroll(isOwnMessage = false) {
            if (isOwnMessage || !isUserScrolledUp) {
                scrollToBottom(true);
            } else {
                unreadCount++;
                updateScrollButton();
            }
        }

        /**
         * Handle scroll event on messages container.
         * Triggers pagination when scrolled near top.
         */
        function handleScroll() {
            isUserScrolledUp = !isNearBottom();
            if (!isUserScrolledUp) {
                unreadCount = 0;
            }
            updateScrollButton();

            // Trigger pagination when scrolled near top
            if (messagesContainer.scrollTop < PAGINATION_THRESHOLD && hasMoreHistory && !isLoadingHistory) {
                loadMoreHistory();
            }
        }

        /**
         * Handle input event for typing indicator.
         * Debounces typing indicator messages and auto-resizes textarea.
         */
        function handleInputEvent() {
            const now = Date.now();

            // Auto-resize textarea
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px';

            // Send typing indicator (debounced)
            if (!isTyping) {
                isTyping = true;
                sendTypingIndicator(true);
            }
            lastTypingTime = now;

            // Clear existing timeout and set new one
            if (typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                if (Date.now() - lastTypingTime >= TYPING_DEBOUNCE_MS && isTyping) {
                    isTyping = false;
                    sendTypingIndicator(false);
                }
            }, TYPING_DEBOUNCE_MS);
        }

        /**
         * Check if a message should be grouped with the previous message.
         * Messages from the same user within MESSAGE_GROUP_INTERVAL_MS are grouped.
         * @param {Object} msg - Message object with userId and ts.
         * @returns {boolean} True if message should be grouped.
         */
        function shouldGroupMessage(msg) {
            const msgTime = msg.ts * 1000;
            const sameUser = msg.userId === lastMessageUserId;
            const withinInterval = (msgTime - lastMessageTime) < MESSAGE_GROUP_INTERVAL_MS;
            return sameUser && withinInterval;
        }

        /**
         * Check if a date separator is needed before this message.
         * @param {Object} msg - Message object with ts timestamp.
         * @returns {boolean} True if a date separator should be rendered.
         */
        function needsDateSeparator(msg) {
            const msgDate = new Date(msg.ts * 1000);
            const msgDateStr = msgDate.toDateString();

            if (lastMessageDate !== msgDateStr) {
                lastMessageDate = msgDateStr;
                return true;
            }
            return false;
        }

        /**
         * Render a code snippet message in the UI.
         * @param {Object} msg - Message object with codeSnippet data.
         */
        function renderCodeSnippetMessage(msg) {
            // Store code snippet message for summarization
            const snippet = msg.codeSnippet || {};
            const lineInfo = snippet.startLine === snippet.endLine
                ? `Line ${snippet.startLine}`
                : `Lines ${snippet.startLine}-${snippet.endLine}`;
            const snippetText = `[Code Snippet: ${snippet.relativePath || snippet.filename || 'code'} ${lineInfo}]\n${snippet.code || ''}${msg.content ? '\nComment: ' + msg.content : ''}`;
            const apiRole = msg.role === 'host' ? 'host' : 'engineer';
            chatMessages.push({
                role: apiRole,
                text: snippetText,
                timestamp: msg.ts || Date.now() / 1000
            });

            const isOwnMessage = msg.userId === session.userId;
            const isGrouped = shouldGroupMessage(msg);

            // Update grouping state for next message
            lastMessageUserId = msg.userId;
            lastMessageTime = msg.ts * 1000;

            const div = document.createElement('div');
            div.setAttribute('data-message-id', msg.id || '');
            div.setAttribute('data-timestamp', msg.ts || '');
            div.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} gap-2 ${isGrouped ? 'mt-1' : ''}`;

            const timeAlign = isOwnMessage ? 'text-right' : '';
            const displayName = msg.displayName || usersMap.get(msg.userId)?.displayName || 'Unknown';
            const idSource = msg.identitySource || usersMap.get(msg.userId)?.identitySource;
            const { nameHtml, bubbleAccent } = buildNameAndRole(displayName, msg.role, idSource);

            // Get avatar color from users map or default
            const userInfo = usersMap.get(msg.userId);
            const colorClass = userInfo ? (avatarColors[userInfo.avatarColor] || 'bg-purple-600') : 'bg-gray-600';

            // Hide avatar and name for grouped messages
            const avatarHtml = (!isOwnMessage && !isGrouped) ? `
                <div class="w-7 h-7 ${colorClass} rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 mt-1">
                    ${getInitials(displayName)}
                </div>
            ` : (!isOwnMessage && isGrouped) ? '<div class="w-7 flex-shrink-0"></div>' : '';

            const showName = !isOwnMessage && !isGrouped;

            // Status indicator for own messages
            const statusHtml = isOwnMessage ? '<span class="message-status text-violet-300/70 ml-1">✓</span>' : '';

            // Comment text if any
            const commentHtml = msg.content ? `
                <p class="text-sm leading-relaxed break-words whitespace-pre-wrap mb-2">${escapeHtml(msg.content)}</p>
            ` : '';

            // Unique IDs for all interactive elements in this snippet bubble
            const uid           = msg.id || Date.now();
            const navigateBtnId = `nav-btn-${uid}`;
            const explainBtnId  = `exp-btn-${uid}`;
            const explainAreaId = `exp-area-${uid}`;
            const questionInpId = `exp-q-${uid}`;
            const explainSubId  = `exp-sub-${uid}`;
            const explainCanId  = `exp-cancel-${uid}`;

            const aiOk = aiSummaryEnabledState && !!aiActiveProviderState;
            const explainDisabled = aiOk ? '' : 'disabled';
            const explainCls = aiOk
                ? 'text-emerald-400/70 hover:text-emerald-300 hover:bg-emerald-500/10'
                : 'text-gray-600 opacity-40 cursor-not-allowed';
            const explainTitle = aiOk ? 'Explain with AI' : 'AI not available';

            div.innerHTML = `
                ${avatarHtml}
                <div class="max-w-[85%] min-w-0">
                    ${showName ? nameHtml : ''}
                    <div class="bg-gray-800 rounded-lg overflow-hidden border border-gray-700 shadow-lg ${!isOwnMessage ? bubbleAccent : ''}">
                        ${commentHtml ? `<div class="px-4 py-2 border-b border-gray-700">${commentHtml}</div>` : ''}
                        <div class="flex items-center justify-between px-3 py-2 bg-gray-700/50 border-b border-gray-600">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                <span class="text-xs text-gray-300 font-mono truncate max-w-[140px]" title="${escapeHtml(snippet.filename || '')}">${escapeHtml(snippet.relativePath || snippet.filename || 'code')}</span>
                                <span class="text-xs text-gray-500">${lineInfo}</span>
                            </div>
                            <div class="flex items-center gap-0.5">
                                <button id="${navigateBtnId}" class="navigate-to-code-btn p-1.5 rounded hover:bg-gray-600 transition-colors" title="Go to code location">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-gray-400 hover:text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <button id="${explainBtnId}" ${explainDisabled} class="snippet-explain-btn p-1.5 rounded transition-colors ${explainCls}" title="${explainTitle}" data-snippet-uid="${uid}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.68.166-1.32.42-1.897A5 5 0 006 10a5 5 0 006 10l-.579 2.894A1 1 0 0012 14z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <pre class="code-snippet-plain p-3 text-xs font-mono text-gray-300 whitespace-pre-wrap break-words max-h-48 overflow-y-auto max-w-full">${escapeHtml(snippet.code || '')}</pre>
                        <!-- Inline question input (hidden until Explain button is clicked) -->
                        <div id="${explainAreaId}" class="hidden border-t border-gray-700/50">
                            <div class="px-3 py-2 flex flex-col gap-1.5" style="background:rgba(5,20,15,0.6);">
                                <input id="${questionInpId}" type="text" maxlength="300"
                                    placeholder="What do you want to know? (optional)"
                                    class="w-full rounded-lg px-2.5 py-1.5 text-xs focus:outline-none"
                                    style="background:rgba(30,40,35,0.95);color:rgba(220,220,220,0.9);border:1px solid rgba(52,211,153,0.25);placeholder-color:#6b7280;"/>
                                <div class="flex items-center justify-end gap-2">
                                    <button id="${explainCanId}" class="text-xs text-gray-500 hover:text-gray-300 px-2 py-0.5 rounded transition-colors">Cancel</button>
                                    <button id="${explainSubId}" class="text-xs px-3 py-1 rounded-lg text-emerald-200 transition-colors" style="background:rgba(5,100,60,0.55);border:1px solid rgba(52,211,153,0.2);">Explain</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5 ${timeAlign} ${isOwnMessage ? 'mr-1' : 'ml-1'} flex items-center ${isOwnMessage ? 'justify-end' : ''}">
                        <span>${formatTime(msg.ts)}</span>${statusHtml}
                    </div>
                </div>
            `;

            messagesContainer.appendChild(div);

            // Navigate button
            const navigateBtn = document.getElementById(navigateBtnId);
            if (navigateBtn) {
                navigateBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    vscode.postMessage({
                        command: 'navigateToCode',
                        relativePath: snippet.relativePath || snippet.filename,
                        startLine: snippet.startLine,
                        endLine: snippet.endLine,
                    });
                });
            }

            // Explain button — toggle inline question input
            const explainBtn  = document.getElementById(explainBtnId);
            const explainArea = document.getElementById(explainAreaId);
            const questionInp = document.getElementById(questionInpId);
            const explainSub  = document.getElementById(explainSubId);
            const explainCan  = document.getElementById(explainCanId);

            const _closeExplainArea = () => explainArea?.classList.add('hidden');

            if (explainBtn && explainArea) {
                explainBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (explainBtn.hasAttribute('disabled')) return;
                    const opening = explainArea.classList.contains('hidden');
                    explainArea.classList.toggle('hidden', !opening);
                    if (opening) questionInp?.focus();
                });
            }
            if (explainCan) explainCan.addEventListener('click', (e) => { e.stopPropagation(); _closeExplainArea(); });

            const _doExplain = () => {
                const question = (questionInp)?.value?.trim() || undefined;
                // Show spinner in explain button while working
                if (explainBtn) {
                    explainBtn.setAttribute('disabled', 'true');
                    explainBtn.setAttribute('data-loading', 'true');
                    explainBtn.innerHTML = `<svg class="animate-spin h-3.5 w-3.5 text-emerald-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>`;
                }
                _closeExplainArea();
                vscode.postMessage({
                    command: 'explainCodeFromSnippet',
                    code:         snippet.code,
                    relativePath: snippet.relativePath || snippet.filename,
                    startLine:    snippet.startLine,
                    endLine:      snippet.endLine,
                    language:     snippet.language,
                    roomId:       session.roomId,
                    question,
                });
            };

            if (explainSub) explainSub.addEventListener('click', (e) => { e.stopPropagation(); _doExplain(); });
            if (questionInp) {
                questionInp.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); _doExplain(); }
                    if (e.key === 'Escape') { e.stopPropagation(); _closeExplainArea(); }
                });
            }

            smartScroll(isOwnMessage);

            // Observe for read receipts (only for messages from others)
            if (!isOwnMessage && msg.id && messageReadObserver) {
                messageReadObserver.observe(div);
            }
        }

        // ============================================================
        // ============================================================
        // renderStackTraceMessage
        // ============================================================

        /**
         * Render a stack trace message in the chat.
         * Frames with a resolved relativePath are clickable (navigate to file:line).
         * @param {Object} msg - Stack trace message.
         */
        function renderStackTraceMessage(msg) {
            const parsed = msg.stackTrace || {};
            const frames = parsed.frames || [];
            const isOwnMessage = msg.userId === session.userId;
            const isGrouped = shouldGroupMessage(msg);
            lastMessageUserId = msg.userId;
            lastMessageTime = (msg.ts || 0) * 1000;

            if (needsDateSeparator(msg)) renderDateSeparator(new Date(msg.ts * 1000));

            const userInfo = usersMap.get(msg.userId);
            const displayName = msg.displayName || userInfo?.displayName || 'Unknown';
            const colorClass = userInfo ? (avatarColors[userInfo.avatarColor] || 'bg-red-700') : 'bg-red-700';
            const idSource = msg.identitySource || userInfo?.identitySource;
            const { nameHtml } = buildNameAndRole(displayName, msg.role, idSource);
            const avatarHtml = (!isOwnMessage && !isGrouped) ? `
                <div class="w-7 h-7 ${colorClass} rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 mt-1">
                    ${getInitials(displayName)}
                </div>` : (!isOwnMessage && isGrouped) ? '<div class="w-7 flex-shrink-0"></div>' : '';

            // Build frame rows
            const framesHtml = frames.map((frame, idx) => {
                const navigable = !frame.isInternal && (frame.relativePath || frame.filePath);
                const displayPath = frame.relativePath || (frame.filePath ? frame.filePath.split('/').slice(-2).join('/') : '?');
                const lineInfo = frame.lineNumber ? `:${frame.lineNumber}` : '';
                const funcInfo = frame.functionName ? ` in ${escapeHtml(frame.functionName)}` : '';
                return `<div class="stack-frame flex items-center gap-2 px-3 py-1.5 text-xs font-mono border-b border-red-900/20
                        ${navigable ? 'cursor-pointer hover:bg-red-900/20 group' : 'opacity-40'}"
                        ${navigable ? `data-frame-path="${escapeHtml(frame.relativePath || frame.filePath || '')}" data-frame-line="${frame.lineNumber || 1}"` : ''}>
                    <span class="text-red-400/50 text-[0.6rem] w-4 text-right flex-shrink-0">${idx + 1}</span>
                    <span class="${navigable ? 'text-blue-400 group-hover:text-blue-300' : 'text-gray-500'} truncate">${escapeHtml(displayPath)}${escapeHtml(lineInfo)}</span>
                    <span class="text-gray-600 truncate">${escapeHtml(funcInfo)}</span>
                </div>`;
            }).join('');

            const msgId = `st-${msg.id || Date.now()}`;
            const div = document.createElement('div');
            div.setAttribute('data-message-id', msg.id || '');
            div.setAttribute('data-timestamp', msg.ts || '');
            div.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} gap-2 ${isGrouped ? 'mt-1' : 'mt-2'}`;
            div.innerHTML = `
                ${avatarHtml}
                <div class="max-w-[90%] min-w-0">
                    ${(!isOwnMessage && !isGrouped) ? nameHtml : ''}
                    <div class="bg-red-950/30 rounded-lg overflow-hidden border border-red-800/40 shadow-lg">
                        <div class="flex items-center gap-2 px-3 py-2 bg-red-900/20 border-b border-red-800/40">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-red-400 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-xs font-semibold text-red-300 truncate">${escapeHtml(parsed.errorType || 'Error')}</span>
                            <span class="text-xs text-red-400/70 truncate flex-1 min-w-0">${escapeHtml(parsed.errorMessage || '')}</span>
                            <button class="copy-raw-st ml-auto p-1 rounded hover:bg-red-800/40 text-gray-500 hover:text-gray-300 text-xs flex-shrink-0" title="Copy raw text">⎘</button>
                        </div>
                        <div id="${msgId}-frames" class="divide-y divide-red-900/10 max-h-48 overflow-y-auto">${framesHtml}</div>
                        ${frames.length === 0 ? `<div class="px-3 py-2 text-xs text-gray-500 font-mono">${escapeHtml(parsed.rawText || msg.rawText || '')}</div>` : ''}
                        ${parsed.language && parsed.language !== 'unknown' ? `<div class="px-3 py-1 text-[0.6rem] text-gray-600 border-t border-red-900/20">${escapeHtml(parsed.language)}</div>` : ''}
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5 ${isOwnMessage ? 'text-right mr-1' : 'ml-1'}">${formatTime(msg.ts)}</div>
                </div>`;

            messagesContainer.appendChild(div);

            // Wire up frame clicks
            div.querySelectorAll('.stack-frame[data-frame-path]').forEach(el => {
                el.addEventListener('click', () => {
                    vscode.postMessage({
                        command: 'navigateToCode',
                        relativePath: el.dataset.framePath,
                        startLine: parseInt(el.dataset.frameLine || '1'),
                        endLine: parseInt(el.dataset.frameLine || '1'),
                    });
                });
            });

            // Copy raw
            div.querySelector('.copy-raw-st')?.addEventListener('click', (e) => {
                e.stopPropagation();
                navigator.clipboard.writeText(parsed.rawText || msg.rawText || '');
            });

            smartScroll(isOwnMessage);
            if (!isOwnMessage && msg.id && messageReadObserver) messageReadObserver.observe(div);
        }

        // ============================================================
        // renderTestFailureMessage
        // ============================================================

        /**
         * Render a test failure message in the chat.
         * @param {Object} msg - Test failure message.
         */
        function renderTestFailureMessage(msg) {
            const tf = msg.testFailure || {};
            const tests = tf.tests || [];
            const isOwnMessage = msg.userId === session.userId;
            const isGrouped = shouldGroupMessage(msg);
            lastMessageUserId = msg.userId;
            lastMessageTime = (msg.ts || 0) * 1000;

            if (needsDateSeparator(msg)) renderDateSeparator(new Date(msg.ts * 1000));

            const userInfo = usersMap.get(msg.userId);
            const displayName = msg.displayName || userInfo?.displayName || 'Unknown';
            const colorClass = userInfo ? (avatarColors[userInfo.avatarColor] || 'bg-orange-700') : 'bg-orange-700';
            const idSource = msg.identitySource || userInfo?.identitySource;
            const { nameHtml } = buildNameAndRole(displayName, msg.role, idSource);
            const avatarHtml = (!isOwnMessage && !isGrouped) ? `
                <div class="w-7 h-7 ${colorClass} rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 mt-1">
                    ${getInitials(displayName)}
                </div>` : (!isOwnMessage && isGrouped) ? '<div class="w-7 flex-shrink-0"></div>' : '';

            const testsHtml = tests.map(t => {
                const navigable = t.filePath;
                return `<div class="px-3 py-2 border-b border-orange-900/20 hover:bg-orange-900/10">
                    <div class="flex items-start gap-2">
                        <span class="text-orange-400 text-xs flex-shrink-0">✗</span>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-mono text-orange-200 break-all">${escapeHtml(t.name)}</p>
                            ${t.errorMessage ? `<p class="text-[0.65rem] text-gray-400 mt-0.5 break-words">${escapeHtml(t.errorMessage)}</p>` : ''}
                            ${navigable ? `<button class="test-nav-btn text-[0.6rem] text-blue-400 hover:text-blue-300 mt-0.5 underline underline-offset-2"
                                data-path="${escapeHtml(t.filePath)}" data-line="${t.lineNumber || 1}">${escapeHtml(t.filePath)}:${t.lineNumber || '?'}</button>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');

            const div = document.createElement('div');
            div.setAttribute('data-message-id', msg.id || '');
            div.setAttribute('data-timestamp', msg.ts || '');
            div.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} gap-2 ${isGrouped ? 'mt-1' : 'mt-2'}`;
            div.innerHTML = `
                ${avatarHtml}
                <div class="max-w-[90%] min-w-0">
                    ${(!isOwnMessage && !isGrouped) ? nameHtml : ''}
                    <div class="bg-orange-950/30 rounded-lg overflow-hidden border border-orange-800/40 shadow-lg">
                        <div class="flex items-center gap-2 px-3 py-2 bg-orange-900/20 border-b border-orange-800/40">
                            <span class="text-orange-400 text-sm">🧪</span>
                            <span class="text-xs font-semibold text-orange-300">${tf.totalFailed || tests.length} test${tf.totalFailed !== 1 ? 's' : ''} failed</span>
                            <span class="text-[0.65rem] text-gray-500 ml-1">${escapeHtml(tf.framework || '')}</span>
                        </div>
                        <div class="max-h-48 overflow-y-auto">${testsHtml || `<div class="px-3 py-2 text-xs text-gray-500">${escapeHtml(tf.rawOutput || 'No details')}</div>`}</div>
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5 ${isOwnMessage ? 'text-right mr-1' : 'ml-1'}">${formatTime(msg.ts)}</div>
                </div>`;

            messagesContainer.appendChild(div);

            div.querySelectorAll('.test-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    vscode.postMessage({ command: 'navigateToCode', relativePath: btn.dataset.path, startLine: parseInt(btn.dataset.line), endLine: parseInt(btn.dataset.line) });
                });
            });

            smartScroll(isOwnMessage);
            if (!isOwnMessage && msg.id && messageReadObserver) messageReadObserver.observe(div);
        }

        // ============================================================
        // renderAiExplanationMessage
        // ============================================================

        function renderAiExplanationMessage(msg) {
            const aiData = msg.aiData || {};
            const isOwnMessage = msg.userId === session.userId;
            const isGrouped = shouldGroupMessage(msg);
            lastMessageUserId = msg.userId;
            lastMessageTime = (msg.ts || 0) * 1000;

            if (needsDateSeparator(msg)) renderDateSeparator(new Date(msg.ts * 1000));

            const code = aiData.code || '';
            const relativePath = aiData.relativePath || '';
            const startLine = aiData.startLine || 1;
            const endLine = aiData.endLine || startLine;
            const lineInfo = startLine === endLine ? `L${startLine}` : `L${startLine}-${endLine}`;
            const navigateBtnId = `exp-nav-${msg.id || Date.now()}`;

            const div = document.createElement('div');
            div.setAttribute('data-message-id', msg.id || '');
            div.setAttribute('data-timestamp', msg.ts || '');
            div.className = `flex justify-start gap-2 ${isGrouped ? 'mt-1' : 'mt-2'}`;
            div.innerHTML = `
                <div class="w-7 h-7 bg-emerald-700 rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 mt-1">AI</div>
                <div class="max-w-[90%] min-w-0">
                    <div class="bg-emerald-950/30 rounded-lg overflow-hidden border border-emerald-800/40 shadow-lg">
                        <div class="flex items-center gap-2 px-3 py-2 bg-emerald-900/20 border-b border-emerald-800/40">
                            <span class="text-emerald-400 text-sm">💡</span>
                            <span class="text-xs font-semibold text-emerald-300">Code Explanation</span>
                            ${relativePath ? `<button id="${navigateBtnId}" class="ml-auto text-[0.65rem] text-blue-400 hover:text-blue-300 font-mono truncate max-w-[140px]" title="Navigate to code">${escapeHtml(relativePath)} ${lineInfo}</button>` : ''}
                        </div>
                        ${code ? `<pre class="px-3 pt-2 pb-1 text-xs font-mono text-gray-300 overflow-x-auto max-h-28 overflow-y-auto border-b border-emerald-900/20 bg-black/20">${escapeHtml(code)}</pre>` : ''}
                        <div class="px-3 py-2.5 text-xs text-gray-200 leading-relaxed break-words">${renderExplanationMarkdown(msg.content || '')}</div>
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5 ml-1">${formatTime(msg.ts)}</div>
                </div>`;

            messagesContainer.appendChild(div);

            const navBtn = document.getElementById(navigateBtnId);
            if (navBtn && relativePath) {
                navBtn.addEventListener('click', () => {
                    vscode.postMessage({ command: 'navigateToCode', relativePath, startLine, endLine });
                });
            }

            smartScroll(false);
            if (msg.id && messageReadObserver) messageReadObserver.observe(div);
        }

        /**
         * Render an AI summary message in the UI.
         * Shows structured summary with special styling and "Generate Code Prompt" button for hosts.
         * @param {Object} msg - AI summary message object with aiData containing summary fields.
         */
        function renderAiSummaryMessage(msg) {
            // Check if we need a date separator
            if (needsDateSeparator(msg)) {
                renderDateSeparator(new Date(msg.ts * 1000));
            }

            // Update grouping state
            lastMessageUserId = msg.userId;
            lastMessageTime = msg.ts * 1000;

            const div = document.createElement('div');
            div.setAttribute('data-message-id', msg.id || '');
            div.setAttribute('data-timestamp', msg.ts || '');
            div.className = 'flex justify-start gap-2 message-enter';

            const aiData = msg.aiData || {};
            const riskLevel = aiData.risk_level || 'low';
            const components = aiData.affected_components || [];
            const steps = aiData.next_steps || [];

            // Risk visual system
            const riskVisual = ({
                low:    { dot: 'bg-green-400',  text: 'text-green-400',  badge: 'bg-green-600/80'  },
                medium: { dot: 'bg-amber-400',  text: 'text-amber-400',  badge: 'bg-amber-600/80'  },
                high:   { dot: 'bg-red-400',    text: 'text-red-400',    badge: 'bg-red-600/80'    },
            })[riskLevel] || { dot: 'bg-green-400', text: 'text-green-400', badge: 'bg-green-600/80' };

            // Discussion type badge (header pill)
            const discussionTypeBadge = aiData.discussion_type
                ? `<span class="px-2 py-0.5 bg-purple-900/60 text-purple-300 text-[10px] rounded-full border border-purple-700/40 font-medium">${escapeHtml(aiData.discussion_type.replace(/_/g, ' '))}</span>`
                : '';

            // Components HTML
            const componentsHtml = components.length > 0 ? `
                <div class="px-4 pb-3 ai-section-3">
                    <div class="text-[10px] font-semibold text-gray-500 uppercase tracking-widest mb-1.5">Files</div>
                    <div class="flex flex-wrap gap-1">
                        ${components.map(c => `<code class="px-2 py-0.5 bg-gray-900/70 text-gray-300 text-[11px] rounded-md border border-gray-700/50 font-mono">${escapeHtml(c)}</code>`).join('')}
                    </div>
                </div>
            ` : '';

            // Next steps HTML
            const stepsHtml = steps.length > 0 ? `
                <div class="px-4 pb-3 ai-section-4">
                    <div class="text-[10px] font-semibold text-gray-500 uppercase tracking-widest mb-2">Next Steps</div>
                    <div class="space-y-1.5">
                        ${steps.map((s, i) => `
                            <div class="flex items-start gap-2">
                                <span class="flex-shrink-0 w-4 h-4 rounded-full bg-purple-900/60 border border-purple-700/40 text-[10px] font-bold text-purple-300 flex items-center justify-center mt-0.5">${i + 1}</span>
                                <span class="text-xs text-gray-300 leading-relaxed">${escapeHtml(s)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            // Code prompt section - checklist UI for items, or single button fallback
            const isUserLead = session.userId === session.leadId;
            const codeRelevantItems = aiData.code_relevant_items || [];
            const showCodePromptBtn = isUserLead && aiData.requires_code_change;
            const codePromptBtnId = `gen-code-btn-${msg.id || Date.now()}`;
            const itemsChecklistId = `items-checklist-${msg.id || Date.now()}`;

            let codePromptBtnHtml = '';
            if (showCodePromptBtn && codeRelevantItems.length === 1) {
                // Single item: skip checklist, show a direct button
                const item = codeRelevantItems[0];
                const typeBadgeColors = {
                    'api_design': 'bg-cyan-700',
                    'code_change': 'bg-blue-700',
                    'product_flow': 'bg-emerald-700',
                    'architecture': 'bg-purple-700',
                    'debugging': 'bg-orange-700',
                };
                const riskBadgeColors = {
                    'low': 'bg-green-600',
                    'medium': 'bg-yellow-600',
                    'high': 'bg-red-600',
                };
                const typeBg = typeBadgeColors[item.type] || 'bg-gray-700';
                const riskBg = riskBadgeColors[item.risk_level] || 'bg-green-600';
                const typeLabel = item.type.replace(/_/g, ' ');
                codePromptBtnHtml = `
                    <div class="px-4 pb-4 pt-3 border-t border-purple-900/40 ai-section-5">
                        <div class="text-[10px] font-semibold text-gray-500 uppercase tracking-widest mb-2">Implementation</div>
                        <div class="flex items-center gap-1.5 flex-wrap mb-3">
                            <span class="px-1.5 py-0.5 ${typeBg} text-white text-[10px] rounded-md font-medium">${escapeHtml(typeLabel)}</span>
                            <span class="text-xs text-gray-200 font-semibold flex-1 min-w-0 truncate">${escapeHtml(item.title)}</span>
                            <span class="flex-shrink-0 px-1.5 py-0.5 ${riskBg} text-white text-[10px] rounded-md">${item.risk_level}</span>
                        </div>
                        <button id="${codePromptBtnId}" class="w-full btn-primary text-sm px-4 py-2.5 flex items-center justify-center gap-2 font-semibold">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Generate Code Prompt
                        </button>
                    </div>
                `;
            } else if (showCodePromptBtn && codeRelevantItems.length > 1) {
                // Multiple items: checklist UI with selectable items
                const typeBadgeColors = {
                    'api_design': 'bg-cyan-700',
                    'code_change': 'bg-blue-700',
                    'product_flow': 'bg-emerald-700',
                    'architecture': 'bg-purple-700',
                    'debugging': 'bg-orange-700',
                };
                const riskBadgeColors = {
                    'low': 'bg-green-600',
                    'medium': 'bg-yellow-600',
                    'high': 'bg-red-600',
                };

                const itemsHtml = codeRelevantItems.map((item, idx) => {
                    const typeBg = typeBadgeColors[item.type] || 'bg-gray-700';
                    const riskBg = riskBadgeColors[item.risk_level] || 'bg-green-600';
                    const typeLabel = item.type.replace(/_/g, ' ');
                    return `
                        <label class="flex items-start gap-2.5 px-3 py-2.5 rounded-lg cursor-pointer hover:bg-indigo-950/40 transition-colors border border-transparent hover:border-indigo-800/20">
                            <input type="checkbox" checked data-item-index="${idx}" class="mt-0.5 accent-indigo-400 flex-shrink-0 item-checkbox-${itemsChecklistId}" />
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-1.5 flex-wrap">
                                    <span class="px-1.5 py-0.5 ${typeBg} text-white text-[10px] rounded-md font-medium">${escapeHtml(typeLabel)}</span>
                                    <span class="text-xs text-gray-200 font-medium flex-1 min-w-0 truncate">${escapeHtml(item.title)}</span>
                                    <span class="flex-shrink-0 px-1.5 py-0.5 ${riskBg} text-white text-[10px] rounded-md">${item.risk_level}</span>
                                </div>
                                ${item.targets && item.targets.length > 0 ? `
                                    <div class="flex flex-wrap gap-1 mt-1.5">
                                        ${item.targets.map(t => `<code class="px-1.5 py-0.5 bg-gray-900/60 text-gray-400 text-[10px] rounded border border-gray-700/30 font-mono">${escapeHtml(t)}</code>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </label>
                    `;
                }).join('');

                codePromptBtnHtml = `
                    <div class="border-t border-purple-900/40 ai-section-5">
                        <div class="px-4 pt-3 pb-1">
                            <div class="text-[10px] font-semibold text-gray-500 uppercase tracking-widest">Implementation Items</div>
                        </div>
                        <div id="${itemsChecklistId}" class="px-1 pb-2 space-y-0.5">
                            ${itemsHtml}
                        </div>
                        <div class="px-4 pb-4">
                            <button id="${codePromptBtnId}" class="w-full btn-primary text-sm px-4 py-2.5 flex items-center justify-center gap-2 font-semibold">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                Generate Code Prompt (${codeRelevantItems.length} selected)
                            </button>
                        </div>
                    </div>
                `;
            } else if (showCodePromptBtn) {
                // Fallback: single button when no items but requires_code_change
                codePromptBtnHtml = `
                    <div class="px-4 pb-4 pt-3 border-t border-purple-900/40 ai-section-5">
                        <button id="${codePromptBtnId}" class="w-full btn-primary text-sm px-4 py-2.5 flex items-center justify-center gap-2 font-semibold">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Generate Code Prompt
                        </button>
                    </div>
                `;
            }

            div.innerHTML = `
                <div class="w-7 h-7 bg-gradient-to-br from-violet-600 to-indigo-600 rounded-full flex items-center justify-center text-white flex-shrink-0 mt-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z"/>
                    </svg>
                </div>
                <div class="max-w-[85%] min-w-0 flex-1">
                    <div class="text-xs text-gray-400 mb-1 ml-1 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-violet-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z"/></svg>
                        ${escapeHtml(msg.displayName || 'AI')}
                    </div>
                    <div class="bg-gradient-to-b from-violet-950/80 via-purple-950/60 to-gray-900/95 rounded-xl overflow-hidden border border-purple-700/40 shadow-2xl ai-card-border">
                        <!-- Header -->
                        <div class="px-4 py-2.5 bg-purple-900/20 border-b border-purple-800/30 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-purple-400 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z"/>
                                </svg>
                                <span class="text-xs font-semibold text-gradient tracking-wide">AI Distillation</span>
                                ${discussionTypeBadge}
                            </div>
                            <div class="flex items-center gap-1.5">
                                <span class="w-1.5 h-1.5 rounded-full ${riskVisual.dot}"></span>
                                <span class="text-[10px] font-semibold ${riskVisual.text} uppercase tracking-wider">${riskLevel}</span>
                            </div>
                        </div>
                        <!-- Topic -->
                        <div class="px-4 pt-3.5 pb-2 ai-section-1">
                            <div class="text-sm font-bold text-white leading-snug">${escapeHtml(aiData.topic || 'No topic')}</div>
                        </div>
                        <!-- Problem / Solution -->
                        <div class="px-4 pb-3 space-y-2 ai-section-2">
                            <div class="rounded-lg p-2.5 bg-black/20 border border-white/5">
                                <div class="text-[9px] font-bold text-purple-400/80 uppercase tracking-[0.12em] mb-1">Problem</div>
                                <div class="text-xs text-gray-300 leading-relaxed">${escapeHtml(aiData.problem_statement || '—')}</div>
                            </div>
                            <div class="rounded-lg p-2.5 bg-black/20 border border-white/5">
                                <div class="text-[9px] font-bold text-indigo-400/80 uppercase tracking-[0.12em] mb-1">Solution</div>
                                <div class="text-xs text-gray-300 leading-relaxed">${escapeHtml(aiData.proposed_solution || '—')}</div>
                            </div>
                        </div>
                        ${componentsHtml}${stepsHtml}${codePromptBtnHtml}
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5 ml-1">
                        <span>${formatTime(msg.ts)}</span>
                    </div>
                </div>
            `;

            messagesContainer.appendChild(div);

            // Add click handler for Generate Code Prompt button
            if (showCodePromptBtn) {
                const codePromptBtn = document.getElementById(codePromptBtnId);

                if (codeRelevantItems.length === 1 && codePromptBtn) {
                    // Single item: directly generate without checkbox selection
                    codePromptBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        currentCodePromptButtonId = codePromptBtnId;
                        vscode.postMessage({
                            command: 'generateCodePromptFromItemsAndPost',
                            items: [codeRelevantItems[0]],
                            topic: aiData.topic || '',
                            roomId: session.roomId
                        });
                        codePromptBtn.disabled = true;
                        codePromptBtn.innerHTML = `
                            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Generating...
                        `;
                    });
                } else if (codeRelevantItems.length > 1 && codePromptBtn) {
                    // Checklist mode: update count on checkbox change, send selected items
                    const checklistEl = document.getElementById(itemsChecklistId);
                    const checkboxes = checklistEl ? checklistEl.querySelectorAll(`input.item-checkbox-${itemsChecklistId}`) : [];

                    const updateButtonCount = () => {
                        const checkedCount = checklistEl ? checklistEl.querySelectorAll(`input.item-checkbox-${itemsChecklistId}:checked`).length : 0;
                        const btnTextNode = codePromptBtn.childNodes[codePromptBtn.childNodes.length - 1];
                        if (btnTextNode && btnTextNode.nodeType === Node.TEXT_NODE) {
                            btnTextNode.textContent = ` Generate Code Prompt (${checkedCount} selected)`;
                        }
                        codePromptBtn.disabled = checkedCount === 0;
                        if (checkedCount === 0) {
                            codePromptBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        } else {
                            codePromptBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    };

                    checkboxes.forEach(cb => {
                        cb.addEventListener('change', updateButtonCount);
                    });

                    codePromptBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Gather selected items
                        const selectedItems = [];
                        const allCheckboxes = checklistEl ? checklistEl.querySelectorAll(`input.item-checkbox-${itemsChecklistId}:checked`) : [];
                        allCheckboxes.forEach(cb => {
                            const idx = parseInt(cb.getAttribute('data-item-index'), 10);
                            if (!isNaN(idx) && codeRelevantItems[idx]) {
                                selectedItems.push(codeRelevantItems[idx]);
                            }
                        });

                        if (selectedItems.length === 0) return;

                        currentCodePromptButtonId = codePromptBtnId;
                        vscode.postMessage({
                            command: 'generateCodePromptFromItemsAndPost',
                            items: selectedItems,
                            topic: aiData.topic || '',
                            roomId: session.roomId
                        });

                        // Show loading state
                        codePromptBtn.disabled = true;
                        codePromptBtn.innerHTML = `
                            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Generating...
                        `;
                    });
                } else if (codePromptBtn) {
                    // Fallback: single button sends full summary
                    codePromptBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        currentSummaryData = aiData;
                        currentCodePromptButtonId = codePromptBtnId;
                        vscode.postMessage({
                            command: 'generateCodePromptAndPost',
                            decisionSummary: aiData,
                            roomId: session.roomId
                        });
                        codePromptBtn.disabled = true;
                        codePromptBtn.innerHTML = `
                            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Generating...
                        `;
                    });
                }
            }

            // Auto-populate TODOs from AI summary items
            if (codeRelevantItems.length > 0 && session.roomId) {
                autoPopulateTodosFromItems(codeRelevantItems, session.roomId);
            }

            smartScroll(false);
        }

        /**
         * Render an AI code prompt message in the UI.
         * Shows code prompt with copy button and special styling.
         * @param {Object} msg - AI code prompt message object.
         */
        function renderAiCodePromptMessage(msg) {
            // Check if we need a date separator
            if (needsDateSeparator(msg)) {
                renderDateSeparator(new Date(msg.ts * 1000));
            }

            // Update grouping state
            lastMessageUserId = msg.userId;
            lastMessageTime = msg.ts * 1000;

            const div = document.createElement('div');
            div.setAttribute('data-message-id', msg.id || '');
            div.setAttribute('data-timestamp', msg.ts || '');
            div.className = 'flex justify-start gap-2';

            const copyBtnId = `copy-prompt-btn-${msg.id || Date.now()}`;
            const lineCount = (msg.content || '').split('\n').length;

            div.innerHTML = `
                <div class="w-7 h-7 bg-gradient-to-br from-cyan-600 to-blue-700 rounded-full flex items-center justify-center text-white flex-shrink-0 mt-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="max-w-[85%] min-w-0 flex-1">
                    <div class="text-xs text-gray-400 mb-1 ml-1 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-cyan-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        ${escapeHtml(msg.displayName || 'AI')}
                    </div>
                    <div class="bg-gradient-to-b from-gray-900 via-blue-950/20 to-gray-900 rounded-xl overflow-hidden border border-cyan-800/25 shadow-xl cgp-card-border">
                        <div class="px-4 py-2.5 border-b border-cyan-800/20 flex items-center justify-between bg-cyan-950/10">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-cyan-400 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                <span class="text-xs font-semibold text-cyan-200 tracking-wide">Code Generation Prompt</span>
                            </div>
                            <div class="flex items-center gap-2.5">
                                <span class="text-[10px] text-gray-600 font-mono">${lineCount} lines</span>
                                <button id="${copyBtnId}" class="btn-secondary px-2.5 py-1 text-[11px] flex items-center gap-1.5">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                                    </svg>
                                    Copy
                                </button>
                            </div>
                        </div>
                        <div class="p-3">
                            <pre class="text-[11px] text-gray-300 whitespace-pre-wrap font-mono leading-relaxed bg-black/30 p-3 rounded-lg border border-gray-800/60 max-h-72 overflow-y-auto">${escapeHtml(msg.content || '')}</pre>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5 ml-1">
                        <span>${formatTime(msg.ts)}</span>
                    </div>
                </div>
            `;

            messagesContainer.appendChild(div);

            // Add click handler for copy button
            const copyBtn = document.getElementById(copyBtnId);
            if (copyBtn) {
                copyBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    try {
                        await navigator.clipboard.writeText(msg.content || '');
                        copyBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                            Copied!
                        `;
                        setTimeout(() => {
                            copyBtn.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                                </svg>
                                Copy
                            `;
                        }, 2000);
                    } catch (err) {
                        console.error('[WebView] Failed to copy:', err);
                    }
                });
            }

            smartScroll(false);
        }

        /**
         * Render a file message in the UI.
         * @param {Object} msg - File message object.
         */
        function renderFileMessage(msg) {
            const isOwnMessage = msg.userId === session.userId;
            const div = document.createElement('div');
            div.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} gap-2`;

            const timeAlign = isOwnMessage ? 'text-right' : '';
            const displayName = msg.displayName || usersMap.get(msg.userId)?.displayName || 'Unknown';
            const idSource = msg.identitySource || usersMap.get(msg.userId)?.identitySource;
            const { nameHtml, bubbleAccent } = buildNameAndRole(displayName, msg.role, idSource);

            // Get avatar color from users map or default
            const userInfo = usersMap.get(msg.userId);
            const colorClass = userInfo ? (avatarColors[userInfo.avatarColor] || 'bg-purple-600') : 'bg-gray-600';

            const avatarHtml = !isOwnMessage ? `
                <div class="w-7 h-7 ${colorClass} rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 mt-1">
                    ${getInitials(displayName)}
                </div>
            ` : '';

            // Build file content based on type
            let fileContentHtml = '';
            const filename = escapeHtml(msg.originalFilename || 'file');
            const fileSize = formatFileSize(msg.sizeBytes || 0);
            const downloadUrl = msg.downloadUrl || '';

            // Store file info for download handler (will be attached after innerHTML is set)
            const fileInfo = {
                fileId: msg.fileId,
                fileName: msg.originalFilename || 'file',
                downloadUrl: downloadUrl
            };

            if (msg.fileType === 'image') {
                // Image: show inline preview with download on click
                fileContentHtml = `
                    <div class="file-attachment">
                        <img src="${downloadUrl}" alt="${filename}"
                             class="max-w-full max-h-64 rounded-lg cursor-pointer hover:opacity-90 transition-opacity file-download-trigger"
                             data-file-id="${escapeHtml(msg.fileId || '')}"
                             data-file-name="${escapeHtml(msg.originalFilename || 'file')}"
                             data-download-url="${escapeHtml(downloadUrl)}"
                             onerror="this.onerror=null; this.src=''; this.alt='Image failed to load';" />
                        <div class="flex items-center gap-2 mt-2 text-xs text-gray-400">
                            <span>${filename}</span>
                            <span>·</span>
                            <span>${fileSize}</span>
                            <span class="text-blue-400 cursor-pointer hover:underline file-download-trigger"
                                  data-file-id="${escapeHtml(msg.fileId || '')}"
                                  data-file-name="${escapeHtml(msg.originalFilename || 'file')}"
                                  data-download-url="${escapeHtml(downloadUrl)}">📥 Download</span>
                        </div>
                    </div>
                `;
            } else {
                // Other files: show download link
                const icon = getFileIcon(msg.fileType);
                fileContentHtml = `
                    <div class="file-attachment flex items-center gap-3 p-3 bg-gray-900/50 rounded-lg hover:bg-gray-900 transition-colors border border-gray-600 cursor-pointer file-download-trigger"
                         data-file-id="${escapeHtml(msg.fileId || '')}"
                         data-file-name="${escapeHtml(msg.originalFilename || 'file')}"
                         data-download-url="${escapeHtml(downloadUrl)}">
                        <span class="text-3xl">${icon}</span>
                        <div class="min-w-0 flex-1">
                            <div class="font-medium text-sm text-gray-200 truncate">${filename}</div>
                            <div class="text-xs text-gray-500">${fileSize}</div>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                `;
            }

            // Add caption if present
            const captionHtml = msg.caption ? `<p class="text-sm mt-2">${escapeHtml(msg.caption)}</p>` : '';

            div.innerHTML = `
                ${avatarHtml}
                <div class="max-w-[75%] min-w-0">
                    ${!isOwnMessage ? nameHtml : ''}
                    <div class="bg-gray-800/50 text-gray-100 rounded-2xl ${isOwnMessage ? 'rounded-tr-sm' : 'rounded-tl-sm'} px-4 py-3 shadow-lg overflow-hidden border border-white/[0.04] ${!isOwnMessage ? bubbleAccent : ''}">
                        ${fileContentHtml}
                        ${captionHtml}
                    </div>
                    <div class="text-xs text-gray-500 mt-1 ${timeAlign} ${isOwnMessage ? 'mr-1' : 'ml-1'}">${formatTime(msg.ts)}</div>
                </div>
            `;

            messagesContainer.appendChild(div);
            smartScroll(isOwnMessage);

            // Attach click handlers to download triggers
            div.querySelectorAll('.file-download-trigger').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const fileId = el.getAttribute('data-file-id');
                    const fileName = el.getAttribute('data-file-name');
                    const downloadUrl = el.getAttribute('data-download-url');

                    console.log('[WebView] Download requested:', { fileId, fileName, downloadUrl });

                    vscode.postMessage({
                        command: 'downloadFile',
                        fileId: fileId,
                        fileName: fileName,
                        downloadUrl: downloadUrl
                    });
                });
            });
        }

        /**
         * Render a chat message in the UI.
         * Includes message grouping and status indicators.
         * @param {Object} msg - Message object with id, userId, displayName, role, content, ts.
         */
        function renderMessage(msg) {
            // Store message for summarization (only text messages)
            if (msg.content) {
                // Map msg.role to API format: 'host' stays 'host', everything else is 'engineer'
                const apiRole = msg.role === 'host' ? 'host' : 'engineer';
                chatMessages.push({
                    role: apiRole,
                    text: msg.content,
                    timestamp: msg.ts || Date.now() / 1000
                });
            }

            // Check if we need a date separator
            if (needsDateSeparator(msg)) {
                renderDateSeparator(new Date(msg.ts * 1000));
            }

            const isOwnMessage = msg.userId === session.userId;
            const isGrouped = shouldGroupMessage(msg);

            // Update grouping state for next message
            lastMessageUserId = msg.userId;
            lastMessageTime = msg.ts * 1000;

            const div = document.createElement('div');
            div.setAttribute('data-message-id', msg.id || '');
            div.setAttribute('data-timestamp', msg.ts || '');
            // Reduce spacing for grouped messages
            div.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} gap-2 ${isGrouped ? 'mt-1' : ''} message-enter`;

            const displayName = msg.displayName || usersMap.get(msg.userId)?.displayName || 'Unknown';
            const idSource = msg.identitySource || usersMap.get(msg.userId)?.identitySource;
            const { nameHtml, bubbleAccent } = buildNameAndRole(displayName, msg.role, idSource);

            const bubbleColor = isOwnMessage
                ? 'bg-gradient-to-br from-violet-600/90 to-indigo-600/90 text-white rounded-2xl rounded-tr-sm shadow-[0_2px_12px_rgba(124,58,237,0.15)]'
                : `bg-gray-800/40 backdrop-blur-sm text-gray-100 rounded-2xl rounded-tl-sm border border-white/[0.04] ${bubbleAccent}`;

            const timeAlign = isOwnMessage ? 'text-right' : '';

            // Get avatar color from users map or default
            const userInfo = usersMap.get(msg.userId);
            const colorClass = userInfo ? (avatarColors[userInfo.avatarColor] || 'bg-purple-600') : 'bg-gray-600';

            // Hide avatar and name for grouped messages
            const avatarHtml = (!isOwnMessage && !isGrouped) ? `
                <div class="w-7 h-7 ${colorClass} rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 mt-1">
                    ${getInitials(displayName)}
                </div>
            ` : (!isOwnMessage && isGrouped) ? '<div class="w-7 flex-shrink-0"></div>' : '';

            // Status indicator for own messages (✓ = sent, ✓✓ = read)
            const statusHtml = isOwnMessage ? '<span class="message-status text-violet-300/70 ml-1">✓</span>' : '';

            // Show name only for first message in group
            const showName = !isOwnMessage && !isGrouped;

            div.innerHTML = `
                ${avatarHtml}
                <div class="max-w-[75%] min-w-0">
                    ${showName ? nameHtml : ''}
                    <div class="${bubbleColor} px-4 py-2 shadow-lg overflow-hidden">
                        <p class="text-sm leading-relaxed break-words whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5 ${timeAlign} ${isOwnMessage ? 'mr-1' : 'ml-1'} flex items-center ${isOwnMessage ? 'justify-end' : ''}">
                        <span>${formatTime(msg.ts)}</span>${statusHtml}
                    </div>
                </div>
            `;

            messagesContainer.appendChild(div);
            smartScroll(isOwnMessage);

            // Observe for read receipts (only for messages from others)
            if (!isOwnMessage && msg.id && messageReadObserver) {
                messageReadObserver.observe(div);
            }
        }

        /**
         * Render a system message (user joined/left)
         */
        function renderSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'flex justify-center message-enter';
            div.innerHTML = `
                <div class="bg-gray-800/30 text-gray-500 text-[0.65rem] px-3 py-1 rounded-full border border-white/[0.04]">
                    ${escapeHtml(text)}
                </div>
            `;
            messagesContainer.appendChild(div);
            scrollToBottom(false);  // System messages don't force scroll
        }

        /**
         * Load more message history (pagination).
         * Fetches older messages from the server and prepends them.
         */
        function loadMoreHistory() {
            if (isLoadingHistory || !hasMoreHistory || !session.roomId) {
                return;
            }

            const oldestTs = getOldestMessageTimestamp();
            if (!oldestTs) {
                hasMoreHistory = false;
                return;
            }

            isLoadingHistory = true;
            console.log('[WebView] Requesting more history via postMessage, before:', oldestTs);
            vscode.postMessage({ command: 'loadHistory', roomId: session.roomId, before: oldestTs, limit: 50 });
        }

        /**
         * Handle history loaded response from extension host.
         * Prepends older messages and restores scroll position.
         */
        function handleHistoryLoaded(message) {
            try {
                const data = message;
                console.log('[WebView] Loaded history:', data.messages?.length, 'messages, hasMore:', data.hasMore);

                if (data.messages && data.messages.length > 0) {
                    // Save scroll position
                    const scrollHeight = messagesContainer.scrollHeight;

                    // Prepend messages (oldest first, so sort chronologically)
                    const sortedMessages = data.messages.sort((a, b) => a.ts - b.ts);
                    sortedMessages.forEach(msg => {
                        if (!isDuplicateMessage(msg.id)) {
                            prependMessage(msg);
                        }
                    });

                    // Restore scroll position
                    messagesContainer.scrollTop = messagesContainer.scrollHeight - scrollHeight;
                }

                hasMoreHistory = data.hasMore === true;
            } catch (err) {
                console.error('[WebView] Failed to process history:', err);
            } finally {
                isLoadingHistory = false;
            }
        }

        /**
         * Get the timestamp of the oldest visible message.
         * @returns {number|null} Unix timestamp or null if no messages.
         */
        function getOldestMessageTimestamp() {
            const messages = messagesContainer.querySelectorAll('[data-timestamp]');
            if (messages.length === 0) return null;
            return parseFloat(messages[0].getAttribute('data-timestamp'));
        }

        /**
         * Prepend a message to the top of the messages container.
         * Similar to renderMessage but inserts at the beginning.
         * @param {Object} msg - Message object.
         */
        function prependMessage(msg) {
            const isOwnMessage = msg.userId === session.userId;

            const div = document.createElement('div');
            div.setAttribute('data-message-id', msg.id || '');
            div.setAttribute('data-timestamp', msg.ts || '');
            div.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} gap-2`;

            const displayName = msg.displayName || usersMap.get(msg.userId)?.displayName || 'Unknown';
            const idSource = msg.identitySource || usersMap.get(msg.userId)?.identitySource;
            const { nameHtml, bubbleAccent } = buildNameAndRole(displayName, msg.role, idSource);

            const bubbleColor = isOwnMessage
                ? 'bg-gradient-to-br from-violet-600/90 to-indigo-600/90 text-white rounded-2xl rounded-tr-sm shadow-[0_2px_12px_rgba(124,58,237,0.15)]'
                : `bg-gray-800/40 backdrop-blur-sm text-gray-100 rounded-2xl rounded-tl-sm border border-white/[0.04] ${bubbleAccent}`;

            const userInfo = usersMap.get(msg.userId);
            const colorClass = userInfo ? (avatarColors[userInfo.avatarColor] || 'bg-purple-600') : 'bg-gray-600';

            const avatarHtml = !isOwnMessage ? `
                <div class="w-7 h-7 ${colorClass} rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 mt-1">
                    ${getInitials(displayName)}
                </div>
            ` : '';

            const statusHtml = isOwnMessage ? '<span class="message-status text-violet-300/70 ml-1">✓</span>' : '';
            const timeAlign = isOwnMessage ? 'text-right' : '';

            div.innerHTML = `
                ${avatarHtml}
                <div class="max-w-[75%] min-w-0">
                    ${!isOwnMessage ? nameHtml : ''}
                    <div class="${bubbleColor} px-4 py-2 shadow-lg overflow-hidden">
                        <p class="text-sm leading-relaxed break-words whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5 ${timeAlign} ${isOwnMessage ? 'mr-1' : 'ml-1'} flex items-center ${isOwnMessage ? 'justify-end' : ''}">
                        <span>${formatTime(msg.ts)}</span>${statusHtml}
                    </div>
                </div>
            `;

            // Insert at the beginning
            messagesContainer.insertBefore(div, messagesContainer.firstChild);

            // Observe for read receipts
            if (!isOwnMessage && msg.id && messageReadObserver) {
                messageReadObserver.observe(div);
            }
        }

        /**
         * Update connection status display
         */
        function updateConnectionStatus(status, isError = false) {
            if (connectionStatus) {
                const colorClass = isError ? 'text-red-400 border-red-700' : 'text-gray-400 border-gray-700';
                connectionStatus.innerHTML = `
                    <div class="bg-gray-800/50 ${colorClass} text-xs px-3 py-1.5 rounded-full border">
                        <span>${status}</span>
                    </div>
                `;
            }
        }

        /**
         * Calculate reconnection delay with exponential backoff.
         * @returns {number} Delay in milliseconds.
         */
        function getReconnectDelay() {
            const delay = Math.min(
                BASE_RECONNECT_DELAY_MS * Math.pow(2, reconnectAttempts),
                MAX_RECONNECT_DELAY_MS
            );
            // Add jitter (±20%) to prevent thundering herd
            const jitter = delay * 0.2 * (Math.random() - 0.5);
            return Math.round(delay + jitter);
        }

        /**
         * Check if a message has already been rendered (for deduplication).
         * @param {string} messageId - The message ID to check.
         * @returns {boolean} True if duplicate, false if new.
         */
        function isDuplicateMessage(messageId) {
            if (!messageId) return false;
            if (seenMessageIds.has(messageId)) return true;
            seenMessageIds.add(messageId);
            // Limit set size to prevent memory issues
            if (seenMessageIds.size > 10000) {
                const first = seenMessageIds.values().next().value;
                seenMessageIds.delete(first);
            }
            return false;
        }

        /**
         * Track the timestamp of the latest message for reconnection recovery.
         * @param {number} ts - Unix timestamp in seconds.
         */
        function updateLastMessageTimestamp(ts) {
            if (ts > lastMessageTimestamp) {
                lastMessageTimestamp = ts;
            }
        }

        /**
         * Send a read receipt for a message.
         * @param {string} messageId - The message ID that was read.
         */
        function sendReadReceipt(messageId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            if (!messageId) return;

            // SECURITY: Backend uses assigned userId
            ws.send(JSON.stringify({
                type: 'read',
                messageId: messageId
            }));
        }

        /**
         * Connect to WebSocket chat server.
         * Supports message recovery on reconnect via `since` parameter.
         */
        function connectWebSocket() {
            if (!session.roomId || !session.userId) {
                console.error('[WebView] Cannot connect: missing roomId or userId');
                updateConnectionStatus('❌ Missing session info', true);
                return;
            }

            // Build WebSocket URL with optional `since` parameter for reconnection
            let wsUrl = session.backendUrl.replace('http', 'ws') + '/ws/chat/' + session.roomId;
            if (lastMessageTimestamp > 0 && reconnectAttempts > 0) {
                wsUrl += `?since=${lastMessageTimestamp}`;
                console.log('[WebView] Reconnecting with message recovery since:', lastMessageTimestamp);
            }
            console.log('[WebView] Connecting to:', wsUrl);
            updateConnectionStatus(reconnectAttempts > 0 ? 'Reconnecting...' : 'Connecting...');

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('[WebView] WebSocket connected');
                reconnectAttempts = 0;
                updateConnectionStatus('✅ Connected');
                // Hide status after a moment
                setTimeout(() => {
                    if (connectionStatus) connectionStatus.style.display = 'none';
                }, 2000);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('[WebView] Received:', data);

                    // SECURITY: Handle backend-assigned credentials FIRST
                    // The backend assigns userId and role on connection - client MUST use these
                    if (data.type === 'connected') {
                        console.log('[WebView] SECURITY: Backend assigned credentials:', data);
                        // Store backend-assigned userId and role
                        session.userId = data.userId;
                        session.sessionRole = data.role;
                        session.leadId = data.leadId || null;
                        console.log('[WebView] Updated session with backend credentials:', {
                            userId: session.userId,
                            sessionRole: session.sessionRole,
                            leadId: session.leadId
                        });
                        // Don't send join yet - wait for history message
                    } else if (data.type === 'history') {
                        // Clear status
                        if (connectionStatus) connectionStatus.style.display = 'none';

                        // Store leadId from server
                        if (data.leadId) session.leadId = data.leadId;
                        updateLeadPermissions();

                        // Render existing users (always update on history)
                        if (data.users) {
                            renderUsersList(data.users);
                        }

                        // Render message history (with deduplication)
                        data.messages.forEach(msg => {
                            if (!isDuplicateMessage(msg.id)) {
                                renderMessage(msg);
                                updateLastMessageTimestamp(msg.ts);
                            }
                        });

                        // Only send join if this is not a recovery (reconnect)
                        // SECURITY: Use backend-assigned userId (already stored in session)
                        if (!data.isRecovery) {
                            ws.send(JSON.stringify({
                                type: 'join',
                                displayName: session.displayName || 'User',
                                identitySource: getIdentitySource()
                                // Note: userId and role are now handled by backend
                            }));
                        }

                        // Proactively fetch AI status so AI-gated buttons start in the correct state.
                        // This is a fire-and-forget call; errors are silently ignored.
                        vscode.postMessage({ command: 'getAiStatus' });
                    } else if (data.type === 'message') {
                        if (!isDuplicateMessage(data.id)) {
                            renderMessage(data);
                            updateLastMessageTimestamp(data.ts);
                        }
                    } else if (data.type === 'file') {
                        if (!isDuplicateMessage(data.id)) {
                            renderFileMessage(data);
                            updateLastMessageTimestamp(data.ts);
                        }
                    } else if (data.type === 'code_snippet') {
                        if (!isDuplicateMessage(data.id)) {
                            renderCodeSnippetMessage(data);
                            updateLastMessageTimestamp(data.ts);
                        }
                    } else if (data.type === 'ai_summary') {
                        if (!isDuplicateMessage(data.id)) {
                            renderAiSummaryMessage(data);
                            updateLastMessageTimestamp(data.ts);
                        }
                    } else if (data.type === 'ai_code_prompt') {
                        if (!isDuplicateMessage(data.id)) {
                            renderAiCodePromptMessage(data);
                            updateLastMessageTimestamp(data.ts);
                        }
                    } else if (data.type === 'user_joined') {
                        renderUsersList(data.users);
                        renderSystemMessage(`${data.user.displayName} joined the chat`);
                    } else if (data.type === 'user_left') {
                        renderUsersList(data.users);
                        renderSystemMessage(`${data.user.displayName} left the chat`);
                    } else if (data.type === 'session_ended') {
                        sessionEnded = true;
                        renderSystemMessage('🔴 ' + data.message);
                        // Disable input
                        chatInput.disabled = true;
                        chatInput.placeholder = 'Chat session has ended';
                        btnSend.disabled = true;
                        btnSend.classList.add('opacity-50', 'cursor-not-allowed');
                        // Hide end chat button
                        btnEndChat.classList.add('hidden');
                        // Clear users list
                        usersList.innerHTML = '';
                        userCount.textContent = '0 online';
                        // Notify extension to reset session state
                        vscode.postMessage({ command: 'sessionEnded' });
                    } else if (data.type === 'typing') {
                        handleTypingEvent(data);
                    } else if (data.type === 'read_receipt') {
                        // Update message status indicators
                        handleReadReceipt(data);
                    } else if (data.type === 'lead_changed') {
                        session.leadId = data.leadId;
                        updateLeadPermissions();
                        // Show who the new lead is
                        const leadUser = usersMap.get(data.leadId);
                        const leadName = leadUser ? leadUser.displayName : 'Unknown';
                        renderSystemMessage(`Lead transferred to ${leadName}`);
                        // Re-render user list to update lead indicator
                        if (usersMap.size > 0) {
                            renderUsersList(Array.from(usersMap.values()));
                        }
                    } else if (data.type === 'stack_trace') {
                        if (!isDuplicateMessage(data.id)) {
                            renderStackTraceMessage(data);
                            updateLastMessageTimestamp(data.ts);
                        }
                    } else if (data.type === 'test_failure') {
                        if (!isDuplicateMessage(data.id)) {
                            renderTestFailureMessage(data);
                            updateLastMessageTimestamp(data.ts);
                        }
                    } else if (data.type === 'ai_explanation') {
                        if (!isDuplicateMessage(data.id)) {
                            renderAiExplanationMessage(data);
                            updateLastMessageTimestamp(data.ts);
                        }
                    } else if (data.type === 'error') {
                        // SECURITY: Handle backend error messages (e.g., permission denied)
                        console.error('[WebView] Backend error:', data.error);
                        renderSystemMessage(`⚠️ ${data.error}`);
                    }
                } catch (err) {
                    console.error('[WebView] Failed to parse message:', err);
                }
            };

            ws.onclose = (event) => {
                console.log('[WebView] WebSocket closed:', event.code, event.reason);
                // Don't reconnect if session was ended by host
                if (sessionEnded) {
                    updateConnectionStatus('Session ended', false);
                    return;
                }
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    const delay = getReconnectDelay();
                    console.log(`[WebView] Reconnecting in ${delay}ms (attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                    updateConnectionStatus(`Reconnecting (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`);
                    setTimeout(connectWebSocket, delay);
                } else {
                    updateConnectionStatus('❌ Connection lost', true);
                }
            };

            ws.onerror = (error) => {
                console.error('[WebView] WebSocket error:', error);
                updateConnectionStatus('❌ Connection error', true);
            };
        }

        /**
         * Handle read receipt from server.
         * Updates message status indicators to show who has read.
         * @param {Object} data - Read receipt data with messageId and readBy.
         */
        function handleReadReceipt(data) {
            const { messageId, readBy } = data;
            if (!messageId || !readBy) return;

            // Find the message element and update its status
            const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageEl) {
                const statusEl = messageEl.querySelector('.message-status');
                if (statusEl) {
                    // Show double checkmark if read by someone other than sender
                    const otherReaders = readBy.filter(id => id !== session.userId);
                    if (otherReaders.length > 0) {
                        statusEl.textContent = '✓✓';
                        statusEl.title = `Read by ${otherReaders.length} ${otherReaders.length === 1 ? 'person' : 'people'}`;
                    }
                }
            }
        }

        /**
         * Send a chat message.
         * Stops typing indicator and resets textarea.
         * Includes code snippet if one is attached.
         */
        function sendMessage() {
            const content = chatInput.value.trim();
            const hasSnippet = pendingCodeSnippet !== null;

            // Need either content or a code snippet to send
            if ((!content && !hasSnippet) || !ws || ws.readyState !== WebSocket.OPEN) {
                return;
            }

            // Stop typing indicator when sending message
            if (isTyping) {
                isTyping = false;
                sendTypingIndicator(false);
            }
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }

            // Build message with optional code snippet
            // SECURITY: userId and role are assigned by backend, we only send content
            const message = {
                displayName: session.displayName || 'User',
                content: content || (hasSnippet ? '' : '')
            };

            // Attach code snippet if present
            if (hasSnippet) {
                message.type = 'code_snippet';
                message.codeSnippet = pendingCodeSnippet;
            }

            console.log('[WebView] Sending:', message);
            ws.send(JSON.stringify(message));
            chatInput.value = '';
            chatInput.style.height = 'auto';  // Reset textarea height

            // Clear code snippet after sending
            if (hasSnippet) {
                clearCodeSnippet();
            }
        }

        // Send button click handler (text messages only)
        btnSend.addEventListener('click', () => {
            sendMessage();
        });

        // Enter key handler (Shift+Enter for new line)
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Input event handler for typing indicator and auto-resize
        chatInput.addEventListener('input', handleInputEvent);

        // Scroll event handler for scroll-to-bottom button
        messagesContainer.addEventListener('scroll', handleScroll);

        // Scroll to bottom button click handler
        scrollToBottomBtn.addEventListener('click', scrollToBottom);

        // ============================================================
        // Tab switching: Chat ↔ Tasks
        // ============================================================

        const tabChat  = document.getElementById('tab-chat');
        const tabTasks = document.getElementById('tab-tasks');
        const tabPanelChat  = document.getElementById('tab-panel-chat');
        const tabPanelTasks = document.getElementById('tab-panel-tasks');
        const todosListEl   = document.getElementById('todos-list');
        const todoBadge     = document.getElementById('todo-count-badge');
        let currentFilter   = 'all';
        let allTodos        = [];

        // Pill-style tab activation helpers
        function activatePillTab(activeBtn, inactiveBtn) {
            activeBtn.classList.add('active','text-white');
            activeBtn.style.background = 'rgba(55,65,81,0.9)';
            activeBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.4)';
            activeBtn.classList.remove('text-gray-500');
            inactiveBtn.classList.remove('active','text-white');
            inactiveBtn.style.background = '';
            inactiveBtn.style.boxShadow = '';
            inactiveBtn.classList.add('text-gray-500');
        }

        tabChat.addEventListener('click', () => {
            activatePillTab(tabChat, tabTasks);
            tabPanelChat.classList.remove('hidden');
            tabPanelTasks.classList.add('hidden');
        });

        tabTasks.addEventListener('click', () => {
            activatePillTab(tabTasks, tabChat);
            tabPanelTasks.classList.remove('hidden');
            tabPanelChat.classList.add('hidden');
            // Load todos when tab opens
            if (session.roomId) {
                vscode.postMessage({ command: 'loadTodos', roomId: session.roomId });
            }
        });

        // Filter buttons
        document.querySelectorAll('.todo-filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.todo-filter-btn').forEach(b => {
                    b.classList.remove('active','bg-violet-600/20','text-violet-400','border-violet-600/30');
                    b.classList.add('text-gray-500','border-gray-700/40');
                });
                btn.classList.add('active','bg-violet-600/20','text-violet-400','border-violet-600/30');
                btn.classList.remove('text-gray-500','border-gray-700/40');
                currentFilter = btn.dataset.filter;
                renderTodoList(allTodos);
            });
        });

        // Add TODO form
        const btnAddTodo    = document.getElementById('btn-add-todo');
        const todoAddForm   = document.getElementById('todo-add-form');
        const todoTitleInput = document.getElementById('todo-title-input');
        const todoPrioritySelect = document.getElementById('todo-priority-select');
        const btnTodoSave   = document.getElementById('btn-todo-save');
        const btnTodoCancel = document.getElementById('btn-todo-cancel');

        btnAddTodo.addEventListener('click', () => {
            todoAddForm.classList.toggle('hidden');
            if (!todoAddForm.classList.contains('hidden')) todoTitleInput.focus();
        });
        const todoDescInput = document.getElementById('todo-desc-input');

        function _closeTodoForm() {
            todoAddForm.classList.add('hidden');
            todoTitleInput.value = '';
            if (todoDescInput) todoDescInput.value = '';
        }

        btnTodoCancel.addEventListener('click', _closeTodoForm);

        // Submit on Cmd/Ctrl+Enter inside the form
        todoAddForm.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) btnTodoSave.click();
        });

        btnTodoSave.addEventListener('click', () => {
            const title = todoTitleInput.value.trim();
            if (!title || !session.roomId) return;
            const description = todoDescInput?.value.trim() || null;
            vscode.postMessage({
                command: 'createTodo',
                roomId: session.roomId,
                todo: {
                    title,
                    description: description || undefined,
                    priority: todoPrioritySelect.value,
                    source: 'manual',
                    created_by: session.displayName || '',
                },
            });
            _closeTodoForm();
        });

        function renderTodoList(todos) {
            allTodos = todos;
            const filtered = currentFilter === 'all' ? todos
                : todos.filter(t => currentFilter === 'done' ? t.status === 'done' : t.status !== 'done');

            if (filtered.length === 0) {
                if (currentFilter === 'done') {
                    todosListEl.innerHTML = `<div class="text-xs text-gray-600 text-center py-6">No completed tasks yet.</div>`;
                } else if (todos.length > 0) {
                    // There are tasks, just none match the filter
                    todosListEl.innerHTML = `<div class="text-xs text-gray-600 text-center py-6">No open tasks.</div>`;
                } else {
                    // Truly empty — explain how tasks are created
                    todosListEl.innerHTML = `
                        <div class="flex flex-col items-center gap-3 py-6 px-2 text-center">
                            <div class="text-2xl">✅</div>
                            <p class="text-xs text-gray-500 font-medium">No tasks yet</p>
                            <div class="bg-gray-800/40 border border-gray-700/40 rounded-lg p-3 text-left space-y-2 w-full">
                                <p class="text-[0.65rem] text-gray-400 font-semibold uppercase tracking-wide">How tasks are created</p>
                                <div class="flex items-start gap-2">
                                    <span class="text-violet-400 flex-shrink-0 mt-0.5">🤖</span>
                                    <p class="text-[0.65rem] text-gray-400 leading-relaxed"><strong class="text-gray-300">Automatically</strong> — run <strong class="text-violet-300">Summarize</strong> in the chat. The AI extracts actionable items and adds them here.</p>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-emerald-400 flex-shrink-0 mt-0.5">✏️</span>
                                    <p class="text-[0.65rem] text-gray-400 leading-relaxed"><strong class="text-gray-300">Manually</strong> — click <strong class="text-gray-300">+ Add</strong> above to create a task yourself.</p>
                                </div>
                            </div>
                        </div>`;
                }
            } else {
                todosListEl.innerHTML = '';
            }

            filtered.forEach(todo => {
                const el = buildTodoEl(todo);
                todosListEl.appendChild(el);
            });

            // Update badge
            const openCount = todos.filter(t => t.status !== 'done').length;
            if (openCount > 0) {
                todoBadge.textContent = openCount;
                todoBadge.classList.remove('hidden');
            } else {
                todoBadge.classList.add('hidden');
            }
        }

        function buildTodoEl(todo) {
            const el = document.createElement('div');
            const isDone = todo.status === 'done';
            el.className = `todo-item rounded-lg border transition-all
                ${isDone ? 'bg-gray-900/20 border-gray-800/30 opacity-55' : 'bg-gray-800/40 border-gray-700/40 hover:border-gray-600/60'}`;
            el.dataset.todoId = todo.id;

            const priorityDot = { high: 'bg-red-400', medium: 'bg-yellow-400', low: 'bg-green-400' };
            const priorityLabel = { high: 'text-red-400', medium: 'text-yellow-400', low: 'text-green-400' };
            const dot = priorityDot[todo.priority] || 'bg-gray-500';
            const prioText = priorityLabel[todo.priority] || 'text-gray-400';

            // Description: show first 2 lines truncated; click to toggle full
            const descHtml = todo.description ? `
                <p class="todo-desc text-[0.65rem] text-gray-500 mt-1 leading-relaxed"
                   style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;"
                >${escapeHtml(todo.description)}</p>` : '';

            // Source badge
            const sourceBadge = todo.source === 'ai_summary'
                ? `<span class="text-[0.6rem] text-violet-500/70">🤖 from AI</span>` : '';

            el.innerHTML = `
                <!-- Main row -->
                <div class="flex items-start gap-2 p-2.5">
                    <!-- Checkbox -->
                    <button class="todo-check mt-0.5 flex-shrink-0 w-4 h-4 rounded border-2 flex items-center justify-center transition-all
                        ${isDone ? 'bg-violet-600 border-violet-600' : 'border-gray-600 hover:border-violet-500'}">
                        ${isDone ? '<svg class="w-2.5 h-2.5 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>' : ''}
                    </button>

                    <!-- Content -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-start gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full ${dot} flex-shrink-0 mt-1.5"></span>
                            <p class="text-xs ${isDone ? 'line-through text-gray-600' : 'text-gray-200'} leading-snug break-words flex-1">${escapeHtml(todo.title)}</p>
                        </div>
                        ${descHtml}
                        <!-- Meta row -->
                        <div class="flex items-center gap-2 mt-1.5 flex-wrap">
                            <span class="text-[0.6rem] font-medium ${prioText} uppercase tracking-wide">${todo.priority}</span>
                            ${todo.type && todo.type !== 'task' ? `<span class="text-[0.6rem] text-gray-500 bg-gray-700/40 px-1.5 py-0.5 rounded">${escapeHtml(todo.type)}</span>` : ''}
                            ${todo.file_path ? `<button class="todo-nav-btn text-[0.6rem] text-blue-400 hover:text-blue-300 font-mono truncate max-w-[110px]" data-path="${escapeHtml(todo.file_path)}" data-line="${todo.line_number || 1}">📎 ${escapeHtml(todo.file_path.split('/').slice(-1)[0])}${todo.line_number ? ':' + todo.line_number : ''}</button>` : ''}
                            ${sourceBadge}
                        </div>
                    </div>
                </div>

                <!-- Action row — shown on hover via CSS, always accessible -->
                <div class="todo-actions flex items-center justify-end gap-1 px-2.5 pb-2">
                    <button class="todo-ai-btn flex items-center gap-1 text-[0.65rem] text-violet-400 hover:text-violet-300
                        bg-violet-500/10 hover:bg-violet-500/20 border border-violet-600/20 hover:border-violet-500/40
                        px-2 py-1 rounded-md transition-all font-medium"
                        title="Ask AI to implement this task — generates a code prompt in chat">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L13.09 8.26L18 6L14.74 10.91L21 12L14.74 13.09L18 18L13.09 15.74L12 22L10.91 15.74L6 18L9.26 13.09L3 12L9.26 10.91L6 6L10.91 8.26L12 2Z"/>
                        </svg>
                        Ask AI
                    </button>
                    <button class="todo-delete-btn flex items-center gap-1 text-[0.65rem] text-gray-600 hover:text-red-400
                        hover:bg-red-500/10 border border-transparent hover:border-red-600/20
                        px-2 py-1 rounded-md transition-all"
                        title="Delete task">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        Delete
                    </button>
                </div>`;

            // Toggle done
            el.querySelector('.todo-check').addEventListener('click', (e) => {
                e.stopPropagation();
                const newStatus = isDone ? 'open' : 'done';
                vscode.postMessage({ command: 'updateTodo', roomId: session.roomId, todoId: todo.id, updates: { status: newStatus } });
            });

            // Navigate to code
            const navBtn = el.querySelector('.todo-nav-btn');
            if (navBtn) {
                navBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    vscode.postMessage({ command: 'navigateToCode', relativePath: navBtn.dataset.path, startLine: parseInt(navBtn.dataset.line), endLine: parseInt(navBtn.dataset.line) });
                });
            }

            // Toggle description expand/collapse
            const descEl = el.querySelector('.todo-desc');
            if (descEl) {
                descEl.style.cursor = 'pointer';
                let descExpanded = false;
                descEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    descExpanded = !descExpanded;
                    descEl.style.webkitLineClamp = descExpanded ? 'unset' : '2';
                    descEl.style.overflow = descExpanded ? 'visible' : 'hidden';
                });
            }

            // Ask AI — format task as CodeRelevantItem and trigger code prompt generation
            el.querySelector('.todo-ai-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                if (!session.roomId) return;

                const aiBtn = el.querySelector('.todo-ai-btn');
                const originalHtml = aiBtn.innerHTML;

                // Show loading state
                aiBtn.disabled = true;
                aiBtn.innerHTML = `<svg class="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg> Generating…`;

                // Package the task as a CodeRelevantItem — reuses the existing CGP pipeline
                const item = {
                    title: todo.title,
                    description: todo.description
                        ? `${todo.title}\n\n${todo.description}`
                        : todo.title,
                    affected_components: todo.file_path ? [todo.file_path] : [],
                    type: todo.type || 'code_change',
                    priority: todo.priority,
                };

                vscode.postMessage({
                    command: 'generateCodePromptFromItemsAndPost',
                    items: [item],
                    topic: todo.title,
                    roomId: session.roomId,
                });

                // Restore button after a short delay (actual result appears in chat)
                setTimeout(() => {
                    aiBtn.disabled = false;
                    aiBtn.innerHTML = originalHtml;
                }, 3000);
            });

            // Delete task
            el.querySelector('.todo-delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                if (!session.roomId) return;
                // Optimistic UI — fade out immediately
                el.style.transition = 'opacity 0.2s';
                el.style.opacity = '0';
                setTimeout(() => {
                    vscode.postMessage({ command: 'deleteTodo', roomId: session.roomId, todoId: todo.id });
                }, 180);
            });

            return el;
        }

        function addTodoToList(todo) {
            allTodos.unshift(todo);
            renderTodoList(allTodos);
        }

        function refreshTodoInList(updated) {
            allTodos = allTodos.map(t => t.id === updated.id ? updated : t);
            renderTodoList(allTodos);
        }

        function removeTodoFromList(todoId) {
            allTodos = allTodos.filter(t => t.id !== todoId);
            renderTodoList(allTodos);
        }

        // Auto-populate todos from AI summary CodeRelevantItems
        function autoPopulateTodosFromItems(items, roomId) {
            if (!items || !roomId) return;
            items.forEach(item => {
                // title and description are both populated so "Ask AI" has full context
                const title = item.title || item.description || 'Task from AI';
                const description = item.description && item.description !== title
                    ? item.description : null;
                const todo = {
                    title,
                    description,
                    type: item.type || 'task',
                    priority: item.priority || 'medium',
                    file_path: (item.affected_components || [])[0] || null,
                    source: 'ai_summary',
                    created_by: 'AI',
                };
                vscode.postMessage({ command: 'createTodo', roomId, todo });
            });
        }

        // ============================================================
        // Workspace TODO Scanner
        // ============================================================

        /** @type {Array<{id:string,filePath:string,relativePath:string,lineNumber:number,title:string,description?:string,descriptionLine?:number,commentPrefix:string}>} */
        let workspaceTodos = [];
        /** Currently edited workspace todo item */
        let _editingWorkspaceTodo = null;

        const btnScanWorkspaceTodos      = document.getElementById('btn-scan-workspace-todos');
        const btnToggleWorkspaceTodos    = document.getElementById('btn-toggle-workspace-todos');
        const workspaceTodosChevron      = document.getElementById('workspace-todos-chevron');
        const workspaceTodosPanel        = document.getElementById('workspace-todos-panel');
        const workspaceTodosEmpty        = document.getElementById('workspace-todos-empty');
        const workspaceTodosList         = document.getElementById('workspace-todos-list');
        const workspaceTodoCount         = document.getElementById('workspace-todo-count');

        const workspaceTodoEditModal     = document.getElementById('workspace-todo-edit-modal');
        const workspaceTodoEditLocation  = document.getElementById('workspace-todo-edit-location');
        const workspaceTodoEditTitle     = document.getElementById('workspace-todo-edit-title');
        const workspaceTodoEditDesc      = document.getElementById('workspace-todo-edit-desc');
        const btnCloseWorkspaceTodoModal = document.getElementById('btn-close-workspace-todo-modal');
        const btnWorkspaceTodoCancel     = document.getElementById('btn-workspace-todo-cancel');
        const btnWorkspaceTodoSave       = document.getElementById('btn-workspace-todo-save');

        let _workspaceTodosExpanded = false;

        /** Pending branch-change info — shown in the scanning overlay banner. */
        let _scanBranchInfo = null;
        /** Safety-net timer to auto-dismiss the scanning overlay. */
        let _scanOverlayTimeout = null;

        function _resetScanOverlayTimeout() {
            if (_scanOverlayTimeout) clearTimeout(_scanOverlayTimeout);
            // If no 'done' arrives within 5 minutes, hide the overlay anyway.
            _scanOverlayTimeout = setTimeout(() => {
                document.getElementById('scanning-overlay')?.classList.add('hidden');
                document.getElementById('index-progress-bar')?.classList.add('hidden');
            }, 5 * 60 * 1000);
        }

        function _clearScanOverlayTimeout() {
            if (_scanOverlayTimeout) { clearTimeout(_scanOverlayTimeout); _scanOverlayTimeout = null; }
        }

        btnToggleWorkspaceTodos.addEventListener('click', () => {
            _workspaceTodosExpanded = !_workspaceTodosExpanded;
            workspaceTodosPanel.classList.toggle('hidden', !_workspaceTodosExpanded);
            workspaceTodosChevron.style.transform = _workspaceTodosExpanded ? 'rotate(90deg)' : '';
        });

        btnScanWorkspaceTodos.addEventListener('click', () => {
            btnScanWorkspaceTodos.textContent = '...';
            btnScanWorkspaceTodos.disabled = true;
            vscode.postMessage({ command: 'scanWorkspaceTodos' });
        });

        function renderWorkspaceTodoList() {
            workspaceTodosList.innerHTML = '';
            if (workspaceTodos.length === 0) {
                workspaceTodosEmpty.classList.remove('hidden');
                workspaceTodoCount.classList.add('hidden');
                return;
            }
            workspaceTodosEmpty.classList.add('hidden');
            workspaceTodoCount.textContent = workspaceTodos.length;
            workspaceTodoCount.classList.remove('hidden');

            // Auto-expand when results arrive
            if (!_workspaceTodosExpanded) {
                _workspaceTodosExpanded = true;
                workspaceTodosPanel.classList.remove('hidden');
                workspaceTodosChevron.style.transform = 'rotate(90deg)';
            }

            workspaceTodos.forEach(todo => {
                const el = document.createElement('div');
                el.className = 'bg-gray-800/50 border border-gray-700/30 rounded-lg p-2.5 flex flex-col gap-1 cursor-pointer hover:border-violet-500/30 transition-colors group';
                el.innerHTML = `
                    <div class="flex items-start justify-between gap-2">
                        <span class="text-xs text-gray-200 font-medium leading-snug flex-1 min-w-0">${escapeHtml(todo.title)}</span>
                        <button class="workspace-todo-edit-btn flex-shrink-0 opacity-0 group-hover:opacity-100 p-0.5 text-gray-500 hover:text-violet-400 transition-opacity" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                            </svg>
                        </button>
                    </div>
                    ${todo.description ? `<span class="text-[0.65rem] text-gray-500 leading-snug">${escapeHtml(todo.description)}</span>` : ''}
                    <div class="flex items-center gap-1 mt-0.5">
                        <span class="text-[0.6rem] text-blue-400/70 font-mono truncate">${escapeHtml(todo.relativePath)}</span>
                        <span class="text-[0.6rem] text-gray-600 flex-shrink-0">:${todo.lineNumber}</span>
                    </div>
                `;
                // Navigate to file on click (but not on edit button)
                el.addEventListener('click', (e) => {
                    if (e.target.closest('.workspace-todo-edit-btn')) return;
                    vscode.postMessage({ command: 'navigateToCode', relativePath: todo.relativePath, startLine: todo.lineNumber, endLine: todo.lineNumber });
                });
                el.querySelector('.workspace-todo-edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openWorkspaceTodoEdit(todo);
                });
                workspaceTodosList.appendChild(el);
            });
        }

        function openWorkspaceTodoEdit(todo) {
            _editingWorkspaceTodo = todo;
            workspaceTodoEditLocation.textContent = `${todo.relativePath}:${todo.lineNumber}`;
            workspaceTodoEditTitle.value = todo.title;
            workspaceTodoEditDesc.value = todo.description || '';
            workspaceTodoEditModal.classList.remove('hidden');
            workspaceTodoEditTitle.focus();
        }

        function closeWorkspaceTodoModal() {
            workspaceTodoEditModal.classList.add('hidden');
            _editingWorkspaceTodo = null;
        }

        btnCloseWorkspaceTodoModal.addEventListener('click', closeWorkspaceTodoModal);
        btnWorkspaceTodoCancel.addEventListener('click', closeWorkspaceTodoModal);

        btnWorkspaceTodoSave.addEventListener('click', () => {
            if (!_editingWorkspaceTodo) return;
            const newTitle = workspaceTodoEditTitle.value.trim();
            if (!newTitle) { showToast('Title is required', 'error'); return; }
            const newDescription = workspaceTodoEditDesc.value.trim();
            vscode.postMessage({
                command: 'updateWorkspaceTodo',
                payload: {
                    filePath: _editingWorkspaceTodo.filePath,
                    lineNumber: _editingWorkspaceTodo.lineNumber,
                    newTitle,
                    newDescription,
                    descriptionLine: _editingWorkspaceTodo.descriptionLine,
                    commentPrefix: _editingWorkspaceTodo.commentPrefix,
                },
            });
            // Optimistically update local state
            _editingWorkspaceTodo.title = newTitle;
            _editingWorkspaceTodo.description = newDescription || undefined;
            renderWorkspaceTodoList();
            closeWorkspaceTodoModal();
        });

        // Handle backend responses
        function handleWorkspaceTodosScanned(data) {
            // Reset scan button
            const btn = document.getElementById('btn-scan-workspace-todos');
            if (btn) { btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg> Scan`; btn.disabled = false; }
            if (data.error) { showToast('Scan failed: ' + data.error, 'error'); return; }
            workspaceTodos = data.todos || [];
            renderWorkspaceTodoList();
            if (workspaceTodos.length === 0) {
                workspaceTodosEmpty.classList.remove('hidden');
                workspaceTodosEmpty.innerHTML = 'No TODO comments found.<br><span class="text-gray-700">Add <code class="text-violet-500">// TODO: title</code> to your code.</span>';
                if (!_workspaceTodosExpanded) {
                    _workspaceTodosExpanded = true;
                    workspaceTodosPanel.classList.remove('hidden');
                    workspaceTodosChevron.style.transform = 'rotate(90deg)';
                }
            }
        }

        function handleWorkspaceTodoUpdated(data) {
            if (!data.ok) showToast('Failed to save TODO to file', 'error');
        }

        // ============================================================
        // Rebuild Index Button & Modal
        // ============================================================

        const rebuildIndexRow       = document.getElementById('rebuild-index-row');
        const btnRebuildIndex       = document.getElementById('btn-rebuild-index');
        const rebuildConfirmModal   = document.getElementById('rebuild-index-confirm-modal');
        const btnCloseRebuildModal  = document.getElementById('btn-close-rebuild-modal');
        const btnRebuildCancel      = document.getElementById('btn-rebuild-cancel');
        const btnRebuildConfirm     = document.getElementById('btn-rebuild-confirm');

        const _rebuildDefaultHTML = btnRebuildIndex.innerHTML;

        btnRebuildIndex.addEventListener('click', () => {
            rebuildConfirmModal.classList.remove('hidden');
        });

        function closeRebuildModal() {
            rebuildConfirmModal.classList.add('hidden');
        }
        btnCloseRebuildModal.addEventListener('click', closeRebuildModal);
        btnRebuildCancel.addEventListener('click', closeRebuildModal);

        btnRebuildConfirm.addEventListener('click', () => {
            closeRebuildModal();
            // Set loading state
            btnRebuildIndex.disabled = true;
            btnRebuildIndex.innerHTML = `<svg class="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Rebuilding\u2026`;
            vscode.postMessage({ command: 'rebuildIndex' });
        });

        function handleIndexRebuildComplete(message) {
            btnRebuildIndex.disabled = false;
            btnRebuildIndex.innerHTML = _rebuildDefaultHTML;
            if (message.success) {
                showToast('Workspace index rebuilt successfully', 'success');
            } else {
                showToast('Index rebuild failed: ' + (message.error || 'unknown error'), 'error');
            }
        }

        // ============================================================
        // Stack Trace Modal & Handling
        // ============================================================

        const stackTraceModal    = document.getElementById('stack-trace-modal');
        const btnStackTrace      = document.getElementById('btn-stack-trace');
        const btnCloseStackTrace = document.getElementById('btn-close-stack-trace-modal');
        const btnCancelStackTrace = document.getElementById('btn-cancel-stack-trace');
        const btnSendStackTrace  = document.getElementById('btn-send-stack-trace');
        const stackTraceInput    = document.getElementById('stack-trace-input');
        const stackTraceError    = document.getElementById('stack-trace-error');
        const stackTraceTabs     = document.querySelectorAll('.stack-tab');

        // Tab switching inside modal
        stackTraceTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;
                stackTraceTabs.forEach(t => {
                    t.classList.remove('text-white','bg-gray-700');
                    t.classList.add('text-gray-400');
                });
                tab.classList.add('text-white','bg-gray-700');
                tab.classList.remove('text-gray-400');
                ['paste','test','vscode'].forEach(id => {
                    const el = document.getElementById(`stack-tab-${id}`);
                    if (el) el.classList.toggle('hidden', id !== target);
                    if (el && id === target) el.classList.add('flex');
                });
            });
        });

        btnStackTrace.addEventListener('click', () => {
            stackTraceError.classList.add('hidden');
            stackTraceModal.classList.remove('hidden');
        });

        function closeStackTraceModal() {
            stackTraceModal.classList.add('hidden');
            stackTraceInput.value = '';
        }

        btnCloseStackTrace.addEventListener('click', closeStackTraceModal);
        btnCancelStackTrace.addEventListener('click', closeStackTraceModal);
        document.getElementById('stack-trace-backdrop').addEventListener('click', closeStackTraceModal);

        btnSendStackTrace.addEventListener('click', () => {
            const activeTab = document.querySelector('.stack-tab.bg-gray-700')?.dataset.tab || 'paste';

            if (activeTab === 'paste') {
                const text = stackTraceInput.value.trim();
                if (!text) {
                    stackTraceError.textContent = 'Please paste a stack trace.';
                    stackTraceError.classList.remove('hidden');
                    return;
                }
                stackTraceError.classList.add('hidden');
                vscode.postMessage({ command: 'shareStackTrace', rawText: text });
                closeStackTraceModal();

            } else if (activeTab === 'test') {
                const text = document.getElementById('test-output-input').value.trim();
                const framework = document.getElementById('test-framework-select').value;
                if (!text) {
                    stackTraceError.textContent = 'Please paste test output.';
                    stackTraceError.classList.remove('hidden');
                    return;
                }
                stackTraceError.classList.add('hidden');
                vscode.postMessage({ command: 'shareTestOutput', rawText: text, framework });
                closeStackTraceModal();

            } else if (activeTab === 'vscode') {
                vscode.postMessage({ command: 'shareTestFailures' });
                closeStackTraceModal();
            }
        });

        document.getElementById('btn-collect-vscode-tests').addEventListener('click', () => {
            vscode.postMessage({ command: 'shareTestFailures' });
        });

        // Handle resolved stack trace from extension
        function handleStackTraceResolved(message) {
            if (message.error) {
                console.warn('[WebView] Stack trace parse error:', message.error);
                return;
            }
            if (!ws || ws.readyState !== WebSocket.OPEN || !session.userId) {
                console.warn('[WebView] Cannot send: not connected');
                return;
            }
            ws.send(JSON.stringify({
                type: 'stack_trace',
                rawText: message.parsed.rawText,
                parsed: message.parsed,
                content: `${message.parsed.errorType || 'Error'}: ${message.parsed.errorMessage || ''}`.trim(),
            }));
        }

        // Handle resolved test failures from extension
        function handleTestFailuresResolved(message) {
            if (message.error) {
                console.warn('[WebView] Test failure error:', message.error);
                // Show in preview area if modal still open
                const preview = document.getElementById('vscode-tests-preview');
                if (preview) {
                    preview.textContent = message.error;
                    preview.classList.remove('hidden');
                }
                return;
            }
            if (!ws || ws.readyState !== WebSocket.OPEN || !session.userId) return;
            const tf = message.testFailure;
            ws.send(JSON.stringify({
                type: 'test_failure',
                testFailure: tf,
                content: `${tf.totalFailed} test(s) failed (${tf.framework})`,
            }));
        }

        // ============================================================
        // Code Snippet Handling
        // ============================================================

        /**
         * Handle code snippet button click - request code from extension
         */
        btnCodeSnippet.addEventListener('click', () => {
            vscode.postMessage({ command: 'getCodeSnippet' });
        });

        /**
         * Handle code snippet received from extension
         */
        function handleCodeSnippetFromExtension(message) {
            if (message.error) {
                console.warn('[WebView] Code snippet error:', message.error);
                return;
            }

            pendingCodeSnippet = {
                filename: message.filename,
                relativePath: message.relativePath,
                language: message.language,
                startLine: message.startLine,
                endLine: message.endLine,
                code: message.code
            };

            // Show preview
            codeSnippetFilename.textContent = message.relativePath || message.filename;
            codeSnippetFilename.title = message.relativePath || message.filename;

            const lineCount = message.endLine - message.startLine + 1;
            codeSnippetLines.textContent = message.startLine === message.endLine
                ? `L${message.startLine}`
                : `L${message.startLine}–${message.endLine}`;

            // Show stats (line count + char count) so user knows how much was captured
            const statsEl = document.getElementById('code-snippet-stats');
            if (statsEl) {
                statsEl.textContent = `${lineCount} line${lineCount !== 1 ? 's' : ''} · ${message.code.length} chars`;
            }

            codeSnippetContent.textContent = message.code;

            // Reset collapse state each time new snippet arrives
            const snippetBody = document.getElementById('code-snippet-body');
            const toggleBtn = document.getElementById('btn-toggle-snippet');
            if (snippetBody) snippetBody.style.maxHeight = '80px';
            if (toggleBtn) toggleBtn.textContent = '▼';

            codeSnippetPreview.classList.remove('hidden');

            // Focus the input for adding a comment
            chatInput.focus();
            chatInput.placeholder = 'Add a comment about this code...';
        }

        /**
         * Clear the pending code snippet
         */
        function clearCodeSnippet() {
            pendingCodeSnippet = null;
            codeSnippetPreview.classList.add('hidden');
            codeSnippetFilename.textContent = '';
            codeSnippetLines.textContent = '';
            codeSnippetContent.textContent = '';
            chatInput.placeholder = 'Type a message...';
        }

        /**
         * Clear snippet button handler
         */
        btnClearSnippet.addEventListener('click', clearCodeSnippet);

        /**
         * Toggle snippet preview between collapsed (5 lines) and expanded (20 lines).
         */
        const btnToggleSnippet = document.getElementById('btn-toggle-snippet');
        const snippetBodyEl = document.getElementById('code-snippet-body');
        let _snippetExpanded = false;
        btnToggleSnippet?.addEventListener('click', () => {
            _snippetExpanded = !_snippetExpanded;
            if (snippetBodyEl) {
                snippetBodyEl.style.maxHeight = _snippetExpanded ? '200px' : '80px';
            }
            if (btnToggleSnippet) {
                btnToggleSnippet.textContent = _snippetExpanded ? '▲' : '▼';
                btnToggleSnippet.title = _snippetExpanded ? 'Collapse preview' : 'Expand preview';
            }
        });

        // ============================================================
        // File Upload Handling
        // ============================================================

        /**
         * Show file preview before upload
         */
        function showFilePreview(file) {
            pendingFile = file;
            filePreviewName.textContent = file.name;
            filePreviewSize.textContent = formatFileSize(file.size);

            // Set icon based on file type
            if (file.type.startsWith('image/')) {
                filePreviewIcon.textContent = '🖼️';
                // Show image thumbnail
                const reader = new FileReader();
                reader.onload = (e) => {
                    filePreviewImg.src = e.target.result;
                    filePreviewImg.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                filePreviewIcon.textContent = '📄';
                filePreviewImg.classList.add('hidden');
            } else if (file.type.startsWith('audio/')) {
                filePreviewIcon.textContent = '🎵';
                filePreviewImg.classList.add('hidden');
            } else {
                filePreviewIcon.textContent = '📎';
                filePreviewImg.classList.add('hidden');
            }

            filePreview.classList.remove('hidden');
        }

        /**
         * Clear file preview
         */
        function clearFilePreview() {
            pendingFile = null;
            isUploading = false;
            filePreview.classList.add('hidden');
            filePreviewImg.src = '';
            filePreviewImg.classList.add('hidden');
            fileInput.value = '';
            fileCaption.value = '';
            btnUploadFile.disabled = false;
            btnUploadFile.textContent = 'Upload';
        }

        /**
         * Upload a file to the backend via VS Code extension host.
         * Checks for duplicates first via extension host proxy.
         */
        async function uploadFile(file, caption = null) {
            if (isUploading) {
                console.log('[WebView] Upload already in progress, ignoring');
                return;
            }

            if (!session.backendUrl || !session.roomId) {
                console.error('[WebView] Cannot upload: missing backendUrl or roomId');
                showToast('Cannot upload: session not initialized. Please start or join a session first.', 'error');
                return;
            }

            if (file.size > MAX_FILE_SIZE) {
                showToast(`File size exceeds 20MB limit. Your file is ${formatFileSize(file.size)}`, 'error');
                return;
            }

            // Store pending data for duplicate check callback
            pendingDupCheckFile = file;
            pendingDupCheckCaption = caption;

            // Ask extension host to check for duplicates
            vscode.postMessage({
                command: 'checkDuplicateFile',
                backendUrl: session.backendUrl,
                roomId: session.roomId,
                fileName: file.name
            });
        }

        // Pending state for duplicate check flow
        let pendingDupCheckFile = null;
        let pendingDupCheckCaption = null;

        /**
         * Handle duplicate check result from extension host.
         */
        function handleCheckDuplicateFileResult(message) {
            const file = pendingDupCheckFile;
            const caption = pendingDupCheckCaption;
            pendingDupCheckFile = null;
            pendingDupCheckCaption = null;

            if (!file) return;

            if (message.duplicate && message.existing_file) {
                showDuplicatePrompt(file, caption, message.existing_file);
            } else {
                doUploadFile(file, caption);
            }
        }

        /**
         * Show duplicate file prompt in the file preview area.
         */
        function showDuplicatePrompt(file, caption, existingFile) {
            const uploadDate = new Date(existingFile.uploaded_at * 1000).toLocaleDateString([], { month: 'short', day: 'numeric' });
            const uploaderName = existingFile.display_name || 'someone';

            filePreview.innerHTML = `
                <div class="p-3">
                    <div class="text-sm text-yellow-300 mb-2">⚠️ Duplicate file detected</div>
                    <p class="text-xs text-gray-400 mb-3">
                        <span class="text-gray-200 font-medium">${escapeHtml(file.name)}</span>
                        was already uploaded by <span class="text-gray-200">${escapeHtml(uploaderName)}</span>
                        on ${uploadDate}
                    </p>
                    <div class="flex gap-2">
                        <button id="btn-dup-upload" class="btn-primary text-xs px-3 py-1.5">Upload New</button>
                        <button id="btn-dup-existing" class="btn-secondary text-xs px-3 py-1.5">Use Existing</button>
                        <button id="btn-dup-cancel" class="text-gray-400 hover:text-gray-200 text-xs px-2 py-1.5">Cancel</button>
                    </div>
                </div>
            `;
            filePreview.classList.remove('hidden');

            document.getElementById('btn-dup-upload').addEventListener('click', () => {
                restoreFilePreviewUI();
                doUploadFile(file, caption);
            });

            document.getElementById('btn-dup-existing').addEventListener('click', () => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const fileMessage = {
                        type: 'file',
                        id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
                        displayName: session.displayName || 'User',
                        fileId: existingFile.id,
                        originalFilename: existingFile.original_filename,
                        fileType: null,
                        mimeType: null,
                        sizeBytes: existingFile.size_bytes,
                        downloadUrl: existingFile.download_url,
                        caption: caption,
                        ts: Date.now() / 1000
                    };
                    ws.send(JSON.stringify(fileMessage));
                }
                clearFilePreview();
            });

            document.getElementById('btn-dup-cancel').addEventListener('click', () => {
                clearFilePreview();
            });
        }

        /**
         * Restore file preview UI to its original HTML structure.
         */
        function restoreFilePreviewUI() {
            filePreview.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span id="file-preview-icon" class="text-2xl">📎</span>
                        <div>
                            <div id="file-preview-name" class="text-sm text-gray-200 font-medium"></div>
                            <div id="file-preview-size" class="text-xs text-gray-500"></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="btn-upload-file" class="btn-success text-sm px-3 py-1.5">Upload</button>
                        <button id="btn-remove-file" class="text-gray-400 hover:text-red-400 p-1 transition-colors" title="Cancel">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                <img id="file-preview-img" class="hidden mt-3 max-h-32 rounded-lg" />
                <div class="mt-2">
                    <input type="text" id="file-caption" placeholder="Add a caption (optional)..."
                           class="input-premium w-full text-sm px-3 py-1.5" />
                </div>
            `;
            // Re-query DOM references after innerHTML replacement
            filePreviewIcon = document.getElementById('file-preview-icon');
            filePreviewName = document.getElementById('file-preview-name');
            filePreviewSize = document.getElementById('file-preview-size');
            filePreviewImg = document.getElementById('file-preview-img');
            fileCaption = document.getElementById('file-caption');
            btnUploadFile = document.getElementById('btn-upload-file');
            btnRemoveFile = document.getElementById('btn-remove-file');
            // Re-bind button handlers
            btnUploadFile.addEventListener('click', async () => {
                if (pendingFile && !isUploading) {
                    const cap = fileCaption.value.trim() || null;
                    await uploadFile(pendingFile, cap);
                }
            });
            btnRemoveFile.addEventListener('click', clearFilePreview);
        }

        /**
         * Perform the actual file upload via extension host (no duplicate check).
         */
        function doUploadFile(file, caption = null) {
            isUploading = true;
            const uploadBtn = document.getElementById('btn-upload-file');
            if (uploadBtn) {
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<span class="upload-spinner"></span> Uploading...';
            }

            // Store caption for use in response handler
            pendingUploadCaption = caption;

            try {
                console.log('[WebView] Uploading file via extension host:', file.name, file.size, 'bytes');

                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Data = e.target.result.split(',')[1];

                    vscode.postMessage({
                        command: 'uploadFile',
                        backendUrl: session.backendUrl,
                        roomId: session.roomId,
                        userId: session.userId,
                        displayName: session.displayName || 'Host',
                        fileData: base64Data,
                        fileName: file.name,
                        mimeType: file.type || 'application/octet-stream',
                        caption: caption
                    });

                    console.log('[WebView] Upload request sent to extension host');
                };
                reader.onerror = function(e) {
                    console.error('[WebView] Failed to read file:', e);
                    showToast('Failed to read file', 'error');
                    isUploading = false;
                    if (uploadBtn) {
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Upload';
                    }
                };
                reader.readAsDataURL(file);

            } catch (error) {
                console.error('[WebView] File upload failed:', error);
                showToast(`File upload failed: ${error.message}`, 'error');
                isUploading = false;
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Upload';
                }
            }
        }

        // Store pending upload caption for use in response handler
        let pendingUploadCaption = null;

        // Attachment button click handler
        btnAttach.addEventListener('click', () => {
            fileInput.click();
        });

        // Upload button click handler (explicit upload action)
        btnUploadFile.addEventListener('click', async () => {
            if (pendingFile && !isUploading) {
                const caption = fileCaption.value.trim() || null;
                await uploadFile(pendingFile, caption);
            }
        });

        // File input change handler
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > MAX_FILE_SIZE) {
                showToast(`File size exceeds 20MB limit. Your file is ${formatFileSize(file.size)}`, 'error');
                fileInput.value = '';
                return;
            }

            showFilePreview(file);
        });

        // Remove file button handler
        btnRemoveFile.addEventListener('click', clearFilePreview);

        // Handle paste event for images
        chatInput.addEventListener('paste', async (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;

            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) {
                        // Show preview for pasted image
                        showFilePreview(file);
                    }
                    break;
                }
            }
        });

        // Drag-and-drop file support on input area
        // Note: VS Code WebViews intercept external file drags, so dataTransfer.files
        // will typically be empty. We detect this and guide users to the Attach button.
        (function initDragDrop() {
            const inputWrapper = document.getElementById('input-wrapper');
            const isVSCode = typeof acquireVsCodeApi === 'function';
            let dragCounter = 0;
            let savedPlaceholder = '';

            // Prevent browser from opening the file
            document.body.addEventListener('dragover', (e) => e.preventDefault());
            document.body.addEventListener('drop', (e) => e.preventDefault());

            inputWrapper.addEventListener('dragenter', (e) => {
                e.preventDefault();
                dragCounter++;
                if (dragCounter === 1) {
                    savedPlaceholder = chatInput.placeholder;
                    chatInput.placeholder = isVSCode
                        ? 'Use the clip button to attach files'
                        : 'Release to attach file';
                    inputWrapper.classList.add('input-drop-active');
                }
            });
            inputWrapper.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            inputWrapper.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dragCounter--;
                if (dragCounter <= 0) {
                    dragCounter = 0;
                    chatInput.placeholder = savedPlaceholder;
                    inputWrapper.classList.remove('input-drop-active');
                }
            });
            inputWrapper.addEventListener('drop', (e) => {
                e.preventDefault();
                dragCounter = 0;
                chatInput.placeholder = savedPlaceholder;
                inputWrapper.classList.remove('input-drop-active');
                const file = e.dataTransfer?.files?.[0];
                if (file) {
                    showFilePreview(file);
                } else if (isVSCode) {
                    showToast('Drag-and-drop is not supported in VS Code. Use the clip button to attach files.', 'info');
                }
            });
        })();

        // Copy room ID button handler
        btnCopyRoomId.addEventListener('click', async () => {
            if (session.roomId) {
                try {
                    await navigator.clipboard.writeText(session.roomId);
                    // Visual feedback - show checkmark
                    btnCopyRoomId.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    `;
                    // Revert to clipboard icon after 2 seconds
                    setTimeout(() => {
                        btnCopyRoomId.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                            </svg>
                        `;
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy room ID:', err);
                }
            }
        });

        // End chat button handler (Lead/Host only)
        btnEndChat.addEventListener('click', () => {
            console.log('[WebView] End Chat button clicked');
            // Use VS Code API for confirmation since confirm() doesn't work in WebView
            vscode.postMessage({
                command: 'confirmEndChat'
            });
        });

        // Handle confirmation response from extension
        function handleEndChatConfirmed() {
            console.log('[WebView] End chat confirmed, ws state:', ws ? ws.readyState : 'null');
            // SECURITY: Backend validates permission using assigned userId
            if (ws && ws.readyState === WebSocket.OPEN) {
                const msg = {
                    type: 'end_session'
                    // Note: userId is handled by backend (assigned on connection)
                };
                console.log('[WebView] Sending end_session:', msg);
                ws.send(JSON.stringify(msg));
            } else {
                console.error('[WebView] WebSocket not open');
            }
        }

        // ============================================================
        // AI Configuration Modal Functions
        // ============================================================

        /**
         * Open the AI Configuration modal and fetch status.
         */
        function openAiConfigModal() {
            aiConfigModal.classList.remove('hidden');
            fetchAiStatus();
        }

        /**
         * Close the AI Configuration modal.
         */
        function closeAiConfigModal() {
            aiConfigModal.classList.add('hidden');
        }

        /**
         * Fetch AI status from the backend via extension.
         */
        function fetchAiStatus() {
            console.log('[WebView] fetchAiStatus called');
            // Show loading state
            aiConfigLoading.classList.remove('hidden');
            aiConfigError.classList.add('hidden');
            aiConfigContent.classList.add('hidden');

            // Request AI status from extension (which proxies to backend)
            console.log('[WebView] Sending getAiStatus message to extension');
            vscode.postMessage({ command: 'getAiStatus' });
        }

        /**
         * Handle AI status response from extension.
         * @param {Object} data - AI status data or error
         */
        function handleAiStatusResponse(data) {
            console.log('[WebView] handleAiStatusResponse called with:', JSON.stringify(data));

            // Hide loading
            aiConfigLoading.classList.add('hidden');

            if (data.error) {
                // Show error state
                console.log('[WebView] AI status error:', data.error);
                aiConfigError.classList.remove('hidden');
                aiConfigErrorText.textContent = data.error;
                aiConfigContent.classList.add('hidden');
                return;
            }

            // Show content
            aiConfigError.classList.add('hidden');
            aiConfigContent.classList.remove('hidden');

            // Update global AI status state
            aiSummaryEnabledState = data.summary_enabled;
            aiActiveProviderState = data.active_provider;
            aiModelsState = data.models || [];
            aiActiveModelState = data.active_model;
            console.log('[WebView] AI status updated: enabled=', aiSummaryEnabledState, ', provider=', aiActiveProviderState, ', model=', aiActiveModelState);

            // Gate AI-dependent buttons based on provider availability
            updateAiDependentButtons();

            // Update summary enabled section
            if (data.summary_enabled) {
                aiSummaryEnabled.textContent = 'Enabled';
                aiSummaryEnabled.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-600 text-white';
                aiSummaryIcon.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-green-600/20 text-green-400';
                aiSummaryStatusText.textContent = data.active_model ? `Using ${data.active_model}` : 'No model available';
                aiSummaryStatusText.className = data.active_model ? 'text-xs text-green-400' : 'text-xs text-yellow-400';
            } else {
                aiSummaryEnabled.textContent = 'Disabled';
                aiSummaryEnabled.className = 'px-3 py-1 rounded-full text-xs font-medium bg-gray-600 text-gray-300';
                aiSummaryIcon.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-gray-600/20 text-gray-400';
                aiSummaryStatusText.textContent = 'AI summarization is disabled';
                aiSummaryStatusText.className = 'text-xs text-gray-400';
            }

            // Update model selection dropdown
            updateModelSelect(data.models || [], data.active_model);

            // Update last updated timestamp
            const now = new Date();
            aiLastUpdated.textContent = `Updated ${now.toLocaleTimeString()}`;

            // Update the sidebar AI status indicator
            updateAiStatusIndicator();

            // Update providers list
            aiProvidersList.innerHTML = '';
            if (data.providers && data.providers.length > 0) {
                aiNoProviders.classList.add('hidden');
                aiProvidersList.classList.remove('hidden');

                data.providers.forEach(provider => {
                    const row = document.createElement('div');
                    const isActive = provider.name === data.active_provider;
                    row.className = isActive
                        ? 'flex items-center justify-between px-3 py-2.5 bg-purple-900/20'
                        : 'flex items-center justify-between px-3 py-2.5';

                    const leftSection = document.createElement('div');
                    leftSection.className = 'flex items-center gap-2';

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'text-sm text-gray-300 font-mono';
                    nameSpan.textContent = provider.name;

                    leftSection.appendChild(nameSpan);

                    // Add "Active" badge if this is the active provider
                    if (isActive) {
                        const activeBadge = document.createElement('span');
                        activeBadge.className = 'px-1.5 py-0.5 rounded text-[10px] font-medium bg-purple-600 text-white uppercase';
                        activeBadge.textContent = 'Active';
                        leftSection.appendChild(activeBadge);
                    }

                    const statusSpan = document.createElement('span');
                    if (!provider.enabled) {
                        // Provider is disabled in settings
                        statusSpan.className = 'flex items-center gap-1.5 text-xs text-gray-500';
                        statusSpan.innerHTML = `
                            <span class="inline-block h-2 w-2 rounded-full bg-gray-500"></span>
                            Disabled
                        `;
                    } else if (!provider.configured) {
                        // Provider is enabled but no API key configured
                        statusSpan.className = 'flex items-center gap-1.5 text-xs text-yellow-500';
                        statusSpan.innerHTML = `
                            <span class="inline-block h-2 w-2 rounded-full bg-yellow-500"></span>
                            Not configured
                        `;
                    } else if (provider.healthy) {
                        // Provider is enabled, configured, and healthy
                        statusSpan.className = 'flex items-center gap-1.5 text-xs text-green-400';
                        statusSpan.innerHTML = `
                            <span class="inline-block h-2 w-2 rounded-full bg-green-400"></span>
                            Healthy
                        `;
                    } else {
                        // Provider is enabled and configured but unhealthy
                        statusSpan.className = 'flex items-center gap-1.5 text-xs text-red-400';
                        statusSpan.innerHTML = `
                            <span class="inline-block h-2 w-2 rounded-full bg-red-400"></span>
                            Unhealthy
                        `;
                    }

                    row.appendChild(leftSection);
                    row.appendChild(statusSpan);
                    aiProvidersList.appendChild(row);
                });
            } else {
                aiProvidersList.classList.add('hidden');
                aiNoProviders.classList.remove('hidden');
            }
        }

        /**
         * Update model selection dropdown.
         * @param {Array} models - Array of model status objects
         * @param {string|null} activeModel - Currently active model ID
         */
        function updateModelSelect(models, activeModel) {
            if (!aiModelSelect) return;

            aiModelSelect.innerHTML = '';

            if (models.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No models available';
                option.disabled = true;
                aiModelSelect.appendChild(option);
                aiModelSelect.disabled = true;
                if (aiModelSelectHint) {
                    aiModelSelectHint.textContent = 'Configure AI providers to enable models';
                }
                return;
            }

            // Group models by provider
            const availableModels = models.filter(m => m.available);
            const unavailableModels = models.filter(m => !m.available);

            // Add available models first
            if (availableModels.length > 0) {
                availableModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = `${model.display_name}`;
                    if (model.id === activeModel) {
                        option.selected = true;
                    }
                    aiModelSelect.appendChild(option);
                });
            }

            // Add unavailable models (grayed out)
            if (unavailableModels.length > 0 && availableModels.length > 0) {
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '── Unavailable ──';
                aiModelSelect.appendChild(separator);
            }
            unavailableModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = `${model.display_name} (no provider)`;
                option.disabled = true;
                aiModelSelect.appendChild(option);
            });

            aiModelSelect.disabled = availableModels.length === 0;

            if (aiModelSelectHint) {
                if (availableModels.length === 0) {
                    aiModelSelectHint.textContent = 'No providers configured - add API keys to enable models';
                    aiModelSelectHint.className = 'text-xs text-yellow-500 mt-2';
                } else {
                    aiModelSelectHint.textContent = `${availableModels.length} model(s) available`;
                    aiModelSelectHint.className = 'text-xs text-gray-500 mt-2';
                }
            }
        }

        /**
         * Handle model selection change.
         */
        function handleModelChange(modelId) {
            if (!modelId) return;

            console.log('[WebView] Changing active model to:', modelId);
            // Disable select while changing
            if (aiModelSelect) {
                aiModelSelect.disabled = true;
            }
            vscode.postMessage({
                command: 'setAiModel',
                modelId: modelId
            });
        }

        /**
         * Handle result of setting AI model.
         * @param {Object} data - Result data from backend
         */
        function handleSetAiModelResult(data) {
            // Re-enable the select
            if (aiModelSelect) {
                aiModelSelect.disabled = false;
            }

            if (data.error) {
                console.error('[WebView] Failed to set AI model:', data.error);
                // The extension will automatically refresh status, which will restore the select
                return;
            }

            console.log('[WebView] AI model set successfully:', data.message);
            // Status will be refreshed automatically by the extension
        }

        // AI Config modal event listeners
        if (btnAiConfig) {
            btnAiConfig.addEventListener('click', openAiConfigModal);
        } else {
            console.error('[WebView] btnAiConfig element not found!');
        }
        if (btnCloseAiConfig) {
            btnCloseAiConfig.addEventListener('click', closeAiConfigModal);
        }
        if (aiConfigBackdrop) {
            aiConfigBackdrop.addEventListener('click', closeAiConfigModal);
        }
        if (btnRefreshAiStatus) {
            btnRefreshAiStatus.addEventListener('click', fetchAiStatus);
        }
        if (aiModelSelect) {
            aiModelSelect.addEventListener('change', (e) => {
                handleModelChange(e.target.value);
            });
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !aiConfigModal.classList.contains('hidden')) {
                closeAiConfigModal();
            }
            if (e.key === 'Escape' && !roomSettingsModal.classList.contains('hidden')) {
                closeRoomSettingsModal();
            }
        });

        // ============================================================
        // ROOM SETTINGS MODAL FUNCTIONS
        // ============================================================

        /**
         * Open the Room Settings modal and fetch settings.
         */
        function openRoomSettingsModal() {
            roomSettingsModal.classList.remove('hidden');
            // Reset preview state
            if (stylePreview) stylePreview.classList.add('hidden');
            if (roomCodeStyleTextarea) roomCodeStyleTextarea.classList.remove('hidden');
            if (btnTogglePreview) btnTogglePreview.textContent = 'Preview';
            fetchRoomSettings();
            fetchStyleTemplates();
        }

        /**
         * Close the Room Settings modal.
         */
        function closeRoomSettingsModal() {
            roomSettingsModal.classList.add('hidden');
        }

        /**
         * Fetch room settings from the backend via extension.
         */
        function fetchRoomSettings() {
            console.log('[WebView] fetchRoomSettings called');
            roomSettingsLoading.classList.remove('hidden');
            roomSettingsError.classList.add('hidden');
            roomSettingsContent.classList.add('hidden');
            roomSettingsFooter.classList.add('hidden');

            vscode.postMessage({ command: 'getRoomSettings', roomId: session.roomId });
        }

        /**
         * Fetch style templates from the backend via extension.
         */
        function fetchStyleTemplates() {
            console.log('[WebView] fetchStyleTemplates called');
            vscode.postMessage({ command: 'getStyleTemplates' });
        }

        /**
         * Handle style templates response from extension.
         * @param {Object} data - Templates data or error
         */
        function handleStyleTemplatesResponse(data) {
            console.log('[WebView] handleStyleTemplatesResponse');
            if (data.error || !data.templates) {
                console.warn('[WebView] Failed to load style templates:', data.error);
                return;
            }
            styleTemplatesCache = data.templates;
            if (styleTemplateSelect) {
                styleTemplateSelect.innerHTML = '<option value="">-- Select a template --</option>';
                data.templates.forEach(function(t) {
                    const opt = document.createElement('option');
                    opt.value = t.name;
                    opt.textContent = t.name.charAt(0).toUpperCase() + t.name.slice(1);
                    styleTemplateSelect.appendChild(opt);
                });
            }
        }

        /**
         * Load selected template content into the textarea.
         */
        function loadSelectedTemplate() {
            if (!styleTemplateSelect) return;
            const name = styleTemplateSelect.value;
            if (!name) return;
            const template = styleTemplatesCache.find(function(t) { return t.name === name; });
            if (template && roomCodeStyleTextarea) {
                roomCodeStyleTextarea.value = template.content;
                // Switch back to edit mode if in preview
                if (stylePreview && !stylePreview.classList.contains('hidden')) {
                    stylePreview.classList.add('hidden');
                    roomCodeStyleTextarea.classList.remove('hidden');
                    if (btnTogglePreview) btnTogglePreview.textContent = 'Preview';
                }
                updateSourceBadge(true);
            }
        }

        /**
         * Toggle between edit and preview mode for the code style textarea.
         */
        function toggleStylePreview() {
            if (!stylePreview || !roomCodeStyleTextarea || !btnTogglePreview) return;
            const isPreview = !stylePreview.classList.contains('hidden');
            if (isPreview) {
                // Switch to edit mode
                stylePreview.classList.add('hidden');
                roomCodeStyleTextarea.classList.remove('hidden');
                btnTogglePreview.textContent = 'Preview';
            } else {
                // Switch to preview mode
                const md = roomCodeStyleTextarea.value || '';
                stylePreview.innerHTML = renderSimpleMarkdown(md);
                roomCodeStyleTextarea.classList.add('hidden');
                stylePreview.classList.remove('hidden');
                btnTogglePreview.textContent = 'Edit';
            }
        }

        /**
         * Simple markdown renderer for preview.
         * Handles # headers, - bullets, and `inline code`.
         * @param {string} md - Markdown text
         * @returns {string} HTML string
         */
        function renderSimpleMarkdown(md) {
            if (!md) return '<p class="text-gray-500 italic">No content</p>';
            const escaped = md.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const lines = escaped.split('\n');
            let html = '';
            let inList = false;

            lines.forEach(function(line) {
                // Headers
                if (line.match(/^### /)) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += '<h4 class="text-sm font-semibold text-violet-300 mt-3 mb-1">' + line.slice(4) + '</h4>';
                } else if (line.match(/^## /)) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += '<h3 class="text-sm font-bold text-violet-200 mt-4 mb-1">' + line.slice(3) + '</h3>';
                } else if (line.match(/^# /)) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += '<h2 class="text-base font-bold text-white mt-4 mb-2">' + line.slice(2) + '</h2>';
                }
                // Bullet points
                else if (line.match(/^\s*- /)) {
                    if (!inList) { html += '<ul class="list-disc list-inside space-y-0.5 text-gray-300">'; inList = true; }
                    html += '<li class="text-xs">' + inlineCode(line.replace(/^\s*- /, '')) + '</li>';
                }
                // Numbered lists
                else if (line.match(/^\s*\d+\. /)) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += '<p class="text-xs text-gray-300 ml-2">' + inlineCode(line) + '</p>';
                }
                // Blank line
                else if (line.trim() === '') {
                    if (inList) { html += '</ul>'; inList = false; }
                }
                // Regular text
                else {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += '<p class="text-xs text-gray-300">' + inlineCode(line) + '</p>';
                }
            });
            if (inList) html += '</ul>';
            return html;
        }

        /**
         * Replace `code` with styled inline code spans.
         * @param {string} text - Text with backtick-delimited code
         * @returns {string} HTML with styled code spans
         */
        function inlineCode(text) {
            return text.replace(/`([^`]+)`/g, '<code class="bg-gray-800 text-violet-300 px-1 rounded text-xs">$1</code>');
        }

        /**
         * Apply inline formatting: `code` and **bold**.
         * Expects already-escaped text (XSS-safe).
         * @param {string} text - Escaped text with backtick/bold markers
         * @returns {string} HTML with styled inline elements
         */
        function inlineFormat(text) {
            // Inline code with emerald theme
            text = text.replace(/`([^`]+)`/g, '<code class="bg-emerald-950/40 text-emerald-300 px-1 rounded text-xs">$1</code>');
            // Bold
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong class="font-semibold text-white">$1</strong>');
            return text;
        }

        /**
         * Render explanation text with light markdown support.
         * Handles bullets, numbered lists, paragraphs, inline code, and bold.
         * Escapes HTML first for XSS safety.
         * @param {string} text - Raw explanation text from LLM
         * @returns {string} Formatted HTML
         */
        function renderExplanationMarkdown(text) {
            if (!text) return '';
            const escaped = escapeHtml(text);
            const lines = escaped.split('\n');
            let html = '';
            let inUl = false;
            let inOl = false;

            lines.forEach(function(line) {
                const trimmed = line.trim();

                // Bullet list (- item or * item)
                if (/^[-*]\s+/.test(trimmed)) {
                    if (inOl) { html += '</ol>'; inOl = false; }
                    if (!inUl) { html += '<ul class="list-disc list-inside space-y-1 text-gray-200 my-1.5 ml-1">'; inUl = true; }
                    html += '<li class="text-xs leading-relaxed">' + inlineFormat(trimmed.replace(/^[-*]\s+/, '')) + '</li>';
                }
                // Numbered list (1. item)
                else if (/^\d+\.\s+/.test(trimmed)) {
                    if (inUl) { html += '</ul>'; inUl = false; }
                    if (!inOl) { html += '<ol class="list-decimal list-inside space-y-1 text-gray-200 my-1.5 ml-1">'; inOl = true; }
                    html += '<li class="text-xs leading-relaxed">' + inlineFormat(trimmed.replace(/^\d+\.\s+/, '')) + '</li>';
                }
                // Blank line — paragraph break
                else if (trimmed === '') {
                    if (inUl) { html += '</ul>'; inUl = false; }
                    if (inOl) { html += '</ol>'; inOl = false; }
                }
                // Regular text — paragraph
                else {
                    if (inUl) { html += '</ul>'; inUl = false; }
                    if (inOl) { html += '</ol>'; inOl = false; }
                    html += '<p class="text-xs text-gray-200 leading-relaxed my-1">' + inlineFormat(trimmed) + '</p>';
                }
            });

            if (inUl) html += '</ul>';
            if (inOl) html += '</ol>';
            return html;
        }

        /**
         * Update the source badge to show Custom or Default.
         * @param {boolean} hasCustomStyle - Whether the room has a custom style set
         */
        function updateSourceBadge(hasCustomStyle) {
            if (!styleSourceBadge) return;
            styleSourceBadge.classList.remove('hidden');
            if (hasCustomStyle) {
                styleSourceBadge.textContent = 'Custom';
                styleSourceBadge.className = 'text-xs px-2 py-0.5 rounded-full font-medium bg-green-900/50 text-green-400 border border-green-700/50';
            } else {
                styleSourceBadge.textContent = 'Default';
                styleSourceBadge.className = 'text-xs px-2 py-0.5 rounded-full font-medium bg-gray-700/50 text-gray-400 border border-gray-600/50';
            }
        }

        /**
         * Handle room settings response from extension.
         * @param {Object} data - Room settings data or error
         */
        function handleRoomSettingsResponse(data) {
            console.log('[WebView] handleRoomSettingsResponse:', JSON.stringify(data));
            roomSettingsLoading.classList.add('hidden');

            if (data.error) {
                roomSettingsError.classList.remove('hidden');
                roomSettingsErrorText.textContent = data.error;
                return;
            }

            roomSettingsContent.classList.remove('hidden');
            roomSettingsFooter.classList.remove('hidden');
            const codeStyle = data.code_style || '';
            roomCodeStyleTextarea.value = codeStyle;
            updateSourceBadge(!!codeStyle);
            if (roomOutputModeSelect) {
                roomOutputModeSelect.value = data.output_mode || '';
            }
        }

        /**
         * Save room settings via extension.
         */
        function saveRoomSettings() {
            console.log('[WebView] saveRoomSettings called');
            const codeStyle = roomCodeStyleTextarea.value;
            const outputMode = roomOutputModeSelect ? roomOutputModeSelect.value : '';
            vscode.postMessage({
                command: 'saveRoomSettings',
                roomId: session.roomId,
                codeStyle: codeStyle,
                outputMode: outputMode
            });
        }

        /**
         * Handle save room settings result from extension.
         * @param {Object} data - Save result data or error
         */
        function handleSaveRoomSettingsResult(data) {
            console.log('[WebView] handleSaveRoomSettingsResult:', JSON.stringify(data));
            if (data.error) {
                roomSettingsError.classList.remove('hidden');
                roomSettingsErrorText.textContent = data.error;
                return;
            }
            closeRoomSettingsModal();
        }

        // Room Settings modal event listeners
        if (btnRoomSettings) {
            btnRoomSettings.addEventListener('click', openRoomSettingsModal);
        }
        if (btnCloseRoomSettings) {
            btnCloseRoomSettings.addEventListener('click', closeRoomSettingsModal);
        }
        if (btnCancelRoomSettings) {
            btnCancelRoomSettings.addEventListener('click', closeRoomSettingsModal);
        }
        if (roomSettingsBackdrop) {
            roomSettingsBackdrop.addEventListener('click', closeRoomSettingsModal);
        }
        if (btnSaveRoomSettings) {
            btnSaveRoomSettings.addEventListener('click', saveRoomSettings);
        }
        if (btnLoadTemplate) {
            btnLoadTemplate.addEventListener('click', loadSelectedTemplate);
        }
        if (btnTogglePreview) {
            btnTogglePreview.addEventListener('click', toggleStylePreview);
        }

        // ============================================================
        // AI SUMMARIZE FUNCTIONALITY
        // ============================================================

        /**
         * Update AI status indicator (no-op, sidebar indicator removed).
         */
        function updateAiStatusIndicator() {}

        /**
         * Open the summary modal in loading state.
         */
        function openSummaryModal() {
            summaryModal.classList.remove('hidden');
            summaryLoading.classList.remove('hidden');
            summaryError.classList.add('hidden');
            summaryContent.classList.add('hidden');
            // Reset code prompt UI when opening modal
            resetCodePromptUI();
        }

        /**
         * Close the summary modal.
         */
        function closeSummaryModal() {
            summaryModal.classList.add('hidden');
        }

        /**
         * Request AI summary of the current chat.
         * If there's only 1 message, summarizes directly.
         * If there are more than 1 message, shows the options modal to let user choose.
         */
        function requestSummarize() {
            console.log('[WebView] requestSummarize called, aiSummaryEnabledState=', aiSummaryEnabledState, ', aiActiveProviderState=', aiActiveProviderState, ', chatMessages.length=', chatMessages.length);
            if (!aiSummaryEnabledState || !aiActiveProviderState) {
                console.warn('[WebView] Cannot summarize: AI not available. enabled=', aiSummaryEnabledState, ', provider=', aiActiveProviderState);
                vscode.postMessage({
                    command: 'alert',
                    text: 'AI summarization is not available. Please check AI configuration.'
                });
                return;
            }

            if (chatMessages.length === 0) {
                console.warn('[WebView] No messages to summarize');
                vscode.postMessage({
                    command: 'alert',
                    text: 'No messages to summarize. Start a conversation first.'
                });
                return;
            }

            // If only 1 message, summarize directly without showing options
            if (chatMessages.length === 1) {
                console.log('[WebView] Only 1 message, summarizing directly');
                executeSummarize(chatMessages);
                return;
            }

            // More than 1 message - show options modal to let user choose
            console.log('[WebView] Multiple messages detected, showing options modal');
            openSummarizeOptionsModal();
        }

        /**
         * Open the summarize options modal.
         */
        function openSummarizeOptionsModal() {
            console.log('[WebView] Opening summarize options modal, element exists:', !!summarizeOptionsModal);
            if (!summarizeOptionsModal) {
                console.error('[WebView] summarizeOptionsModal element not found!');
                return;
            }
            summarizeOptionsModal.classList.remove('hidden');
            console.log('[WebView] Modal classList after remove hidden:', summarizeOptionsModal.classList.toString());
            // Update message count
            if (summarizeAllCount) {
                summarizeAllCount.textContent = `${chatMessages.length} messages`;
            }
        }

        /**
         * Close the summarize options modal.
         */
        function closeSummarizeOptionsModal() {
            summarizeOptionsModal.classList.add('hidden');
        }

        /**
         * Handle "Summarize All" button click.
         * Summarizes all messages in the chat.
         */
        function handleSummarizeAll() {
            closeSummarizeOptionsModal();
            executeSummarize(chatMessages);
        }

        /**
         * Open the message selection modal.
         */
        function openMessageSelectionModal() {
            closeSummarizeOptionsModal();
            messageSelectionModal.classList.remove('hidden');
            selectedMessageIndices.clear();
            populateMessageSelectionList();
            updateSelectedCount();
        }

        /**
         * Close the message selection modal.
         */
        function closeMessageSelectionModal() {
            messageSelectionModal.classList.add('hidden');
        }

        /**
         * Populate the message selection list with checkboxes.
         */
        function populateMessageSelectionList() {
            messageSelectionList.innerHTML = '';
            chatMessages.forEach((msg, index) => {
                const messageItem = document.createElement('div');
                messageItem.className = 'flex items-start gap-3 p-3 bg-gray-700/50 rounded-lg hover:bg-gray-700 transition-colors';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `msg-checkbox-${index}`;
                checkbox.className = 'mt-1 h-4 w-4 rounded border-gray-600 bg-gray-700 text-purple-600 focus:ring-purple-500 cursor-pointer';
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedMessageIndices.add(index);
                    } else {
                        selectedMessageIndices.delete(index);
                    }
                    updateSelectedCount();
                });

                const label = document.createElement('label');
                label.htmlFor = `msg-checkbox-${index}`;
                label.className = 'flex-1 cursor-pointer';

                const roleSpan = document.createElement('span');
                roleSpan.className = msg.role === 'host' ? 'text-amber-400 text-xs font-medium' : 'text-blue-400 text-xs font-medium';
                roleSpan.textContent = msg.role === 'host' ? 'Host' : 'Engineer';

                const textSpan = document.createElement('span');
                textSpan.className = 'text-gray-300 text-sm block mt-1';
                textSpan.textContent = msg.text.length > 100 ? msg.text.substring(0, 100) + '...' : msg.text;

                label.appendChild(roleSpan);
                label.appendChild(textSpan);

                messageItem.appendChild(checkbox);
                messageItem.appendChild(label);
                messageSelectionList.appendChild(messageItem);
            });
        }

        /**
         * Update the selected messages count display.
         */
        function updateSelectedCount() {
            selectedMessagesCount.textContent = `${selectedMessageIndices.size} selected`;
            btnConfirmMessageSelection.disabled = selectedMessageIndices.size === 0;
        }

        /**
         * Select all messages in the selection list.
         */
        function handleSelectAllMessages() {
            chatMessages.forEach((_, index) => selectedMessageIndices.add(index));
            document.querySelectorAll('#message-selection-list input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateSelectedCount();
        }

        /**
         * Deselect all messages in the selection list.
         */
        function handleDeselectAllMessages() {
            selectedMessageIndices.clear();
            document.querySelectorAll('#message-selection-list input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }

        /**
         * Handle confirm button click in message selection modal.
         * Summarizes only the selected messages.
         */
        function handleConfirmMessageSelection() {
            if (selectedMessageIndices.size === 0) return;

            closeMessageSelectionModal();

            // Get selected messages in order
            const selectedMessages = Array.from(selectedMessageIndices)
                .sort((a, b) => a - b)
                .map(index => chatMessages[index]);

            executeSummarize(selectedMessages);
        }

        /**
         * Execute the summarization with the given messages.
         * @param {Array} messages - The messages to summarize
         */
        function executeSummarize(messages) {
            // Open modal and show loading state
            openSummaryModal();

            console.log('[WebView] Requesting summary for', messages.length, 'messages');

            // Request summary from extension with properly formatted messages
            vscode.postMessage({
                command: 'summarize',
                messages: messages
            });
        }

        /**
         * Handle summarize response from extension.
         * Since the summary is now posted as an AI message in chat,
         * this just closes the modal on success.
         * @param {Object} data - The structured summary response or error
         */
        function handleSummarizeResponse(data) {
            // Hide loading
            summaryLoading.classList.add('hidden');

            if (data.error) {
                console.error('[WebView] Summarize error:', data.error);
                summaryError.classList.remove('hidden');
                summaryErrorText.textContent = data.error;
                summaryContent.classList.add('hidden');
                return;
            }

            // Success - the summary is now posted as an AI message in chat
            // Close the modal since the summary appears in the chat
            closeSummaryModal();
            console.log('[WebView] Summary posted to chat successfully');
        }

        // Summary modal event listeners
        if (btnCloseSummary) {
            btnCloseSummary.addEventListener('click', closeSummaryModal);
        }
        if (btnDismissSummary) {
            btnDismissSummary.addEventListener('click', closeSummaryModal);
        }
        if (summaryModalBackdrop) {
            summaryModalBackdrop.addEventListener('click', closeSummaryModal);
        }

        // Summarize options modal event listeners
        if (btnCloseSummarizeOptions) {
            btnCloseSummarizeOptions.addEventListener('click', closeSummarizeOptionsModal);
        }
        if (summarizeOptionsBackdrop) {
            summarizeOptionsBackdrop.addEventListener('click', closeSummarizeOptionsModal);
        }
        if (btnSummarizeAll) {
            btnSummarizeAll.addEventListener('click', handleSummarizeAll);
        }
        if (btnSummarizeSelect) {
            btnSummarizeSelect.addEventListener('click', openMessageSelectionModal);
        }

        // Message selection modal event listeners
        if (btnCloseMessageSelection) {
            btnCloseMessageSelection.addEventListener('click', closeMessageSelectionModal);
        }
        if (messageSelectionBackdrop) {
            messageSelectionBackdrop.addEventListener('click', closeMessageSelectionModal);
        }
        if (btnSelectAllMessages) {
            btnSelectAllMessages.addEventListener('click', handleSelectAllMessages);
        }
        if (btnDeselectAllMessages) {
            btnDeselectAllMessages.addEventListener('click', handleDeselectAllMessages);
        }
        if (btnCancelMessageSelection) {
            btnCancelMessageSelection.addEventListener('click', closeMessageSelectionModal);
        }
        if (btnConfirmMessageSelection) {
            btnConfirmMessageSelection.addEventListener('click', handleConfirmMessageSelection);
        }

        /**
         * Request code prompt generation from the backend.
         */
        function requestCodePrompt() {
            if (!currentSummaryData) {
                console.warn('[WebView] No summary data available for code prompt generation');
                return;
            }

            // Show loading state
            codePromptInitial.classList.add('hidden');
            codePromptLoading.classList.remove('hidden');
            codePromptError.classList.add('hidden');
            codePromptResult.classList.add('hidden');

            // Disable button
            if (btnGenerateCodePrompt) {
                btnGenerateCodePrompt.disabled = true;
            }

            console.log('[WebView] Requesting code prompt for summary:', currentSummaryData.topic);

            // Request code prompt from extension
            vscode.postMessage({
                command: 'generateCodePrompt',
                decisionSummary: currentSummaryData
            });
        }

        /**
         * Handle code prompt response from extension.
         * @param {Object} data - The code prompt response or error
         */
        function handleCodePromptResponse(data) {
            // Hide loading
            codePromptLoading.classList.add('hidden');

            // Re-enable button
            if (btnGenerateCodePrompt) {
                btnGenerateCodePrompt.disabled = false;
            }

            if (data.error) {
                console.error('[WebView] Code prompt error:', data.error);
                codePromptError.classList.remove('hidden');
                codePromptErrorText.textContent = data.error;
                codePromptInitial.classList.remove('hidden');
                return;
            }

            if (data.code_prompt) {
                // Store the generated prompt
                generatedCodePrompt = data.code_prompt;

                // Show the result
                codePromptError.classList.add('hidden');
                codePromptResult.classList.remove('hidden');
                codePromptTextarea.value = data.code_prompt;

                console.log('[WebView] Code prompt generated successfully');
            }
        }

        /**
         * Handle code prompt post result from extension.
         * This is called after the code prompt is posted to chat as an AI message.
         * @param {Object} data - The result with success or error
         */
        function handleCodePromptPostResponse(data) {
            if (data.error) {
                console.error('[WebView] Code prompt post error:', data.error);
                // Re-enable button on error so user can retry
                if (currentCodePromptButtonId) {
                    const btn = document.getElementById(currentCodePromptButtonId);
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Generate Code Prompt
                        `;
                    }
                    currentCodePromptButtonId = null;
                }
                // Show error to user
                vscode.postMessage({
                    command: 'alert',
                    text: `Failed to post code prompt: ${data.error}`
                });
            } else if (data.success) {
                console.log('[WebView] Code prompt posted to chat successfully');
                // Update button to "Done" state
                if (currentCodePromptButtonId) {
                    const btn = document.getElementById(currentCodePromptButtonId);
                    if (btn) {
                        btn.disabled = true;
                        btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        btn.classList.add('bg-green-600', 'cursor-not-allowed');
                        btn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                            Done
                        `;
                    }
                    currentCodePromptButtonId = null;
                }
            }
        }

        /**
         * Copy code prompt to clipboard.
         */
        function copyCodePromptToClipboard() {
            if (!generatedCodePrompt) {
                return;
            }

            navigator.clipboard.writeText(generatedCodePrompt).then(() => {
                // Show success feedback
                if (btnCopyCodePromptText) {
                    const originalText = btnCopyCodePromptText.textContent;
                    btnCopyCodePromptText.textContent = 'Copied!';
                    setTimeout(() => {
                        btnCopyCodePromptText.textContent = originalText;
                    }, 2000);
                }
                console.log('[WebView] Code prompt copied to clipboard');
            }).catch(err => {
                console.error('[WebView] Failed to copy code prompt:', err);
            });
        }

        /**
         * Reset code prompt UI state (called when summary modal is opened).
         */
        function resetCodePromptUI() {
            codePromptInitial.classList.remove('hidden');
            codePromptLoading.classList.add('hidden');
            codePromptError.classList.add('hidden');
            codePromptResult.classList.add('hidden');
            generatedCodePrompt = null;
            if (codePromptTextarea) {
                codePromptTextarea.value = '';
            }
        }

        // Generate Code Prompt button handler
        if (btnGenerateCodePrompt) {
            btnGenerateCodePrompt.addEventListener('click', requestCodePrompt);
        }

        // Copy Code Prompt button handler
        if (btnCopyCodePrompt) {
            btnCopyCodePrompt.addEventListener('click', copyCodePromptToClipboard);
        }

        // Fetch AI status on load

        vscode.postMessage({ command: 'getAiStatus' });

        // Initialize UI from the current FSM state
        render(conductorState, null);

        // Request latest conductor state from extension (in case it changed since HTML was built)
        vscode.postMessage({ command: 'getConductorState' });
    </script>
</body>
</html>

