<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link rel="stylesheet" href="tailwind.css">
</head>
<body class="bg-gray-900 text-gray-100 h-screen overflow-hidden">
    <div class="flex h-full">
        <!-- Main Chat Area -->
        <div class="flex flex-col flex-1">

            <!-- ============================================================ -->
            <!-- STATE PANEL: Idle â€” Start / Join buttons                     -->
            <!-- ============================================================ -->
            <div id="panel-idle" class="hidden flex-1 flex flex-col items-center justify-center gap-4 px-6">
                <h2 class="text-lg font-semibold text-white">Conductor</h2>
                <p class="text-sm text-gray-400 text-center">Start a new session or join an existing one.</p>
                <button
                    id="btn-idle-start"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-6 py-2 rounded-lg flex items-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    Start
                </button>
                <div class="flex items-center gap-2 w-full max-w-xs">
                    <input
                        id="invite-url-input"
                        type="text"
                        placeholder="Paste invite linkâ€¦"
                        class="flex-1 bg-gray-700 text-white text-xs px-3 py-1.5 rounded-lg border border-gray-600 focus:outline-none focus:border-blue-500"
                    />
                    <button
                        id="btn-idle-join"
                        class="bg-green-600 hover:bg-green-700 text-white text-xs font-medium px-3 py-1.5 rounded-lg flex items-center gap-1"
                    >
                        Join
                    </button>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- STATE PANEL: BackendDisconnected â€” error + retry             -->
            <!-- ============================================================ -->
            <div id="panel-disconnected" class="hidden flex-1 flex flex-col items-center justify-center gap-4 px-6">
                <span class="text-3xl">âš </span>
                <h2 class="text-lg font-semibold text-white">Backend Not Reachable</h2>
                <p class="text-sm text-gray-400 text-center">Could not connect to the backend server.</p>
                <button
                    id="btn-retry"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-6 py-2 rounded-lg flex items-center gap-2"
                >
                    Retry
                </button>
            </div>

            <!-- ============================================================ -->
            <!-- STATE PANEL: ReadyToHost â€” start session                     -->
            <!-- ============================================================ -->
            <div id="panel-ready" class="hidden flex-1 flex flex-col items-center justify-center gap-4 px-6">
                <h2 class="text-lg font-semibold text-white">Ready</h2>
                <p class="text-sm text-gray-400 text-center">Backend connected. Start a session or join an existing one.</p>
                <button
                    id="btn-start-session"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-6 py-2 rounded-lg flex items-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    Start Session
                </button>
                <div class="flex items-center gap-2 w-full max-w-xs">
                    <input
                        id="ready-invite-url-input"
                        type="text"
                        placeholder="Paste invite linkâ€¦"
                        class="flex-1 bg-gray-700 text-white text-xs px-3 py-1.5 rounded-lg border border-gray-600 focus:outline-none focus:border-blue-500"
                    />
                    <button
                        id="btn-ready-join"
                        class="bg-green-600 hover:bg-green-700 text-white text-xs font-medium px-3 py-1.5 rounded-lg flex items-center gap-1"
                    >
                        Join
                    </button>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- STATE PANEL: Joining â€” loading indicator                     -->
            <!-- ============================================================ -->
            <div id="panel-joining" class="hidden flex-1 flex flex-col items-center justify-center gap-3 px-6">
                <div class="h-8 w-8 border-4 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-sm text-gray-400">Joining sessionâ€¦</p>
            </div>

            <!-- ============================================================ -->
            <!-- STATE PANELS: Hosting / Joined â€” full chat UI                -->
            <!-- ============================================================ -->
            <div id="panel-chat" class="hidden flex flex-1">
            <!-- Chat content column (header + messages + input) -->
            <div class="flex flex-col flex-1">

            <!-- Header (only visible in Hosting / Joined) -->
            <header class="bg-gray-800 border-b border-gray-700 px-6 py-4 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-xl font-semibold text-white">AI Chat Assistant</h1>
                        <p class="text-sm text-gray-400 mt-1 flex items-center gap-1">
                            Room: <span id="room-id-display" class="font-mono text-xs text-gray-500">loading...</span>
                            <button id="btn-copy-room-id" class="text-gray-500 hover:text-gray-300 transition-colors p-0.5" title="Copy Room ID">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                                </svg>
                            </button>
                        </p>
                    </div>
                    <div class="flex items-center gap-3">
                        <!-- Auto Apply Toggle (Lead only) -->
                        <div id="auto-apply-toggle-container" class="hidden flex items-center gap-2">
                            <span class="text-xs text-gray-400">Auto</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="auto-apply-toggle" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-amber-600"></div>
                            </label>
                        </div>
                        <div id="role-badge" class="px-3 py-1 rounded-full text-xs font-medium bg-gray-700 text-gray-300">
                            <!-- Role badge will be updated by JavaScript -->
                        </div>
                    </div>
                </div>

            <!-- Hosting-only controls: invite + stop -->
            <div id="hosting-controls" class="hidden mt-4 flex items-center gap-2">
                <span class="text-xs text-green-400 flex items-center gap-1">
                    <span class="inline-block h-2 w-2 rounded-full bg-green-400"></span>
                    Hosting
                </span>
                <button
                    id="btn-copy-invite"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-medium px-3 py-1.5 rounded-lg flex items-center gap-1"
                >
                    Copy Invite Link
                </button>
                <button
                    id="btn-stop-session"
                    class="bg-gray-600 hover:bg-gray-500 text-white text-xs font-medium px-3 py-1.5 rounded-lg"
                >
                    Stop
                </button>
            </div>

            <!-- Joined-only controls: leave -->
            <div id="joined-controls" class="hidden mt-4 flex items-center gap-2">
                <span class="text-xs text-blue-400 flex items-center gap-1">
                    <span class="inline-block h-2 w-2 rounded-full bg-blue-400"></span>
                    Joined
                </span>
                <button
                    id="btn-leave-session"
                    class="bg-gray-600 hover:bg-gray-500 text-white text-xs font-medium px-3 py-1.5 rounded-lg"
                >
                    Leave
                </button>
            </div>

            <!-- Lead-only Action Buttons -->
            <div id="lead-actions" class="hidden mt-4 flex gap-2">
                <button
                    id="btn-create-summary"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    Create Summary
                </button>
                <button
                    id="btn-generate-changes"
                    class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Generate Changes
                </button>
                <button
                    id="btn-end-chat"
                    class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2"
                    title="End chat session for all participants"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                    End Chat
                </button>
            </div>

            <!-- Pending Changes Card (hidden by default) -->
            <div id="pending-changes-card" class="hidden mt-4 bg-gray-700/50 border border-gray-600 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-medium text-white flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                        </svg>
                        <span id="pending-changes-title">Pending Changes</span>
                        <span id="change-progress" class="text-purple-300 text-xs font-normal"></span>
                    </h3>
                    <button id="btn-discard-changes" class="text-gray-400 hover:text-gray-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <!-- Current File Info -->
                <div id="current-file-info" class="text-xs text-blue-300 mb-2 flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                    </svg>
                    <span id="current-file-name"></span>
                </div>

                <!-- Change Stats -->
                <div class="flex items-center gap-4 text-xs text-gray-300 mb-3">
                    <span id="pending-files-count" class="flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                        </svg>
                        <span>1 file</span>
                    </span>
                    <span id="pending-lines-count" class="flex items-center gap-1">
                        <span class="text-green-400">+5</span>
                        <span class="text-red-400">-3</span>
                        <span>lines</span>
                    </span>
                </div>

                <!-- Policy Status -->
                <div id="policy-status" class="flex items-center gap-2 text-xs mb-3">
                    <span id="policy-status-icon" class="text-green-400">âœ“</span>
                    <span id="policy-status-text" class="text-gray-300">Safe to apply</span>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2">
                    <button
                        id="btn-view-diff"
                        class="flex-1 bg-gray-600 hover:bg-gray-500 text-white text-xs font-medium px-3 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                        </svg>
                        View Diff
                    </button>
                    <button
                        id="btn-apply-changes"
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white text-xs font-medium px-3 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Apply
                    </button>
                </div>
            </div>
        </header>

        <!-- Messages Area -->
        <div id="messages-container" class="flex-1 overflow-y-auto px-6 py-4 space-y-4">
            <!-- Messages will be rendered here by JavaScript -->
            <div id="connection-status" class="flex justify-center">
                <div class="bg-gray-800/50 text-gray-400 text-xs px-3 py-1.5 rounded-full border border-gray-700">
                    <span>Connecting to chat...</span>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="flex-shrink-0 border-t border-gray-700 bg-gray-800 px-6 py-4">
            <div class="flex items-end gap-3">
                <!-- Text Input -->
                <div class="flex-1">
                    <textarea
                        id="chat-input"
                        rows="1"
                        placeholder="Type your message..."
                        class="w-full bg-gray-900 text-gray-100 border border-gray-700 rounded-lg px-4 py-3 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-500 text-sm"
                    ></textarea>
                </div>

                <!-- Send Button -->
                <button
                    id="btn-send"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-3 rounded-lg transition-colors duration-200 flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                    <span class="text-sm">Send</span>
                </button>
            </div>

            <!-- Helper Text -->
                <div class="mt-2 text-xs text-gray-500">
                    Press Enter to send, Shift+Enter for new line
                </div>
            </div>
        </div>

        <!-- Users Sidebar (inside panel-chat) -->
        <aside id="sidebar" class="w-56 bg-gray-800 border-l border-gray-700 flex-shrink-0 hidden md:flex flex-col">
            <div class="px-4 py-4 border-b border-gray-700">
                <h2 class="text-sm font-semibold text-gray-300">Participants</h2>
                <p id="user-count" class="text-xs text-gray-500 mt-1">0 online</p>
            </div>
            <div id="users-list" class="flex-1 overflow-y-auto p-3 space-y-2">
                <!-- Users will be rendered here -->
            </div>
        </aside>
        </div> <!-- close panel-chat -->
    </div> <!-- close main area flex-col -->
    </div> <!-- close outer flex h-full -->

    <script>
        // VS Code API for communication with the extension
        const vscode = acquireVsCodeApi();

        // Session state (injected by extension)
        let session = window.initialSession || { roomId: null, hostId: null, userId: null, createdAt: null, backendUrl: 'http://localhost:8000', displayName: 'Host' };
        console.log('[WebView] Session initialized:', session.roomId ? `roomId=${session.roomId}, userId=${session.userId}` : 'no session');

        // Conductor FSM state (injected by extension)
        let conductorState = window.initialConductorState || 'Idle';
        console.log('[WebView] Conductor state:', conductorState);

        // Users map: userId -> user info
        const usersMap = new Map();

        // Display roomId in the header (truncated for readability)
        const roomIdDisplay = document.getElementById('room-id-display');
        if (roomIdDisplay && session.roomId) {
            roomIdDisplay.textContent = session.roomId.substring(0, 8) + '...';
            roomIdDisplay.title = session.roomId; // Full ID on hover
        }

        // State
        let pendingChangeSet = null;
        let policyResult = null;
        let autoApplyEnabled = false;
        let currentChange = null;
        let currentChangeIndex = 0;
        let totalChanges = 0;

        // WebSocket state
        let ws = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const RECONNECT_DELAY_MS = 2000;

        // DOM elements
        const roleBadge = document.getElementById('role-badge');
        const leadActions = document.getElementById('lead-actions');
        const btnCreateSummary = document.getElementById('btn-create-summary');
        const btnGenerateChanges = document.getElementById('btn-generate-changes');
        const autoApplyToggleContainer = document.getElementById('auto-apply-toggle-container');
        const autoApplyToggle = document.getElementById('auto-apply-toggle');
        const pendingChangesCard = document.getElementById('pending-changes-card');
        const pendingFilesCount = document.getElementById('pending-files-count');
        const pendingLinesCount = document.getElementById('pending-lines-count');
        const policyStatus = document.getElementById('policy-status');
        const policyStatusIcon = document.getElementById('policy-status-icon');
        const policyStatusText = document.getElementById('policy-status-text');
        const btnViewDiff = document.getElementById('btn-view-diff');
        const btnApplyChanges = document.getElementById('btn-apply-changes');
        const btnDiscardChanges = document.getElementById('btn-discard-changes');
        const changeProgress = document.getElementById('change-progress');
        const currentFileInfo = document.getElementById('current-file-info');
        const currentFileName = document.getElementById('current-file-name');
        const messagesContainer = document.getElementById('messages-container');
        const connectionStatus = document.getElementById('connection-status');
        const chatInput = document.getElementById('chat-input');
        const btnSend = document.getElementById('btn-send');
        const btnCopyRoomId = document.getElementById('btn-copy-room-id');
        const btnEndChat = document.getElementById('btn-end-chat');
        const usersList = document.getElementById('users-list');
        const userCount = document.getElementById('user-count');

        // State panels (render() toggles these)
        const panelIdle = document.getElementById('panel-idle');
        const panelDisconnected = document.getElementById('panel-disconnected');
        const panelReady = document.getElementById('panel-ready');
        const panelJoining = document.getElementById('panel-joining');
        const panelChat = document.getElementById('panel-chat');
        const hostingControls = document.getElementById('hosting-controls');
        const joinedControls = document.getElementById('joined-controls');

        // Buttons inside state panels
        const btnIdleStart = document.getElementById('btn-idle-start');
        const btnIdleJoin = document.getElementById('btn-idle-join');
        const btnRetry = document.getElementById('btn-retry');
        const btnStartSession = document.getElementById('btn-start-session');
        const btnReadyJoin = document.getElementById('btn-ready-join');
        const readyInviteUrlInput = document.getElementById('ready-invite-url-input');
        const btnStopSession = document.getElementById('btn-stop-session');
        const btnCopyInvite = document.getElementById('btn-copy-invite');
        const inviteUrlInput = document.getElementById('invite-url-input');
        const btnLeaveSession = document.getElementById('btn-leave-session');

        // Track session state
        let sessionEnded = false;

        // Avatar color mapping
        const avatarColors = {
            purple: 'bg-purple-600',
            blue: 'bg-blue-600',
            green: 'bg-green-600',
            orange: 'bg-orange-600',
            pink: 'bg-pink-600',
            cyan: 'bg-cyan-600',
            yellow: 'bg-yellow-600',
            red: 'bg-red-600',
            amber: 'bg-amber-500'
        };

        /**
         * Update the UI based on permissions.
         */
        function updateUIForPermissions(permissions) {
            // Update role badge
            if (permissions.role === 'lead') {
                roleBadge.textContent = 'ðŸ‘‘ Lead';
                roleBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-amber-600 text-white';
            } else {
                roleBadge.textContent = 'ðŸ‘¤ Member';
                roleBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-gray-700 text-gray-300';
            }

            // Show/hide lead-only actions (show if any lead action is available OR if lead role)
            // End Chat button is always available for leads
            if (permissions.role === 'lead' || permissions.canCreateSummary || permissions.canGenerateChanges) {
                leadActions.classList.remove('hidden');
                leadActions.classList.add('flex');
            } else {
                leadActions.classList.add('hidden');
                leadActions.classList.remove('flex');
            }

            // Individual button visibility
            btnCreateSummary.style.display = permissions.canCreateSummary ? 'flex' : 'none';
            btnGenerateChanges.style.display = permissions.canGenerateChanges ? 'flex' : 'none';
            // End Chat button is always visible for leads
            btnEndChat.style.display = permissions.role === 'lead' ? 'flex' : 'none';

            // Show auto-apply toggle for leads
            if (permissions.canAutoApply) {
                autoApplyToggleContainer.classList.remove('hidden');
                autoApplyToggleContainer.classList.add('flex');
            } else {
                autoApplyToggleContainer.classList.add('hidden');
                autoApplyToggleContainer.classList.remove('flex');
            }
        }

        /**
         * Single render function â€” deterministically updates the entire UI
         * based on the ConductorState. No conditional UI logic exists
         * outside this function.
         */
        function render(state, newSession) {
            const prevState = conductorState;
            conductorState = state;

            // Track if roomId changed (need to reconnect WebSocket)
            const prevRoomId = session.roomId;

            // Update session data if provided (e.g. after startHosting or joinSucceeded)
            if (newSession) {
                session = { ...session, ...newSession };
                if (roomIdDisplay && session.roomId) {
                    roomIdDisplay.textContent = session.roomId.substring(0, 8) + '...';
                    roomIdDisplay.title = session.roomId;
                }
            }

            const roomIdChanged = newSession && newSession.roomId && newSession.roomId !== prevRoomId;

            // --- 1. Hide every panel ----------------------------------------
            panelIdle.classList.add('hidden');
            panelIdle.classList.remove('flex');
            panelDisconnected.classList.add('hidden');
            panelDisconnected.classList.remove('flex');
            panelReady.classList.add('hidden');
            panelReady.classList.remove('flex');
            panelJoining.classList.add('hidden');
            panelJoining.classList.remove('flex');
            panelChat.classList.add('hidden');
            panelChat.classList.remove('flex');
            hostingControls.classList.add('hidden');
            hostingControls.classList.remove('flex');
            joinedControls.classList.add('hidden');
            joinedControls.classList.remove('flex');

            // --- 2. Show the panel for the current state --------------------
            if (state === 'Idle') {
                panelIdle.classList.remove('hidden');
                panelIdle.classList.add('flex');
            } else if (state === 'BackendDisconnected') {
                panelDisconnected.classList.remove('hidden');
                panelDisconnected.classList.add('flex');
            } else if (state === 'ReadyToHost') {
                panelReady.classList.remove('hidden');
                panelReady.classList.add('flex');
            } else if (state === 'Joining') {
                panelJoining.classList.remove('hidden');
                panelJoining.classList.add('flex');
            } else if (state === 'Hosting') {
                panelChat.classList.remove('hidden');
                panelChat.classList.add('flex');
                hostingControls.classList.remove('hidden');
                hostingControls.classList.add('flex');
            } else if (state === 'Joined') {
                panelChat.classList.remove('hidden');
                panelChat.classList.add('flex');
                joinedControls.classList.remove('hidden');
                joinedControls.classList.add('flex');
            }

            // --- 3. WebSocket lifecycle -------------------------------------
            const chatStates = ['Hosting', 'Joined'];
            const wasInChat = chatStates.includes(prevState);
            const nowInChat = chatStates.includes(state);

            if (nowInChat && !wasInChat) {
                // Entering chat state â€” connect
                connectWebSocket();
            } else if (!nowInChat && wasInChat) {
                // Leaving chat state â€” disconnect
                disconnectWebSocket();
            } else if (nowInChat && wasInChat && roomIdChanged) {
                // Staying in chat but roomId changed â€” reconnect to new room
                console.log('[WebView] roomId changed, reconnecting WebSocket');
                disconnectWebSocket();
                connectWebSocket();
            }

            console.log('[WebView] render:', prevState, 'â†’', state, roomIdChanged ? '(roomId changed)' : '');
        }

        /**
         * Disconnect the WebSocket if open.
         */
        function disconnectWebSocket() {
            if (ws) {
                console.log('[WebView] Disconnecting WebSocket');
                ws.close();
                ws = null;
            }
        }

        /**
         * Update the pending changes card UI.
         */
        function updatePendingChangesCard(changeSet, policy) {
            if (!changeSet) {
                pendingChangesCard.classList.add('hidden');
                return;
            }

            pendingChangesCard.classList.remove('hidden');

            // Update file count
            const filesCount = changeSet.changes ? changeSet.changes.length : 0;
            pendingFilesCount.querySelector('span').textContent = `${filesCount} file${filesCount !== 1 ? 's' : ''}`;

            // Update lines count
            let linesAdded = 0;
            let linesRemoved = 0;
            if (changeSet.changes) {
                for (const change of changeSet.changes) {
                    if (change.type === 'replace_range' && change.range) {
                        linesRemoved += change.range.end - change.range.start + 1;
                        linesAdded += (change.content || '').split('\n').length;
                    } else if (change.type === 'create_file') {
                        linesAdded += (change.content || '').split('\n').length;
                    }
                }
            }
            pendingLinesCount.innerHTML = `
                <span class="text-green-400">+${linesAdded}</span>
                <span class="text-red-400">-${linesRemoved}</span>
                <span>lines</span>
            `;

            // Update policy status
            if (policy) {
                if (policy.allowed) {
                    policyStatusIcon.textContent = 'âœ“';
                    policyStatusIcon.className = 'text-green-400';
                    policyStatusText.textContent = 'Safe to apply';
                    policyStatusText.className = 'text-gray-300';
                    btnApplyChanges.disabled = false;
                    btnApplyChanges.className = 'flex-1 bg-green-600 hover:bg-green-700 text-white text-xs font-medium px-3 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1';
                } else {
                    policyStatusIcon.textContent = 'âš ';
                    policyStatusIcon.className = 'text-amber-400';
                    policyStatusText.textContent = policy.reasons ? policy.reasons.join('; ') : 'Manual review required';
                    policyStatusText.className = 'text-amber-300';
                    // Still allow manual apply, but show warning
                    btnApplyChanges.disabled = false;
                    btnApplyChanges.className = 'flex-1 bg-amber-600 hover:bg-amber-700 text-white text-xs font-medium px-3 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1';
                }
            }
        }

        /**
         * Clear pending changes.
         */
        function clearPendingChanges() {
            pendingChangeSet = null;
            policyResult = null;
            currentChange = null;
            currentChangeIndex = 0;
            totalChanges = 0;
            pendingChangesCard.classList.add('hidden');
        }

        /**
         * Update UI for the current change being reviewed.
         */
        function updateCurrentChangeUI(change, index, total, policy) {
            if (!change) {
                pendingChangesCard.classList.add('hidden');
                return;
            }

            pendingChangesCard.classList.remove('hidden');
            currentChange = change;
            currentChangeIndex = index;
            totalChanges = total;
            policyResult = policy;

            // Update progress indicator (e.g., "1/3")
            changeProgress.textContent = `(${index + 1}/${total})`;

            // Update current file name
            currentFileName.textContent = change.file;
            currentFileInfo.classList.remove('hidden');

            // Update file count to show current/total
            pendingFilesCount.querySelector('span').textContent = `Change ${index + 1} of ${total}`;

            // Calculate lines for this single change
            let linesAdded = 0;
            let linesRemoved = 0;
            if (change.type === 'replace_range' && change.range) {
                linesRemoved = change.range.end - change.range.start + 1;
                linesAdded = (change.content || '').split('\n').length;
            } else if (change.type === 'create_file') {
                linesAdded = (change.content || '').split('\n').length;
            }
            pendingLinesCount.innerHTML = `
                <span class="text-green-400">+${linesAdded}</span>
                <span class="text-red-400">-${linesRemoved}</span>
                <span>lines</span>
            `;

            // Update policy status
            if (policy) {
                if (policy.allowed) {
                    policyStatusIcon.textContent = 'âœ“';
                    policyStatusIcon.className = 'text-green-400';
                    policyStatusText.textContent = 'Safe to apply';
                    policyStatusText.className = 'text-gray-300';
                    btnApplyChanges.className = 'flex-1 bg-green-600 hover:bg-green-700 text-white text-xs font-medium px-3 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1';
                } else {
                    policyStatusIcon.textContent = 'âš ';
                    policyStatusIcon.className = 'text-amber-400';
                    policyStatusText.textContent = policy.reasons ? policy.reasons.join('; ') : 'Manual review required';
                    policyStatusText.className = 'text-amber-300';
                    btnApplyChanges.className = 'flex-1 bg-amber-600 hover:bg-amber-700 text-white text-xs font-medium px-3 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1';
                }
            }

            btnApplyChanges.disabled = false;
        }

        // Handle messages from the extension
        window.addEventListener('message', event => {
            const message = event.data;
            console.log('Received message from extension:', message);
            switch (message.command) {
                case 'updatePermissions':
                    console.log('Updating permissions:', message.permissions);
                    updateUIForPermissions(message.permissions);
                    break;
                case 'showCurrentChange':
                    // Sequential review mode: show one change at a time
                    updateCurrentChangeUI(
                        message.currentChange,
                        message.currentIndex,
                        message.totalChanges,
                        message.policyResult
                    );

                    // If auto-apply is enabled and policy allows, apply automatically
                    if (autoApplyEnabled && message.policyResult && message.policyResult.allowed) {
                        vscode.postMessage({ command: 'applyChanges', changeSet: { changes: [message.currentChange] } });
                    }
                    break;
                case 'allChangesComplete':
                    // All changes have been reviewed
                    clearPendingChanges();
                    break;
                case 'changesGenerated':
                    // Legacy: Store the pending change set (kept for backwards compatibility)
                    pendingChangeSet = message.changeSet;
                    policyResult = message.policyResult;
                    // Don't call updatePendingChangesCard here anymore
                    // The showCurrentChange message will handle the UI update
                    break;
                case 'changesApplied':
                    // Single change applied, waiting for next showCurrentChange or allChangesComplete
                    break;
                case 'autoApplyState':
                    autoApplyEnabled = message.enabled;
                    autoApplyToggle.checked = autoApplyEnabled;
                    break;
                case 'endChatConfirmed':
                    handleEndChatConfirmed();
                    break;
                case 'conductorStateChanged':
                    render(message.state, message.session);
                    break;
            }
        });

        // ----- Conductor session button handlers -----

        // Idle panel: Start (triggers health check â†’ ReadyToHost â†’ startSession)
        btnIdleStart.addEventListener('click', () => {
            vscode.postMessage({ command: 'startSession' });
        });

        // Idle panel: Join (paste invite URL)
        btnIdleJoin.addEventListener('click', () => {
            const url = inviteUrlInput.value.trim();
            if (!url) { return; }
            vscode.postMessage({ command: 'joinSession', inviteUrl: url });
            inviteUrlInput.value = '';
        });

        // BackendDisconnected panel: Retry
        btnRetry.addEventListener('click', () => {
            vscode.postMessage({ command: 'retryConnection' });
        });

        // ReadyToHost panel: Start Session
        btnStartSession.addEventListener('click', () => {
            vscode.postMessage({ command: 'startSession' });
        });

        // ReadyToHost panel: Join (paste invite URL)
        btnReadyJoin.addEventListener('click', () => {
            const url = readyInviteUrlInput.value.trim();
            if (!url) { return; }
            vscode.postMessage({ command: 'joinSession', inviteUrl: url });
            readyInviteUrlInput.value = '';
        });

        // Hosting: Stop + Copy Invite
        btnStopSession.addEventListener('click', () => {
            vscode.postMessage({ command: 'stopSession' });
        });

        btnCopyInvite.addEventListener('click', () => {
            vscode.postMessage({ command: 'copyInviteLink' });
        });

        // Joined: Leave
        btnLeaveSession.addEventListener('click', () => {
            vscode.postMessage({ command: 'leaveSession' });
        });

        // Button click handlers
        btnCreateSummary.addEventListener('click', () => {
            vscode.postMessage({ command: 'alert', text: 'Create Summary clicked (Lead feature)' });
        });

        btnGenerateChanges.addEventListener('click', () => {
            // Trigger generate changes - will use the active editor's file
            vscode.postMessage({ command: 'generateChanges' });
        });

        // Auto-apply toggle handler
        autoApplyToggle.addEventListener('change', (e) => {
            autoApplyEnabled = e.target.checked;
            vscode.postMessage({ command: 'setAutoApply', enabled: autoApplyEnabled });
        });

        // Pending changes card button handlers
        btnViewDiff.addEventListener('click', () => {
            // View diff for current change only
            if (currentChange) {
                vscode.postMessage({ command: 'viewDiff', changeSet: { changes: [currentChange], summary: '' } });
            } else if (pendingChangeSet) {
                vscode.postMessage({ command: 'viewDiff', changeSet: pendingChangeSet });
            }
        });

        btnApplyChanges.addEventListener('click', () => {
            // Apply current change only (the extension handles the queue)
            if (currentChange) {
                vscode.postMessage({ command: 'applyChanges', changeSet: { changes: [currentChange], summary: '' } });
            } else if (pendingChangeSet) {
                vscode.postMessage({ command: 'applyChanges', changeSet: pendingChangeSet });
            }
        });

        btnDiscardChanges.addEventListener('click', () => {
            clearPendingChanges();
            vscode.postMessage({ command: 'discardChanges' });
        });

        // Initialize with permissions from the extension
        if (window.initialPermissions) {
            updateUIForPermissions(window.initialPermissions);
        } else {
            // Request permissions if not injected
            vscode.postMessage({ command: 'getPermissions' });
        }

        // Request auto-apply state
        vscode.postMessage({ command: 'getAutoApplyState' });

        // =====================================================
        // WebSocket Chat Implementation
        // =====================================================

        /**
         * Format timestamp for display
         */
        function formatTime(ts) {
            const date = new Date(ts * 1000);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Get initials from a display name
         */
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        /**
         * Render the users list in the sidebar
         */
        function renderUsersList(users) {
            usersMap.clear();
            users.forEach(u => usersMap.set(u.userId, u));

            userCount.textContent = `${users.length} online`;
            usersList.innerHTML = users.map(user => {
                const colorClass = avatarColors[user.avatarColor] || 'bg-purple-600';
                const isHost = user.role === 'host';
                const isMe = user.userId === session.userId;
                return `
                    <div class="flex items-center gap-2 p-2 rounded-lg ${isMe ? 'bg-gray-700/50' : 'hover:bg-gray-700/30'}">
                        <div class="w-7 h-7 ${colorClass} rounded-full flex items-center justify-center text-white text-xs font-medium">
                            ${getInitials(user.displayName)}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-1">
                                <span class="text-xs text-gray-200 truncate">${escapeHtml(user.displayName)}</span>
                                ${isHost ? '<span class="text-xs">ðŸ‘‘</span>' : ''}
                                ${isMe ? '<span class="text-xs text-gray-500">(you)</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Render a chat message in the UI
         */
        function renderMessage(msg) {
            const isOwnMessage = msg.userId === session.userId;
            const div = document.createElement('div');
            div.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} gap-2`;

            const bubbleColor = isOwnMessage
                ? 'bg-blue-600 text-white rounded-2xl rounded-tr-sm'
                : 'bg-gray-800 text-gray-100 rounded-2xl rounded-tl-sm border border-gray-700';

            const timeAlign = isOwnMessage ? 'text-right' : '';
            const roleLabel = msg.role === 'host' ? 'ðŸ‘‘ ' : '';
            const displayName = msg.displayName || usersMap.get(msg.userId)?.displayName || 'Unknown';

            // Get avatar color from users map or default
            const userInfo = usersMap.get(msg.userId);
            const colorClass = userInfo ? (avatarColors[userInfo.avatarColor] || 'bg-purple-600') : 'bg-gray-600';

            const avatarHtml = !isOwnMessage ? `
                <div class="w-7 h-7 ${colorClass} rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 mt-1">
                    ${getInitials(displayName)}
                </div>
            ` : '';

            div.innerHTML = `
                ${avatarHtml}
                <div class="max-w-[75%] min-w-0">
                    ${!isOwnMessage ? `<div class="text-xs text-gray-400 mb-1 ml-1">${roleLabel}${escapeHtml(displayName)}</div>` : ''}
                    <div class="${bubbleColor} px-4 py-3 shadow-lg overflow-hidden">
                        <p class="text-sm leading-relaxed break-words whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                    </div>
                    <div class="text-xs text-gray-500 mt-1 ${timeAlign} ${isOwnMessage ? 'mr-1' : 'ml-1'}">${formatTime(msg.ts)}</div>
                </div>
            `;

            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * Render a system message (user joined/left)
         */
        function renderSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'flex justify-center';
            div.innerHTML = `
                <div class="bg-gray-800/50 text-gray-400 text-xs px-3 py-1.5 rounded-full border border-gray-700">
                    ${escapeHtml(text)}
                </div>
            `;
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * Update connection status display
         */
        function updateConnectionStatus(status, isError = false) {
            if (connectionStatus) {
                const colorClass = isError ? 'text-red-400 border-red-700' : 'text-gray-400 border-gray-700';
                connectionStatus.innerHTML = `
                    <div class="bg-gray-800/50 ${colorClass} text-xs px-3 py-1.5 rounded-full border">
                        <span>${status}</span>
                    </div>
                `;
            }
        }

        /**
         * Connect to WebSocket chat server
         */
        function connectWebSocket() {
            if (!session.roomId || !session.userId) {
                console.error('[WebView] Cannot connect: missing roomId or userId');
                updateConnectionStatus('âŒ Missing session info', true);
                return;
            }

            const wsUrl = session.backendUrl.replace('http', 'ws') + '/ws/chat/' + session.roomId;
            console.log('[WebView] Connecting to:', wsUrl);
            updateConnectionStatus('Connecting...');

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('[WebView] WebSocket connected');
                reconnectAttempts = 0;
                updateConnectionStatus('âœ… Connected');
                // Hide status after a moment
                setTimeout(() => {
                    if (connectionStatus) connectionStatus.style.display = 'none';
                }, 2000);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('[WebView] Received:', data);

                    if (data.type === 'history') {
                        // Clear status and render history
                        if (connectionStatus) connectionStatus.remove();
                        // Render existing users
                        if (data.users) {
                            renderUsersList(data.users);
                        }
                        // Render message history
                        data.messages.forEach(msg => renderMessage(msg));

                        // Send join message to register ourselves
                        ws.send(JSON.stringify({
                            type: 'join',
                            userId: session.userId,
                            displayName: session.displayName || 'Host',
                            role: 'host'
                        }));
                    } else if (data.type === 'message') {
                        renderMessage(data);
                    } else if (data.type === 'user_joined') {
                        renderUsersList(data.users);
                        renderSystemMessage(`${data.user.displayName} joined the chat`);
                    } else if (data.type === 'user_left') {
                        renderUsersList(data.users);
                        renderSystemMessage(`${data.user.displayName} left the chat`);
                    } else if (data.type === 'session_ended') {
                        sessionEnded = true;
                        renderSystemMessage('ðŸ”´ ' + data.message);
                        // Disable input
                        chatInput.disabled = true;
                        chatInput.placeholder = 'Chat session has ended';
                        btnSend.disabled = true;
                        btnSend.classList.add('opacity-50', 'cursor-not-allowed');
                        // Hide end chat button
                        btnEndChat.classList.add('hidden');
                        // Clear users list
                        usersList.innerHTML = '';
                        userCount.textContent = '0 online';
                        // TODO: Notify extension to reset session state and generate new roomId
                        vscode.postMessage({ command: 'sessionEnded' });
                    }
                } catch (err) {
                    console.error('[WebView] Failed to parse message:', err);
                }
            };

            ws.onclose = (event) => {
                console.log('[WebView] WebSocket closed:', event.code, event.reason);
                // Don't reconnect if session was ended by host
                if (sessionEnded) {
                    updateConnectionStatus('Session ended', false);
                    return;
                }
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    updateConnectionStatus(`Reconnecting (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`);
                    setTimeout(connectWebSocket, RECONNECT_DELAY_MS);
                } else {
                    updateConnectionStatus('âŒ Connection lost', true);
                }
            };

            ws.onerror = (error) => {
                console.error('[WebView] WebSocket error:', error);
                updateConnectionStatus('âŒ Connection error', true);
            };
        }

        /**
         * Send a chat message
         */
        function sendMessage() {
            const content = chatInput.value.trim();
            if (!content || !ws || ws.readyState !== WebSocket.OPEN) {
                return;
            }

            const message = {
                userId: session.userId,
                displayName: session.displayName || 'Host',
                role: 'host',
                content: content
            };

            console.log('[WebView] Sending:', message);
            ws.send(JSON.stringify(message));
            chatInput.value = '';
        }

        // Send button click handler
        btnSend.addEventListener('click', sendMessage);

        // Enter key handler (Shift+Enter for new line)
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Copy room ID button handler
        btnCopyRoomId.addEventListener('click', async () => {
            if (session.roomId) {
                try {
                    await navigator.clipboard.writeText(session.roomId);
                    // Visual feedback - show checkmark
                    btnCopyRoomId.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    `;
                    // Revert to clipboard icon after 2 seconds
                    setTimeout(() => {
                        btnCopyRoomId.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                            </svg>
                        `;
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy room ID:', err);
                }
            }
        });

        // End chat button handler (Lead/Host only)
        btnEndChat.addEventListener('click', () => {
            console.log('[WebView] End Chat button clicked');
            // Use VS Code API for confirmation since confirm() doesn't work in WebView
            vscode.postMessage({
                command: 'confirmEndChat'
            });
        });

        // Handle confirmation response from extension
        function handleEndChatConfirmed() {
            console.log('[WebView] End chat confirmed, ws state:', ws ? ws.readyState : 'null');
            if (ws && ws.readyState === WebSocket.OPEN) {
                const msg = {
                    type: 'end_session',
                    userId: session.userId
                };
                console.log('[WebView] Sending end_session:', msg);
                ws.send(JSON.stringify(msg));
            } else {
                console.error('[WebView] WebSocket not open');
            }
        }

        // Initialize UI from the current FSM state
        render(conductorState, null);

        // Request latest conductor state from extension (in case it changed since HTML was built)
        vscode.postMessage({ command: 'getConductorState' });
    </script>
</body>
</html>

