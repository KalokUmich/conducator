<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link rel="stylesheet" href="tailwind.css">
    <style>
        /* Custom scrollbar for WebKit browsers (Chrome, Safari, VS Code) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Ensure proper flex layout for chat */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* WhatsApp-style message bubbles */
        .message-bubble {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Scroll to bottom button */
        #scroll-to-bottom {
            transition: opacity 0.2s, transform 0.2s;
        }
        #scroll-to-bottom:hover {
            transform: scale(1.1);
        }

        /* Unread badge animation */
        .unread-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Disable syntax highlighting in code snippets */
        .code-snippet-plain,
        .code-snippet-plain code,
        .code-snippet-plain * {
            color: #d1d5db !important; /* text-gray-300 */
            background: transparent !important;
        }

        /* Role-based accent colors */
        .bubble-host { border-left: 3px solid #f59e0b; }
        .bubble-guest { border-left: 3px solid #3b82f6; }
        .name-host { color: #fbbf24; }
        .name-guest { color: #60a5fa; }
        .role-pill {
            font-size: 0.625rem;
            line-height: 1rem;
            padding: 0 0.375rem;
            border-radius: 9999px;
            font-weight: 500;
            letter-spacing: 0.025em;
            text-transform: uppercase;
        }
        .role-pill-host { background: rgba(245,158,11,0.15); color: #fbbf24; }
        .role-pill-guest { background: rgba(59,130,246,0.15); color: #60a5fa; }
        .role-pill-sso { background: rgba(34,197,94,0.15); color: #4ade80; }
        .role-pill-aws { background: rgba(251,191,36,0.15); color: #fbbf24; }
        .role-pill-google { background: rgba(96,165,250,0.15); color: #60a5fa; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen overflow-hidden">
    <div class="flex h-full">
        <!-- Main Chat Area -->
        <div class="flex flex-col flex-1">

            <!-- ============================================================ -->
            <!-- STATE PANEL: Idle ‚Äî Start / Join buttons                     -->
            <!-- ============================================================ -->
            <div id="panel-idle" class="hidden flex-1 flex flex-col items-center justify-center gap-4 px-6">
                <h2 class="text-lg font-semibold text-white">Conductor</h2>
                <p class="text-sm text-gray-400 text-center">Start a new session or join an existing one.</p>
                <button
                    id="btn-idle-start"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-6 py-2 rounded-lg flex items-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    Start
                </button>
                <div class="flex items-center gap-2 w-full max-w-xs">
                    <input
                        id="invite-url-input"
                        type="text"
                        placeholder="Paste invite link‚Ä¶"
                        class="flex-1 bg-gray-700 text-white text-xs px-3 py-1.5 rounded-lg border border-gray-600 focus:outline-none focus:border-blue-500"
                    />
                    <button
                        id="btn-idle-join"
                        class="bg-green-600 hover:bg-green-700 text-white text-xs font-medium px-3 py-1.5 rounded-lg flex items-center gap-1"
                    >
                        Join
                    </button>
                </div>
                <!-- SSO Identity Section -->
                <div id="sso-idle" class="w-full max-w-xs mt-2">
                    <div id="sso-idle-signin" class="sso-signin flex gap-2">
                        <button class="sso-login-btn sso-login-aws flex-1 text-gray-400 hover:text-gray-200 text-xs py-1.5 px-3 border border-gray-700 rounded-lg hover:border-gray-500 transition-colors" data-provider="aws">
                            &#9729; AWS SSO
                        </button>
                        <button class="sso-login-btn sso-login-google flex-1 text-gray-400 hover:text-gray-200 text-xs py-1.5 px-3 border border-gray-700 rounded-lg hover:border-gray-500 transition-colors" data-provider="google">
                            G Google
                        </button>
                    </div>
                    <div id="sso-idle-pending" class="sso-pending hidden">
                        <div class="flex items-center justify-center gap-2 py-1.5 px-3 border border-gray-700 rounded-lg">
                            <div class="h-3 w-3 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-xs text-gray-400">Waiting for SSO...</span>
                            <code class="sso-user-code text-xs text-blue-400 font-mono"></code>
                            <button class="sso-cancel-btn text-gray-500 hover:text-gray-300 text-xs ml-1">Cancel</button>
                        </div>
                    </div>
                    <div id="sso-idle-done" class="sso-done hidden">
                        <div class="flex items-center gap-2 py-1.5 px-3 bg-gray-800 border border-gray-700 rounded-lg">
                            <span class="sso-provider-badge text-xs"></span>
                            <span class="sso-email text-xs text-gray-300 truncate"></span>
                            <button class="sso-clear-btn ml-auto text-gray-500 hover:text-gray-300 text-xs flex-shrink-0" title="Clear identity">&#10005;</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- STATE PANEL: BackendDisconnected ‚Äî join only mode            -->
            <!-- ============================================================ -->
            <div id="panel-disconnected" class="hidden flex-1 flex flex-col items-center justify-center gap-4 px-6">
                <!-- Backend status warning -->
                <div class="flex items-center gap-2 text-amber-400 mb-2">
                    <span class="text-xl">‚ö†</span>
                    <span class="text-sm font-medium">Local backend not running</span>
                </div>

                <h2 class="text-lg font-semibold text-white">Join Only Mode</h2>
                <p class="text-sm text-gray-400 text-center max-w-xs">
                    You can join other people's sessions. To start your own session, please start the backend first.
                </p>

                <!-- Start Session button (disabled) -->
                <div class="relative group w-full max-w-xs">
                    <button
                        id="btn-start-session-disabled"
                        disabled
                        class="w-full bg-gray-600 text-gray-400 text-sm font-medium px-6 py-2 rounded-lg flex items-center justify-center gap-2 cursor-not-allowed opacity-60"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        Start Session
                    </button>
                    <!-- Tooltip -->
                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-1.5 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
                        Backend required to host a session
                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                    </div>
                </div>

                <!-- Join Session input + button -->
                <div class="flex items-center gap-2 w-full max-w-xs">
                    <input
                        id="disconnected-invite-url-input"
                        type="text"
                        placeholder="Paste invite link‚Ä¶"
                        class="flex-1 bg-gray-700 text-white text-xs px-3 py-1.5 rounded-lg border border-gray-600 focus:outline-none focus:border-green-500"
                    />
                    <button
                        id="btn-disconnected-join"
                        class="bg-green-600 hover:bg-green-700 text-white text-xs font-medium px-3 py-1.5 rounded-lg flex items-center gap-1"
                    >
                        Join
                    </button>
                </div>

                <!-- Retry connection link -->
                <button
                    id="btn-retry"
                    class="text-blue-400 hover:text-blue-300 text-xs underline mt-2"
                >
                    Retry backend connection
                </button>
                <!-- SSO Identity Section -->
                <div id="sso-disconnected" class="w-full max-w-xs mt-2">
                    <div id="sso-disconnected-signin" class="sso-signin flex gap-2">
                        <button class="sso-login-btn sso-login-aws flex-1 text-gray-400 hover:text-gray-200 text-xs py-1.5 px-3 border border-gray-700 rounded-lg hover:border-gray-500 transition-colors" data-provider="aws">
                            &#9729; AWS SSO
                        </button>
                        <button class="sso-login-btn sso-login-google flex-1 text-gray-400 hover:text-gray-200 text-xs py-1.5 px-3 border border-gray-700 rounded-lg hover:border-gray-500 transition-colors" data-provider="google">
                            G Google
                        </button>
                    </div>
                    <div id="sso-disconnected-pending" class="sso-pending hidden">
                        <div class="flex items-center justify-center gap-2 py-1.5 px-3 border border-gray-700 rounded-lg">
                            <div class="h-3 w-3 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-xs text-gray-400">Waiting for SSO...</span>
                            <code class="sso-user-code text-xs text-blue-400 font-mono"></code>
                            <button class="sso-cancel-btn text-gray-500 hover:text-gray-300 text-xs ml-1">Cancel</button>
                        </div>
                    </div>
                    <div id="sso-disconnected-done" class="sso-done hidden">
                        <div class="flex items-center gap-2 py-1.5 px-3 bg-gray-800 border border-gray-700 rounded-lg">
                            <span class="sso-provider-badge text-xs"></span>
                            <span class="sso-email text-xs text-gray-300 truncate"></span>
                            <button class="sso-clear-btn ml-auto text-gray-500 hover:text-gray-300 text-xs flex-shrink-0" title="Clear identity">&#10005;</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- STATE PANEL: ReadyToHost ‚Äî start session                     -->
            <!-- ============================================================ -->
            <div id="panel-ready" class="hidden flex-1 flex flex-col items-center justify-center gap-4 px-6">
                <h2 class="text-lg font-semibold text-white">Ready</h2>
                <p class="text-sm text-gray-400 text-center">Backend connected. Start a session or join an existing one.</p>
                <button
                    id="btn-start-session"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-6 py-2 rounded-lg flex items-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    Start Session
                </button>
                <div class="flex items-center gap-2 w-full max-w-xs">
                    <input
                        id="ready-invite-url-input"
                        type="text"
                        placeholder="Paste invite link‚Ä¶"
                        class="flex-1 bg-gray-700 text-white text-xs px-3 py-1.5 rounded-lg border border-gray-600 focus:outline-none focus:border-blue-500"
                    />
                    <button
                        id="btn-ready-join"
                        class="bg-green-600 hover:bg-green-700 text-white text-xs font-medium px-3 py-1.5 rounded-lg flex items-center gap-1"
                    >
                        Join
                    </button>
                </div>
                <!-- SSO Identity Section -->
                <div id="sso-ready" class="w-full max-w-xs mt-2">
                    <div id="sso-ready-signin" class="sso-signin flex gap-2">
                        <button class="sso-login-btn sso-login-aws flex-1 text-gray-400 hover:text-gray-200 text-xs py-1.5 px-3 border border-gray-700 rounded-lg hover:border-gray-500 transition-colors" data-provider="aws">
                            &#9729; AWS SSO
                        </button>
                        <button class="sso-login-btn sso-login-google flex-1 text-gray-400 hover:text-gray-200 text-xs py-1.5 px-3 border border-gray-700 rounded-lg hover:border-gray-500 transition-colors" data-provider="google">
                            G Google
                        </button>
                    </div>
                    <div id="sso-ready-pending" class="sso-pending hidden">
                        <div class="flex items-center justify-center gap-2 py-1.5 px-3 border border-gray-700 rounded-lg">
                            <div class="h-3 w-3 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-xs text-gray-400">Waiting for SSO...</span>
                            <code class="sso-user-code text-xs text-blue-400 font-mono"></code>
                            <button class="sso-cancel-btn text-gray-500 hover:text-gray-300 text-xs ml-1">Cancel</button>
                        </div>
                    </div>
                    <div id="sso-ready-done" class="sso-done hidden">
                        <div class="flex items-center gap-2 py-1.5 px-3 bg-gray-800 border border-gray-700 rounded-lg">
                            <span class="sso-provider-badge text-xs"></span>
                            <span class="sso-email text-xs text-gray-300 truncate"></span>
                            <button class="sso-clear-btn ml-auto text-gray-500 hover:text-gray-300 text-xs flex-shrink-0" title="Clear identity">&#10005;</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- STATE PANEL: Joining ‚Äî loading indicator                     -->
            <!-- ============================================================ -->
            <div id="panel-joining" class="hidden flex-1 flex flex-col items-center justify-center gap-3 px-6">
                <div class="h-8 w-8 border-4 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-sm text-gray-400">Joining session‚Ä¶</p>
            </div>

            <!-- ============================================================ -->
            <!-- STATE PANELS: Hosting / Joined ‚Äî full chat UI                -->
            <!-- ============================================================ -->
            <div id="panel-chat" class="hidden flex flex-1 min-h-0">
            <!-- Chat content column (header + messages + input) -->
            <div class="flex flex-col flex-1 min-h-0 overflow-hidden">

            <!-- Header (only visible in Hosting / Joined) -->
            <header class="bg-gray-800 border-b border-gray-700 px-6 py-4 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-xl font-semibold text-white">AI Chat Assistant</h1>
                        <p class="text-sm text-gray-400 mt-1 flex items-center gap-1">
                            Room: <span id="room-id-display" class="font-mono text-xs text-gray-500">loading...</span>
                            <button id="btn-copy-room-id" class="text-gray-500 hover:text-gray-300 transition-colors p-0.5" title="Copy Room ID">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                                </svg>
                            </button>
                        </p>
                    </div>
                    <div class="flex items-center gap-3">
                        <!-- AI Config Button -->
                        <button
                            id="btn-ai-config"
                            class="text-gray-400 hover:text-purple-400 p-1.5 rounded transition-colors"
                            title="AI Configuration"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <!-- Room Settings Button (Lead only) -->
                        <button
                            id="btn-room-settings"
                            class="hidden text-gray-400 hover:text-blue-400 p-1.5 rounded transition-colors"
                            title="Room Settings"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <!-- Auto Apply Toggle (Lead only) -->
                        <div id="auto-apply-toggle-container" class="hidden flex items-center gap-2">
                            <span class="text-xs text-gray-400">Auto</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="auto-apply-toggle" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-amber-600"></div>
                            </label>
                        </div>
                        <div id="sso-header-badge" class="hidden px-2 py-1 rounded-full text-xs bg-gray-700 text-gray-400 truncate max-w-[120px]" title="">
                        </div>
                        <div id="role-badge" class="px-3 py-1 rounded-full text-xs font-medium bg-gray-700 text-gray-300">
                            <!-- Role badge will be updated by JavaScript -->
                        </div>
                    </div>
                </div>

            <!-- Hosting-only controls: invite + stop -->
            <div id="hosting-controls" class="hidden mt-4 flex items-center gap-2">
                <span class="text-xs text-green-400 flex items-center gap-1">
                    <span class="inline-block h-2 w-2 rounded-full bg-green-400"></span>
                    Hosting
                </span>
                <button
                    id="btn-copy-invite"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-medium px-3 py-1.5 rounded-lg flex items-center gap-1"
                >
                    Copy Invite Link
                </button>
                <button
                    id="btn-stop-session"
                    class="bg-gray-600 hover:bg-gray-500 text-white text-xs font-medium px-3 py-1.5 rounded-lg"
                >
                    Stop
                </button>
            </div>

            <!-- Joined-only controls: leave -->
            <div id="joined-controls" class="hidden mt-4 flex items-center gap-2">
                <span class="text-xs text-blue-400 flex items-center gap-1">
                    <span class="inline-block h-2 w-2 rounded-full bg-blue-400"></span>
                    Joined
                </span>
                <button
                    id="btn-leave-session"
                    class="bg-gray-600 hover:bg-gray-500 text-white text-xs font-medium px-3 py-1.5 rounded-lg"
                >
                    Leave
                </button>
            </div>

            <!-- Lead-only Action Buttons -->
            <div id="lead-actions" class="hidden mt-4 flex gap-2">
                <button
                    id="btn-create-summary"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    Create Summary
                </button>
                <button
                    id="btn-end-chat"
                    class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2"
                    title="End chat session for all participants"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                    End Chat
                </button>
            </div>

            <!-- Pending Changes Card (hidden by default) -->
            <div id="pending-changes-card" class="hidden mt-4 bg-gray-700/50 border border-gray-600 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-medium text-white flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                        </svg>
                        <span id="pending-changes-title">Pending Changes</span>
                        <span id="change-progress" class="text-purple-300 text-xs font-normal"></span>
                    </h3>
                    <button id="btn-discard-changes" class="text-gray-400 hover:text-gray-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <!-- Current File Info -->
                <div id="current-file-info" class="text-xs text-blue-300 mb-2 flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                    </svg>
                    <span id="current-file-name"></span>
                </div>

                <!-- Change Stats -->
                <div class="flex items-center gap-4 text-xs text-gray-300 mb-3">
                    <span id="pending-files-count" class="flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                        </svg>
                        <span>1 file</span>
                    </span>
                    <span id="pending-lines-count" class="flex items-center gap-1">
                        <span class="text-green-400">+5</span>
                        <span class="text-red-400">-3</span>
                        <span>lines</span>
                    </span>
                </div>

                <!-- Policy Status -->
                <div id="policy-status" class="flex items-center gap-2 text-xs mb-3">
                    <span id="policy-status-icon" class="text-green-400">‚úì</span>
                    <span id="policy-status-text" class="text-gray-300">Safe to apply</span>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2">
                    <button
                        id="btn-view-diff"
                        class="flex-1 bg-gray-600 hover:bg-gray-500 text-white text-xs font-medium px-3 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                        </svg>
                        View Diff
                    </button>
                    <button
                        id="btn-apply-changes"
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white text-xs font-medium px-3 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Apply
                    </button>
                </div>
            </div>
        </header>

        <!-- Messages Area - WhatsApp-style scrollable container -->
        <div class="relative flex-1 min-h-0">
            <div id="messages-container" class="absolute inset-0 overflow-y-auto px-4 py-4 space-y-3" style="scrollbar-width: thin; scrollbar-color: #4b5563 transparent;">
                <!-- Messages will be rendered here by JavaScript -->
                <div id="connection-status" class="flex justify-center">
                    <div class="bg-gray-800/50 text-gray-400 text-xs px-3 py-1.5 rounded-full border border-gray-700">
                        <span>Connecting to chat...</span>
                    </div>
                </div>
            </div>

            <!-- Scroll to bottom button -->
            <button id="scroll-to-bottom" class="hidden absolute bottom-4 right-4 bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-full shadow-lg z-10" title="Scroll to bottom">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                <span id="unread-count" class="hidden absolute -top-1 -right-1 bg-blue-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center unread-badge">0</span>
            </button>
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="hidden flex-shrink-0 px-6 py-2 text-xs text-gray-400 italic">
            <span id="typing-text">Someone is typing...</span>
        </div>

        <!-- Input Area -->
        <div class="flex-shrink-0 border-t border-gray-700 bg-gray-800 px-6 py-4">
            <!-- Hidden file input -->
            <input type="file" id="file-input" class="hidden"
                   accept="image/*,.pdf,audio/*,.mp3,.wav,.ogg,.m4a,.flac" />

            <!-- File preview area (shown when file is selected) -->
            <div id="file-preview" class="hidden mb-3 p-3 bg-gray-900 rounded-lg border border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span id="file-preview-icon" class="text-2xl">üìé</span>
                        <div>
                            <div id="file-preview-name" class="text-sm text-gray-200 font-medium"></div>
                            <div id="file-preview-size" class="text-xs text-gray-500"></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- Upload button -->
                        <button id="btn-upload-file" class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium px-3 py-1.5 rounded-lg transition-colors">
                            ‚¨ÜÔ∏è Upload
                        </button>
                        <!-- Cancel button -->
                        <button id="btn-remove-file" class="text-gray-400 hover:text-red-400 p-1" title="Cancel">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- Image preview thumbnail -->
                <img id="file-preview-img" class="hidden mt-3 max-h-32 rounded-lg" />
                <!-- Optional caption input -->
                <div class="mt-2">
                    <input type="text" id="file-caption" placeholder="Add a caption (optional)..."
                           class="w-full bg-gray-800 text-gray-100 border border-gray-600 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
            </div>

            <!-- Code Snippet Preview (shown when code is attached) -->
            <div id="code-snippet-preview" class="hidden mb-3 bg-gray-800 border border-gray-600 rounded-lg overflow-hidden">
                <div class="flex items-center justify-between px-3 py-2 bg-gray-700 border-b border-gray-600">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        <span id="code-snippet-filename" class="text-xs text-gray-300 font-mono truncate max-w-[200px]"></span>
                        <span id="code-snippet-lines" class="text-xs text-gray-500"></span>
                    </div>
                    <button id="btn-clear-snippet" class="text-gray-400 hover:text-white p-1" title="Remove code snippet">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <pre id="code-snippet-content" class="code-snippet-plain p-3 text-xs font-mono text-gray-300 overflow-x-auto max-h-32 overflow-y-auto"></pre>
            </div>

            <div class="flex items-end gap-3">
                <!-- Attachment Button -->
                <button
                    id="btn-attach"
                    class="bg-gray-700 hover:bg-gray-600 text-gray-300 p-3 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500"
                    title="Attach file (images, PDF, audio, max 20MB)"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clip-rule="evenodd" />
                    </svg>
                </button>

                <!-- Code Snippet Button -->
                <button
                    id="btn-code-snippet"
                    class="bg-gray-700 hover:bg-gray-600 text-gray-300 p-3 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500"
                    title="Share code from editor (select code first)"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>

                <!-- Text Input -->
                <div class="flex-1">
                    <textarea
                        id="chat-input"
                        rows="1"
                        placeholder="Type your message or paste an image..."
                        class="w-full bg-gray-900 text-gray-100 border border-gray-700 rounded-lg px-4 py-3 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-500 text-sm"
                    ></textarea>
                </div>

                <!-- Send Button -->
                <button
                    id="btn-send"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-3 rounded-lg transition-colors duration-200 flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                    <span class="text-sm">Send</span>
                </button>
            </div>

            <!-- Helper Text -->
            <div class="mt-2 text-xs text-gray-500">
                Press Enter to send, Shift+Enter for new line. Click <span class="text-blue-400">&lt;/&gt;</span> to share code from editor.
            </div>
        </div>
        </div> <!-- close chat content column -->

        <!-- Users Sidebar (inside panel-chat) -->
        <aside id="sidebar" class="w-56 bg-gray-800 border-l border-gray-700 flex-shrink-0 hidden md:flex flex-col">
            <div class="px-4 py-4 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-sm font-semibold text-gray-300">Participants</h2>
                    <span id="user-count" class="text-xs text-gray-400 bg-gray-700 px-2 py-0.5 rounded-full">0</span>
                </div>
            </div>
            <div id="users-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- Users will be rendered here -->
            </div>
        </aside>
        </div> <!-- close panel-chat -->
    </div> <!-- close main area flex-col -->
    </div> <!-- close outer flex h-full -->

    <!-- ============================================================ -->
    <!-- AI Configuration Modal                                        -->
    <!-- ============================================================ -->
    <div id="ai-config-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <!-- Backdrop -->
        <div id="ai-config-backdrop" class="absolute inset-0 bg-black/60"></div>
        <!-- Modal Content -->
        <div class="relative bg-gray-800 rounded-lg shadow-xl border border-gray-700 w-full max-w-md mx-4">
            <!-- Header -->
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                    </svg>
                    AI Configuration
                </h3>
                <button id="btn-close-ai-config" class="text-gray-400 hover:text-white p-1 rounded transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <!-- Body -->
            <div class="px-5 py-4 space-y-4">
                <!-- Loading State -->
                <div id="ai-config-loading" class="hidden flex items-center justify-center py-8">
                    <div class="h-6 w-6 border-2 border-purple-400 border-t-transparent rounded-full animate-spin"></div>
                    <span class="ml-3 text-gray-400 text-sm">Loading AI status...</span>
                </div>
                <!-- Error State -->
                <div id="ai-config-error" class="hidden bg-red-900/30 border border-red-700 rounded-lg p-3">
                    <p class="text-red-400 text-sm" id="ai-config-error-text">Failed to fetch AI status</p>
                </div>
                <!-- Content -->
                <div id="ai-config-content" class="hidden space-y-4">
                    <!-- AI Summary Toggle Section -->
                    <div class="bg-gray-900/50 rounded-lg border border-gray-700 p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div id="ai-summary-icon" class="h-10 w-10 rounded-full flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div>
                                    <span class="text-white text-sm font-medium block">AI Summary</span>
                                    <span id="ai-summary-status-text" class="text-xs text-gray-400">Checking status...</span>
                                </div>
                            </div>
                            <span id="ai-summary-enabled" class="px-3 py-1 rounded-full text-xs font-medium"></span>
                        </div>
                    </div>

                    <!-- Model Selection Dropdown -->
                    <div class="bg-purple-900/20 rounded-lg border border-purple-700/50 p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-purple-300 text-xs font-medium uppercase tracking-wide">Active Model</span>
                        </div>
                        <select id="ai-model-select" class="w-full bg-gray-900 border border-gray-600 text-white text-sm rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            <option value="">No models available</option>
                        </select>
                        <p id="ai-model-select-hint" class="text-xs text-gray-500 mt-2">Select a model to use for AI summarization</p>
                    </div>

                    <!-- Provider Health List -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-300 text-sm font-medium">Provider Health Status</span>
                            <span id="ai-last-updated" class="text-xs text-gray-500"></span>
                        </div>
                        <div id="ai-providers-list" class="bg-gray-900/50 rounded-lg border border-gray-700 divide-y divide-gray-700">
                            <!-- Provider rows will be inserted here -->
                        </div>
                        <p id="ai-no-providers" class="hidden text-gray-500 text-xs italic py-2">No providers configured</p>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div class="px-5 py-4 border-t border-gray-700 flex justify-end gap-2">
                <button
                    id="btn-refresh-ai-status"
                    class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors flex items-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                    </svg>
                    Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- Room Settings Modal                                           -->
    <!-- ============================================================ -->
    <div id="room-settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <!-- Backdrop -->
        <div id="room-settings-backdrop" class="absolute inset-0 bg-black/60"></div>
        <!-- Modal Content -->
        <div class="relative bg-gray-800 rounded-lg shadow-xl border border-gray-700 w-full max-w-md mx-4">
            <!-- Header -->
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                    </svg>
                    Room Settings
                </h3>
                <button id="btn-close-room-settings" class="text-gray-400 hover:text-white p-1 rounded transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <!-- Body -->
            <div class="px-5 py-4 space-y-4">
                <!-- Loading State -->
                <div id="room-settings-loading" class="hidden flex items-center justify-center py-8">
                    <div class="h-6 w-6 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                    <span class="ml-3 text-gray-400 text-sm">Loading settings...</span>
                </div>
                <!-- Error State -->
                <div id="room-settings-error" class="hidden bg-red-900/30 border border-red-700 rounded-lg p-3">
                    <p class="text-red-400 text-sm" id="room-settings-error-text">Failed to fetch settings</p>
                </div>
                <!-- Content -->
                <div id="room-settings-content" class="hidden space-y-4">
                    <!-- Code Style Textarea -->
                    <div>
                        <label for="room-code-style" class="block text-sm font-medium text-gray-300 mb-2">Code Style Guidelines</label>
                        <textarea
                            id="room-code-style"
                            rows="8"
                            class="w-full bg-gray-900 border border-gray-600 text-gray-100 text-sm rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono resize-y"
                            placeholder="Enter code style guidelines for this room (e.g., indentation rules, naming conventions, patterns to follow)..."
                        ></textarea>
                        <p class="text-xs text-gray-500 mt-1">These guidelines will be included in AI-generated code prompts for this room.</p>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div id="room-settings-footer" class="hidden flex items-center justify-end gap-3 px-5 py-4 border-t border-gray-700">
                <button id="btn-cancel-room-settings" class="text-gray-400 hover:text-white text-sm px-4 py-2 rounded-lg transition-colors">
                    Cancel
                </button>
                <button id="btn-save-room-settings" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- Summarize Options Modal                                       -->
    <!-- ============================================================ -->
    <div id="summarize-options-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <!-- Backdrop -->
        <div id="summarize-options-backdrop" class="absolute inset-0 bg-black/60"></div>
        <!-- Modal Content -->
        <div class="relative bg-gray-800 rounded-lg shadow-xl border border-gray-700 w-full max-w-md mx-4">
            <!-- Header -->
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                    </svg>
                    Summarize Chat
                </h3>
                <button id="btn-close-summarize-options" class="text-gray-400 hover:text-white p-1 rounded transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <!-- Body -->
            <div class="px-5 py-4 space-y-4">
                <p class="text-gray-300 text-sm">How would you like to summarize the conversation?</p>

                <!-- Option: Summarize All -->
                <button id="btn-summarize-all" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium px-4 py-3 rounded-lg transition-colors flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                    </svg>
                    <div class="text-left">
                        <span class="block font-medium">Summarize All Messages</span>
                        <span id="summarize-all-count" class="text-xs text-purple-200">0 messages</span>
                    </div>
                </button>

                <!-- Option: Select Messages -->
                <button id="btn-summarize-select" class="w-full bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium px-4 py-3 rounded-lg transition-colors flex items-center gap-3 border border-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    <div class="text-left">
                        <span class="block font-medium">Select Messages to Summarize</span>
                        <span class="text-xs text-gray-400">Choose specific messages</span>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- Message Selection Modal                                       -->
    <!-- ============================================================ -->
    <div id="message-selection-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <!-- Backdrop -->
        <div id="message-selection-backdrop" class="absolute inset-0 bg-black/60"></div>
        <!-- Modal Content -->
        <div class="relative bg-gray-800 rounded-lg shadow-xl border border-gray-700 w-full max-w-lg mx-4 max-h-[80vh] flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-700 flex-shrink-0">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    Select Messages
                </h3>
                <button id="btn-close-message-selection" class="text-gray-400 hover:text-white p-1 rounded transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <!-- Selection controls -->
            <div class="px-5 py-3 border-b border-gray-700 flex items-center justify-between flex-shrink-0">
                <div class="flex items-center gap-3">
                    <button id="btn-select-all-messages" class="text-xs text-purple-400 hover:text-purple-300 transition-colors">Select All</button>
                    <span class="text-gray-600">|</span>
                    <button id="btn-deselect-all-messages" class="text-xs text-gray-400 hover:text-gray-300 transition-colors">Deselect All</button>
                </div>
                <span id="selected-messages-count" class="text-xs text-gray-400">0 selected</span>
            </div>
            <!-- Message list (scrollable) -->
            <div id="message-selection-list" class="px-5 py-3 overflow-y-auto flex-1 space-y-2">
                <!-- Messages will be populated here -->
            </div>
            <!-- Footer -->
            <div class="px-5 py-4 border-t border-gray-700 flex justify-end gap-3 flex-shrink-0">
                <button id="btn-cancel-message-selection" class="px-4 py-2 text-sm text-gray-400 hover:text-white transition-colors">
                    Cancel
                </button>
                <button id="btn-confirm-message-selection" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white text-sm font-medium rounded-lg transition-colors">
                    Summarize Selected
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- AI Summary Results Modal                                      -->
    <!-- ============================================================ -->
    <div id="summary-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <!-- Backdrop -->
        <div id="summary-modal-backdrop" class="absolute inset-0 bg-black/60"></div>
        <!-- Modal Content -->
        <div class="relative bg-gray-800 rounded-lg shadow-xl border border-gray-700 w-full max-w-lg mx-4 max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-700 flex-shrink-0">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    Chat Summary
                </h3>
                <button id="btn-close-summary" class="text-gray-400 hover:text-white p-1 rounded transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <!-- Body (scrollable) -->
            <div class="px-5 py-4 space-y-4 overflow-y-auto flex-1">
                <!-- Loading State -->
                <div id="summary-loading" class="hidden flex items-center justify-center py-8">
                    <div class="h-6 w-6 border-2 border-emerald-400 border-t-transparent rounded-full animate-spin"></div>
                    <span class="ml-3 text-gray-400 text-sm">Generating summary...</span>
                </div>
                <!-- Error State -->
                <div id="summary-error" class="hidden bg-red-900/30 border border-red-700 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        <span class="text-red-400 font-medium">Summary Failed</span>
                    </div>
                    <p class="text-red-300 text-sm" id="summary-error-text">Unable to generate summary.</p>
                </div>
                <!-- Summary Content -->
                <div id="summary-content" class="hidden space-y-4">
                    <!-- Topic -->
                    <div>
                        <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-1">Topic</h4>
                        <p id="summary-topic" class="text-white text-sm"></p>
                    </div>
                    <!-- Problem Statement -->
                    <div>
                        <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-1">Problem</h4>
                        <p id="summary-problem" class="text-gray-200 text-sm"></p>
                    </div>
                    <!-- Proposed Solution -->
                    <div>
                        <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-1">Proposed Solution</h4>
                        <p id="summary-solution" class="text-gray-200 text-sm"></p>
                    </div>
                    <!-- Risk Level -->
                    <div class="flex items-center gap-3">
                        <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Risk Level</h4>
                        <span id="summary-risk" class="px-2 py-0.5 rounded text-xs font-medium"></span>
                    </div>
                    <!-- Affected Components -->
                    <div id="summary-components-section">
                        <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Affected Components</h4>
                        <div id="summary-components" class="flex flex-wrap gap-1"></div>
                    </div>
                    <!-- Next Steps -->
                    <div id="summary-steps-section">
                        <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">Next Steps</h4>
                        <ul id="summary-steps" class="text-sm text-gray-200 list-disc list-inside space-y-1"></ul>
                    </div>
                    <!-- Code Change Required Section -->
                    <div id="summary-code-change-section" class="hidden mt-4 p-4 bg-purple-900/30 border border-purple-700 rounded-lg">
                        <div class="flex items-center gap-2 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-purple-300 font-medium text-sm">This decision includes code changes.</span>
                        </div>

                        <!-- Initial state: Generate button -->
                        <div id="code-prompt-initial" class="">
                            <p class="text-gray-300 text-xs mb-3">Generate a coding prompt?</p>
                            <button id="btn-generate-code-prompt" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                <span id="btn-generate-code-prompt-text">Generate Coding Prompt</span>
                            </button>
                        </div>

                        <!-- Loading state -->
                        <div id="code-prompt-loading" class="hidden flex items-center justify-center py-4">
                            <div class="h-5 w-5 border-2 border-purple-400 border-t-transparent rounded-full animate-spin"></div>
                            <span class="ml-2 text-gray-400 text-sm">Generating prompt...</span>
                        </div>

                        <!-- Error state -->
                        <div id="code-prompt-error" class="hidden bg-red-900/30 border border-red-700 rounded-lg p-3 mt-2">
                            <p class="text-red-300 text-xs" id="code-prompt-error-text">Failed to generate code prompt.</p>
                        </div>

                        <!-- Result state: Code prompt display -->
                        <div id="code-prompt-result" class="hidden mt-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-medium text-gray-400">Generated Coding Prompt</span>
                                <button id="btn-copy-code-prompt" class="text-xs text-purple-400 hover:text-purple-300 flex items-center gap-1 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                                    </svg>
                                    <span id="btn-copy-code-prompt-text">Copy</span>
                                </button>
                            </div>
                            <textarea id="code-prompt-textarea" readonly class="w-full h-40 bg-gray-900 border border-gray-700 rounded-lg p-3 text-xs text-gray-200 font-mono resize-none focus:outline-none focus:border-purple-500"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div class="px-5 py-4 border-t border-gray-700 flex justify-end flex-shrink-0">
                <button id="btn-dismiss-summary" class="bg-gray-600 hover:bg-gray-500 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // VS Code API for communication with the extension
        const vscode = acquireVsCodeApi();

        // Session state (injected by extension)
        let session = window.initialSession || { roomId: null, hostId: null, userId: null, createdAt: null, backendUrl: 'http://localhost:8000', displayName: 'Host', leadId: null };
        console.log('[WebView] Session initialized:', session.roomId ? `roomId=${session.roomId}, userId=${session.userId}` : 'no session');

        // Conductor FSM state (injected by extension)
        let conductorState = window.initialConductorState || 'Idle';
        console.log('[WebView] Conductor state:', conductorState);

        // Users map: userId -> user info
        const usersMap = new Map();

        // Display roomId in the header (truncated for readability)
        const roomIdDisplay = document.getElementById('room-id-display');
        if (roomIdDisplay && session.roomId) {
            roomIdDisplay.textContent = session.roomId.substring(0, 8) + '...';
            roomIdDisplay.title = session.roomId; // Full ID on hover
        }

        // State
        let pendingChangeSet = null;
        let policyResult = null;
        let autoApplyEnabled = false;
        let currentChange = null;
        let currentChangeIndex = 0;
        let totalChanges = 0;

        // WebSocket state
        let ws = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;
        const BASE_RECONNECT_DELAY_MS = 1000;
        const MAX_RECONNECT_DELAY_MS = 30000;

        // Message recovery & deduplication
        let lastMessageTimestamp = 0;
        const seenMessageIds = new Set();

        // Chat messages storage for summarization
        // Each message: { role: 'host'|'engineer', text: string, timestamp: number }
        const chatMessages = [];

        // DOM elements
        const roleBadge = document.getElementById('role-badge');
        const leadActions = document.getElementById('lead-actions');
        const btnCreateSummary = document.getElementById('btn-create-summary');
        const autoApplyToggleContainer = document.getElementById('auto-apply-toggle-container');
        const autoApplyToggle = document.getElementById('auto-apply-toggle');
        const pendingChangesCard = document.getElementById('pending-changes-card');
        const pendingFilesCount = document.getElementById('pending-files-count');
        const pendingLinesCount = document.getElementById('pending-lines-count');
        const policyStatus = document.getElementById('policy-status');
        const policyStatusIcon = document.getElementById('policy-status-icon');
        const policyStatusText = document.getElementById('policy-status-text');
        const btnViewDiff = document.getElementById('btn-view-diff');
        const btnApplyChanges = document.getElementById('btn-apply-changes');
        const btnDiscardChanges = document.getElementById('btn-discard-changes');
        const changeProgress = document.getElementById('change-progress');
        const currentFileInfo = document.getElementById('current-file-info');
        const currentFileName = document.getElementById('current-file-name');
        const messagesContainer = document.getElementById('messages-container');
        const connectionStatus = document.getElementById('connection-status');
        const chatInput = document.getElementById('chat-input');
        const btnSend = document.getElementById('btn-send');
        const btnCopyRoomId = document.getElementById('btn-copy-room-id');
        const btnEndChat = document.getElementById('btn-end-chat');
        const usersList = document.getElementById('users-list');
        const userCount = document.getElementById('user-count');

        // State panels (render() toggles these)
        const panelIdle = document.getElementById('panel-idle');
        const panelDisconnected = document.getElementById('panel-disconnected');
        const panelReady = document.getElementById('panel-ready');
        const panelJoining = document.getElementById('panel-joining');
        const panelChat = document.getElementById('panel-chat');
        const hostingControls = document.getElementById('hosting-controls');
        const joinedControls = document.getElementById('joined-controls');

        // Buttons inside state panels
        const btnIdleStart = document.getElementById('btn-idle-start');
        const btnIdleJoin = document.getElementById('btn-idle-join');
        const btnRetry = document.getElementById('btn-retry');
        const btnStartSession = document.getElementById('btn-start-session');
        const btnReadyJoin = document.getElementById('btn-ready-join');
        const readyInviteUrlInput = document.getElementById('ready-invite-url-input');
        const btnDisconnectedJoin = document.getElementById('btn-disconnected-join');
        const disconnectedInviteUrlInput = document.getElementById('disconnected-invite-url-input');
        const btnStopSession = document.getElementById('btn-stop-session');
        const btnCopyInvite = document.getElementById('btn-copy-invite');
        const inviteUrlInput = document.getElementById('invite-url-input');
        const btnLeaveSession = document.getElementById('btn-leave-session');

        // File upload elements
        const fileInput = document.getElementById('file-input');
        const filePreview = document.getElementById('file-preview');
        const filePreviewIcon = document.getElementById('file-preview-icon');
        const filePreviewName = document.getElementById('file-preview-name');
        const filePreviewSize = document.getElementById('file-preview-size');
        const filePreviewImg = document.getElementById('file-preview-img');
        const fileCaption = document.getElementById('file-caption');
        const btnAttach = document.getElementById('btn-attach');
        const btnRemoveFile = document.getElementById('btn-remove-file');
        const btnUploadFile = document.getElementById('btn-upload-file');

        // Code snippet elements
        const btnCodeSnippet = document.getElementById('btn-code-snippet');
        const codeSnippetPreview = document.getElementById('code-snippet-preview');
        const codeSnippetFilename = document.getElementById('code-snippet-filename');
        const codeSnippetLines = document.getElementById('code-snippet-lines');
        const codeSnippetContent = document.getElementById('code-snippet-content');
        const btnClearSnippet = document.getElementById('btn-clear-snippet');

        // AI Config modal elements
        const aiConfigModal = document.getElementById('ai-config-modal');
        const aiConfigBackdrop = document.getElementById('ai-config-backdrop');
        const btnAiConfig = document.getElementById('btn-ai-config');
        const btnCloseAiConfig = document.getElementById('btn-close-ai-config');
        const btnRefreshAiStatus = document.getElementById('btn-refresh-ai-status');
        const aiConfigLoading = document.getElementById('ai-config-loading');
        const aiConfigError = document.getElementById('ai-config-error');
        const aiConfigErrorText = document.getElementById('ai-config-error-text');
        const aiConfigContent = document.getElementById('ai-config-content');
        const aiSummaryEnabled = document.getElementById('ai-summary-enabled');
        const aiSummaryIcon = document.getElementById('ai-summary-icon');
        const aiSummaryStatusText = document.getElementById('ai-summary-status-text');
        const aiModelSelect = document.getElementById('ai-model-select');
        const aiModelSelectHint = document.getElementById('ai-model-select-hint');
        const aiLastUpdated = document.getElementById('ai-last-updated');
        const aiProvidersList = document.getElementById('ai-providers-list');
        const aiNoProviders = document.getElementById('ai-no-providers');

        // Track models state
        let aiModelsState = [];
        let aiActiveModelState = null;

        // Room Settings modal elements
        const roomSettingsModal = document.getElementById('room-settings-modal');
        const roomSettingsBackdrop = document.getElementById('room-settings-backdrop');
        const btnRoomSettings = document.getElementById('btn-room-settings');
        const btnCloseRoomSettings = document.getElementById('btn-close-room-settings');
        const btnCancelRoomSettings = document.getElementById('btn-cancel-room-settings');
        const btnSaveRoomSettings = document.getElementById('btn-save-room-settings');
        const roomSettingsLoading = document.getElementById('room-settings-loading');
        const roomSettingsError = document.getElementById('room-settings-error');
        const roomSettingsErrorText = document.getElementById('room-settings-error-text');
        const roomSettingsContent = document.getElementById('room-settings-content');
        const roomSettingsFooter = document.getElementById('room-settings-footer');
        const roomCodeStyleTextarea = document.getElementById('room-code-style');

        // AI Summarize elements

        // Summary modal elements
        const summaryModal = document.getElementById('summary-modal');
        const summaryModalBackdrop = document.getElementById('summary-modal-backdrop');
        const btnCloseSummary = document.getElementById('btn-close-summary');
        const btnDismissSummary = document.getElementById('btn-dismiss-summary');
        const summaryLoading = document.getElementById('summary-loading');
        const summaryError = document.getElementById('summary-error');
        const summaryErrorText = document.getElementById('summary-error-text');
        const summaryContent = document.getElementById('summary-content');
        const summaryTopic = document.getElementById('summary-topic');
        const summaryProblem = document.getElementById('summary-problem');
        const summarySolution = document.getElementById('summary-solution');
        const summaryRisk = document.getElementById('summary-risk');
        const summaryComponents = document.getElementById('summary-components');
        const summaryComponentsSection = document.getElementById('summary-components-section');
        const summarySteps = document.getElementById('summary-steps');
        const summaryStepsSection = document.getElementById('summary-steps-section');
        const summaryCodeChangeSection = document.getElementById('summary-code-change-section');
        const btnGenerateCodePrompt = document.getElementById('btn-generate-code-prompt');
        const btnGenerateCodePromptText = document.getElementById('btn-generate-code-prompt-text');
        const codePromptInitial = document.getElementById('code-prompt-initial');
        const codePromptLoading = document.getElementById('code-prompt-loading');
        const codePromptError = document.getElementById('code-prompt-error');
        const codePromptErrorText = document.getElementById('code-prompt-error-text');
        const codePromptResult = document.getElementById('code-prompt-result');
        const codePromptTextarea = document.getElementById('code-prompt-textarea');
        const btnCopyCodePrompt = document.getElementById('btn-copy-code-prompt');
        const btnCopyCodePromptText = document.getElementById('btn-copy-code-prompt-text');

        // Summarize options modal elements
        const summarizeOptionsModal = document.getElementById('summarize-options-modal');
        const summarizeOptionsBackdrop = document.getElementById('summarize-options-backdrop');
        const btnCloseSummarizeOptions = document.getElementById('btn-close-summarize-options');
        const btnSummarizeAll = document.getElementById('btn-summarize-all');
        const btnSummarizeSelect = document.getElementById('btn-summarize-select');
        const summarizeAllCount = document.getElementById('summarize-all-count');

        // Message selection modal elements
        const messageSelectionModal = document.getElementById('message-selection-modal');
        const messageSelectionBackdrop = document.getElementById('message-selection-backdrop');
        const btnCloseMessageSelection = document.getElementById('btn-close-message-selection');
        const btnSelectAllMessages = document.getElementById('btn-select-all-messages');
        const btnDeselectAllMessages = document.getElementById('btn-deselect-all-messages');
        const selectedMessagesCount = document.getElementById('selected-messages-count');
        const messageSelectionList = document.getElementById('message-selection-list');
        const btnCancelMessageSelection = document.getElementById('btn-cancel-message-selection');
        const btnConfirmMessageSelection = document.getElementById('btn-confirm-message-selection');

        // Track selected message indices for summarization
        let selectedMessageIndices = new Set();

        // Track AI status
        let aiSummaryEnabledState = false;
        let aiActiveProviderState = null;

        // Track current summary for code prompt generation
        let currentSummaryData = null;

        // Track the button ID for the current code prompt generation
        let currentCodePromptButtonId = null;

        // Track generated code prompt
        let generatedCodePrompt = null;

        // SSO state
        let ssoIdentity = window.initialSSOIdentity || null;
        let ssoProvider = window.initialSSOProvider || null;

        function getSSODisplayName(identity) {
            if (!identity) return null;
            if (identity.email) {
                const at = identity.email.indexOf('@');
                return at > 0 ? identity.email.substring(0, at) : identity.email;
            }
            if (identity.name) return identity.name;
            return identity.user_id || null;
        }

        function getIdentitySource() {
            if (ssoIdentity) return 'sso';
            if (session.displayName && session.displayName !== 'Host' && session.displayName !== 'User') return 'named';
            return 'anonymous';
        }

        function getProviderBadge(provider) {
            if (provider === 'aws') return '\u2601 AWS';
            if (provider === 'google') return 'G Google';
            return '\u2713';
        }

        const ssoDisplayName = getSSODisplayName(ssoIdentity);
        if (ssoDisplayName) session.displayName = ssoDisplayName;

        // SSO panel containers (each has .sso-signin, .sso-pending, .sso-done children)
        const ssoPanels = ['sso-idle', 'sso-disconnected', 'sso-ready'].map(id => document.getElementById(id));
        const ssoHeaderBadge = document.getElementById('sso-header-badge');

        /**
         * Show/hide SSO provider buttons based on which providers are enabled.
         * If no providers are enabled, the entire sign-in row is hidden.
         */
        function applySSOProviderVisibility(providers) {
            document.querySelectorAll('.sso-login-aws').forEach(btn => {
                btn.classList.toggle('hidden', !providers.aws);
            });
            document.querySelectorAll('.sso-login-google').forEach(btn => {
                btn.classList.toggle('hidden', !providers.google);
            });
            // If neither provider is enabled, hide the entire signin row
            const noneEnabled = !providers.aws && !providers.google;
            document.querySelectorAll('.sso-signin').forEach(row => {
                row.classList.toggle('hidden', noneEnabled);
            });
        }

        // Apply initial provider visibility from injected config
        let enabledProviders = window.initialEnabledSSOProviders || { aws: false, google: false };
        applySSOProviderVisibility(enabledProviders);

        // Attach SSO button handlers (login + cancel) for all three panels
        document.querySelectorAll('.sso-login-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const provider = btn.dataset.provider || 'aws';
                vscode.postMessage({ command: 'ssoLogin', provider });
            });
        });
        document.querySelectorAll('.sso-cancel-btn').forEach(btn => {
            btn.addEventListener('click', () => vscode.postMessage({ command: 'ssoCancel' }));
        });
        document.querySelectorAll('.sso-clear-btn').forEach(btn => {
            btn.addEventListener('click', () => vscode.postMessage({ command: 'ssoClearCache' }));
        });

        /**
         * Update all SSO UI panels to show the sign-in button (default state).
         */
        function showSSOSignInState() {
            ssoPanels.forEach(panel => {
                if (!panel) return;
                panel.querySelector('.sso-signin')?.classList.remove('hidden');
                panel.querySelector('.sso-pending')?.classList.add('hidden');
                panel.querySelector('.sso-done')?.classList.add('hidden');
            });
            // Re-apply provider visibility (hides row if no providers enabled)
            applySSOProviderVisibility(enabledProviders);
        }

        /**
         * Update all SSO UI panels to show the pending/polling state.
         */
        function showSSOPendingState(userCode) {
            ssoPanels.forEach(panel => {
                if (!panel) return;
                panel.querySelector('.sso-signin')?.classList.add('hidden');
                panel.querySelector('.sso-pending')?.classList.remove('hidden');
                panel.querySelector('.sso-done')?.classList.add('hidden');
                const codeEl = panel.querySelector('.sso-user-code');
                if (codeEl) codeEl.textContent = userCode || '';
            });
        }

        /**
         * Update all SSO UI panels to show the signed-in state with email and provider badge.
         */
        function showSSOSignedInState(identity, provider) {
            const email = identity?.email || identity?.arn || 'Signed in';
            const badge = getProviderBadge(provider || ssoProvider);
            ssoPanels.forEach(panel => {
                if (!panel) return;
                panel.querySelector('.sso-signin')?.classList.add('hidden');
                panel.querySelector('.sso-pending')?.classList.add('hidden');
                panel.querySelector('.sso-done')?.classList.remove('hidden');
                const badgeEl = panel.querySelector('.sso-provider-badge');
                if (badgeEl) {
                    badgeEl.textContent = badge;
                }
                const emailEl = panel.querySelector('.sso-email');
                if (emailEl) {
                    emailEl.textContent = email;
                    emailEl.title = identity?.arn || email;
                }
            });
            // Name is now shown in the role badge, so keep ssoHeaderBadge hidden
        }

        // Restore SSO state on page load
        if (ssoIdentity) {
            showSSOSignedInState(ssoIdentity, ssoProvider);
        }

        // Track session state
        let sessionEnded = false;

        // Track pending code snippet
        let pendingCodeSnippet = null;

        // Track pending file upload
        let pendingFile = null;
        let isUploading = false;  // Prevent double uploads
        const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB

        // Typing indicator state
        const typingIndicator = document.getElementById('typing-indicator');
        const typingText = document.getElementById('typing-text');
        const typingUsers = new Map();  // userId -> displayName
        let typingTimeout = null;
        const TYPING_DEBOUNCE_MS = 500;
        const TYPING_EXPIRE_MS = 3000;
        let isTyping = false;
        let lastTypingTime = 0;

        // Message grouping state
        let lastMessageUserId = null;
        let lastMessageTime = 0;
        let lastMessageDate = null;
        const MESSAGE_GROUP_INTERVAL_MS = 5 * 60 * 1000;  // 5 minutes

        // Scroll to bottom button state
        const scrollToBottomBtn = document.getElementById('scroll-to-bottom');
        const unreadCountBadge = document.getElementById('unread-count');
        let unreadCount = 0;
        let isUserScrolledUp = false;
        const SCROLL_THRESHOLD = 100;  // pixels from bottom to consider "at bottom"

        // Pagination state
        let isLoadingHistory = false;
        let hasMoreHistory = true;
        const PAGINATION_THRESHOLD = 100;  // pixels from top to trigger load

        // Avatar color mapping
        const avatarColors = {
            purple: 'bg-purple-600',
            blue: 'bg-blue-600',
            green: 'bg-green-600',
            orange: 'bg-orange-600',
            pink: 'bg-pink-600',
            cyan: 'bg-cyan-600',
            yellow: 'bg-yellow-600',
            red: 'bg-red-600',
            amber: 'bg-amber-500'
        };

        /**
         * Update UI based on dynamic lead permissions from WebSocket.
         * This replaces the static isEffectiveLead logic with server-tracked lead state.
         */
        function updateLeadPermissions() {
            const isHost = session.sessionRole === 'host';
            const isLead = session.userId === session.leadId;
            const canUseAI = isLead;
            const canConfigure = isHost || isLead;

            // Update role badge to reflect lead status
            const headerName = escapeHtml(session.displayName || 'User');
            if (isHost && isLead) {
                roleBadge.innerHTML = `<span class="font-semibold text-amber-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-amber-400 font-medium">Host + Lead</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-amber-500/10 border border-amber-500/20';
            } else if (isHost) {
                roleBadge.innerHTML = `<span class="font-semibold text-amber-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-amber-400 font-medium">Host</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-amber-500/10 border border-amber-500/20';
            } else if (isLead) {
                roleBadge.innerHTML = `<span class="font-semibold text-purple-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-purple-400 font-medium">Lead</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-purple-500/10 border border-purple-500/20';
            } else {
                roleBadge.innerHTML = `<span class="font-semibold text-gray-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-gray-400 font-medium">Member</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-gray-700/50 border border-gray-600/30';
            }

            // AI buttons: only lead
            btnCreateSummary.style.display = canUseAI ? 'flex' : 'none';

            // Config buttons: host OR lead
            if (btnAiConfig) btnAiConfig.style.display = canConfigure ? 'flex' : 'none';
            if (btnRoomSettings) btnRoomSettings.classList.toggle('hidden', !canConfigure);

            // End session: host only
            btnEndChat.style.display = isHost ? 'flex' : 'none';

            // Auto-apply toggle: lead only
            if (canUseAI) {
                autoApplyToggleContainer.classList.remove('hidden');
                autoApplyToggleContainer.classList.add('flex');
            } else {
                autoApplyToggleContainer.classList.add('hidden');
                autoApplyToggleContainer.classList.remove('flex');
            }

            // AI toolbar section: show if user has any AI-related permissions
            if (canUseAI || canConfigure) {
                leadActions.classList.remove('hidden');
                leadActions.classList.add('flex');
            } else {
                leadActions.classList.add('hidden');
                leadActions.classList.remove('flex');
            }
        }

        /**
         * Update the UI based on permissions from extension host.
         * After setting sessionRole, delegates to updateLeadPermissions() for
         * dynamic lead-based visibility.
         */
        function updateUIForPermissions(permissions) {
            // Store session role for use in messages
            if (permissions.sessionRole) {
                session.sessionRole = permissions.sessionRole;
            }

            // Hide SSO header badge since name is now shown in role badge
            if (ssoHeaderBadge) {
                ssoHeaderBadge.classList.add('hidden');
            }

            // Delegate to dynamic lead permissions if leadId is known
            // (leadId comes from WebSocket, not from extension permissions)
            if (session.leadId) {
                updateLeadPermissions();
                return;
            }

            // Fallback: use old isEffectiveLead logic if WebSocket hasn't sent leadId yet
            const isEffectiveLead = permissions.role === 'lead' || permissions.sessionRole === 'host';

            // Update role badge based on session role (host/guest) or config role (lead/member)
            const headerName = escapeHtml(session.displayName || 'User');
            if (permissions.sessionRole === 'host') {
                roleBadge.innerHTML = `<span class="font-semibold text-amber-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-amber-400 font-medium">Host</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-amber-500/10 border border-amber-500/20';
            } else if (permissions.sessionRole === 'guest') {
                roleBadge.innerHTML = `<span class="font-semibold text-blue-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-blue-400 font-medium">Guest</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-blue-500/10 border border-blue-500/20';
            } else if (permissions.role === 'lead') {
                roleBadge.innerHTML = `<span class="font-semibold text-amber-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-amber-400 font-medium">Lead</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-amber-500/10 border border-amber-500/20';
            } else {
                roleBadge.innerHTML = `<span class="font-semibold text-gray-300">${headerName}</span>
                    <span class="mx-1.5 text-gray-600">&middot;</span>
                    <span class="text-gray-400 font-medium">Member</span>`;
                roleBadge.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-gray-700/50 border border-gray-600/30';
            }

            // Show/hide lead-only actions: host or lead get full access
            if (isEffectiveLead || permissions.canCreateSummary) {
                leadActions.classList.remove('hidden');
                leadActions.classList.add('flex');
            } else {
                leadActions.classList.add('hidden');
                leadActions.classList.remove('flex');
            }

            // Individual button visibility ‚Äî host gets same access as lead
            btnCreateSummary.style.display = (permissions.canCreateSummary || isEffectiveLead) ? 'flex' : 'none';
            btnEndChat.style.display = isEffectiveLead ? 'flex' : 'none';

            // Show auto-apply toggle for leads/hosts
            if (permissions.canAutoApply || isEffectiveLead) {
                autoApplyToggleContainer.classList.remove('hidden');
                autoApplyToggleContainer.classList.add('flex');
            } else {
                autoApplyToggleContainer.classList.add('hidden');
                autoApplyToggleContainer.classList.remove('flex');
            }

            // Show room settings button for leads/hosts
            if (btnRoomSettings) {
                btnRoomSettings.classList.toggle('hidden', !isEffectiveLead);
            }
        }

        /**
         * Single render function ‚Äî deterministically updates the entire UI
         * based on the ConductorState. No conditional UI logic exists
         * outside this function.
         */
        function render(state, newSession) {
            const prevState = conductorState;
            conductorState = state;

            // Track if roomId changed (need to reconnect WebSocket)
            const prevRoomId = session.roomId;

            // Update session data if provided (e.g. after startHosting or joinSucceeded)
            if (newSession) {
                session = { ...session, ...newSession };
                if (roomIdDisplay && session.roomId) {
                    roomIdDisplay.textContent = session.roomId.substring(0, 8) + '...';
                    roomIdDisplay.title = session.roomId;
                }
            }

            const roomIdChanged = newSession && newSession.roomId && newSession.roomId !== prevRoomId;

            // --- 1. Hide every panel ----------------------------------------
            panelIdle.classList.add('hidden');
            panelIdle.classList.remove('flex');
            panelDisconnected.classList.add('hidden');
            panelDisconnected.classList.remove('flex');
            panelReady.classList.add('hidden');
            panelReady.classList.remove('flex');
            panelJoining.classList.add('hidden');
            panelJoining.classList.remove('flex');
            panelChat.classList.add('hidden');
            panelChat.classList.remove('flex');
            hostingControls.classList.add('hidden');
            hostingControls.classList.remove('flex');
            joinedControls.classList.add('hidden');
            joinedControls.classList.remove('flex');

            // --- 2. Show the panel for the current state --------------------
            if (state === 'Idle') {
                panelIdle.classList.remove('hidden');
                panelIdle.classList.add('flex');
            } else if (state === 'BackendDisconnected') {
                panelDisconnected.classList.remove('hidden');
                panelDisconnected.classList.add('flex');
            } else if (state === 'ReadyToHost') {
                panelReady.classList.remove('hidden');
                panelReady.classList.add('flex');
            } else if (state === 'Joining') {
                panelJoining.classList.remove('hidden');
                panelJoining.classList.add('flex');
            } else if (state === 'Hosting') {
                panelChat.classList.remove('hidden');
                panelChat.classList.add('flex');
                hostingControls.classList.remove('hidden');
                hostingControls.classList.add('flex');
            } else if (state === 'Joined') {
                panelChat.classList.remove('hidden');
                panelChat.classList.add('flex');
                joinedControls.classList.remove('hidden');
                joinedControls.classList.add('flex');
            }

            // --- 3. WebSocket lifecycle -------------------------------------
            const chatStates = ['Hosting', 'Joined'];
            const wasInChat = chatStates.includes(prevState);
            const nowInChat = chatStates.includes(state);

            if (nowInChat && !wasInChat) {
                // Entering chat state ‚Äî connect
                connectWebSocket();
            } else if (!nowInChat && wasInChat) {
                // Leaving chat state ‚Äî disconnect
                disconnectWebSocket();
            } else if (nowInChat && wasInChat && roomIdChanged) {
                // Staying in chat but roomId changed ‚Äî reconnect to new room
                console.log('[WebView] roomId changed, reconnecting WebSocket');
                disconnectWebSocket();
                connectWebSocket();
            }

            // Re-apply SSO identity state after panel switch
            if (ssoIdentity) {
                showSSOSignedInState(ssoIdentity, ssoProvider);
            }

            console.log('[WebView] render:', prevState, '‚Üí', state, roomIdChanged ? '(roomId changed)' : '');
        }

        /**
         * Disconnect the WebSocket if open.
         */
        function disconnectWebSocket() {
            if (ws) {
                console.log('[WebView] Disconnecting WebSocket');
                ws.close();
                ws = null;
            }
        }

        /**
         * Update the pending changes card UI.
         */
        function updatePendingChangesCard(changeSet, policy) {
            if (!changeSet) {
                pendingChangesCard.classList.add('hidden');
                return;
            }

            pendingChangesCard.classList.remove('hidden');

            // Update file count
            const filesCount = changeSet.changes ? changeSet.changes.length : 0;
            pendingFilesCount.querySelector('span').textContent = `${filesCount} file${filesCount !== 1 ? 's' : ''}`;

            // Update lines count
            let linesAdded = 0;
            let linesRemoved = 0;
            if (changeSet.changes) {
                for (const change of changeSet.changes) {
                    if (change.type === 'replace_range' && change.range) {
                        linesRemoved += change.range.end - change.range.start + 1;
                        linesAdded += (change.content || '').split('\n').length;
                    } else if (change.type === 'create_file') {
                        linesAdded += (change.content || '').split('\n').length;
                    }
                }
            }
            pendingLinesCount.innerHTML = `
                <span class="text-green-400">+${linesAdded}</span>
                <span class="text-red-400">-${linesRemoved}</span>
                <span>lines</span>
            `;

            // Update policy status
            if (policy) {
                if (policy.allowed) {
                    policyStatusIcon.textContent = '‚úì';
                    policyStatusIcon.className = 'text-green-400';
                    policyStatusText.textContent = 'Safe to apply';
                    policyStatusText.className = 'text-gray-300';
                    btnApplyChanges.disabled = false;
                    btnApplyChanges.className = 'flex-1 bg-green-600 hover:bg-green-700 text-white text-xs font-medium px-3 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1';
                } else {
                    policyStatusIcon.textContent = '‚ö†';
                    policyStatusIcon.className = 'text-amber-400';
                    policyStatusText.textContent = policy.reasons ? policy.reasons.join('; ') : 'Manual review required';
                    policyStatusText.className = 'text-amber-300';
                    // Still allow manual apply, but show warning
                    btnApplyChanges.disabled = false;
                    btnApplyChanges.className = 'flex-1 bg-amber-600 hover:bg-amber-700 text-white text-xs font-medium px-3 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1';
                }
            }
        }

        /**
         * Clear pending changes.
         */
        function clearPendingChanges() {
            pendingChangeSet = null;
            policyResult = null;
            currentChange = null;
            currentChangeIndex = 0;
            totalChanges = 0;
            pendingChangesCard.classList.add('hidden');
        }

        /**
         * Update UI for the current change being reviewed.
         */
        function updateCurrentChangeUI(change, index, total, policy) {
            if (!change) {
                pendingChangesCard.classList.add('hidden');
                return;
            }

            pendingChangesCard.classList.remove('hidden');
            currentChange = change;
            currentChangeIndex = index;
            totalChanges = total;
            policyResult = policy;

            // Update progress indicator (e.g., "1/3")
            changeProgress.textContent = `(${index + 1}/${total})`;

            // Update current file name
            currentFileName.textContent = change.file;
            currentFileInfo.classList.remove('hidden');

            // Update file count to show current/total
            pendingFilesCount.querySelector('span').textContent = `Change ${index + 1} of ${total}`;

            // Calculate lines for this single change
            let linesAdded = 0;
            let linesRemoved = 0;
            if (change.type === 'replace_range' && change.range) {
                linesRemoved = change.range.end - change.range.start + 1;
                linesAdded = (change.content || '').split('\n').length;
            } else if (change.type === 'create_file') {
                linesAdded = (change.content || '').split('\n').length;
            }
            pendingLinesCount.innerHTML = `
                <span class="text-green-400">+${linesAdded}</span>
                <span class="text-red-400">-${linesRemoved}</span>
                <span>lines</span>
            `;

            // Update policy status
            if (policy) {
                if (policy.allowed) {
                    policyStatusIcon.textContent = '‚úì';
                    policyStatusIcon.className = 'text-green-400';
                    policyStatusText.textContent = 'Safe to apply';
                    policyStatusText.className = 'text-gray-300';
                    btnApplyChanges.className = 'flex-1 bg-green-600 hover:bg-green-700 text-white text-xs font-medium px-3 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1';
                } else {
                    policyStatusIcon.textContent = '‚ö†';
                    policyStatusIcon.className = 'text-amber-400';
                    policyStatusText.textContent = policy.reasons ? policy.reasons.join('; ') : 'Manual review required';
                    policyStatusText.className = 'text-amber-300';
                    btnApplyChanges.className = 'flex-1 bg-amber-600 hover:bg-amber-700 text-white text-xs font-medium px-3 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1';
                }
            }

            btnApplyChanges.disabled = false;
        }

        // Handle messages from the extension
        window.addEventListener('message', event => {
            const message = event.data;
            console.log('Received message from extension:', message);
            switch (message.command) {
                case 'updatePermissions':
                    console.log('Updating permissions:', message.permissions);
                    updateUIForPermissions(message.permissions);
                    break;
                case 'showCurrentChange':
                    // Sequential review mode: show one change at a time
                    updateCurrentChangeUI(
                        message.currentChange,
                        message.currentIndex,
                        message.totalChanges,
                        message.policyResult
                    );

                    // If auto-apply is enabled and policy allows, apply automatically
                    if (autoApplyEnabled && message.policyResult && message.policyResult.allowed) {
                        vscode.postMessage({ command: 'applyChanges', changeSet: { changes: [message.currentChange] } });
                    }
                    break;
                case 'allChangesComplete':
                    // All changes have been reviewed
                    clearPendingChanges();
                    break;
                case 'changesGenerated':
                    // Legacy: Store the pending change set (kept for backwards compatibility)
                    pendingChangeSet = message.changeSet;
                    policyResult = message.policyResult;
                    // Don't call updatePendingChangesCard here anymore
                    // The showCurrentChange message will handle the UI update
                    break;
                case 'changesApplied':
                    // Single change applied, waiting for next showCurrentChange or allChangesComplete
                    break;
                case 'autoApplyState':
                    autoApplyEnabled = message.enabled;
                    autoApplyToggle.checked = autoApplyEnabled;
                    break;
                case 'endChatConfirmed':
                    handleEndChatConfirmed();
                    break;
                case 'conductorStateChanged':
                    // Restore SSO identity from extension's globalState if available
                    if (message.ssoIdentity && !ssoIdentity) {
                        ssoIdentity = message.ssoIdentity;
                        ssoProvider = message.ssoProvider || ssoProvider;
                    }
                    render(message.state, message.session);
                    break;
                case 'uploadFileResult':
                    handleUploadFileResult(message);
                    break;
                case 'codeSnippet':
                    // Received code snippet from extension (user selected code in editor)
                    handleCodeSnippetFromExtension(message);
                    break;
                case 'aiStatus':
                    // Received AI status from extension (proxied from backend)
                    console.log('[WebView] Received aiStatus:', message.data);
                    handleAiStatusResponse(message.data);
                    break;
                case 'setAiModelResult':
                    // Received result of setting AI model
                    console.log('[WebView] Received setAiModelResult:', message.data);
                    handleSetAiModelResult(message.data);
                    break;
                case 'summarizeResult':
                    // Received summarize result from extension
                    handleSummarizeResponse(message.data);
                    break;
                case 'codePromptResult':
                    // Received code prompt result from extension
                    handleCodePromptResponse(message.data);
                    break;
                case 'codePromptPostResult':
                    // Received code prompt post result from extension
                    handleCodePromptPostResponse(message.data);
                    break;
                case 'roomSettings':
                    // Received room settings from extension
                    handleRoomSettingsResponse(message.data);
                    break;
                case 'saveRoomSettingsResult':
                    // Received save room settings result from extension
                    handleSaveRoomSettingsResult(message.data);
                    break;
                case 'ssoLoginPending':
                    showSSOPendingState(message.userCode);
                    break;
                case 'ssoLoginResult':
                    if (message.identity) {
                        ssoIdentity = message.identity;
                        ssoProvider = message.provider || ssoProvider;
                        showSSOSignedInState(message.identity, message.provider);
                        const loginName = getSSODisplayName(message.identity);
                        if (loginName) session.displayName = loginName;
                        console.log('[WebView] SSO identity:', message.identity, 'provider:', message.provider);
                    } else {
                        showSSOSignInState();
                        if (message.error) {
                            console.warn('[WebView] SSO error:', message.error);
                        }
                    }
                    break;
                case 'ssoCacheCleared':
                    ssoIdentity = null;
                    ssoProvider = null;
                    session.displayName = 'User';
                    showSSOSignInState();
                    if (ssoHeaderBadge) {
                        ssoHeaderBadge.classList.add('hidden');
                    }
                    break;
                case 'ssoProvidersUpdate':
                    enabledProviders = message.providers;
                    applySSOProviderVisibility(enabledProviders);
                    break;
            }
        });

        /**
         * Handle file upload result from extension host
         */
        function handleUploadFileResult(message) {
            console.log('[WebView] Upload result received:', message);

            if (message.success) {
                const result = message.result;
                console.log('[WebView] File uploaded successfully:', result);
                console.log('[WebView] WebSocket state:', ws ? ws.readyState : 'null', '(OPEN=1)');

                // Send file message via WebSocket
                // SECURITY: userId and role are assigned by backend
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const fileMessage = {
                        type: 'file',
                        id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
                        displayName: session.displayName || 'User',
                        fileId: result.id,
                        originalFilename: result.original_filename,
                        fileType: result.file_type,
                        mimeType: result.mime_type,
                        sizeBytes: result.size_bytes,
                        downloadUrl: result.download_url,
                        caption: pendingUploadCaption,
                        ts: Date.now() / 1000
                    };

                    console.log('[WebView] Sending file message via WebSocket:', fileMessage);
                    ws.send(JSON.stringify(fileMessage));
                    console.log('[WebView] File message sent successfully');
                } else {
                    console.error('[WebView] Cannot send file message: WebSocket not open. ws:', ws, 'readyState:', ws?.readyState);
                }

                // Clear preview after successful upload
                clearFilePreview();
                pendingUploadCaption = null;
                console.log('[WebView] File upload complete, preview cleared');
            } else {
                console.error('[WebView] File upload failed:', message.error);
                alert(`File upload failed: ${message.error}`);
                // Reset upload state but keep preview so user can retry
                isUploading = false;
                btnUploadFile.disabled = false;
                btnUploadFile.textContent = '‚¨ÜÔ∏è Upload';
            }
        }

        // ----- Conductor session button handlers -----

        // Idle panel: Start (triggers health check ‚Üí ReadyToHost ‚Üí startSession)
        btnIdleStart.addEventListener('click', () => {
            vscode.postMessage({ command: 'startSession' });
        });

        // Idle panel: Join (paste invite URL)
        btnIdleJoin.addEventListener('click', () => {
            const url = inviteUrlInput.value.trim();
            if (!url) { return; }
            vscode.postMessage({ command: 'joinSession', inviteUrl: url });
            inviteUrlInput.value = '';
        });

        // BackendDisconnected panel: Retry
        btnRetry.addEventListener('click', () => {
            vscode.postMessage({ command: 'retryConnection' });
        });

        // BackendDisconnected panel: Join (paste invite URL)
        btnDisconnectedJoin.addEventListener('click', () => {
            const url = disconnectedInviteUrlInput.value.trim();
            if (!url) { return; }
            vscode.postMessage({ command: 'joinSession', inviteUrl: url });
            disconnectedInviteUrlInput.value = '';
        });

        // ReadyToHost panel: Start Session
        btnStartSession.addEventListener('click', () => {
            vscode.postMessage({ command: 'startSession' });
        });

        // ReadyToHost panel: Join (paste invite URL)
        btnReadyJoin.addEventListener('click', () => {
            const url = readyInviteUrlInput.value.trim();
            if (!url) { return; }
            vscode.postMessage({ command: 'joinSession', inviteUrl: url });
            readyInviteUrlInput.value = '';
        });

        // Hosting: Stop + Copy Invite
        btnStopSession.addEventListener('click', () => {
            vscode.postMessage({ command: 'stopSession' });
        });

        btnCopyInvite.addEventListener('click', () => {
            vscode.postMessage({ command: 'copyInviteLink' });
        });

        // Joined: Leave
        btnLeaveSession.addEventListener('click', () => {
            vscode.postMessage({ command: 'leaveSession' });
        });

        // Button click handlers
        btnCreateSummary.addEventListener('click', () => {
            // Use the same summary functionality as the sidebar button
            requestSummarize();
        });

        // Auto-apply toggle handler
        autoApplyToggle.addEventListener('change', (e) => {
            autoApplyEnabled = e.target.checked;
            vscode.postMessage({ command: 'setAutoApply', enabled: autoApplyEnabled });
        });

        // Pending changes card button handlers
        btnViewDiff.addEventListener('click', () => {
            // View diff for current change only
            if (currentChange) {
                vscode.postMessage({ command: 'viewDiff', changeSet: { changes: [currentChange], summary: '' } });
            } else if (pendingChangeSet) {
                vscode.postMessage({ command: 'viewDiff', changeSet: pendingChangeSet });
            }
        });

        btnApplyChanges.addEventListener('click', () => {
            // Apply current change only (the extension handles the queue)
            if (currentChange) {
                vscode.postMessage({ command: 'applyChanges', changeSet: { changes: [currentChange], summary: '' } });
            } else if (pendingChangeSet) {
                vscode.postMessage({ command: 'applyChanges', changeSet: pendingChangeSet });
            }
        });

        btnDiscardChanges.addEventListener('click', () => {
            clearPendingChanges();
            vscode.postMessage({ command: 'discardChanges' });
        });

        // Initialize with permissions from the extension
        if (window.initialPermissions) {
            updateUIForPermissions(window.initialPermissions);
        } else {
            // Request permissions if not injected
            vscode.postMessage({ command: 'getPermissions' });
        }

        // Request auto-apply state
        vscode.postMessage({ command: 'getAutoApplyState' });

        // =====================================================
        // WebSocket Chat Implementation
        // =====================================================

        // Intersection Observer for read receipts
        let messageReadObserver = null;
        const readMessageIds = new Set();  // Track which messages we've already sent read receipts for

        /**
         * Initialize Intersection Observer for read receipts.
         * Called once when messages container is available.
         */
        function initReadReceiptObserver() {
            if (messageReadObserver) return;  // Already initialized

            messageReadObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const messageId = entry.target.getAttribute('data-message-id');
                        if (messageId && !readMessageIds.has(messageId)) {
                            readMessageIds.add(messageId);
                            sendReadReceipt(messageId);
                            // Stop observing this message
                            messageReadObserver.unobserve(entry.target);
                        }
                    }
                });
            }, {
                root: messagesContainer,
                threshold: 0.5  // Message is 50% visible
            });
        }

        // Initialize observer when DOM is ready
        initReadReceiptObserver();

        /**
         * Format timestamp for display
         */
        function formatTime(ts) {
            const date = new Date(ts * 1000);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Get initials from a display name
         */
        function getInitials(name) {
            const parts = name.includes('.') && !name.includes(' ')
                ? name.split('.') : name.split(' ');
            return parts.map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function buildNameAndRole(displayName, role, identitySource) {
            const nameColor = role === 'host' ? 'name-host' : 'name-guest';
            const pill = role === 'host'
                ? '<span class="role-pill role-pill-host ml-1.5">host</span>' : '';
            const ssoPill = identitySource === 'sso'
                ? '<span class="role-pill role-pill-sso ml-1">SSO</span>' : '';
            const nameHtml = `<div class="flex items-center gap-1 mb-1 ml-1">
                <span class="text-xs font-semibold ${nameColor}">${escapeHtml(displayName)}</span>${pill}${ssoPill}</div>`;
            const bubbleAccent = role === 'host' ? 'bubble-host' : 'bubble-guest';
            return { nameHtml, bubbleAccent };
        }

        /**
         * Render the users list in the sidebar with enhanced status display
         */
        function renderUsersList(users) {
            usersMap.clear();
            users.forEach(u => usersMap.set(u.userId, u));

            // Update count badge
            userCount.textContent = users.length;

            // Update room ID display if available
            if (session.roomId) {
                const roomIdDisplay = document.getElementById('room-id-display');
                const shortId = session.roomId.slice(0, 8);
                roomIdDisplay.innerHTML = `Room: <span class="text-gray-400 font-mono">${shortId}...</span>`;
                roomIdDisplay.title = session.roomId;
            }

            // Determine if current user can transfer lead (host or current lead)
            const myIsHost = session.sessionRole === 'host';
            const myIsLead = session.userId === session.leadId;
            const canTransferLead = myIsHost || myIsLead;

            usersList.innerHTML = users.map(user => {
                const colorClass = avatarColors[user.avatarColor] || 'bg-purple-600';
                const isHost = user.role === 'host';
                const isMe = user.userId === session.userId;
                const isTyping = typingUsers.has(user.userId);
                const isUserLead = user.userId === session.leadId;

                // Role pill
                const rolePill = isHost
                    ? '<span class="role-pill role-pill-host">host</span>'
                    : '<span class="role-pill role-pill-guest">member</span>';

                // Lead pill
                const leadPill = isUserLead
                    ? '<span class="role-pill" style="background:rgba(168,85,247,0.15);color:#c084fc;">&#9733; lead</span>'
                    : '';

                // SSO pill
                const ssoPill = user.identitySource === 'sso'
                    ? '<span class="role-pill role-pill-sso">SSO</span>'
                    : '';

                // Transfer Lead button (shown to host/lead, not on self, not on current lead)
                const transferBtn = (canTransferLead && !isMe && !isUserLead)
                    ? `<button class="transfer-lead-btn ml-auto text-xs text-purple-400 hover:text-purple-300 hover:bg-purple-500/10 px-1.5 py-0.5 rounded transition-colors" data-target-id="${escapeHtml(user.userId)}" title="Transfer lead to ${escapeHtml(user.displayName)}">Make Lead</button>`
                    : '';

                // Status indicator
                const statusDot = isTyping
                    ? '<span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-blue-500 rounded-full animate-pulse"></span>'
                    : '<span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border border-gray-800"></span>';

                // Typing status text
                const typingText = isTyping
                    ? '<span class="text-xs text-blue-400 italic">typing...</span>'
                    : '';

                const nameColor = isHost ? 'text-amber-300' : (isUserLead ? 'text-purple-300' : 'text-gray-200');

                return `
                    <div class="user-item flex items-center gap-2 p-2 rounded-lg transition-colors ${isMe ? 'ring-1 ring-gray-600/50' : 'hover:bg-gray-700/30'}" data-user-id="${escapeHtml(user.userId)}">
                        <div class="relative flex-shrink-0">
                            <div class="w-8 h-8 ${colorClass} rounded-full flex items-center justify-center text-white text-xs font-medium shadow-sm">
                                ${getInitials(user.displayName)}
                            </div>
                            ${statusDot}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center">
                                <span class="text-sm ${nameColor} truncate font-medium">${escapeHtml(user.displayName)}</span>
                                ${isMe ? '<span class="ml-1 text-xs text-gray-500">you</span>' : ''}
                                ${transferBtn}
                            </div>
                            <div class="flex items-center gap-1 mt-0.5">
                                ${rolePill}
                                ${leadPill}
                                ${ssoPill}
                                ${typingText}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Attach click handlers for transfer lead buttons
            usersList.querySelectorAll('.transfer-lead-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const targetId = btn.getAttribute('data-target-id');
                    if (ws && ws.readyState === WebSocket.OPEN && targetId) {
                        ws.send(JSON.stringify({ type: 'transfer_lead', targetUserId: targetId }));
                    }
                });
            });
        }

        /**
         * Format file size for display
         */
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        /**
         * Get file icon based on file type.
         * @param {string} fileType - File type (image, pdf, audio, other).
         * @returns {string} Emoji icon for the file type.
         */
        function getFileIcon(fileType) {
            switch (fileType) {
                case 'image': return 'üñºÔ∏è';
                case 'pdf': return 'üìÑ';
                case 'audio': return 'üéµ';
                default: return 'üìé';
            }
        }

        /**
         * Format a date for display as a date separator.
         * @param {Date} date - The date to format.
         * @returns {string} Formatted date string (e.g., "Today", "Yesterday", or "Feb 7, 2026").
         */
        function formatDateSeparator(date) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
            }
        }

        /**
         * Render a date separator in the messages container.
         * @param {Date} date - The date for the separator.
         */
        function renderDateSeparator(date) {
            const div = document.createElement('div');
            div.className = 'flex justify-center my-4';
            div.innerHTML = `
                <span class="text-xs text-gray-500 bg-gray-800 px-3 py-1 rounded-full border border-gray-700">
                    ${formatDateSeparator(date)}
                </span>
            `;
            messagesContainer.appendChild(div);
        }

        /**
         * Update the typing indicator display.
         * Shows which users are currently typing.
         */
        function updateTypingIndicator() {
            if (typingUsers.size === 0) {
                typingIndicator.classList.add('hidden');
                return;
            }

            const names = Array.from(typingUsers.values());
            let text;
            if (names.length === 1) {
                text = `${names[0]} is typing...`;
            } else if (names.length === 2) {
                text = `${names[0]} and ${names[1]} are typing...`;
            } else {
                text = `${names[0]} and ${names.length - 1} others are typing...`;
            }

            typingText.textContent = text;
            typingIndicator.classList.remove('hidden');
        }

        /**
         * Handle incoming typing indicator from another user.
         * Updates both the typing indicator and user list to show typing status.
         * @param {Object} data - Typing event data with userId, displayName, isTyping.
         */
        function handleTypingEvent(data) {
            if (data.isTyping) {
                typingUsers.set(data.userId, data.displayName);
                // Auto-expire after TYPING_EXPIRE_MS
                setTimeout(() => {
                    typingUsers.delete(data.userId);
                    updateTypingIndicator();
                    updateUserTypingStatus(data.userId, false);
                }, TYPING_EXPIRE_MS);
            } else {
                typingUsers.delete(data.userId);
            }
            updateTypingIndicator();
            updateUserTypingStatus(data.userId, data.isTyping);
        }

        /**
         * Update a specific user's typing status in the user list
         * without re-rendering the entire list
         */
        function updateUserTypingStatus(userId, isTyping) {
            const userItem = usersList.querySelector(`[data-user-id="${userId}"]`);
            if (!userItem) return;

            // Update status dot
            const statusDot = userItem.querySelector('.absolute');
            if (statusDot) {
                if (isTyping) {
                    statusDot.className = 'absolute bottom-0 right-0 w-2.5 h-2.5 bg-blue-500 rounded-full animate-pulse';
                } else {
                    statusDot.className = 'absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border border-gray-800';
                }
            }

            // Update typing text
            const statusTextContainer = userItem.querySelector('.flex.items-center.gap-1.mt-0\\.5');
            if (statusTextContainer) {
                const existingTyping = statusTextContainer.querySelector('.italic');
                if (isTyping && !existingTyping) {
                    const typingSpan = document.createElement('span');
                    typingSpan.className = 'text-xs text-blue-400 italic';
                    typingSpan.textContent = 'typing...';
                    statusTextContainer.appendChild(typingSpan);
                } else if (!isTyping && existingTyping) {
                    existingTyping.remove();
                }
            }
        }

        /**
         * Send typing indicator to other users (debounced).
         * @param {boolean} isTyping - Whether the user is currently typing.
         */
        function sendTypingIndicator(isTyping) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            // SECURITY: Backend uses assigned userId, we only send displayName
            ws.send(JSON.stringify({
                type: 'typing',
                displayName: session.displayName || 'Host',
                isTyping: isTyping
            }));
        }

        /**
         * Check if user is scrolled near the bottom of messages.
         * @returns {boolean} True if within SCROLL_THRESHOLD of bottom.
         */
        function isNearBottom() {
            const { scrollTop, scrollHeight, clientHeight } = messagesContainer;
            return scrollHeight - scrollTop - clientHeight < SCROLL_THRESHOLD;
        }

        /**
         * Update scroll-to-bottom button visibility and unread count.
         */
        function updateScrollButton() {
            if (isUserScrolledUp) {
                scrollToBottomBtn.classList.remove('hidden');
                if (unreadCount > 0) {
                    unreadCountBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    unreadCountBadge.classList.remove('hidden');
                } else {
                    unreadCountBadge.classList.add('hidden');
                }
            } else {
                scrollToBottomBtn.classList.add('hidden');
                unreadCount = 0;
            }
        }

        /**
         * Scroll to the bottom of messages container.
         * @param {boolean} force - Force scroll even if user scrolled up.
         */
        function scrollToBottom(force = true) {
            if (force || !isUserScrolledUp) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                isUserScrolledUp = false;
                unreadCount = 0;
                updateScrollButton();
            }
        }

        /**
         * Smart scroll: scroll to bottom if user is near bottom, otherwise increment unread.
         * @param {boolean} isOwnMessage - True if this is the current user's message.
         */
        function smartScroll(isOwnMessage = false) {
            if (isOwnMessage || !isUserScrolledUp) {
                scrollToBottom(true);
            } else {
                unreadCount++;
                updateScrollButton();
            }
        }

        /**
         * Handle scroll event on messages container.
         * Triggers pagination when scrolled near top.
         */
        function handleScroll() {
            isUserScrolledUp = !isNearBottom();
            if (!isUserScrolledUp) {
                unreadCount = 0;
            }
            updateScrollButton();

            // Trigger pagination when scrolled near top
            if (messagesContainer.scrollTop < PAGINATION_THRESHOLD && hasMoreHistory && !isLoadingHistory) {
                loadMoreHistory();
            }
        }

        /**
         * Handle input event for typing indicator.
         * Debounces typing indicator messages and auto-resizes textarea.
         */
        function handleInputEvent() {
            const now = Date.now();

            // Auto-resize textarea
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px';

            // Send typing indicator (debounced)
            if (!isTyping) {
                isTyping = true;
                sendTypingIndicator(true);
            }
            lastTypingTime = now;

            // Clear existing timeout and set new one
            if (typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                if (Date.now() - lastTypingTime >= TYPING_DEBOUNCE_MS && isTyping) {
                    isTyping = false;
                    sendTypingIndicator(false);
                }
            }, TYPING_DEBOUNCE_MS);
        }

        /**
         * Check if a message should be grouped with the previous message.
         * Messages from the same user within MESSAGE_GROUP_INTERVAL_MS are grouped.
         * @param {Object} msg - Message object with userId and ts.
         * @returns {boolean} True if message should be grouped.
         */
        function shouldGroupMessage(msg) {
            const msgTime = msg.ts * 1000;
            const sameUser = msg.userId === lastMessageUserId;
            const withinInterval = (msgTime - lastMessageTime) < MESSAGE_GROUP_INTERVAL_MS;
            return sameUser && withinInterval;
        }

        /**
         * Check if a date separator is needed before this message.
         * @param {Object} msg - Message object with ts timestamp.
         * @returns {boolean} True if a date separator should be rendered.
         */
        function needsDateSeparator(msg) {
            const msgDate = new Date(msg.ts * 1000);
            const msgDateStr = msgDate.toDateString();

            if (lastMessageDate !== msgDateStr) {
                lastMessageDate = msgDateStr;
                return true;
            }
            return false;
        }

        /**
         * Render a code snippet message in the UI.
         * @param {Object} msg - Message object with codeSnippet data.
         */
        function renderCodeSnippetMessage(msg) {
            // Store code snippet message for summarization
            const snippet = msg.codeSnippet || {};
            const lineInfo = snippet.startLine === snippet.endLine
                ? `Line ${snippet.startLine}`
                : `Lines ${snippet.startLine}-${snippet.endLine}`;
            const snippetText = `[Code Snippet: ${snippet.relativePath || snippet.filename || 'code'} ${lineInfo}]\n${snippet.code || ''}${msg.content ? '\nComment: ' + msg.content : ''}`;
            const apiRole = msg.role === 'host' ? 'host' : 'engineer';
            chatMessages.push({
                role: apiRole,
                text: snippetText,
                timestamp: msg.ts || Date.now() / 1000
            });

            const isOwnMessage = msg.userId === session.userId;
            const isGrouped = shouldGroupMessage(msg);

            // Update grouping state for next message
            lastMessageUserId = msg.userId;
            lastMessageTime = msg.ts * 1000;

            const div = document.createElement('div');
            div.setAttribute('data-message-id', msg.id || '');
            div.setAttribute('data-timestamp', msg.ts || '');
            div.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} gap-2 ${isGrouped ? 'mt-1' : ''}`;

            const timeAlign = isOwnMessage ? 'text-right' : '';
            const displayName = msg.displayName || usersMap.get(msg.userId)?.displayName || 'Unknown';
            const idSource = msg.identitySource || usersMap.get(msg.userId)?.identitySource;
            const { nameHtml, bubbleAccent } = buildNameAndRole(displayName, msg.role, idSource);

            // Get avatar color from users map or default
            const userInfo = usersMap.get(msg.userId);
            const colorClass = userInfo ? (avatarColors[userInfo.avatarColor] || 'bg-purple-600') : 'bg-gray-600';

            // Hide avatar and name for grouped messages
            const avatarHtml = (!isOwnMessage && !isGrouped) ? `
                <div class="w-7 h-7 ${colorClass} rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 mt-1">
                    ${getInitials(displayName)}
                </div>
            ` : (!isOwnMessage && isGrouped) ? '<div class="w-7 flex-shrink-0"></div>' : '';

            const showName = !isOwnMessage && !isGrouped;

            // Status indicator for own messages
            const statusHtml = isOwnMessage ? '<span class="message-status text-blue-300 ml-1">‚úì</span>' : '';

            // Comment text if any
            const commentHtml = msg.content ? `
                <p class="text-sm leading-relaxed break-words whitespace-pre-wrap mb-2">${escapeHtml(msg.content)}</p>
            ` : '';

            // Generate unique ID for the navigate button
            const navigateBtnId = `nav-btn-${msg.id || Date.now()}`;

            div.innerHTML = `
                ${avatarHtml}
                <div class="max-w-[85%] min-w-0">
                    ${showName ? nameHtml : ''}
                    <div class="bg-gray-800 rounded-lg overflow-hidden border border-gray-700 shadow-lg ${!isOwnMessage ? bubbleAccent : ''}">
                        ${commentHtml ? `<div class="px-4 py-2 border-b border-gray-700">${commentHtml}</div>` : ''}
                        <div class="flex items-center justify-between px-3 py-2 bg-gray-700/50 border-b border-gray-600">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                <span class="text-xs text-gray-300 font-mono truncate max-w-[180px]" title="${escapeHtml(snippet.filename || '')}">${escapeHtml(snippet.relativePath || snippet.filename || 'code')}</span>
                                <span class="text-xs text-gray-500">${lineInfo}</span>
                            </div>
                            <button id="${navigateBtnId}" class="navigate-to-code-btn p-1 rounded hover:bg-gray-600 transition-colors" title="Go to code location">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 hover:text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <pre class="code-snippet-plain p-3 text-xs font-mono text-gray-300 overflow-x-auto max-h-48 overflow-y-auto">${escapeHtml(snippet.code || '')}</pre>
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5 ${timeAlign} ${isOwnMessage ? 'mr-1' : 'ml-1'} flex items-center ${isOwnMessage ? 'justify-end' : ''}">
                        <span>${formatTime(msg.ts)}</span>${statusHtml}
                    </div>
                </div>
            `;

            // Add click handler for navigate button after element is added to DOM
            messagesContainer.appendChild(div);

            const navigateBtn = document.getElementById(navigateBtnId);
            if (navigateBtn) {
                navigateBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    vscode.postMessage({
                        command: 'navigateToCode',
                        relativePath: snippet.relativePath || snippet.filename,
                        startLine: snippet.startLine,
                        endLine: snippet.endLine
                    });
                });
            }

            smartScroll(isOwnMessage);

            // Observe for read receipts (only for messages from others)
            if (!isOwnMessage && msg.id && messageReadObserver) {
                messageReadObserver.observe(div);
            }
        }

        /**
         * Render an AI summary message in the UI.
         * Shows structured summary with special styling and "Generate Code Prompt" button for hosts.
         * @param {Object} msg - AI summary message object with aiData containing summary fields.
         */
        function renderAiSummaryMessage(msg) {
            // Check if we need a date separator
            if (needsDateSeparator(msg)) {
                renderDateSeparator(new Date(msg.ts * 1000));
            }

            // Update grouping state
            lastMessageUserId = msg.userId;
            lastMessageTime = msg.ts * 1000;

            const div = document.createElement('div');
            div.setAttribute('data-message-id', msg.id || '');
            div.setAttribute('data-timestamp', msg.ts || '');
            div.className = 'flex justify-start gap-2';

            const aiData = msg.aiData || {};
            const riskLevel = aiData.risk_level || 'low';
            const components = aiData.affected_components || [];
            const steps = aiData.next_steps || [];

            // Risk badge color
            let riskBadgeClass = 'bg-green-600';
            if (riskLevel === 'high') riskBadgeClass = 'bg-red-600';
            else if (riskLevel === 'medium') riskBadgeClass = 'bg-yellow-600';

            // Components HTML
            const componentsHtml = components.length > 0 ? `
                <div class="mt-3">
                    <div class="text-xs font-medium text-gray-400 mb-1">Affected Components:</div>
                    <div class="flex flex-wrap gap-1">
                        ${components.map(c => `<span class="px-2 py-0.5 bg-gray-700 text-gray-300 text-xs rounded">${escapeHtml(c)}</span>`).join('')}
                    </div>
                </div>
            ` : '';

            // Next steps HTML
            const stepsHtml = steps.length > 0 ? `
                <div class="mt-3">
                    <div class="text-xs font-medium text-gray-400 mb-1">Next Steps:</div>
                    <ul class="list-disc list-inside text-sm text-gray-300 space-y-0.5">
                        ${steps.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                    </ul>
                </div>
            ` : '';

            // Generate Code Prompt button - only shown to lead when requires_code_change is true
            const isUserLead = session.userId === session.leadId;
            const showCodePromptBtn = isUserLead && aiData.requires_code_change;
            const codePromptBtnId = `gen-code-btn-${msg.id || Date.now()}`;
            const codePromptBtnHtml = showCodePromptBtn ? `
                <div class="mt-4 pt-3 border-t border-gray-600">
                    <button id="${codePromptBtnId}" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Generate Code Prompt
                    </button>
                </div>
            ` : '';

            div.innerHTML = `
                <div class="w-7 h-7 bg-purple-600 rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 mt-1">
                    ü§ñ
                </div>
                <div class="max-w-[85%] min-w-0 flex-1">
                    <div class="text-xs text-gray-400 mb-1 ml-1">ü§ñ ${escapeHtml(msg.displayName || 'AI')}</div>
                    <div class="bg-gradient-to-br from-purple-900/50 to-gray-800 rounded-lg overflow-hidden border border-purple-700/50 shadow-lg">
                        <div class="px-4 py-3 bg-purple-800/30 border-b border-purple-700/50 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-sm font-medium text-purple-200">AI Summary</span>
                        </div>
                        <div class="p-4 space-y-3">
                            <div>
                                <div class="text-xs font-medium text-gray-400 mb-1">Topic:</div>
                                <div class="text-sm font-semibold text-white">${escapeHtml(aiData.topic || 'No topic')}</div>
                            </div>
                            <div>
                                <div class="text-xs font-medium text-gray-400 mb-1">Problem Statement:</div>
                                <div class="text-sm text-gray-200">${escapeHtml(aiData.problem_statement || 'No problem statement')}</div>
                            </div>
                            <div>
                                <div class="text-xs font-medium text-gray-400 mb-1">Proposed Solution:</div>
                                <div class="text-sm text-gray-200">${escapeHtml(aiData.proposed_solution || 'No solution proposed')}</div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div>
                                    <div class="text-xs font-medium text-gray-400 mb-1">Risk Level:</div>
                                    <span class="px-2 py-0.5 rounded text-xs font-medium ${riskBadgeClass} text-white">${riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1)}</span>
                                </div>
                                ${aiData.requires_code_change ? `
                                <div>
                                    <div class="text-xs font-medium text-gray-400 mb-1">Code Change:</div>
                                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-blue-600 text-white">Required</span>
                                </div>
                                ` : ''}
                            </div>
                            ${componentsHtml}
                            ${stepsHtml}
                        </div>
                        ${codePromptBtnHtml}
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5 ml-1">
                        <span>${formatTime(msg.ts)}</span>
                    </div>
                </div>
            `;

            messagesContainer.appendChild(div);

            // Add click handler for Generate Code Prompt button
            if (showCodePromptBtn) {
                const codePromptBtn = document.getElementById(codePromptBtnId);
                if (codePromptBtn) {
                    codePromptBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Store the AI data for code prompt generation
                        currentSummaryData = aiData;
                        // Store the button ID for later update
                        currentCodePromptButtonId = codePromptBtnId;
                        // Request code prompt generation
                        vscode.postMessage({
                            command: 'generateCodePromptAndPost',
                            decisionSummary: aiData,
                            roomId: session.roomId
                        });
                        // Disable button and show loading state
                        codePromptBtn.disabled = true;
                        codePromptBtn.innerHTML = `
                            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Generating...
                        `;
                    });
                }
            }

            smartScroll(false);
        }

        /**
         * Render an AI code prompt message in the UI.
         * Shows code prompt with copy button and special styling.
         * @param {Object} msg - AI code prompt message object.
         */
        function renderAiCodePromptMessage(msg) {
            // Check if we need a date separator
            if (needsDateSeparator(msg)) {
                renderDateSeparator(new Date(msg.ts * 1000));
            }

            // Update grouping state
            lastMessageUserId = msg.userId;
            lastMessageTime = msg.ts * 1000;

            const div = document.createElement('div');
            div.setAttribute('data-message-id', msg.id || '');
            div.setAttribute('data-timestamp', msg.ts || '');
            div.className = 'flex justify-start gap-2';

            const copyBtnId = `copy-prompt-btn-${msg.id || Date.now()}`;

            div.innerHTML = `
                <div class="w-7 h-7 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 mt-1">
                    ü§ñ
                </div>
                <div class="max-w-[85%] min-w-0 flex-1">
                    <div class="text-xs text-gray-400 mb-1 ml-1">ü§ñ ${escapeHtml(msg.displayName || 'AI')}</div>
                    <div class="bg-gradient-to-br from-blue-900/50 to-gray-800 rounded-lg overflow-hidden border border-blue-700/50 shadow-lg">
                        <div class="px-4 py-3 bg-blue-800/30 border-b border-blue-700/50 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                <span class="text-sm font-medium text-blue-200">Code Generation Prompt</span>
                            </div>
                            <button id="${copyBtnId}" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded transition-colors flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                                </svg>
                                Copy
                            </button>
                        </div>
                        <div class="p-4">
                            <pre class="text-sm text-gray-200 whitespace-pre-wrap font-mono bg-gray-900/50 p-3 rounded border border-gray-700 max-h-96 overflow-y-auto">${escapeHtml(msg.content || '')}</pre>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5 ml-1">
                        <span>${formatTime(msg.ts)}</span>
                    </div>
                </div>
            `;

            messagesContainer.appendChild(div);

            // Add click handler for copy button
            const copyBtn = document.getElementById(copyBtnId);
            if (copyBtn) {
                copyBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    try {
                        await navigator.clipboard.writeText(msg.content || '');
                        copyBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                            Copied!
                        `;
                        setTimeout(() => {
                            copyBtn.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                                </svg>
                                Copy
                            `;
                        }, 2000);
                    } catch (err) {
                        console.error('[WebView] Failed to copy:', err);
                    }
                });
            }

            smartScroll(false);
        }

        /**
         * Render a file message in the UI.
         * @param {Object} msg - File message object.
         */
        function renderFileMessage(msg) {
            const isOwnMessage = msg.userId === session.userId;
            const div = document.createElement('div');
            div.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} gap-2`;

            const timeAlign = isOwnMessage ? 'text-right' : '';
            const displayName = msg.displayName || usersMap.get(msg.userId)?.displayName || 'Unknown';
            const idSource = msg.identitySource || usersMap.get(msg.userId)?.identitySource;
            const { nameHtml, bubbleAccent } = buildNameAndRole(displayName, msg.role, idSource);

            // Get avatar color from users map or default
            const userInfo = usersMap.get(msg.userId);
            const colorClass = userInfo ? (avatarColors[userInfo.avatarColor] || 'bg-purple-600') : 'bg-gray-600';

            const avatarHtml = !isOwnMessage ? `
                <div class="w-7 h-7 ${colorClass} rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 mt-1">
                    ${getInitials(displayName)}
                </div>
            ` : '';

            // Build file content based on type
            let fileContentHtml = '';
            const filename = escapeHtml(msg.originalFilename || 'file');
            const fileSize = formatFileSize(msg.sizeBytes || 0);
            const downloadUrl = msg.downloadUrl || '';

            // Store file info for download handler (will be attached after innerHTML is set)
            const fileInfo = {
                fileId: msg.fileId,
                fileName: msg.originalFilename || 'file',
                downloadUrl: downloadUrl
            };

            if (msg.fileType === 'image') {
                // Image: show inline preview with download on click
                fileContentHtml = `
                    <div class="file-attachment">
                        <img src="${downloadUrl}" alt="${filename}"
                             class="max-w-full max-h-64 rounded-lg cursor-pointer hover:opacity-90 transition-opacity file-download-trigger"
                             data-file-id="${escapeHtml(msg.fileId || '')}"
                             data-file-name="${escapeHtml(msg.originalFilename || 'file')}"
                             data-download-url="${escapeHtml(downloadUrl)}"
                             onerror="this.onerror=null; this.src=''; this.alt='Image failed to load';" />
                        <div class="flex items-center gap-2 mt-2 text-xs text-gray-400">
                            <span>${filename}</span>
                            <span>¬∑</span>
                            <span>${fileSize}</span>
                            <span class="text-blue-400 cursor-pointer hover:underline file-download-trigger"
                                  data-file-id="${escapeHtml(msg.fileId || '')}"
                                  data-file-name="${escapeHtml(msg.originalFilename || 'file')}"
                                  data-download-url="${escapeHtml(downloadUrl)}">üì• Download</span>
                        </div>
                    </div>
                `;
            } else {
                // Other files: show download link
                const icon = getFileIcon(msg.fileType);
                fileContentHtml = `
                    <div class="file-attachment flex items-center gap-3 p-3 bg-gray-900/50 rounded-lg hover:bg-gray-900 transition-colors border border-gray-600 cursor-pointer file-download-trigger"
                         data-file-id="${escapeHtml(msg.fileId || '')}"
                         data-file-name="${escapeHtml(msg.originalFilename || 'file')}"
                         data-download-url="${escapeHtml(downloadUrl)}">
                        <span class="text-3xl">${icon}</span>
                        <div class="min-w-0 flex-1">
                            <div class="font-medium text-sm text-gray-200 truncate">${filename}</div>
                            <div class="text-xs text-gray-500">${fileSize}</div>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                `;
            }

            // Add caption if present
            const captionHtml = msg.caption ? `<p class="text-sm mt-2">${escapeHtml(msg.caption)}</p>` : '';

            div.innerHTML = `
                ${avatarHtml}
                <div class="max-w-[75%] min-w-0">
                    ${!isOwnMessage ? nameHtml : ''}
                    <div class="bg-gray-800 text-gray-100 rounded-2xl ${isOwnMessage ? 'rounded-tr-sm' : 'rounded-tl-sm'} px-4 py-3 shadow-lg overflow-hidden border border-gray-700 ${!isOwnMessage ? bubbleAccent : ''}">
                        ${fileContentHtml}
                        ${captionHtml}
                    </div>
                    <div class="text-xs text-gray-500 mt-1 ${timeAlign} ${isOwnMessage ? 'mr-1' : 'ml-1'}">${formatTime(msg.ts)}</div>
                </div>
            `;

            messagesContainer.appendChild(div);
            smartScroll(isOwnMessage);

            // Attach click handlers to download triggers
            div.querySelectorAll('.file-download-trigger').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const fileId = el.getAttribute('data-file-id');
                    const fileName = el.getAttribute('data-file-name');
                    const downloadUrl = el.getAttribute('data-download-url');

                    console.log('[WebView] Download requested:', { fileId, fileName, downloadUrl });

                    vscode.postMessage({
                        command: 'downloadFile',
                        fileId: fileId,
                        fileName: fileName,
                        downloadUrl: downloadUrl
                    });
                });
            });
        }

        /**
         * Render a chat message in the UI.
         * Includes message grouping and status indicators.
         * @param {Object} msg - Message object with id, userId, displayName, role, content, ts.
         */
        function renderMessage(msg) {
            // Store message for summarization (only text messages)
            if (msg.content) {
                // Map msg.role to API format: 'host' stays 'host', everything else is 'engineer'
                const apiRole = msg.role === 'host' ? 'host' : 'engineer';
                chatMessages.push({
                    role: apiRole,
                    text: msg.content,
                    timestamp: msg.ts || Date.now() / 1000
                });
            }

            // Check if we need a date separator
            if (needsDateSeparator(msg)) {
                renderDateSeparator(new Date(msg.ts * 1000));
            }

            const isOwnMessage = msg.userId === session.userId;
            const isGrouped = shouldGroupMessage(msg);

            // Update grouping state for next message
            lastMessageUserId = msg.userId;
            lastMessageTime = msg.ts * 1000;

            const div = document.createElement('div');
            div.setAttribute('data-message-id', msg.id || '');
            div.setAttribute('data-timestamp', msg.ts || '');
            // Reduce spacing for grouped messages
            div.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} gap-2 ${isGrouped ? 'mt-1' : ''}`;

            const displayName = msg.displayName || usersMap.get(msg.userId)?.displayName || 'Unknown';
            const idSource = msg.identitySource || usersMap.get(msg.userId)?.identitySource;
            const { nameHtml, bubbleAccent } = buildNameAndRole(displayName, msg.role, idSource);

            const bubbleColor = isOwnMessage
                ? 'bg-blue-600 text-white rounded-2xl rounded-tr-sm'
                : `bg-gray-800 text-gray-100 rounded-2xl rounded-tl-sm border border-gray-700 ${bubbleAccent}`;

            const timeAlign = isOwnMessage ? 'text-right' : '';

            // Get avatar color from users map or default
            const userInfo = usersMap.get(msg.userId);
            const colorClass = userInfo ? (avatarColors[userInfo.avatarColor] || 'bg-purple-600') : 'bg-gray-600';

            // Hide avatar and name for grouped messages
            const avatarHtml = (!isOwnMessage && !isGrouped) ? `
                <div class="w-7 h-7 ${colorClass} rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 mt-1">
                    ${getInitials(displayName)}
                </div>
            ` : (!isOwnMessage && isGrouped) ? '<div class="w-7 flex-shrink-0"></div>' : '';

            // Status indicator for own messages (‚úì = sent, ‚úì‚úì = read)
            const statusHtml = isOwnMessage ? '<span class="message-status text-blue-300 ml-1">‚úì</span>' : '';

            // Show name only for first message in group
            const showName = !isOwnMessage && !isGrouped;

            div.innerHTML = `
                ${avatarHtml}
                <div class="max-w-[75%] min-w-0">
                    ${showName ? nameHtml : ''}
                    <div class="${bubbleColor} px-4 py-2 shadow-lg overflow-hidden">
                        <p class="text-sm leading-relaxed break-words whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5 ${timeAlign} ${isOwnMessage ? 'mr-1' : 'ml-1'} flex items-center ${isOwnMessage ? 'justify-end' : ''}">
                        <span>${formatTime(msg.ts)}</span>${statusHtml}
                    </div>
                </div>
            `;

            messagesContainer.appendChild(div);
            smartScroll(isOwnMessage);

            // Observe for read receipts (only for messages from others)
            if (!isOwnMessage && msg.id && messageReadObserver) {
                messageReadObserver.observe(div);
            }
        }

        /**
         * Render a system message (user joined/left)
         */
        function renderSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'flex justify-center';
            div.innerHTML = `
                <div class="bg-gray-800/50 text-gray-400 text-xs px-3 py-1.5 rounded-full border border-gray-700">
                    ${escapeHtml(text)}
                </div>
            `;
            messagesContainer.appendChild(div);
            scrollToBottom(false);  // System messages don't force scroll
        }

        /**
         * Load more message history (pagination).
         * Fetches older messages from the server and prepends them.
         */
        async function loadMoreHistory() {
            if (isLoadingHistory || !hasMoreHistory || !session.backendUrl || !session.roomId) {
                return;
            }

            isLoadingHistory = true;

            // Find the oldest message timestamp
            const messages = messagesContainer.querySelectorAll('[data-message-id]');
            if (messages.length === 0) {
                isLoadingHistory = false;
                return;
            }

            // Get timestamp from first message (oldest visible)
            const firstMessage = messages[0];
            const messageId = firstMessage.getAttribute('data-message-id');
            // We need to find the timestamp - look for it in the message data
            // For now, use the message ID to find timestamp from our tracking
            // Actually, we need to store timestamps. Let's use a different approach.

            // Find oldest timestamp from seenMessageIds is not possible.
            // We'll use lastMessageTimestamp tracking differently.
            // Let's add data-timestamp attribute to messages.

            // For now, use a simple approach: fetch with limit and check hasMore
            try {
                // Build URL - we need to get the oldest message's timestamp
                // Since we don't have it stored, we'll need to track it
                const oldestTs = getOldestMessageTimestamp();
                if (!oldestTs) {
                    isLoadingHistory = false;
                    hasMoreHistory = false;
                    return;
                }

                const url = `${session.backendUrl}/chat/${session.roomId}/history?before=${oldestTs}&limit=50`;
                console.log('[WebView] Loading more history from:', url);

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('[WebView] Loaded history:', data.messages?.length, 'messages, hasMore:', data.hasMore);

                if (data.messages && data.messages.length > 0) {
                    // Save scroll position
                    const scrollHeight = messagesContainer.scrollHeight;

                    // Prepend messages (oldest first, so reverse to get chronological order)
                    const sortedMessages = data.messages.sort((a, b) => a.ts - b.ts);
                    sortedMessages.forEach(msg => {
                        if (!isDuplicateMessage(msg.id)) {
                            prependMessage(msg);
                        }
                    });

                    // Restore scroll position
                    messagesContainer.scrollTop = messagesContainer.scrollHeight - scrollHeight;
                }

                hasMoreHistory = data.hasMore === true;
            } catch (err) {
                console.error('[WebView] Failed to load history:', err);
            } finally {
                isLoadingHistory = false;
            }
        }

        /**
         * Get the timestamp of the oldest visible message.
         * @returns {number|null} Unix timestamp or null if no messages.
         */
        function getOldestMessageTimestamp() {
            const messages = messagesContainer.querySelectorAll('[data-timestamp]');
            if (messages.length === 0) return null;
            return parseFloat(messages[0].getAttribute('data-timestamp'));
        }

        /**
         * Prepend a message to the top of the messages container.
         * Similar to renderMessage but inserts at the beginning.
         * @param {Object} msg - Message object.
         */
        function prependMessage(msg) {
            const isOwnMessage = msg.userId === session.userId;

            const div = document.createElement('div');
            div.setAttribute('data-message-id', msg.id || '');
            div.setAttribute('data-timestamp', msg.ts || '');
            div.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} gap-2`;

            const displayName = msg.displayName || usersMap.get(msg.userId)?.displayName || 'Unknown';
            const idSource = msg.identitySource || usersMap.get(msg.userId)?.identitySource;
            const { nameHtml, bubbleAccent } = buildNameAndRole(displayName, msg.role, idSource);

            const bubbleColor = isOwnMessage
                ? 'bg-blue-600 text-white rounded-2xl rounded-tr-sm'
                : `bg-gray-800 text-gray-100 rounded-2xl rounded-tl-sm border border-gray-700 ${bubbleAccent}`;

            const userInfo = usersMap.get(msg.userId);
            const colorClass = userInfo ? (avatarColors[userInfo.avatarColor] || 'bg-purple-600') : 'bg-gray-600';

            const avatarHtml = !isOwnMessage ? `
                <div class="w-7 h-7 ${colorClass} rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0 mt-1">
                    ${getInitials(displayName)}
                </div>
            ` : '';

            const statusHtml = isOwnMessage ? '<span class="message-status text-blue-300 ml-1">‚úì</span>' : '';
            const timeAlign = isOwnMessage ? 'text-right' : '';

            div.innerHTML = `
                ${avatarHtml}
                <div class="max-w-[75%] min-w-0">
                    ${!isOwnMessage ? nameHtml : ''}
                    <div class="${bubbleColor} px-4 py-2 shadow-lg overflow-hidden">
                        <p class="text-sm leading-relaxed break-words whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                    </div>
                    <div class="text-xs text-gray-500 mt-0.5 ${timeAlign} ${isOwnMessage ? 'mr-1' : 'ml-1'} flex items-center ${isOwnMessage ? 'justify-end' : ''}">
                        <span>${formatTime(msg.ts)}</span>${statusHtml}
                    </div>
                </div>
            `;

            // Insert at the beginning
            messagesContainer.insertBefore(div, messagesContainer.firstChild);

            // Observe for read receipts
            if (!isOwnMessage && msg.id && messageReadObserver) {
                messageReadObserver.observe(div);
            }
        }

        /**
         * Update connection status display
         */
        function updateConnectionStatus(status, isError = false) {
            if (connectionStatus) {
                const colorClass = isError ? 'text-red-400 border-red-700' : 'text-gray-400 border-gray-700';
                connectionStatus.innerHTML = `
                    <div class="bg-gray-800/50 ${colorClass} text-xs px-3 py-1.5 rounded-full border">
                        <span>${status}</span>
                    </div>
                `;
            }
        }

        /**
         * Calculate reconnection delay with exponential backoff.
         * @returns {number} Delay in milliseconds.
         */
        function getReconnectDelay() {
            const delay = Math.min(
                BASE_RECONNECT_DELAY_MS * Math.pow(2, reconnectAttempts),
                MAX_RECONNECT_DELAY_MS
            );
            // Add jitter (¬±20%) to prevent thundering herd
            const jitter = delay * 0.2 * (Math.random() - 0.5);
            return Math.round(delay + jitter);
        }

        /**
         * Check if a message has already been rendered (for deduplication).
         * @param {string} messageId - The message ID to check.
         * @returns {boolean} True if duplicate, false if new.
         */
        function isDuplicateMessage(messageId) {
            if (!messageId) return false;
            if (seenMessageIds.has(messageId)) return true;
            seenMessageIds.add(messageId);
            // Limit set size to prevent memory issues
            if (seenMessageIds.size > 10000) {
                const first = seenMessageIds.values().next().value;
                seenMessageIds.delete(first);
            }
            return false;
        }

        /**
         * Track the timestamp of the latest message for reconnection recovery.
         * @param {number} ts - Unix timestamp in seconds.
         */
        function updateLastMessageTimestamp(ts) {
            if (ts > lastMessageTimestamp) {
                lastMessageTimestamp = ts;
            }
        }

        /**
         * Send a read receipt for a message.
         * @param {string} messageId - The message ID that was read.
         */
        function sendReadReceipt(messageId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            if (!messageId) return;

            // SECURITY: Backend uses assigned userId
            ws.send(JSON.stringify({
                type: 'read',
                messageId: messageId
            }));
        }

        /**
         * Connect to WebSocket chat server.
         * Supports message recovery on reconnect via `since` parameter.
         */
        function connectWebSocket() {
            if (!session.roomId || !session.userId) {
                console.error('[WebView] Cannot connect: missing roomId or userId');
                updateConnectionStatus('‚ùå Missing session info', true);
                return;
            }

            // Build WebSocket URL with optional `since` parameter for reconnection
            let wsUrl = session.backendUrl.replace('http', 'ws') + '/ws/chat/' + session.roomId;
            if (lastMessageTimestamp > 0 && reconnectAttempts > 0) {
                wsUrl += `?since=${lastMessageTimestamp}`;
                console.log('[WebView] Reconnecting with message recovery since:', lastMessageTimestamp);
            }
            console.log('[WebView] Connecting to:', wsUrl);
            updateConnectionStatus(reconnectAttempts > 0 ? 'Reconnecting...' : 'Connecting...');

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('[WebView] WebSocket connected');
                reconnectAttempts = 0;
                updateConnectionStatus('‚úÖ Connected');
                // Hide status after a moment
                setTimeout(() => {
                    if (connectionStatus) connectionStatus.style.display = 'none';
                }, 2000);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('[WebView] Received:', data);

                    // SECURITY: Handle backend-assigned credentials FIRST
                    // The backend assigns userId and role on connection - client MUST use these
                    if (data.type === 'connected') {
                        console.log('[WebView] SECURITY: Backend assigned credentials:', data);
                        // Store backend-assigned userId and role
                        session.userId = data.userId;
                        session.sessionRole = data.role;
                        session.leadId = data.leadId || null;
                        console.log('[WebView] Updated session with backend credentials:', {
                            userId: session.userId,
                            sessionRole: session.sessionRole,
                            leadId: session.leadId
                        });
                        // Don't send join yet - wait for history message
                    } else if (data.type === 'history') {
                        // Clear status
                        if (connectionStatus) connectionStatus.style.display = 'none';

                        // Store leadId from server
                        if (data.leadId) session.leadId = data.leadId;
                        updateLeadPermissions();

                        // Render existing users (always update on history)
                        if (data.users) {
                            renderUsersList(data.users);
                        }

                        // Render message history (with deduplication)
                        data.messages.forEach(msg => {
                            if (!isDuplicateMessage(msg.id)) {
                                renderMessage(msg);
                                updateLastMessageTimestamp(msg.ts);
                            }
                        });

                        // Only send join if this is not a recovery (reconnect)
                        // SECURITY: Use backend-assigned userId (already stored in session)
                        if (!data.isRecovery) {
                            ws.send(JSON.stringify({
                                type: 'join',
                                displayName: session.displayName || 'User',
                                identitySource: getIdentitySource()
                                // Note: userId and role are now handled by backend
                            }));
                        }
                    } else if (data.type === 'message') {
                        if (!isDuplicateMessage(data.id)) {
                            renderMessage(data);
                            updateLastMessageTimestamp(data.ts);
                        }
                    } else if (data.type === 'file') {
                        if (!isDuplicateMessage(data.id)) {
                            renderFileMessage(data);
                            updateLastMessageTimestamp(data.ts);
                        }
                    } else if (data.type === 'code_snippet') {
                        if (!isDuplicateMessage(data.id)) {
                            renderCodeSnippetMessage(data);
                            updateLastMessageTimestamp(data.ts);
                        }
                    } else if (data.type === 'ai_summary') {
                        if (!isDuplicateMessage(data.id)) {
                            renderAiSummaryMessage(data);
                            updateLastMessageTimestamp(data.ts);
                        }
                    } else if (data.type === 'ai_code_prompt') {
                        if (!isDuplicateMessage(data.id)) {
                            renderAiCodePromptMessage(data);
                            updateLastMessageTimestamp(data.ts);
                        }
                    } else if (data.type === 'user_joined') {
                        renderUsersList(data.users);
                        renderSystemMessage(`${data.user.displayName} joined the chat`);
                    } else if (data.type === 'user_left') {
                        renderUsersList(data.users);
                        renderSystemMessage(`${data.user.displayName} left the chat`);
                    } else if (data.type === 'session_ended') {
                        sessionEnded = true;
                        renderSystemMessage('üî¥ ' + data.message);
                        // Disable input
                        chatInput.disabled = true;
                        chatInput.placeholder = 'Chat session has ended';
                        btnSend.disabled = true;
                        btnSend.classList.add('opacity-50', 'cursor-not-allowed');
                        // Hide end chat button
                        btnEndChat.classList.add('hidden');
                        // Clear users list
                        usersList.innerHTML = '';
                        userCount.textContent = '0 online';
                        // Notify extension to reset session state
                        vscode.postMessage({ command: 'sessionEnded' });
                    } else if (data.type === 'typing') {
                        handleTypingEvent(data);
                    } else if (data.type === 'read_receipt') {
                        // Update message status indicators
                        handleReadReceipt(data);
                    } else if (data.type === 'lead_changed') {
                        session.leadId = data.leadId;
                        updateLeadPermissions();
                        // Show who the new lead is
                        const leadUser = usersMap.get(data.leadId);
                        const leadName = leadUser ? leadUser.displayName : 'Unknown';
                        renderSystemMessage(`Lead transferred to ${leadName}`);
                        // Re-render user list to update lead indicator
                        if (usersMap.size > 0) {
                            renderUsersList(Array.from(usersMap.values()));
                        }
                    } else if (data.type === 'error') {
                        // SECURITY: Handle backend error messages (e.g., permission denied)
                        console.error('[WebView] Backend error:', data.error);
                        renderSystemMessage(`‚ö†Ô∏è ${data.error}`);
                    }
                } catch (err) {
                    console.error('[WebView] Failed to parse message:', err);
                }
            };

            ws.onclose = (event) => {
                console.log('[WebView] WebSocket closed:', event.code, event.reason);
                // Don't reconnect if session was ended by host
                if (sessionEnded) {
                    updateConnectionStatus('Session ended', false);
                    return;
                }
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    const delay = getReconnectDelay();
                    console.log(`[WebView] Reconnecting in ${delay}ms (attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                    updateConnectionStatus(`Reconnecting (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`);
                    setTimeout(connectWebSocket, delay);
                } else {
                    updateConnectionStatus('‚ùå Connection lost', true);
                }
            };

            ws.onerror = (error) => {
                console.error('[WebView] WebSocket error:', error);
                updateConnectionStatus('‚ùå Connection error', true);
            };
        }

        /**
         * Handle read receipt from server.
         * Updates message status indicators to show who has read.
         * @param {Object} data - Read receipt data with messageId and readBy.
         */
        function handleReadReceipt(data) {
            const { messageId, readBy } = data;
            if (!messageId || !readBy) return;

            // Find the message element and update its status
            const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageEl) {
                const statusEl = messageEl.querySelector('.message-status');
                if (statusEl) {
                    // Show double checkmark if read by someone other than sender
                    const otherReaders = readBy.filter(id => id !== session.userId);
                    if (otherReaders.length > 0) {
                        statusEl.textContent = '‚úì‚úì';
                        statusEl.title = `Read by ${otherReaders.length} ${otherReaders.length === 1 ? 'person' : 'people'}`;
                    }
                }
            }
        }

        /**
         * Send a chat message.
         * Stops typing indicator and resets textarea.
         * Includes code snippet if one is attached.
         */
        function sendMessage() {
            const content = chatInput.value.trim();
            const hasSnippet = pendingCodeSnippet !== null;

            // Need either content or a code snippet to send
            if ((!content && !hasSnippet) || !ws || ws.readyState !== WebSocket.OPEN) {
                return;
            }

            // Stop typing indicator when sending message
            if (isTyping) {
                isTyping = false;
                sendTypingIndicator(false);
            }
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }

            // Build message with optional code snippet
            // SECURITY: userId and role are assigned by backend, we only send content
            const message = {
                displayName: session.displayName || 'User',
                content: content || (hasSnippet ? '' : '')
            };

            // Attach code snippet if present
            if (hasSnippet) {
                message.type = 'code_snippet';
                message.codeSnippet = pendingCodeSnippet;
            }

            console.log('[WebView] Sending:', message);
            ws.send(JSON.stringify(message));
            chatInput.value = '';
            chatInput.style.height = 'auto';  // Reset textarea height

            // Clear code snippet after sending
            if (hasSnippet) {
                clearCodeSnippet();
            }
        }

        // Send button click handler (text messages only)
        btnSend.addEventListener('click', () => {
            sendMessage();
        });

        // Enter key handler (Shift+Enter for new line)
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Input event handler for typing indicator and auto-resize
        chatInput.addEventListener('input', handleInputEvent);

        // Scroll event handler for scroll-to-bottom button
        messagesContainer.addEventListener('scroll', handleScroll);

        // Scroll to bottom button click handler
        scrollToBottomBtn.addEventListener('click', scrollToBottom);

        // ============================================================
        // Code Snippet Handling
        // ============================================================

        /**
         * Handle code snippet button click - request code from extension
         */
        btnCodeSnippet.addEventListener('click', () => {
            vscode.postMessage({ command: 'getCodeSnippet' });
        });

        /**
         * Handle code snippet received from extension
         */
        function handleCodeSnippetFromExtension(message) {
            if (message.error) {
                console.warn('[WebView] Code snippet error:', message.error);
                return;
            }

            pendingCodeSnippet = {
                filename: message.filename,
                relativePath: message.relativePath,
                language: message.language,
                startLine: message.startLine,
                endLine: message.endLine,
                code: message.code
            };

            // Show preview
            codeSnippetFilename.textContent = message.relativePath || message.filename;
            codeSnippetFilename.title = message.filename;
            codeSnippetLines.textContent = message.startLine === message.endLine
                ? `Line ${message.startLine}`
                : `Lines ${message.startLine}-${message.endLine}`;
            codeSnippetContent.textContent = message.code;
            codeSnippetPreview.classList.remove('hidden');

            // Focus the input for adding a comment
            chatInput.focus();
            chatInput.placeholder = 'Add a comment about this code...';
        }

        /**
         * Clear the pending code snippet
         */
        function clearCodeSnippet() {
            pendingCodeSnippet = null;
            codeSnippetPreview.classList.add('hidden');
            codeSnippetFilename.textContent = '';
            codeSnippetLines.textContent = '';
            codeSnippetContent.textContent = '';
            chatInput.placeholder = 'Type your message or paste an image...';
        }

        /**
         * Clear snippet button handler
         */
        btnClearSnippet.addEventListener('click', clearCodeSnippet);

        // ============================================================
        // File Upload Handling
        // ============================================================

        /**
         * Show file preview before upload
         */
        function showFilePreview(file) {
            pendingFile = file;
            filePreviewName.textContent = file.name;
            filePreviewSize.textContent = formatFileSize(file.size);

            // Set icon based on file type
            if (file.type.startsWith('image/')) {
                filePreviewIcon.textContent = 'üñºÔ∏è';
                // Show image thumbnail
                const reader = new FileReader();
                reader.onload = (e) => {
                    filePreviewImg.src = e.target.result;
                    filePreviewImg.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                filePreviewIcon.textContent = 'üìÑ';
                filePreviewImg.classList.add('hidden');
            } else if (file.type.startsWith('audio/')) {
                filePreviewIcon.textContent = 'üéµ';
                filePreviewImg.classList.add('hidden');
            } else {
                filePreviewIcon.textContent = 'üìé';
                filePreviewImg.classList.add('hidden');
            }

            filePreview.classList.remove('hidden');
        }

        /**
         * Clear file preview
         */
        function clearFilePreview() {
            pendingFile = null;
            isUploading = false;
            filePreview.classList.add('hidden');
            filePreviewImg.src = '';
            filePreviewImg.classList.add('hidden');
            fileInput.value = '';
            fileCaption.value = '';
            btnUploadFile.disabled = false;
            btnUploadFile.textContent = '‚¨ÜÔ∏è Upload';
        }

        /**
         * Upload a file to the backend via VS Code extension host
         * (WebView cannot make direct fetch requests due to CORS restrictions)
         */
        async function uploadFile(file, caption = null) {
            // Prevent double uploads
            if (isUploading) {
                console.log('[WebView] Upload already in progress, ignoring');
                return;
            }

            console.log('[WebView] uploadFile called with:', file?.name, 'caption:', caption);
            console.log('[WebView] Session state:', {
                backendUrl: session.backendUrl,
                roomId: session.roomId,
                userId: session.userId,
                displayName: session.displayName
            });

            if (!session.backendUrl || !session.roomId) {
                console.error('[WebView] Cannot upload: missing backendUrl or roomId');
                alert('Cannot upload: session not initialized. Please start or join a session first.');
                return;
            }

            // Mark as uploading
            isUploading = true;
            btnUploadFile.disabled = true;
            btnUploadFile.textContent = '‚è≥ Uploading...';

            // Validate file size
            if (file.size > MAX_FILE_SIZE) {
                alert(`File size exceeds 20MB limit. Your file is ${formatFileSize(file.size)}`);
                isUploading = false;
                btnUploadFile.disabled = false;
                btnUploadFile.textContent = '‚¨ÜÔ∏è Upload';
                return;
            }

            // Store caption for use in response handler
            pendingUploadCaption = caption;

            try {
                console.log('[WebView] Uploading file via extension host:', file.name, file.size, 'bytes');

                // Convert file to base64 for sending via postMessage
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Data = e.target.result.split(',')[1]; // Remove data URL prefix

                    // Send upload request to extension host
                    vscode.postMessage({
                        command: 'uploadFile',
                        backendUrl: session.backendUrl,
                        roomId: session.roomId,
                        userId: session.userId,
                        displayName: session.displayName || 'Host',
                        fileData: base64Data,
                        fileName: file.name,
                        mimeType: file.type || 'application/octet-stream',
                        caption: caption
                    });

                    console.log('[WebView] Upload request sent to extension host');
                };
                reader.onerror = function(e) {
                    console.error('[WebView] Failed to read file:', e);
                    alert('Failed to read file');
                    isUploading = false;
                    btnUploadFile.disabled = false;
                    btnUploadFile.textContent = '‚¨ÜÔ∏è Upload';
                };
                reader.readAsDataURL(file);

            } catch (error) {
                console.error('[WebView] File upload failed:', error);
                alert(`File upload failed: ${error.message}`);
                isUploading = false;
                btnUploadFile.disabled = false;
                btnUploadFile.textContent = '‚¨ÜÔ∏è Upload';
            }
        }

        // Store pending upload caption for use in response handler
        let pendingUploadCaption = null;

        // Attachment button click handler
        btnAttach.addEventListener('click', () => {
            fileInput.click();
        });

        // Upload button click handler (explicit upload action)
        btnUploadFile.addEventListener('click', async () => {
            if (pendingFile && !isUploading) {
                const caption = fileCaption.value.trim() || null;
                await uploadFile(pendingFile, caption);
            }
        });

        // File input change handler
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > MAX_FILE_SIZE) {
                alert(`File size exceeds 20MB limit. Your file is ${formatFileSize(file.size)}`);
                fileInput.value = '';
                return;
            }

            showFilePreview(file);
        });

        // Remove file button handler
        btnRemoveFile.addEventListener('click', clearFilePreview);

        // Handle paste event for images
        chatInput.addEventListener('paste', async (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;

            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) {
                        // Show preview for pasted image
                        showFilePreview(file);
                    }
                    break;
                }
            }
        });

        // Copy room ID button handler
        btnCopyRoomId.addEventListener('click', async () => {
            if (session.roomId) {
                try {
                    await navigator.clipboard.writeText(session.roomId);
                    // Visual feedback - show checkmark
                    btnCopyRoomId.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    `;
                    // Revert to clipboard icon after 2 seconds
                    setTimeout(() => {
                        btnCopyRoomId.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                            </svg>
                        `;
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy room ID:', err);
                }
            }
        });

        // End chat button handler (Lead/Host only)
        btnEndChat.addEventListener('click', () => {
            console.log('[WebView] End Chat button clicked');
            // Use VS Code API for confirmation since confirm() doesn't work in WebView
            vscode.postMessage({
                command: 'confirmEndChat'
            });
        });

        // Handle confirmation response from extension
        function handleEndChatConfirmed() {
            console.log('[WebView] End chat confirmed, ws state:', ws ? ws.readyState : 'null');
            // SECURITY: Backend validates permission using assigned userId
            if (ws && ws.readyState === WebSocket.OPEN) {
                const msg = {
                    type: 'end_session'
                    // Note: userId is handled by backend (assigned on connection)
                };
                console.log('[WebView] Sending end_session:', msg);
                ws.send(JSON.stringify(msg));
            } else {
                console.error('[WebView] WebSocket not open');
            }
        }

        // ============================================================
        // AI Configuration Modal Functions
        // ============================================================

        /**
         * Open the AI Configuration modal and fetch status.
         */
        function openAiConfigModal() {
            aiConfigModal.classList.remove('hidden');
            fetchAiStatus();
        }

        /**
         * Close the AI Configuration modal.
         */
        function closeAiConfigModal() {
            aiConfigModal.classList.add('hidden');
        }

        /**
         * Fetch AI status from the backend via extension.
         */
        function fetchAiStatus() {
            console.log('[WebView] fetchAiStatus called');
            // Show loading state
            aiConfigLoading.classList.remove('hidden');
            aiConfigError.classList.add('hidden');
            aiConfigContent.classList.add('hidden');

            // Request AI status from extension (which proxies to backend)
            console.log('[WebView] Sending getAiStatus message to extension');
            vscode.postMessage({ command: 'getAiStatus' });
        }

        /**
         * Handle AI status response from extension.
         * @param {Object} data - AI status data or error
         */
        function handleAiStatusResponse(data) {
            console.log('[WebView] handleAiStatusResponse called with:', JSON.stringify(data));

            // Hide loading
            aiConfigLoading.classList.add('hidden');

            if (data.error) {
                // Show error state
                console.log('[WebView] AI status error:', data.error);
                aiConfigError.classList.remove('hidden');
                aiConfigErrorText.textContent = data.error;
                aiConfigContent.classList.add('hidden');
                return;
            }

            // Show content
            aiConfigError.classList.add('hidden');
            aiConfigContent.classList.remove('hidden');

            // Update global AI status state
            aiSummaryEnabledState = data.summary_enabled;
            aiActiveProviderState = data.active_provider;
            aiModelsState = data.models || [];
            aiActiveModelState = data.active_model;
            console.log('[WebView] AI status updated: enabled=', aiSummaryEnabledState, ', provider=', aiActiveProviderState, ', model=', aiActiveModelState);

            // Update summary enabled section
            if (data.summary_enabled) {
                aiSummaryEnabled.textContent = 'Enabled';
                aiSummaryEnabled.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-600 text-white';
                aiSummaryIcon.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-green-600/20 text-green-400';
                aiSummaryStatusText.textContent = data.active_model ? `Using ${data.active_model}` : 'No model available';
                aiSummaryStatusText.className = data.active_model ? 'text-xs text-green-400' : 'text-xs text-yellow-400';
            } else {
                aiSummaryEnabled.textContent = 'Disabled';
                aiSummaryEnabled.className = 'px-3 py-1 rounded-full text-xs font-medium bg-gray-600 text-gray-300';
                aiSummaryIcon.className = 'h-10 w-10 rounded-full flex items-center justify-center bg-gray-600/20 text-gray-400';
                aiSummaryStatusText.textContent = 'AI summarization is disabled';
                aiSummaryStatusText.className = 'text-xs text-gray-400';
            }

            // Update model selection dropdown
            updateModelSelect(data.models || [], data.active_model);

            // Update last updated timestamp
            const now = new Date();
            aiLastUpdated.textContent = `Updated ${now.toLocaleTimeString()}`;

            // Update the sidebar AI status indicator
            updateAiStatusIndicator();

            // Update providers list
            aiProvidersList.innerHTML = '';
            if (data.providers && data.providers.length > 0) {
                aiNoProviders.classList.add('hidden');
                aiProvidersList.classList.remove('hidden');

                data.providers.forEach(provider => {
                    const row = document.createElement('div');
                    const isActive = provider.name === data.active_provider;
                    row.className = isActive
                        ? 'flex items-center justify-between px-3 py-2.5 bg-purple-900/20'
                        : 'flex items-center justify-between px-3 py-2.5';

                    const leftSection = document.createElement('div');
                    leftSection.className = 'flex items-center gap-2';

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'text-sm text-gray-300 font-mono';
                    nameSpan.textContent = provider.name;

                    leftSection.appendChild(nameSpan);

                    // Add "Active" badge if this is the active provider
                    if (isActive) {
                        const activeBadge = document.createElement('span');
                        activeBadge.className = 'px-1.5 py-0.5 rounded text-[10px] font-medium bg-purple-600 text-white uppercase';
                        activeBadge.textContent = 'Active';
                        leftSection.appendChild(activeBadge);
                    }

                    const statusSpan = document.createElement('span');
                    if (!provider.enabled) {
                        // Provider is disabled in settings
                        statusSpan.className = 'flex items-center gap-1.5 text-xs text-gray-500';
                        statusSpan.innerHTML = `
                            <span class="inline-block h-2 w-2 rounded-full bg-gray-500"></span>
                            Disabled
                        `;
                    } else if (!provider.configured) {
                        // Provider is enabled but no API key configured
                        statusSpan.className = 'flex items-center gap-1.5 text-xs text-yellow-500';
                        statusSpan.innerHTML = `
                            <span class="inline-block h-2 w-2 rounded-full bg-yellow-500"></span>
                            Not configured
                        `;
                    } else if (provider.healthy) {
                        // Provider is enabled, configured, and healthy
                        statusSpan.className = 'flex items-center gap-1.5 text-xs text-green-400';
                        statusSpan.innerHTML = `
                            <span class="inline-block h-2 w-2 rounded-full bg-green-400"></span>
                            Healthy
                        `;
                    } else {
                        // Provider is enabled and configured but unhealthy
                        statusSpan.className = 'flex items-center gap-1.5 text-xs text-red-400';
                        statusSpan.innerHTML = `
                            <span class="inline-block h-2 w-2 rounded-full bg-red-400"></span>
                            Unhealthy
                        `;
                    }

                    row.appendChild(leftSection);
                    row.appendChild(statusSpan);
                    aiProvidersList.appendChild(row);
                });
            } else {
                aiProvidersList.classList.add('hidden');
                aiNoProviders.classList.remove('hidden');
            }
        }

        /**
         * Update model selection dropdown.
         * @param {Array} models - Array of model status objects
         * @param {string|null} activeModel - Currently active model ID
         */
        function updateModelSelect(models, activeModel) {
            if (!aiModelSelect) return;

            aiModelSelect.innerHTML = '';

            if (models.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No models available';
                option.disabled = true;
                aiModelSelect.appendChild(option);
                aiModelSelect.disabled = true;
                if (aiModelSelectHint) {
                    aiModelSelectHint.textContent = 'Configure AI providers to enable models';
                }
                return;
            }

            // Group models by provider
            const availableModels = models.filter(m => m.available);
            const unavailableModels = models.filter(m => !m.available);

            // Add available models first
            if (availableModels.length > 0) {
                availableModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = `${model.display_name}`;
                    if (model.id === activeModel) {
                        option.selected = true;
                    }
                    aiModelSelect.appendChild(option);
                });
            }

            // Add unavailable models (grayed out)
            if (unavailableModels.length > 0 && availableModels.length > 0) {
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '‚îÄ‚îÄ Unavailable ‚îÄ‚îÄ';
                aiModelSelect.appendChild(separator);
            }
            unavailableModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = `${model.display_name} (no provider)`;
                option.disabled = true;
                aiModelSelect.appendChild(option);
            });

            aiModelSelect.disabled = availableModels.length === 0;

            if (aiModelSelectHint) {
                if (availableModels.length === 0) {
                    aiModelSelectHint.textContent = 'No providers configured - add API keys to enable models';
                    aiModelSelectHint.className = 'text-xs text-yellow-500 mt-2';
                } else {
                    aiModelSelectHint.textContent = `${availableModels.length} model(s) available`;
                    aiModelSelectHint.className = 'text-xs text-gray-500 mt-2';
                }
            }
        }

        /**
         * Handle model selection change.
         */
        function handleModelChange(modelId) {
            if (!modelId) return;

            console.log('[WebView] Changing active model to:', modelId);
            // Disable select while changing
            if (aiModelSelect) {
                aiModelSelect.disabled = true;
            }
            vscode.postMessage({
                command: 'setAiModel',
                modelId: modelId
            });
        }

        /**
         * Handle result of setting AI model.
         * @param {Object} data - Result data from backend
         */
        function handleSetAiModelResult(data) {
            // Re-enable the select
            if (aiModelSelect) {
                aiModelSelect.disabled = false;
            }

            if (data.error) {
                console.error('[WebView] Failed to set AI model:', data.error);
                // The extension will automatically refresh status, which will restore the select
                return;
            }

            console.log('[WebView] AI model set successfully:', data.message);
            // Status will be refreshed automatically by the extension
        }

        // AI Config modal event listeners
        if (btnAiConfig) {
            btnAiConfig.addEventListener('click', openAiConfigModal);
        } else {
            console.error('[WebView] btnAiConfig element not found!');
        }
        if (btnCloseAiConfig) {
            btnCloseAiConfig.addEventListener('click', closeAiConfigModal);
        }
        if (aiConfigBackdrop) {
            aiConfigBackdrop.addEventListener('click', closeAiConfigModal);
        }
        if (btnRefreshAiStatus) {
            btnRefreshAiStatus.addEventListener('click', fetchAiStatus);
        }
        if (aiModelSelect) {
            aiModelSelect.addEventListener('change', (e) => {
                handleModelChange(e.target.value);
            });
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !aiConfigModal.classList.contains('hidden')) {
                closeAiConfigModal();
            }
            if (e.key === 'Escape' && !roomSettingsModal.classList.contains('hidden')) {
                closeRoomSettingsModal();
            }
        });

        // ============================================================
        // ROOM SETTINGS MODAL FUNCTIONS
        // ============================================================

        /**
         * Open the Room Settings modal and fetch settings.
         */
        function openRoomSettingsModal() {
            roomSettingsModal.classList.remove('hidden');
            fetchRoomSettings();
        }

        /**
         * Close the Room Settings modal.
         */
        function closeRoomSettingsModal() {
            roomSettingsModal.classList.add('hidden');
        }

        /**
         * Fetch room settings from the backend via extension.
         */
        function fetchRoomSettings() {
            console.log('[WebView] fetchRoomSettings called');
            roomSettingsLoading.classList.remove('hidden');
            roomSettingsError.classList.add('hidden');
            roomSettingsContent.classList.add('hidden');
            roomSettingsFooter.classList.add('hidden');

            vscode.postMessage({ command: 'getRoomSettings', roomId: currentRoomId });
        }

        /**
         * Handle room settings response from extension.
         * @param {Object} data - Room settings data or error
         */
        function handleRoomSettingsResponse(data) {
            console.log('[WebView] handleRoomSettingsResponse:', JSON.stringify(data));
            roomSettingsLoading.classList.add('hidden');

            if (data.error) {
                roomSettingsError.classList.remove('hidden');
                roomSettingsErrorText.textContent = data.error;
                return;
            }

            roomSettingsContent.classList.remove('hidden');
            roomSettingsFooter.classList.remove('hidden');
            roomCodeStyleTextarea.value = data.code_style || '';
        }

        /**
         * Save room settings via extension.
         */
        function saveRoomSettings() {
            console.log('[WebView] saveRoomSettings called');
            const codeStyle = roomCodeStyleTextarea.value;
            vscode.postMessage({
                command: 'saveRoomSettings',
                roomId: currentRoomId,
                codeStyle: codeStyle
            });
        }

        /**
         * Handle save room settings result from extension.
         * @param {Object} data - Save result data or error
         */
        function handleSaveRoomSettingsResult(data) {
            console.log('[WebView] handleSaveRoomSettingsResult:', JSON.stringify(data));
            if (data.error) {
                roomSettingsError.classList.remove('hidden');
                roomSettingsErrorText.textContent = data.error;
                return;
            }
            closeRoomSettingsModal();
        }

        // Room Settings modal event listeners
        if (btnRoomSettings) {
            btnRoomSettings.addEventListener('click', openRoomSettingsModal);
        }
        if (btnCloseRoomSettings) {
            btnCloseRoomSettings.addEventListener('click', closeRoomSettingsModal);
        }
        if (btnCancelRoomSettings) {
            btnCancelRoomSettings.addEventListener('click', closeRoomSettingsModal);
        }
        if (roomSettingsBackdrop) {
            roomSettingsBackdrop.addEventListener('click', closeRoomSettingsModal);
        }
        if (btnSaveRoomSettings) {
            btnSaveRoomSettings.addEventListener('click', saveRoomSettings);
        }

        // ============================================================
        // AI SUMMARIZE FUNCTIONALITY
        // ============================================================

        /**
         * Update AI status indicator (no-op, sidebar indicator removed).
         */
        function updateAiStatusIndicator() {}

        /**
         * Open the summary modal in loading state.
         */
        function openSummaryModal() {
            summaryModal.classList.remove('hidden');
            summaryLoading.classList.remove('hidden');
            summaryError.classList.add('hidden');
            summaryContent.classList.add('hidden');
            // Reset code prompt UI when opening modal
            resetCodePromptUI();
        }

        /**
         * Close the summary modal.
         */
        function closeSummaryModal() {
            summaryModal.classList.add('hidden');
        }

        /**
         * Request AI summary of the current chat.
         * If there's only 1 message, summarizes directly.
         * If there are more than 1 message, shows the options modal to let user choose.
         */
        function requestSummarize() {
            console.log('[WebView] requestSummarize called, aiSummaryEnabledState=', aiSummaryEnabledState, ', aiActiveProviderState=', aiActiveProviderState, ', chatMessages.length=', chatMessages.length);
            if (!aiSummaryEnabledState || !aiActiveProviderState) {
                console.warn('[WebView] Cannot summarize: AI not available. enabled=', aiSummaryEnabledState, ', provider=', aiActiveProviderState);
                vscode.postMessage({
                    command: 'alert',
                    text: 'AI summarization is not available. Please check AI configuration.'
                });
                return;
            }

            if (chatMessages.length === 0) {
                console.warn('[WebView] No messages to summarize');
                vscode.postMessage({
                    command: 'alert',
                    text: 'No messages to summarize. Start a conversation first.'
                });
                return;
            }

            // If only 1 message, summarize directly without showing options
            if (chatMessages.length === 1) {
                console.log('[WebView] Only 1 message, summarizing directly');
                executeSummarize(chatMessages);
                return;
            }

            // More than 1 message - show options modal to let user choose
            console.log('[WebView] Multiple messages detected, showing options modal');
            openSummarizeOptionsModal();
        }

        /**
         * Open the summarize options modal.
         */
        function openSummarizeOptionsModal() {
            console.log('[WebView] Opening summarize options modal, element exists:', !!summarizeOptionsModal);
            if (!summarizeOptionsModal) {
                console.error('[WebView] summarizeOptionsModal element not found!');
                return;
            }
            summarizeOptionsModal.classList.remove('hidden');
            console.log('[WebView] Modal classList after remove hidden:', summarizeOptionsModal.classList.toString());
            // Update message count
            if (summarizeAllCount) {
                summarizeAllCount.textContent = `${chatMessages.length} messages`;
            }
        }

        /**
         * Close the summarize options modal.
         */
        function closeSummarizeOptionsModal() {
            summarizeOptionsModal.classList.add('hidden');
        }

        /**
         * Handle "Summarize All" button click.
         * Summarizes all messages in the chat.
         */
        function handleSummarizeAll() {
            closeSummarizeOptionsModal();
            executeSummarize(chatMessages);
        }

        /**
         * Open the message selection modal.
         */
        function openMessageSelectionModal() {
            closeSummarizeOptionsModal();
            messageSelectionModal.classList.remove('hidden');
            selectedMessageIndices.clear();
            populateMessageSelectionList();
            updateSelectedCount();
        }

        /**
         * Close the message selection modal.
         */
        function closeMessageSelectionModal() {
            messageSelectionModal.classList.add('hidden');
        }

        /**
         * Populate the message selection list with checkboxes.
         */
        function populateMessageSelectionList() {
            messageSelectionList.innerHTML = '';
            chatMessages.forEach((msg, index) => {
                const messageItem = document.createElement('div');
                messageItem.className = 'flex items-start gap-3 p-3 bg-gray-700/50 rounded-lg hover:bg-gray-700 transition-colors';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `msg-checkbox-${index}`;
                checkbox.className = 'mt-1 h-4 w-4 rounded border-gray-600 bg-gray-700 text-purple-600 focus:ring-purple-500 cursor-pointer';
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedMessageIndices.add(index);
                    } else {
                        selectedMessageIndices.delete(index);
                    }
                    updateSelectedCount();
                });

                const label = document.createElement('label');
                label.htmlFor = `msg-checkbox-${index}`;
                label.className = 'flex-1 cursor-pointer';

                const roleSpan = document.createElement('span');
                roleSpan.className = msg.role === 'host' ? 'text-amber-400 text-xs font-medium' : 'text-blue-400 text-xs font-medium';
                roleSpan.textContent = msg.role === 'host' ? 'Host' : 'Engineer';

                const textSpan = document.createElement('span');
                textSpan.className = 'text-gray-300 text-sm block mt-1';
                textSpan.textContent = msg.text.length > 100 ? msg.text.substring(0, 100) + '...' : msg.text;

                label.appendChild(roleSpan);
                label.appendChild(textSpan);

                messageItem.appendChild(checkbox);
                messageItem.appendChild(label);
                messageSelectionList.appendChild(messageItem);
            });
        }

        /**
         * Update the selected messages count display.
         */
        function updateSelectedCount() {
            selectedMessagesCount.textContent = `${selectedMessageIndices.size} selected`;
            btnConfirmMessageSelection.disabled = selectedMessageIndices.size === 0;
        }

        /**
         * Select all messages in the selection list.
         */
        function handleSelectAllMessages() {
            chatMessages.forEach((_, index) => selectedMessageIndices.add(index));
            document.querySelectorAll('#message-selection-list input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateSelectedCount();
        }

        /**
         * Deselect all messages in the selection list.
         */
        function handleDeselectAllMessages() {
            selectedMessageIndices.clear();
            document.querySelectorAll('#message-selection-list input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }

        /**
         * Handle confirm button click in message selection modal.
         * Summarizes only the selected messages.
         */
        function handleConfirmMessageSelection() {
            if (selectedMessageIndices.size === 0) return;

            closeMessageSelectionModal();

            // Get selected messages in order
            const selectedMessages = Array.from(selectedMessageIndices)
                .sort((a, b) => a - b)
                .map(index => chatMessages[index]);

            executeSummarize(selectedMessages);
        }

        /**
         * Execute the summarization with the given messages.
         * @param {Array} messages - The messages to summarize
         */
        function executeSummarize(messages) {
            // Open modal and show loading state
            openSummaryModal();

            console.log('[WebView] Requesting summary for', messages.length, 'messages');

            // Request summary from extension with properly formatted messages
            vscode.postMessage({
                command: 'summarize',
                messages: messages
            });
        }

        /**
         * Handle summarize response from extension.
         * Since the summary is now posted as an AI message in chat,
         * this just closes the modal on success.
         * @param {Object} data - The structured summary response or error
         */
        function handleSummarizeResponse(data) {
            // Hide loading
            summaryLoading.classList.add('hidden');

            if (data.error) {
                console.error('[WebView] Summarize error:', data.error);
                summaryError.classList.remove('hidden');
                summaryErrorText.textContent = data.error;
                summaryContent.classList.add('hidden');
                return;
            }

            // Success - the summary is now posted as an AI message in chat
            // Close the modal since the summary appears in the chat
            closeSummaryModal();
            console.log('[WebView] Summary posted to chat successfully');
        }

        // Summary modal event listeners
        if (btnCloseSummary) {
            btnCloseSummary.addEventListener('click', closeSummaryModal);
        }
        if (btnDismissSummary) {
            btnDismissSummary.addEventListener('click', closeSummaryModal);
        }
        if (summaryModalBackdrop) {
            summaryModalBackdrop.addEventListener('click', closeSummaryModal);
        }

        // Summarize options modal event listeners
        if (btnCloseSummarizeOptions) {
            btnCloseSummarizeOptions.addEventListener('click', closeSummarizeOptionsModal);
        }
        if (summarizeOptionsBackdrop) {
            summarizeOptionsBackdrop.addEventListener('click', closeSummarizeOptionsModal);
        }
        if (btnSummarizeAll) {
            btnSummarizeAll.addEventListener('click', handleSummarizeAll);
        }
        if (btnSummarizeSelect) {
            btnSummarizeSelect.addEventListener('click', openMessageSelectionModal);
        }

        // Message selection modal event listeners
        if (btnCloseMessageSelection) {
            btnCloseMessageSelection.addEventListener('click', closeMessageSelectionModal);
        }
        if (messageSelectionBackdrop) {
            messageSelectionBackdrop.addEventListener('click', closeMessageSelectionModal);
        }
        if (btnSelectAllMessages) {
            btnSelectAllMessages.addEventListener('click', handleSelectAllMessages);
        }
        if (btnDeselectAllMessages) {
            btnDeselectAllMessages.addEventListener('click', handleDeselectAllMessages);
        }
        if (btnCancelMessageSelection) {
            btnCancelMessageSelection.addEventListener('click', closeMessageSelectionModal);
        }
        if (btnConfirmMessageSelection) {
            btnConfirmMessageSelection.addEventListener('click', handleConfirmMessageSelection);
        }

        /**
         * Request code prompt generation from the backend.
         */
        function requestCodePrompt() {
            if (!currentSummaryData) {
                console.warn('[WebView] No summary data available for code prompt generation');
                return;
            }

            // Show loading state
            codePromptInitial.classList.add('hidden');
            codePromptLoading.classList.remove('hidden');
            codePromptError.classList.add('hidden');
            codePromptResult.classList.add('hidden');

            // Disable button
            if (btnGenerateCodePrompt) {
                btnGenerateCodePrompt.disabled = true;
            }

            console.log('[WebView] Requesting code prompt for summary:', currentSummaryData.topic);

            // Request code prompt from extension
            vscode.postMessage({
                command: 'generateCodePrompt',
                decisionSummary: currentSummaryData
            });
        }

        /**
         * Handle code prompt response from extension.
         * @param {Object} data - The code prompt response or error
         */
        function handleCodePromptResponse(data) {
            // Hide loading
            codePromptLoading.classList.add('hidden');

            // Re-enable button
            if (btnGenerateCodePrompt) {
                btnGenerateCodePrompt.disabled = false;
            }

            if (data.error) {
                console.error('[WebView] Code prompt error:', data.error);
                codePromptError.classList.remove('hidden');
                codePromptErrorText.textContent = data.error;
                codePromptInitial.classList.remove('hidden');
                return;
            }

            if (data.code_prompt) {
                // Store the generated prompt
                generatedCodePrompt = data.code_prompt;

                // Show the result
                codePromptError.classList.add('hidden');
                codePromptResult.classList.remove('hidden');
                codePromptTextarea.value = data.code_prompt;

                console.log('[WebView] Code prompt generated successfully');
            }
        }

        /**
         * Handle code prompt post result from extension.
         * This is called after the code prompt is posted to chat as an AI message.
         * @param {Object} data - The result with success or error
         */
        function handleCodePromptPostResponse(data) {
            if (data.error) {
                console.error('[WebView] Code prompt post error:', data.error);
                // Re-enable button on error so user can retry
                if (currentCodePromptButtonId) {
                    const btn = document.getElementById(currentCodePromptButtonId);
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Generate Code Prompt
                        `;
                    }
                    currentCodePromptButtonId = null;
                }
                // Show error to user
                vscode.postMessage({
                    command: 'alert',
                    text: `Failed to post code prompt: ${data.error}`
                });
            } else if (data.success) {
                console.log('[WebView] Code prompt posted to chat successfully');
                // Update button to "Done" state
                if (currentCodePromptButtonId) {
                    const btn = document.getElementById(currentCodePromptButtonId);
                    if (btn) {
                        btn.disabled = true;
                        btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        btn.classList.add('bg-green-600', 'cursor-not-allowed');
                        btn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                            Done
                        `;
                    }
                    currentCodePromptButtonId = null;
                }
            }
        }

        /**
         * Copy code prompt to clipboard.
         */
        function copyCodePromptToClipboard() {
            if (!generatedCodePrompt) {
                return;
            }

            navigator.clipboard.writeText(generatedCodePrompt).then(() => {
                // Show success feedback
                if (btnCopyCodePromptText) {
                    const originalText = btnCopyCodePromptText.textContent;
                    btnCopyCodePromptText.textContent = 'Copied!';
                    setTimeout(() => {
                        btnCopyCodePromptText.textContent = originalText;
                    }, 2000);
                }
                console.log('[WebView] Code prompt copied to clipboard');
            }).catch(err => {
                console.error('[WebView] Failed to copy code prompt:', err);
            });
        }

        /**
         * Reset code prompt UI state (called when summary modal is opened).
         */
        function resetCodePromptUI() {
            codePromptInitial.classList.remove('hidden');
            codePromptLoading.classList.add('hidden');
            codePromptError.classList.add('hidden');
            codePromptResult.classList.add('hidden');
            generatedCodePrompt = null;
            if (codePromptTextarea) {
                codePromptTextarea.value = '';
            }
        }

        // Generate Code Prompt button handler
        if (btnGenerateCodePrompt) {
            btnGenerateCodePrompt.addEventListener('click', requestCodePrompt);
        }

        // Copy Code Prompt button handler
        if (btnCopyCodePrompt) {
            btnCopyCodePrompt.addEventListener('click', copyCodePromptToClipboard);
        }

        // Fetch AI status on load

        vscode.postMessage({ command: 'getAiStatus' });

        // Initialize UI from the current FSM state
        render(conductorState, null);

        // Request latest conductor state from extension (in case it changed since HTML was built)
        vscode.postMessage({ command: 'getConductorState' });
    </script>
</body>
</html>

